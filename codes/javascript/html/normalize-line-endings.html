<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æœ¬è¡Œå°¾è§„èŒƒåŒ–å·¥å…· - normalizeLineEndings</title>
    <!-- å¼•å…¥æ’ä»¶æ ·å¼ -->
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 18px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.25s ease;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .textarea-field {
            min-height: 200px;
            resize: vertical;
            line-height: 1.6;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .text-editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .editor-panel {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .editor-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.05rem;
        }

        .editor-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .editor-badge.original {
            background: #dbeafe;
            color: #1e40af;
        }

        .editor-badge.normalized {
            background: #dcfce7;
            color: #15803d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .comparison-view {
            background: white;
            border-radius: 14px;
            padding: 20px;
            margin-top: 20px;
        }

        .line-ending-info {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #667eea;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .select-container {
            margin-bottom: 16px;
        }

        .checkbox-container {
            margin-top: 12px;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
            margin-bottom: 16px;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .file-info {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 600;
            color: #1f2937;
        }

        .file-size {
            font-size: 0.85rem;
            color: #64748b;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            border-left: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .history-info {
            font-size: 0.85rem;
            color: #1f2937;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .text-editor-container {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        .code-preview {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin-top: 12px;
        }

        .code-preview .keyword {
            color: #c792ea;
        }

        .code-preview .function {
            color: #82aaff;
        }

        .code-preview .string {
            color: #c3e88d;
        }

        .code-preview .comment {
            color: #697098;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ–‡æœ¬è¡Œå°¾è§„èŒƒåŒ–å·¥å…·</h1>
            <p>åŸºäº normalizeLineEndings å‡½æ•°çš„æ–‡æœ¬å¤„ç†å·¥å…·ï¼Œç»Ÿä¸€ä¸åŒæ ¼å¼çš„è¡Œå°¾ç¬¦å·</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="sidebar">
                <div class="card">
                    <h2>âš™ï¸ é…ç½®é€‰é¡¹</h2>
                    <div class="input-group">
                        <label>ç›®æ ‡è¡Œå°¾æ ¼å¼</label>
                        <div id="lineEndingSelect" class="select-container"></div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary btn-block" onclick="window.textNormalizer?.normalize()">
                            ğŸ”„ è§„èŒƒåŒ–æ–‡æœ¬
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ </h2>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div style="font-size: 3rem; margin-bottom: 12px;">ğŸ“</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</div>
                        <div style="font-size: 0.85rem; color: #64748b;">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                        <input type="file" id="fileInput" style="display: none;" accept=".txt,.js,.ts,.json,.md,.css,.html">
                    </div>
                    <div id="fileInfo" style="display: none;"></div>
                </div>

                <div class="card">
                    <h2>ğŸ”§ å·¥å…·</h2>
                    <div id="checkboxGroup" class="checkbox-container"></div>
                    <div class="button-group">
                        <button class="btn btn-info btn-sm" onclick="window.textNormalizer?.detectLineEndings()">
                            ğŸ” æ£€æµ‹è¡Œå°¾æ ¼å¼
                        </button>
                        <button class="btn btn-success btn-sm" onclick="window.textNormalizer?.loadSample()">
                            ğŸ“ åŠ è½½ç¤ºä¾‹
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="window.textNormalizer?.exportResult()">
                            ğŸ’¾ å¯¼å‡ºç»“æœ
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="window.textNormalizer?.clearAll()">
                            ğŸ§¹ æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalLines">0</div>
                            <div class="stat-label">æ€»è¡Œæ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalChars">0</div>
                            <div class="stat-label">æ€»å­—ç¬¦æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="lineEndingType">-</div>
                            <div class="stat-label">è¡Œå°¾ç±»å‹</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“œ å¤„ç†å†å²</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state" style="padding: 40px 20px;">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p style="font-size: 0.9rem;">å¤„ç†å†å²å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ–‡æœ¬ç¼–è¾‘åŒºåŸŸ -->
            <div class="visualization">
                <div class="card">
                    <h2>ğŸ“„ æ–‡æœ¬ç¼–è¾‘å™¨</h2>
                    <div class="text-editor-container">
                        <div class="editor-panel">
                            <div class="editor-header">
                                <span class="editor-title">åŸå§‹æ–‡æœ¬</span>
                                <span class="editor-badge original">åŸå§‹</span>
                            </div>
                            <textarea id="originalText" class="textarea-field" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶..."></textarea>
                        </div>
                        <div class="editor-panel">
                            <div class="editor-header">
                                <span class="editor-title">è§„èŒƒåŒ–å</span>
                                <span class="editor-badge normalized">è§„èŒƒåŒ–</span>
                            </div>
                            <textarea id="normalizedText" class="textarea-field" placeholder="è§„èŒƒåŒ–åçš„æ–‡æœ¬å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" id="comparisonCard" style="display: none;">
                    <h2>ğŸ“Š è¯¦ç»†ä¿¡æ¯</h2>
                    <div class="comparison-view">
                        <div class="line-ending-info">
                            <div class="info-row">
                                <span class="info-label">åŸå§‹è¡Œå°¾æ ¼å¼</span>
                                <span class="info-value" id="originalLineEnding">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç›®æ ‡è¡Œå°¾æ ¼å¼</span>
                                <span class="info-value" id="targetLineEnding">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">åŸå§‹å­—ç¬¦æ•°</span>
                                <span class="info-value" id="originalChars">0</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è§„èŒƒåŒ–åå­—ç¬¦æ•°</span>
                                <span class="info-value" id="normalizedChars">0</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å­—ç¬¦æ•°å˜åŒ–</span>
                                <span class="info-value" id="charChange">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#667eea;margin-bottom:12px;">normalizeLineEndings å‡½æ•°ï¼ˆè§„èŒƒåŒ–è¡Œå°¾ï¼‰</h3>
                <div class="code-preview">
<span class="keyword">const</span> <span class="function">normalizeLineEndings</span> = (str, normalized = <span class="string">"\r\n"</span>) => str.<span class="function">replace</span>(<span class="string">/\r?\n/g</span>, normalized);
                </div>
                <p style="color:#374151;line-height:1.8;margin-top:16px;">
                    <strong>normalizeLineEndings</strong> å‡½æ•°ç”¨äºè§„èŒƒåŒ–å­—ç¬¦ä¸²ä¸­çš„è¡Œç»“å°¾ã€‚
                    å¯ä»¥å°†ä¸åŒæ ¼å¼çš„è¡Œå°¾ï¼ˆ\r\nã€\nã€\rï¼‰ç»Ÿä¸€è½¬æ¢ä¸ºæŒ‡å®šçš„æ ¼å¼ã€‚
                </p>
                <h3 style="color:#667eea;margin:20px 0 12px;">ä½¿ç”¨ç¤ºä¾‹</h3>
                <div class="code-preview">
<span class="comment">// ç»Ÿä¸€ä¸º Windows æ ¼å¼ (\r\n)</span>
<span class="function">normalizeLineEndings</span>(<span class="string">'Line1\nLine2\r\nLine3'</span>);
<span class="comment">// => 'Line1\r\nLine2\r\nLine3'</span>

<span class="comment">// ç»Ÿä¸€ä¸º Unix æ ¼å¼ (\n)</span>
<span class="function">normalizeLineEndings</span>(<span class="string">'Line1\r\nLine2\nLine3'</span>, <span class="string">'\n'</span>);
<span class="comment">// => 'Line1\nLine2\nLine3'</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ’ä»¶è„šæœ¬ -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>

    <script>
        // normalizeLineEndings å‡½æ•°ï¼šè§„èŒƒåŒ–å­—ç¬¦ä¸²ä¸­çš„è¡Œç»“å°¾
        const normalizeLineEndings = (str, normalized = "\r\n") => str.replace(/\r?\n/g, normalized);

        // æ–‡æœ¬è¡Œå°¾è§„èŒƒåŒ–å·¥å…·
        class TextNormalizer {
            constructor() {
                this.plugins = {};
                this.originalText = '';
                this.normalizedText = '';
                this.history = [];
                this.currentFile = null;
                
                this.init();
            }

            async init() {
                await this.loadPlugins();
                this.setupLineEndingSelect();
                this.setupCheckboxes();
                this.setupFileUpload();
                this.setupTextInput();
                this.loadHistoryFromStorage();
                this.updateStats();
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupLineEndingSelect() {
                try {
                    this.plugins.lineEndingSelect = new Select({
                        container: '#lineEndingSelect',
                        options: [
                            { value: '\\r\\n', label: 'Windows (\\r\\n)' },
                            { value: '\\n', label: 'Unix/Linux (\\n)' },
                            { value: '\\r', label: 'Mac (\\r)' }
                        ],
                        placeholder: 'é€‰æ‹©ç›®æ ‡è¡Œå°¾æ ¼å¼',
                        onChange: (value) => {
                            if (this.originalText) {
                                this.normalize();
                            }
                        }
                    });
                    this.plugins.lineEndingSelect.setValue('\\r\\n');
                } catch (error) {
                    console.warn('è¡Œå°¾æ ¼å¼é€‰æ‹©å™¨åŠ è½½å¤±è´¥:', error);
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;

                const options = [
                    { id: 'showDetails', label: 'æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯', checked: true },
                    { id: 'autoNormalize', label: 'è‡ªåŠ¨è§„èŒƒåŒ–', checked: false },
                    { id: 'enableNotifications', label: 'å¯ç”¨é€šçŸ¥æé†’', checked: true },
                    { id: 'saveHistory', label: 'ä¿å­˜å¤„ç†å†å²', checked: true }
                ];

                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: options,
                        onChange: () => {
                            this.updateComparisonDisplay();
                        }
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = ['showDetails', 'autoNormalize', 'enableNotifications', 'saveHistory'].indexOf(id);
                        return index !== -1 ? states[index] : false;
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥:', error);
                    }
                }
                return false;
            }

            showNotification(message, type = 'info') {
                if (this.plugins.notification && this.getCheckboxValue('enableNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            setupFileUpload() {
                const uploadArea = document.getElementById('fileUploadArea');
                const fileInput = document.getElementById('fileInput');
                
                if (!uploadArea || !fileInput) return;

                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                // æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleFile(file);
                    }
                });

                // æ‹–æ”¾ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        this.handleFile(file);
                    }
                });
            }

            setupTextInput() {
                const originalTextArea = document.getElementById('originalText');
                if (!originalTextArea) return;

                let timeout;
                originalTextArea.addEventListener('input', () => {
                    this.originalText = originalTextArea.value;
                    this.updateStats();

                    // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨è§„èŒƒåŒ–ï¼Œå»¶è¿Ÿæ‰§è¡Œä»¥é¿å…é¢‘ç¹å¤„ç†
                    if (this.getCheckboxValue('autoNormalize')) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            this.normalize();
                        }, 500);
                    }
                });
            }

            async handleFile(file) {
                this.currentFile = file;
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                const fileInfo = document.getElementById('fileInfo');
                if (fileInfo) {
                    fileInfo.style.display = 'block';
                    fileInfo.innerHTML = `
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${this.formatFileSize(file.size)}</span>
                        </div>
                    `;
                }

                try {
                    const text = await this.readFile(file);
                    const originalTextArea = document.getElementById('originalText');
                    if (originalTextArea) {
                        originalTextArea.value = text;
                        this.originalText = text;
                    }
                    
                    if (this.getCheckboxValue('autoNormalize')) {
                        this.normalize();
                    }
                    
                    this.updateStats();
                    this.showNotification(`æ–‡ä»¶ "${file.name}" åŠ è½½æˆåŠŸ`, 'success');
                } catch (error) {
                    this.showNotification('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsText(file, 'UTF-8');
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            detectLineEndings() {
                const originalTextArea = document.getElementById('originalText');
                const text = originalTextArea?.value || '';

                if (!text) {
                    this.showNotification('è¯·å…ˆè¾“å…¥æ–‡æœ¬', 'warning');
                    return;
                }

                // å…ˆç»Ÿè®¡ CRLF
                const crlfCount = (text.match(/\r\n/g) || []).length;
                
                // ç§»é™¤æ‰€æœ‰ CRLF åç»Ÿè®¡å•ç‹¬çš„ LF å’Œ CR
                const textWithoutCRLF = text.replace(/\r\n/g, '');
                const lfCount = (textWithoutCRLF.match(/\n/g) || []).length;
                const crCount = (textWithoutCRLF.match(/\r/g) || []).length;

                let detectedType = 'æœªæ£€æµ‹åˆ°';
                let detectedValue = '';

                if (crlfCount > lfCount && crlfCount > crCount) {
                    detectedType = 'Windows (\\r\\n)';
                    detectedValue = '\\r\\n';
                } else if (lfCount > crCount) {
                    detectedType = 'Unix/Linux (\\n)';
                    detectedValue = '\\n';
                } else if (crCount > 0) {
                    detectedType = 'Mac (\\r)';
                    detectedValue = '\\r';
                }

                this.plugins.modal?.show({
                    title: 'ğŸ” è¡Œå°¾æ ¼å¼æ£€æµ‹ç»“æœ',
                    content: `
                        <div style="padding: 8px 0;">
                            <div style="margin-bottom: 12px;">
                                <strong>æ£€æµ‹åˆ°çš„è¡Œå°¾æ ¼å¼:</strong>
                                <div style="font-size: 1.2rem; font-weight: 700; color: #667eea; margin-top: 8px;">
                                    ${detectedType}
                                </div>
                            </div>
                            <div style="background: #f8fafc; padding: 12px; border-radius: 8px;">
                                <div style="margin-bottom: 8px;"><strong>ç»Ÿè®¡:</strong></div>
                                <div>\\r\\n (Windows): ${crlfCount} å¤„</div>
                                <div>\\n (Unix/Linux): ${lfCount} å¤„</div>
                                <div>\\r (Mac): ${crCount} å¤„</div>
                            </div>
                        </div>
                    `,
                    type: 'alert'
                });

                // å¦‚æœæ£€æµ‹åˆ°æ ¼å¼ï¼Œå¯ä»¥è‡ªåŠ¨è®¾ç½®
                if (detectedValue && this.plugins.lineEndingSelect) {
                    this.plugins.lineEndingSelect.setValue(detectedValue);
                }
            }

            normalize() {
                const originalTextArea = document.getElementById('originalText');
                const normalizedTextArea = document.getElementById('normalizedText');
                
                if (!originalTextArea) return;

                const text = originalTextArea.value;
                this.originalText = text;

                if (!text) {
                    this.showNotification('è¯·å…ˆè¾“å…¥æ–‡æœ¬', 'warning');
                    return;
                }

                // è·å–ç›®æ ‡è¡Œå°¾æ ¼å¼
                const selectedValue = this.plugins.lineEndingSelect?.getValue() || '\\r\\n';
                let normalized;

                switch (selectedValue) {
                    case '\\r\\n':
                        normalized = '\r\n';
                        break;
                    case '\\n':
                        normalized = '\n';
                        break;
                    case '\\r':
                        normalized = '\r';
                        break;
                    default:
                        normalized = '\r\n';
                }

                // ä½¿ç”¨ normalizeLineEndings å‡½æ•°è§„èŒƒåŒ–
                this.normalizedText = normalizeLineEndings(text, normalized);

                // æ˜¾ç¤ºç»“æœ
                if (normalizedTextArea) {
                    normalizedTextArea.value = this.normalizedText;
                }

                // æ›´æ–°ç»Ÿè®¡å’Œè¯¦ç»†ä¿¡æ¯
                this.updateStats();
                this.updateComparisonDisplay();

                // ä¿å­˜å†å²
                if (this.getCheckboxValue('saveHistory')) {
                    this.addToHistory(text, this.normalizedText, normalized);
                }

                this.showNotification('æ–‡æœ¬è§„èŒƒåŒ–å®Œæˆ', 'success');
            }

            updateStats() {
                const lines = this.originalText ? this.originalText.split(/\r?\n/).length : 0;
                const chars = this.originalText ? this.originalText.length : 0;
                
                // æ£€æµ‹è¡Œå°¾æ ¼å¼
                let lineEndingType = '-';
                if (this.originalText) {
                    const crlfCount = (this.originalText.match(/\r\n/g) || []).length;
                    const textWithoutCRLF = this.originalText.replace(/\r\n/g, '');
                    const lfCount = (textWithoutCRLF.match(/\n/g) || []).length;
                    const crCount = (textWithoutCRLF.match(/\r/g) || []).length;
                    
                    if (crlfCount > lfCount && crlfCount > crCount) {
                        lineEndingType = 'CRLF';
                    } else if (lfCount > crCount) {
                        lineEndingType = 'LF';
                    } else if (crCount > 0) {
                        lineEndingType = 'CR';
                    }
                }

                document.getElementById('totalLines').textContent = lines;
                document.getElementById('totalChars').textContent = chars;
                document.getElementById('lineEndingType').textContent = lineEndingType;
            }

            updateComparisonDisplay() {
                const card = document.getElementById('comparisonCard');
                if (!card) return;

                if (!this.getCheckboxValue('showDetails') || !this.originalText) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';

                // æ£€æµ‹åŸå§‹è¡Œå°¾æ ¼å¼
                let originalType = 'æœªæ£€æµ‹åˆ°';
                if (this.originalText) {
                    const crlfCount = (this.originalText.match(/\r\n/g) || []).length;
                    const textWithoutCRLF = this.originalText.replace(/\r\n/g, '');
                    const lfCount = (textWithoutCRLF.match(/\n/g) || []).length;
                    const crCount = (textWithoutCRLF.match(/\r/g) || []).length;
                    
                    if (crlfCount > lfCount && crlfCount > crCount) {
                        originalType = 'Windows (\\r\\n)';
                    } else if (lfCount > crCount) {
                        originalType = 'Unix/Linux (\\n)';
                    } else if (crCount > 0) {
                        originalType = 'Mac (\\r)';
                    }
                }

                // è·å–ç›®æ ‡æ ¼å¼
                const selectedValue = this.plugins.lineEndingSelect?.getValue() || '\\r\\n';
                let targetType = 'Windows (\\r\\n)';
                switch (selectedValue) {
                    case '\\r\\n':
                        targetType = 'Windows (\\r\\n)';
                        break;
                    case '\\n':
                        targetType = 'Unix/Linux (\\n)';
                        break;
                    case '\\r':
                        targetType = 'Mac (\\r)';
                        break;
                }

                const originalChars = this.originalText.length;
                const normalizedChars = this.normalizedText.length;
                const charChange = normalizedChars - originalChars;

                document.getElementById('originalLineEnding').textContent = originalType;
                document.getElementById('targetLineEnding').textContent = targetType;
                document.getElementById('originalChars').textContent = originalChars.toLocaleString();
                document.getElementById('normalizedChars').textContent = normalizedChars.toLocaleString();
                document.getElementById('charChange').textContent = 
                    charChange > 0 ? `+${charChange.toLocaleString()}` : charChange.toLocaleString();
            }

            addToHistory(original, normalized, lineEnding) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    originalLength: original.length,
                    normalizedLength: normalized.length,
                    lineEnding: lineEnding,
                    lineCount: original.split(/\r?\n/).length
                });

                if (this.history.length > 50) {
                    this.history.pop();
                }

                this.renderHistory();
                this.saveHistory();
            }

            renderHistory() {
                const container = document.getElementById('historyList');
                if (!container) return;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 40px 20px;">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p style="font-size: 0.9rem;">å¤„ç†å†å²å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item" onclick="window.textNormalizer?.loadHistory(${this.history.indexOf(item)})">
                        <div class="history-time">${item.time}</div>
                        <div class="history-info">
                            è¡Œå°¾: ${item.lineEnding === '\r\n' ? 'Windows' : item.lineEnding === '\n' ? 'Unix/Linux' : 'Mac'} | 
                            è¡Œæ•°: ${item.lineCount} | 
                            å­—ç¬¦: ${item.originalLength} â†’ ${item.normalizedLength}
                        </div>
                    </div>
                `).join('');
            }

            loadHistory(index) {
                // å†å²è®°å½•ä¸»è¦ç”¨äºæŸ¥çœ‹ï¼Œå®é™…åŠ è½½éœ€è¦ä»åŸå§‹æ•°æ®æ¢å¤
                this.showNotification('å†å²è®°å½•æŸ¥çœ‹åŠŸèƒ½', 'info');
            }

            loadSample() {
                const sampleText = `è¿™æ˜¯ç¬¬ä¸€è¡Œ
è¿™æ˜¯ç¬¬äºŒè¡Œ\r
è¿™æ˜¯ç¬¬ä¸‰è¡Œ\r\n
è¿™æ˜¯ç¬¬å››è¡Œ
è¿™æ˜¯ç¬¬äº”è¡Œ`;

                const originalTextArea = document.getElementById('originalText');
                if (originalTextArea) {
                    originalTextArea.value = sampleText;
                    this.originalText = sampleText;
                    
                    if (this.getCheckboxValue('autoNormalize')) {
                        this.normalize();
                    }
                    
                    this.updateStats();
                    this.showNotification('ç¤ºä¾‹æ–‡æœ¬å·²åŠ è½½', 'success');
                }
            }

            exportResult() {
                if (!this.normalizedText) {
                    this.showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ', 'warning');
                    return;
                }

                const blob = new Blob([this.normalizedText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `normalized_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                this.showNotification('ç»“æœå·²å¯¼å‡º', 'success');
            }

            clearAll() {
                this.plugins.modal?.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ').then(confirmed => {
                    if (confirmed) {
                        const originalTextArea = document.getElementById('originalText');
                        const normalizedTextArea = document.getElementById('normalizedText');
                        const fileInfo = document.getElementById('fileInfo');
                        
                        if (originalTextArea) originalTextArea.value = '';
                        if (normalizedTextArea) normalizedTextArea.value = '';
                        if (fileInfo) fileInfo.style.display = 'none';
                        
                        this.originalText = '';
                        this.normalizedText = '';
                        this.currentFile = null;
                        
                        const comparisonCard = document.getElementById('comparisonCard');
                        if (comparisonCard) comparisonCard.style.display = 'none';
                        
                        this.updateStats();
                        this.showNotification('å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹', 'info');
                    }
                });
            }

            saveHistory() {
                try {
                    localStorage.setItem('textNormalizer_history', JSON.stringify(this.history));
                } catch (error) {
                    console.warn('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
                }
            }

            loadHistoryFromStorage() {
                try {
                    const saved = localStorage.getItem('textNormalizer_history');
                    if (saved) {
                        this.history = JSON.parse(saved);
                        this.renderHistory();
                    }
                } catch (error) {
                    console.warn('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                }
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.textNormalizer = new TextNormalizer();
        });

        if (document.readyState !== 'loading' && !window.textNormalizer) {
            window.textNormalizer = new TextNormalizer();
        }
    </script>
</body>
</html>