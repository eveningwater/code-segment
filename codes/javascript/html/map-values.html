<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è±¡å€¼æ˜ å°„å¹³å° - mapValues</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
            min-height: 100vh;
            color: #0f172a;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: #0f172a;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 6px rgba(15, 23, 42, 0.15);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
            color: #1e293b;
        }

        .main-content {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
            font-size: 0.98rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.25);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .object-entries,
        .result-display {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .entry-list {
            display: grid;
            gap: 12px;
        }

        .entry-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 18px;
            align-items: center;
        }

        .entry-key {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .entry-value {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #0f172a;
        }

        .entry-meta {
            font-size: 0.8rem;
            color: #475569;
        }

        .remove-entry {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
            cursor: pointer;
            font-weight: 600;
        }

        .result-preview {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 1rem;
            overflow-x: auto;
            word-break: break-word;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }

        .analysis-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.1);
        }

        .analysis-card h4 {
            font-size: 0.98rem;
            color: #4f46e5;
            margin-bottom: 6px;
        }

        .analysis-card p,
        .analysis-card ul {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            color: #334155;
        }

        .analysis-card ul {
            padding-left: 18px;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #38bdf8;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #0f172a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #6366f1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .function-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 34px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(79, 70, 229, 0.1);
            color: #4338ca;
            font-size: 0.75rem;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ å¯¹è±¡å€¼æ˜ å°„å¹³å°</h1>
            <p>åŸºäº mapValues çš„å¯¹è±¡å€¼å¤„ç†å®éªŒå®¤ï¼šå½•å…¥åŸå§‹å¯¹è±¡ã€é€‰æ‹©æ˜ å°„å‡½æ•°ã€å®æ—¶å¯è§†åŒ–å˜åŒ–ã€ç»Ÿè®¡åˆ†æã€å†å²è¿½è¸ªä¸ä»£ç é¢„è§ˆï¼Œè®©å€¼è½¬æ¢æµç¨‹ä¸€ç›®äº†ç„¶</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ§± è¾“å…¥é…ç½®</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>é”® (Key)</label>
                            <input id="keyInput" class="input-field" placeholder="ä¾‹å¦‚ï¼šprice" />
                        </div>
                        <div class="input-group">
                            <label>å€¼ç±»å‹</label>
                            <div id="valueTypeSelect"></div>
                        </div>
                        <div class="input-group">
                            <label>å€¼ (Value)</label>
                            <input id="valueInput" class="input-field" placeholder="æ ¹æ®ç±»å‹è¾“å…¥å¯¹åº”çš„å€¼" />
                        </div>
                        <div class="input-group">
                            <label>å€¼æ‰©å±•å‚æ•°ï¼ˆå¯é€‰ï¼Œå¦‚ JSONï¼‰</label>
                            <textarea id="valueParam" class="textarea-field" placeholder='ä¾‹å¦‚ï¼š{"currency":"USD"}'></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.valuesTool?.addEntry()">â• æ·»åŠ é”®å€¼</button>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.valuesTool?.mapValues()">âš¡ æ‰§è¡Œ mapValues</button>
                            <button class="btn btn-info" onclick="window.valuesTool?.loadSample()">ğŸ“„ ç¤ºä¾‹å¯¹è±¡</button>
                            <button class="btn btn-warning" onclick="window.valuesTool?.generateRandom()">ğŸ² éšæœºç”Ÿæˆ</button>
                            <button class="btn btn-danger" onclick="window.valuesTool?.clearAll()">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ§  æ˜ å°„å‡½æ•°</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>é€‰æ‹©æ˜ å°„å‡½æ•°</label>
                            <div id="functionSelect"></div>
                        </div>
                        <div class="input-group" id="numericConfig" style="display:none;">
                            <label>æ•°å€¼ç³»æ•°ï¼ˆä¹˜æ³•å› å­ï¼‰</label>
                            <div id="numericFactor"></div>
                        </div>
                        <div class="input-group" id="stringConfig" style="display:none;">
                            <label>å­—ç¬¦ä¸²é™„åŠ æ–‡æœ¬</label>
                            <input id="stringAppend" class="input-field" placeholder="ä¾‹å¦‚ï¼šå•ä½: å…ƒ" />
                        </div>
                        <div class="input-group" id="booleanConfig" style="display:none;">
                            <label>å¸ƒå°”æ˜ å°„æ¨¡å¼</label>
                            <div id="booleanModeSelect"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>éšæœºæ¡ç›®æ•°é‡</label>
                            <div id="randomCountInput"></div>
                        </div>
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ å†å²è®°å½• (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æ˜ å°„å†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>ğŸ§¾ åŸå§‹å¯¹è±¡</h2>
                    <div class="object-entries" id="objectEntries">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ§±</div>
                            <p>æ·»åŠ é”®å€¼å¯¹åå°†åœ¨æ­¤å±•ç¤ºåŸå§‹å¯¹è±¡</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âœ¨ æ˜ å°„ç»“æœ</h2>
                    <div class="result-display" id="resultDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡Œ mapValues åå°†åœ¨æ­¤å±•ç¤ºæ–°å¯¹è±¡</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“Š è½¬æ¢åˆ†æ</h2>
                    <div class="analysis-grid" id="analysisGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#4f46e5;margin-bottom:12px;">mapValues å‡½æ•°ï¼ˆå¯¹è±¡å€¼æ˜ å°„ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const mapValues = (obj, fn) => Object.fromEntries(
  Object.entries(obj).map(([key, value]) => [key, fn(value, key, obj)])
);</code></pre>
                </div>

                <h3 style="color:#4f46e5;margin:20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#334155;line-height:1.8;">
                    <strong>mapValues</strong> éå†å¯¹è±¡ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼Œå°†å€¼ä¼ å…¥æ˜ å°„å‡½æ•° <code>fn</code>ï¼Œå¹¶ä½¿ç”¨è¿”å›ç»“æœæ„é€ æ–°å¯¹è±¡ã€‚
                    å›è°ƒå‡½æ•°å¯åŒæ—¶è®¿é—®å€¼ã€é”®å’ŒåŸå§‹å¯¹è±¡ï¼Œéå¸¸é€‚åˆè¿›è¡Œæ‰¹é‡æ•°æ®è½¬æ¢ã€å•ä½æ¢ç®—ã€æ•æ„Ÿä¿¡æ¯è„±æ•ã€æ ¼å¼åŒ–å±•ç¤ºç­‰æ“ä½œã€‚
                </p>

                <h3 style="color:#4f46e5;margin:20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                    <div class="code-block">
                        <pre><code class="language-javascript">const prices = { apple: 3.5, banana: 2.2 };
mapValues(prices, value => `${value.toFixed(2)} å…ƒ`);
// { apple: "3.50 å…ƒ", banana: "2.20 å…ƒ" }

const scores = { alice: 0.83, bob: 0.92 };
mapValues(scores, (value, key) => ({ name: key, percent: Math.round(value * 100) }));
// {
//   alice: { name: 'alice', percent: 83 },
//   bob: { name: 'bob', percent: 92 }
// }</code></pre>
                    </div>

                <h3 style="color:#4f46e5;margin:20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="function-badge">æ•°æ®æ ¼å¼åŒ–</span>
                    <span class="function-badge">å•ä½æ¢ç®—</span>
                    <span class="function-badge">æ•æ„Ÿä¿¡æ¯è„±æ•</span>
                    <span class="function-badge">æ‰¹é‡ç»“æ„åŒ–</span>
                    <span class="function-badge">æŠ¥è¡¨ç”Ÿæˆ</span>
                    <span class="function-badge">API å“åº”å¤„ç†</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const mapValues = (obj, fn) => Object.fromEntries(
            Object.entries(obj).map(([key, value]) => [key, fn(value, key, obj)])
        );

        class MapValuesTool {
            constructor() {
                this.plugins = {};
                this.originalObject = {};
                this.history = [];
                this.stats = {
                    totalMappings: 0,
                    totalKeys: 0,
                    uniqueKeys: new Set(),
                    mostUsedFunction: '-'
                };
                this.functionUsage = {};
                this.valueTypes = [
                    { value: 'string', label: 'å­—ç¬¦ä¸² (String)' },
                    { value: 'number', label: 'æ•°å­— (Number)' },
                    { value: 'boolean', label: 'å¸ƒå°”å€¼ (Boolean)' },
                    { value: 'json', label: 'JSON / å¯¹è±¡' },
                    { value: 'array', label: 'æ•°ç»„ (ä»¥é€—å·åˆ†éš”)' },
                    { value: 'date', label: 'æ—¥æœŸ (ISO/å¯è§£æ)' }
                ];
                this.mappingFunctions = [
                    {
                        value: 'scale',
                        label: 'æ•°å€¼ç¼©æ”¾ (value Ã— factor)',
                        desc: 'å¯¹æ•°å€¼ä¹˜ä»¥å¯é…ç½®å› å­ï¼Œå…¶ä»–ç±»å‹ä¿æŒä¸å˜',
                        handler: (value, key, obj, config) => {
                            const factor = config.numericFactor ?? 1;
                            if (typeof value === 'number') {
                                return Math.round(value * factor * 1000) / 1000;
                            }
                            return value;
                        }
                    },
                    {
                        value: 'stringAppend',
                        label: 'å­—ç¬¦ä¸²é™„åŠ æ–‡æœ¬ (value + suffix)',
                        desc: 'å¯¹å­—ç¬¦ä¸²è¿½åŠ è®¾å®šæ–‡æœ¬ï¼Œéå­—ç¬¦ä¸²ä¿æŒä¸å˜',
                        handler: (value, key, obj, config) => {
                            const suffix = config.stringAppend || '';
                            if (typeof value === 'string') {
                                return value + suffix;
                            }
                            return value;
                        }
                    },
                    {
                        value: 'booleanMode',
                        label: 'å¸ƒå°”æ˜ å°„ (Boolean Mode)',
                        desc: 'æŒ‰æ¨¡å¼è½¬æ¢å¸ƒå°”å€¼ï¼Œä¾‹å¦‚åè½¬ã€è½¬æ¢ä¸º YES/NO',
                        handler: (value, key, obj, config) => {
                            const mode = config.booleanMode || 'toggle';
                            if (typeof value === 'boolean') {
                                if (mode === 'toggle') return !value;
                                if (mode === 'yesno') return value ? 'YES' : 'NO';
                                if (mode === 'binary') return value ? 1 : 0;
                            }
                            return value;
                        }
                    },
                    {
                        value: 'wrapMetadata',
                        label: 'åŒ…è£…ä¸ºå…ƒæ•°æ®å¯¹è±¡',
                        desc: 'å°†ä»»æ„å€¼åŒ…è£…ä¸º { original, key, type } ç»“æ„',
                        handler: (value, key) => ({ original: value, key, type: Array.isArray(value) ? 'array' : typeof value })
                    },
                    {
                        value: 'maskString',
                        label: 'å­—ç¬¦ä¸²è„±æ• (mask)',
                        desc: 'ä»…ä¿ç•™é¦–å°¾å­—ç¬¦ï¼Œä¸­é—´æ›¿æ¢ä¸º *',
                        handler: (value) => {
                            if (typeof value === 'string' && value.length > 2) {
                                return value[0] + '*'.repeat(value.length - 2) + value[value.length - 1];
                            }
                            return value;
                        }
                    }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupValueTypeSelect();
                    this.setupFunctionSelect();
                    this.setupInputNumber();
                    this.setupBooleanSelect();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupValueTypeSelect() {
                const container = document.getElementById('valueTypeSelect');
                if (!container) return;
                try {
                    const select = new Select({
                        container,
                        options: this.valueTypes,
                        placeholder: 'é€‰æ‹©å€¼ç±»å‹',
                        onChange: () => {}
                    });
                    select.setValue('string');
                    this.plugins.valueType = select;
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿé€‰æ‹©æ¡†:', error);
                    const select = document.createElement('select');
                    select.className = 'input-field';
                    this.valueTypes.forEach((option, index) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (index === 0) opt.selected = true;
                        select.appendChild(opt);
                    });
                    container.appendChild(select);
                }
            }

            setupFunctionSelect() {
                const container = document.getElementById('functionSelect');
                if (!container) return;
                try {
                    const select = new Select({
                        container,
                        options: this.mappingFunctions,
                        placeholder: 'é€‰æ‹©æ˜ å°„å‡½æ•°',
                        onChange: (value) => this.toggleFunctionConfig(value)
                    });
                    select.setValue('scale');
                    this.plugins.functionSelect = select;
                    this.toggleFunctionConfig('scale');
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿé€‰æ‹©æ¡†:', error);
                    const select = document.createElement('select');
                    select.className = 'input-field';
                    this.mappingFunctions.forEach((option, index) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (index === 0) opt.selected = true;
                        select.appendChild(opt);
                    });
                    select.addEventListener('change', (event) => this.toggleFunctionConfig(event.target.value));
                    container.appendChild(select);
                }
            }

            setupInputNumber() {
                const container = document.getElementById('numericFactor');
                if (!container) return;
                try {
                    this.plugins.numericFactor = new InputNumber({
                        container,
                        value: 1,
                        min: -100,
                        max: 100,
                        step: 0.5,
                        onChange: () => {}
                    });
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰æ•°å­—è¾“å…¥åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿè¾“å…¥æ¡†:', error);
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = '1';
                    input.min = '-100';
                    input.max = '100';
                    input.step = '0.5';
                    input.id = 'numericFactorNative';
                    input.className = 'input-field';
                    container.appendChild(input);
                }
            }

            setupBooleanSelect() {
                const container = document.getElementById('booleanModeSelect');
                if (!container) return;
                try {
                    const select = new Select({
                        container,
                        options: [
                            { value: 'toggle', label: 'åè½¬å¸ƒå°”å€¼ (true â†” false)' },
                            { value: 'yesno', label: 'è½¬ä¸º YES / NO' },
                            { value: 'binary', label: 'è½¬ä¸º 1 / 0' }
                        ],
                        placeholder: 'é€‰æ‹©å¸ƒå°”æ˜ å°„æ¨¡å¼',
                        onChange: () => {}
                    });
                    select.setValue('toggle');
                    this.plugins.booleanMode = select;
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿé€‰æ‹©æ¡†:', error);
                    const select = document.createElement('select');
                    select.className = 'input-field';
                    select.innerHTML = `
                        <option value="toggle">åè½¬å¸ƒå°”å€¼ (true â†” false)</option>
                        <option value="yesno">è½¬ä¸º YES / NO</option>
                        <option value="binary">è½¬ä¸º 1 / 0</option>`;
                    container.appendChild(select);
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                const options = [
                    { id: 'autoSortKeys', label: 'æŒ‰é”®æ’åºå¯¹è±¡', checked: false },
                    { id: 'showOriginal', label: 'æ˜¾ç¤ºåŸå§‹å¯¹è±¡', checked: true },
                    { id: 'showMapped', label: 'æ˜¾ç¤ºæ˜ å°„ç»“æœ', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºè½¬æ¢åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºæ‰§è¡Œä»£ç ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: options.map(option => ({ id: option.id, label: option.label, checked: option.checked })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                    this.checkboxOptions = options;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    options.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            toggleFunctionConfig(value) {
                const numeric = document.getElementById('numericConfig');
                const stringCfg = document.getElementById('stringConfig');
                const booleanCfg = document.getElementById('booleanConfig');
                if (!numeric || !stringCfg || !booleanCfg) return;
                numeric.style.display = value === 'scale' ? 'block' : 'none';
                stringCfg.style.display = value === 'stringAppend' ? 'block' : 'none';
                booleanCfg.style.display = value === 'booleanMode' ? 'block' : 'none';
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup && this.checkboxOptions) {
                    try {
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            const states = this.plugins.checkboxGroup.getAllChecked();
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è·å–å¤é€‰æ¡†å€¼å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            getValueType() {
                if (this.plugins.valueType?.getValue) {
                    return this.plugins.valueType.getValue();
                }
                const native = document.querySelector('#valueTypeSelect select');
                return native ? native.value : 'string';
            }

            getFunctionConfig() {
                const config = {};
                if (this.plugins.numericFactor?.getValue) {
                    config.numericFactor = Number(this.plugins.numericFactor.getValue());
                } else {
                    const native = document.getElementById('numericFactorNative');
                    if (native) config.numericFactor = Number(native.value || 1);
                }
                const stringAppend = document.getElementById('stringAppend');
                if (stringAppend) config.stringAppend = stringAppend.value;
                if (this.plugins.booleanMode?.getValue) {
                    config.booleanMode = this.plugins.booleanMode.getValue();
                } else {
                    const native = document.querySelector('#booleanModeSelect select');
                    if (native) config.booleanMode = native.value;
                }
                return config;
            }

            getSelectedFunction() {
                let value = 'scale';
                if (this.plugins.functionSelect?.getValue) {
                    try {
                        value = this.plugins.functionSelect.getValue();
                    } catch (error) {
                        console.warn('è·å–æ˜ å°„å‡½æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ scale:', error);
                    }
                } else {
                    const native = document.querySelector('#functionSelect select');
                    if (native) value = native.value;
                }
                return this.mappingFunctions.find(item => item.value === value) || this.mappingFunctions[0];
            }

            parseValue(rawValue, type, param) {
                switch (type) {
                    case 'number': {
                        const num = Number(rawValue);
                        if (Number.isNaN(num)) throw new Error('æ— æ³•è§£æä¸ºæ•°å­—ï¼Œè¯·è¾“å…¥åˆæ³•æ•°å­—');
                        return num;
                    }
                    case 'boolean': {
                        const normalized = (rawValue || '').toString().trim().toLowerCase();
                        return ['true', '1', 'yes', 'y', 'on'].includes(normalized);
                    }
                    case 'json': {
                        if (!rawValue) return null;
                        try {
                            return JSON.parse(rawValue);
                        } catch (error) {
                            throw new Error('JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                        }
                    }
                    case 'array': {
                        if (!rawValue) return [];
                        return rawValue.split(',').map(item => item.trim());
                    }
                    case 'date': {
                        const date = new Date(rawValue);
                        if (Number.isNaN(date.getTime())) throw new Error('æ— æ³•è§£æä¸ºæ—¥æœŸï¼Œè¯·è¾“å…¥åˆæ³•æ—¥æœŸå­—ç¬¦ä¸²');
                        return date.toISOString();
                    }
                    default:
                        return rawValue;
                }
            }

            addEntry() {
                const keyInput = document.getElementById('keyInput');
                const valueInput = document.getElementById('valueInput');
                const paramInput = document.getElementById('valueParam');
                if (!keyInput || !valueInput) return;
                const key = keyInput.value.trim();
                if (!key) {
                    this.showError('è¯·è¾“å…¥é”® (Key)');
                    return;
                }
                const type = this.getValueType();
                const rawValue = valueInput.value;
                const param = paramInput?.value || '';
                try {
                    const parsedValue = this.parseValue(rawValue, type, param);
                    this.originalObject[key] = parsedValue;
                    this.stats.uniqueKeys.add(key);
                    this.displayOriginalObject();
                    keyInput.value = '';
                    valueInput.value = '';
                    if (paramInput) paramInput.value = '';
                    this.showNotification(`å·²æ·»åŠ é”®ã€Œ${key}ã€`, 'success');
                } catch (error) {
                    this.showError(error.message);
                }
            }

            removeEntry(key) {
                delete this.originalObject[key];
                this.displayOriginalObject();
                this.showNotification(`å·²ç§»é™¤é”®ã€Œ${key}ã€`, 'info');
            }

            clearAll() {
                this.originalObject = {};
                this.displayOriginalObject();
                const resultDisplay = document.getElementById('resultDisplay');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡Œ mapValues åå°†åœ¨æ­¤å±•ç¤ºæ–°å¯¹è±¡</p>
                        </div>`;
                }
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                this.showNotification('å·²æ¸…ç©ºå¯¹è±¡', 'info');
            }

            displayOriginalObject() {
                const container = document.getElementById('objectEntries');
                if (!container) return;
                if (!this.getCheckboxValue('showOriginal')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­åŸå§‹å¯¹è±¡å±•ç¤º</p>
                        </div>`;
                    return;
                }
                const entries = Object.entries(this.originalObject);
                if (entries.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ§±</div>
                            <p>æ·»åŠ é”®å€¼å¯¹åå°†åœ¨æ­¤å±•ç¤ºåŸå§‹å¯¹è±¡</p>
                        </div>`;
                    return;
                }
                const sortedEntries = this.getCheckboxValue('autoSortKeys')
                    ? entries.sort((a, b) => a[0].localeCompare(b[0]))
                    : entries;
                const html = sortedEntries.map(([key, value]) => {
                    const type = Array.isArray(value) ? 'array' : value === null ? 'null' : typeof value;
                    const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
                    return `
                        <div class="entry-card">
                            <div class="entry-key">${key}</div>
                            <div>
                                <div class="entry-value">${displayValue}</div>
                                <div class="entry-meta">ç±»å‹ï¼š${type}</div>
                            </div>
                            <button class="remove-entry" onclick="window.valuesTool?.removeEntry('${key.replace(/'/g, "\\'")}')">ç§»é™¤</button>
                        </div>
                    `;
                }).join('');
                container.innerHTML = `<div class="entry-list">${html}</div>`;
            }

            mapValues() {
                const entries = Object.entries(this.originalObject);
                if (entries.length === 0) {
                    this.showError('è¯·å…ˆæ·»åŠ å¯¹è±¡é”®å€¼å¯¹');
                    return;
                }
                const mapping = this.getSelectedFunction();
                const config = this.getFunctionConfig();
                const handler = mapping.handler;
                try {
                    const t0 = performance.now();
                    const result = mapValues(this.originalObject, (value, key, obj) => handler(value, key, obj, config));
                    const t1 = performance.now();
                    const time = Math.round((t1 - t0) * 1000) / 1000;
                    this.stats.totalMappings++;
                    this.stats.totalKeys += entries.length;
                    this.functionUsage[mapping.value] = (this.functionUsage[mapping.value] || 0) + 1;
                    this.stats.mostUsedFunction = Object.keys(this.functionUsage)
                        .reduce((a, b) => this.functionUsage[a] > this.functionUsage[b] ? a : b, mapping.value);
                    this.displayResult(result);
                    if (this.getCheckboxValue('showAnalysis')) {
                        this.displayAnalysis(result, mapping, config);
                    }
                    this.updateStats();
                    this.addToHistory(result, mapping, time);
                    if (this.getCheckboxValue('showCode')) {
                        this.showCode(result, mapping, config);
                    }
                    this.showNotification(`æ˜ å°„å®Œæˆï¼šå¤„ç†é”® ${entries.length} ä¸ªï¼Œç”¨æ—¶ ${time}Î¼s`, 'success');
                } catch (error) {
                    this.showError('æ˜ å°„å¤±è´¥: ' + error.message);
                }
            }

            displayResult(result) {
                const container = document.getElementById('resultDisplay');
                if (!container) return;
                if (!this.getCheckboxValue('showMapped')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­æ˜ å°„ç»“æœå±•ç¤º</p>
                        </div>`;
                    return;
                }
                container.innerHTML = `<div class="result-preview">${JSON.stringify(result, null, 2)}</div>`;
            }

            displayAnalysis(result, mapping, config) {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('analysisGrid');
                if (!card || !grid) return;
                const beforeTypes = this.countValueTypes(this.originalObject);
                const afterTypes = this.countValueTypes(result);
                const configText = Object.entries(config)
                    .filter(([, value]) => value !== undefined && value !== '' && value !== null)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('ã€') || 'æ— ';
                grid.innerHTML = `
                    <div class="analysis-card">
                        <h4>ç±»å‹åˆ†å¸ƒ (åŸå§‹)</h4>
                        <ul>${Object.entries(beforeTypes).map(([type, count]) => `<li>${type}: ${count}</li>`).join('')}</ul>
                    </div>
                    <div class="analysis-card">
                        <h4>ç±»å‹åˆ†å¸ƒ (æ˜ å°„å)</h4>
                        <ul>${Object.entries(afterTypes).map(([type, count]) => `<li>${type}: ${count}</li>`).join('')}</ul>
                    </div>
                    <div class="analysis-card">
                        <h4>æ˜ å°„å‡½æ•°</h4>
                        <p>å‡½æ•°ï¼š${mapping.label}</p>
                        <p>å‚æ•°ï¼š${configText}</p>
                    </div>
                `;
                card.style.display = 'block';
            }

            countValueTypes(obj) {
                return Object.values(obj).reduce((acc, value) => {
                    const type = Array.isArray(value) ? 'array' : value === null ? 'null' : typeof value;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
            }

            addToHistory(result, mapping, time) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    keys: Object.keys(result).length,
                    function: mapping.label,
                    execTime: time,
                    preview: JSON.stringify(result).slice(0, 60) + (JSON.stringify(result).length > 60 ? '...' : '')
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;
                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æ˜ å°„å†å²</p>
                        </div>`;
                    return;
                }
                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.execTime}Î¼s</div>
                        <div class="history-summary">é”®æ•°ï¼š${item.keys} | å‡½æ•°ï¼š${item.function}</div>
                        <div style="color:#64748b;font-size:0.8rem;margin-top:6px;">é¢„è§ˆï¼š${item.preview}</div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                const mostUsed = this.mappingFunctions.find(item => item.value === this.stats.mostUsedFunction)?.label || '-';
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalMappings}</div>
                        <div class="stat-label">æ˜ å°„æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalKeys}</div>
                        <div class="stat-label">ç´¯è®¡å¤„ç†é”®</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.uniqueKeys.size}</div>
                        <div class="stat-label">å”¯ä¸€é”®æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="font-size:1rem;">${mostUsed}</div>
                        <div class="stat-label">æœ€å¸¸ç”¨æ˜ å°„å‡½æ•°</div>
                    </div>
                `;
            }

            showCode(result, mapping, config) {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;
                const source = JSON.stringify(this.originalObject, null, 2);
                const configLines = Object.entries(config)
                    .filter(([, value]) => value !== undefined && value !== '' && value !== null)
                    .map(([key, value]) => `  ${key}: ${JSON.stringify(value)}`)
                    .join(',\n');
                const mappingSource = mapping.handler.toString().replace(/\n/g, '\n  ');
                const code = `const mapValues = (obj, fn) => Object.fromEntries(\n  Object.entries(obj).map(([key, value]) => [key, fn(value, key, obj)])\n);\n\nconst source = ${source};\n\nconst config = {\n${configLines ? configLines : '  // æ— ç‰¹æ®Šå‚æ•°'}\n};\n\nconst handler = ${mappingSource};\n\nconst result = mapValues(source, (value, key, obj) => handler(value, key, obj, config));\n\nconsole.log(result);\n// ${JSON.stringify(result, null, 2)}`;
                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            loadSample() {
                this.originalObject = {
                    price: 129.9,
                    discount: 0.15,
                    status: true,
                    title: 'æ——èˆ°ç‰ˆä¼šå‘˜',
                    tags: ['pro', 'annual'],
                    metadata: { region: 'APAC', currency: 'USD' }
                };
                this.displayOriginalObject();
                this.showNotification('ç¤ºä¾‹å¯¹è±¡å·²åŠ è½½', 'info');
            }

            generateRandom() {
                const count = this.getRandomCount();
                const keysPool = ['price', 'score', 'flag', 'title', 'city', 'tags', 'meta', 'date', 'count', 'level'];
                const randomObj = {};
                for (let i = 0; i < count; i++) {
                    const key = `${keysPool[Math.floor(Math.random() * keysPool.length)]}_${i}`;
                    const type = this.valueTypes[Math.floor(Math.random() * this.valueTypes.length)].value;
                    let value;
                    switch (type) {
                        case 'number':
                            value = Math.round(Math.random() * 1000) / 10;
                            break;
                        case 'boolean':
                            value = Math.random() > 0.5;
                            break;
                        case 'json':
                            value = { id: i, active: Math.random() > 0.5 };
                            break;
                        case 'array':
                            value = ['alpha', 'beta', 'gamma'].sort(() => Math.random() - 0.5).slice(0, 2);
                            break;
                        case 'date':
                            value = new Date(Date.now() - Math.random() * 86400000).toISOString();
                            break;
                        default:
                            value = `value_${i}`;
                    }
                    randomObj[key] = value;
                    this.stats.uniqueKeys.add(key);
                }
                this.originalObject = randomObj;
                this.displayOriginalObject();
                this.showNotification(`å·²ç”Ÿæˆ ${count} ä¸ªéšæœºé”®`, 'info');
            }

            getRandomCount() {
                if (this.plugins.randomCount?.getValue) {
                    return Number(this.plugins.randomCount.getValue() || 5);
                }
                const native = document.getElementById('randomCountNative');
                return native ? Number(native.value || 5) : 5;
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨å¯¹è±¡å€¼æ˜ å°„å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">ğŸ”„</div>
                                <p style="color:#334155;line-height:1.8;">
                                    ä½¿ç”¨ <strong>mapValues</strong> æ‰¹é‡è½¬æ¢å¯¹è±¡ valueï¼Œæ”¯æŒå¤šç§æ˜ å°„å‡½æ•°å’Œå¯è§†åŒ–æµç¨‹ï¼Œè®©æ•°æ®å¤„ç†æ›´åŠ ç›´è§‚ä¸é«˜æ•ˆã€‚
                                </p>
                                <div style="background:#e0f2fe;border-left:4px solid #0ea5e9;padding:12px;border-radius:12px;color:#0c4a6e;">
                                    <strong>äº®ç‚¹ï¼š</strong> å­—æ®µå½•å…¥ã€ç±»å‹é€‰æ‹©ã€æ˜ å°„å‡½æ•°åˆ‡æ¢ã€è½¬æ¢åˆ†æã€ä»£ç é¢„è§ˆã€å†å²è®°å½•ä¸€åº”ä¿±å…¨ã€‚
                                </div>
                                <ul style="color:#0f172a;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>è¦†ç›–æ•°å€¼ç¼©æ”¾ã€å­—ç¬¦ä¸²æ‹¼æ¥ã€å¸ƒå°”è½¬æ¢ã€è„±æ•åŒ…è£…ç­‰å¸¸è§åœºæ™¯</li>
                                    <li>éšæœºç”Ÿæˆ & ç¤ºä¾‹å¯¹è±¡å¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹</li>
                                    <li>ç»Ÿè®¡ä»ªè¡¨ç›˜æŒæ¡è½¬æ¢æ•ˆç‡ä¸å‡½æ•°åå¥½</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.valuesTool = new MapValuesTool();
        });

        if (document.readyState !== 'loading' && !window.valuesTool) {
            window.valuesTool = new MapValuesTool();
        }
    </script>
</body>

</html>