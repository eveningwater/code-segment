<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡½æ•°ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–å¹³å° - memoize</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: white;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.98rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 100px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .result-display {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            margin-bottom: 16px;
        }

        .result-label {
            font-size: 0.9rem;
            color: #4338ca;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #312e81;
            font-family: 'Monaco', 'Menlo', monospace;
            margin-bottom: 16px;
        }

        .result-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4338ca;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .performance-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .performance-card h4 {
            font-size: 1rem;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .performance-card.cached h4 {
            color: #22c55e;
        }

        .performance-time {
            font-size: 2rem;
            font-weight: 800;
            color: #1f2937;
            font-family: 'Monaco', 'Menlo', monospace;
            margin-bottom: 8px;
        }

        .performance-time.cached {
            color: #22c55e;
        }

        .performance-speedup {
            background: #dcfce7;
            color: #15803d;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .cache-display {
            background: #f8fafc;
            border-radius: 14px;
            padding: 16px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .cache-item {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cache-key {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #1f2937;
            flex: 1;
            word-break: break-all;
        }

        .cache-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #22c55e;
            font-weight: 700;
            margin-left: 12px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .comparison-card h4 {
            font-size: 0.95rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .comparison-card p {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #475569;
            margin: 4px 0;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-item.cached {
            border-left-color: #22c55e;
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #1f2937;
        }

        .history-badge {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        .function-selector {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .function-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .function-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .function-option.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .function-name {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .function-desc {
            font-size: 0.85rem;
            color: #64748b;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .performance-comparison {
                grid-template-columns: 1fr;
            }
        }
        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ å‡½æ•°ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–å¹³å°</h1>
            <p>åŸºäº memoize å‡½æ•°çš„ç¼“å­˜æœºåˆ¶æ¼”ç¤ºï¼Œå¯¹æ¯”ç¼“å­˜å‰åçš„æ€§èƒ½å·®å¼‚</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ”§ å‡½æ•°é€‰æ‹©</h2>
                    <div class="function-selector" id="functionSelector"></div>
                </div>

                <div class="card">
                    <h2>ğŸ“ å‚æ•°è¾“å…¥</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label id="inputLabel">è¾“å…¥å‚æ•°</label>
                            <input type="text" id="functionInput" class="input-field" placeholder="è¾“å…¥å‚æ•°å€¼">
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success btn-block" onclick="window.memoizeTool?.executeFunction()">âš¡ æ‰§è¡Œå‡½æ•°</button>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-info" onclick="window.memoizeTool?.loadSample()">ğŸ“„ ç¤ºä¾‹</button>
                            <button class="btn btn-warning" onclick="window.memoizeTool?.clearCache()">ğŸ—‘ï¸ æ¸…ç©ºç¼“å­˜</button>
                            <button class="btn btn-danger" onclick="window.memoizeTool?.clearAll()">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ æ‰§è¡Œå†å² (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æ‰§è¡Œå†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>âœ¨ æ‰§è¡Œç»“æœ</h2>
                    <div class="result-display" id="resultDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡Œå‡½æ•°åå°†åœ¨æ­¤å±•ç¤ºç»“æœ</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="performanceCard" style="display:none;">
                    <h2>âš¡ æ€§èƒ½å¯¹æ¯”</h2>
                    <div class="performance-comparison" id="performanceComparison"></div>
                </div>

                <div class="card" id="cacheCard" style="display:none;">
                    <h2>ğŸ’¾ ç¼“å­˜å†…å®¹ (<span id="cacheSize">0</span>)</h2>
                    <div class="cache-display" id="cacheDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¾</div>
                            <p>ç¼“å­˜ä¸ºç©º</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“Š ç»Ÿè®¡åˆ†æ</h2>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#667eea;margin-bottom:12px;">memoize å‡½æ•°ï¼ˆå‡½æ•°ç¼“å­˜ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const memoize = (fn) => {
  const cache = new Map();
  const cached = (val) =>
    cache.has(val)
      ? cache.get(val)
      : cache.set(val, fn.call(this, val)) && cache.get(val);
  cached.cache = cache;
  return cached;
};</code></pre>
                </div>

                <h3 style="color:#667eea;margin:20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#374151;line-height:1.8;">
                    <strong>memoize</strong> å‡½æ•°ç”¨äºåˆ›å»ºå¸¦ç¼“å­˜çš„å‡½æ•°ï¼Œé€šè¿‡ç¼“å­˜è®¡ç®—ç»“æœæ¥æå‡æ€§èƒ½ã€‚
                    å½“ä½¿ç”¨ç›¸åŒå‚æ•°è°ƒç”¨å‡½æ•°æ—¶ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
                    è¿™å¯¹äºè®¡ç®—å¯†é›†å‹å‡½æ•°ç‰¹åˆ«æœ‰ç”¨ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ã€‚
                </p>

                <h3 style="color:#667eea;margin:20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">// ç¤ºä¾‹ï¼šç¼“å­˜ä¸­ä½æ•°è®¡ç®—å‡½æ•°
const medianCache = memoize(median);
medianCache([5, 6, 50, 1, -5]); // ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè®¡ç®—å¹¶ç¼“å­˜
medianCache([5, 6, 50, 1, -5]); // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œä»ç¼“å­˜è¿”å›

// è®¿é—®ç¼“å­˜
console.log(medianCache.cache); // Map { [5,6,50,1,-5] => 5 }</code></pre>
                </div>

                <h3 style="color:#667eea;margin:20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="badge">é€’å½’å‡½æ•°ä¼˜åŒ–</span>
                    <span class="badge">å¤æ‚è®¡ç®—ç¼“å­˜</span>
                    <span class="badge">API å“åº”ç¼“å­˜</span>
                    <span class="badge">æ€§èƒ½ä¼˜åŒ–</span>
                    <span class="badge">åŠ¨æ€è§„åˆ’</span>
                    <span class="badge">ç®—æ³•å­¦ä¹ </span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const memoize = (fn) => {
            const cache = new Map();
            const cached = (val) =>
                cache.has(val)
                    ? cache.get(val)
                    : cache.set(val, fn.call(this, val)) && cache.get(val);
            cached.cache = cache;
            return cached;
        };

        // è¾…åŠ©å‡½æ•°
        const median = (arr) => {
            // åˆ›å»ºæ•°ç»„å‰¯æœ¬ï¼Œé¿å…ä¿®æ”¹åŸæ•°ç»„
            const sortedArr = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sortedArr.length / 2);
            return sortedArr.length % 2 !== 0
                ? sortedArr[mid]
                : (sortedArr[mid - 1] + sortedArr[mid]) / 2;
        };

        const fibonacci = (n) => {
            if (n <= 1) return n;
            return fibonacci(n - 1) + fibonacci(n - 2);
        };

        const factorial = (n) => {
            if (n <= 1) return 1;
            return n * factorial(n - 1);
        };

        const sum = (arr) => {
            return arr.reduce((a, b) => a + b, 0);
        };

        const power = (base, exp) => {
            return Math.pow(base, exp);
        };

        class MemoizeTool {
            constructor() {
                this.plugins = {};
                this.currentFunction = null;
                this.currentFunctionName = null;
                this.cachedFunction = null;
                this.originalFunction = null;
                this.history = [];
                this.stats = {
                    totalCalls: 0,
                    cacheHits: 0,
                    cacheMisses: 0,
                    totalTimeWithoutCache: 0,
                    totalTimeWithCache: 0
                };
                this.functions = {
                    median: {
                        name: 'median',
                        description: 'è®¡ç®—æ•°ç»„çš„ä¸­ä½æ•°',
                        fn: median,
                        parseInput: (input) => {
                            try {
                                const parsed = JSON.parse(input);
                                return Array.isArray(parsed) ? parsed : [parsed];
                            } catch {
                                return input.split(/[,\s]+/).map(Number).filter(n => !isNaN(n));
                            }
                        },
                        formatInput: (input) => JSON.stringify(input),
                        formatOutput: (output) => output.toString()
                    },
                    fibonacci: {
                        name: 'fibonacci',
                        description: 'è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ n é¡¹ï¼ˆé€’å½’ï¼Œæ…¢ï¼‰',
                        fn: fibonacci,
                        parseInput: (input) => parseInt(input) || 0,
                        formatInput: (input) => input.toString(),
                        formatOutput: (output) => output.toString()
                    },
                    factorial: {
                        name: 'factorial',
                        description: 'è®¡ç®— n çš„é˜¶ä¹˜ï¼ˆé€’å½’ï¼‰',
                        fn: factorial,
                        parseInput: (input) => parseInt(input) || 0,
                        formatInput: (input) => input.toString(),
                        formatOutput: (output) => output.toString()
                    },
                    sum: {
                        name: 'sum',
                        description: 'è®¡ç®—æ•°ç»„æ‰€æœ‰å…ƒç´ çš„å’Œ',
                        fn: sum,
                        parseInput: (input) => {
                            try {
                                const parsed = JSON.parse(input);
                                return Array.isArray(parsed) ? parsed : [parsed];
                            } catch {
                                return input.split(/[,\s]+/).map(Number).filter(n => !isNaN(n));
                            }
                        },
                        formatInput: (input) => JSON.stringify(input),
                        formatOutput: (output) => output.toString()
                    },
                    power: {
                        name: 'power',
                        description: 'è®¡ç®— base çš„ exp æ¬¡å¹‚',
                        fn: power,
                        parseInput: (input) => {
                            try {
                                const parsed = JSON.parse(input);
                                return Array.isArray(parsed) && parsed.length >= 2 ? parsed : [parsed || 2, 2];
                            } catch {
                                const parts = input.split(/[,\s]+/).map(Number);
                                return parts.length >= 2 ? [parts[0], parts[1]] : [parts[0] || 2, parts[1] || 2];
                            }
                        },
                        formatInput: (input) => JSON.stringify(Array.isArray(input) ? input : [input, 2]),
                        formatOutput: (output) => output.toString()
                    }
                };
                this.checkboxOptions = [
                    { id: 'showResult', label: 'æ˜¾ç¤ºæ‰§è¡Œç»“æœ', checked: true },
                    { id: 'showPerformance', label: 'æ˜¾ç¤ºæ€§èƒ½å¯¹æ¯”', checked: true },
                    { id: 'showCache', label: 'æ˜¾ç¤ºç¼“å­˜å†…å®¹', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºç»Ÿè®¡åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºä»£ç é¢„è§ˆ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupFunctionSelector();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupFunctionSelector() {
                const container = document.getElementById('functionSelector');
                if (!container) return;

                Object.keys(this.functions).forEach((key, index) => {
                    const func = this.functions[key];
                    const option = document.createElement('div');
                    option.className = 'function-option' + (index === 0 ? ' selected' : '');
                    option.innerHTML = `
                        <div class="function-name">${func.name}</div>
                        <div class="function-desc">${func.description}</div>
                    `;
                    option.onclick = () => {
                        document.querySelectorAll('.function-option').forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectFunction(key);
                    };
                    container.appendChild(option);
                });

                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå‡½æ•°
                this.selectFunction(Object.keys(this.functions)[0]);
            }

            selectFunction(functionName) {
                this.currentFunctionName = functionName;
                this.currentFunction = this.functions[functionName];
                this.originalFunction = this.currentFunction.fn;
                
                // åˆ›å»ºè‡ªå®šä¹‰çš„ memoize åŒ…è£…å™¨ï¼Œèƒ½å¤Ÿå¤„ç†å‚æ•°è½¬æ¢
                const cache = new Map();
                this.cachedFunction = (inputKey) => {
                    // æ£€æŸ¥ç¼“å­˜
                    if (cache.has(inputKey)) {
                        return cache.get(inputKey);
                    }
                    
                    // å°†å­—ç¬¦ä¸²é”®è½¬æ¢å›å®é™…å‚æ•°ï¼ˆä½¿ç”¨å½“å‰å‡½æ•°çš„ parseInput æ–¹æ³•ï¼‰
                    const actualInput = this.currentFunction.parseInput(inputKey);
                    
                    // è®¡ç®—å¹¶ç¼“å­˜
                    let result;
                    if (functionName === 'power' && Array.isArray(actualInput)) {
                        result = this.originalFunction(actualInput[0], actualInput[1]);
                    } else {
                        result = this.originalFunction(actualInput);
                    }
                    cache.set(inputKey, result);
                    return result;
                };
                this.cachedFunction.cache = cache;

                const inputLabel = document.getElementById('inputLabel');
                const functionInput = document.getElementById('functionInput');
                if (inputLabel) {
                    inputLabel.textContent = functionName === 'power' ? 'è¾“å…¥å‚æ•° (base, exp)' : 'è¾“å…¥å‚æ•°';
                }
                if (functionInput) {
                    functionInput.placeholder = functionName === 'power' 
                        ? '2, 10 æˆ– [2, 10]' 
                        : functionName === 'fibonacci' || functionName === 'factorial'
                        ? 'è¾“å…¥æ•°å­—'
                        : '[1, 2, 3] æˆ– 1,2,3';
                }

                this.updateCacheDisplay();
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: this.checkboxOptions.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    this.checkboxOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            executeFunction() {
                const functionInput = document.getElementById('functionInput');
                if (!functionInput || !this.currentFunction) return;

                const inputStr = functionInput.value.trim();
                if (!inputStr) {
                    this.showError('è¯·è¾“å…¥å‚æ•°');
                    return;
                }

                try {
                    const input = this.currentFunction.parseInput(inputStr);
                    const inputKey = this.currentFunction.formatInput(input);

                    // æ£€æŸ¥ç¼“å­˜
                    const isCached = this.cachedFunction.cache.has(inputKey);
                    
                    // æ‰§è¡Œæ— ç¼“å­˜ç‰ˆæœ¬
                    const startWithoutCache = performance.now();
                    const resultWithoutCache = this.originalFunction(input);
                    const timeWithoutCache = performance.now() - startWithoutCache;

                    // æ‰§è¡Œç¼“å­˜ç‰ˆæœ¬
                    const startWithCache = performance.now();
                    const resultWithCache = this.cachedFunction(inputKey);
                    const timeWithCache = performance.now() - startWithCache;

                    this.stats.totalCalls++;
                    if (isCached) {
                        this.stats.cacheHits++;
                    } else {
                        this.stats.cacheMisses++;
                    }
                    this.stats.totalTimeWithoutCache += timeWithoutCache;
                    this.stats.totalTimeWithCache += timeWithCache;

                    // æ˜¾ç¤ºç»“æœ
                    if (this.getCheckboxValue('showResult')) {
                        this.displayResult(resultWithCache, inputKey);
                    }

                    if (this.getCheckboxValue('showPerformance')) {
                        this.displayPerformance(timeWithoutCache, timeWithCache, isCached);
                    }

                    if (this.getCheckboxValue('showCache')) {
                        this.updateCacheDisplay();
                    }

                    if (this.getCheckboxValue('showAnalysis')) {
                        this.displayAnalysis();
                    }

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode(inputKey, resultWithCache, isCached);
                    }

                    this.addToHistory(inputKey, resultWithCache, timeWithoutCache, timeWithCache, isCached);
                    this.updateStats();

                    const speedup = timeWithoutCache > 0 ? (timeWithoutCache / timeWithCache).toFixed(2) : 'âˆ';
                    this.showNotification(
                        `ç»“æœ: ${this.currentFunction.formatOutput(resultWithCache)} | ` +
                        `æ— ç¼“å­˜: ${timeWithoutCache.toFixed(3)}ms | ` +
                        `æœ‰ç¼“å­˜: ${timeWithCache.toFixed(3)}ms | ` +
                        `åŠ é€Ÿ: ${speedup}x ${isCached ? '(ç¼“å­˜å‘½ä¸­)' : '(ç¼“å­˜æœªå‘½ä¸­)'}`,
                        isCached ? 'success' : 'info'
                    );
                } catch (error) {
                    this.showError('æ‰§è¡Œå¤±è´¥: ' + error.message);
                }
            }

            displayResult(result, inputKey) {
                const container = document.getElementById('resultDisplay');
                if (!container) return;

                container.innerHTML = `
                    <div class="result-card">
                        <div class="result-label">å‡½æ•°ç»“æœ</div>
                        <div class="result-value">${this.currentFunction.formatOutput(result)}</div>
                        <div class="result-info">
                            <div class="info-item">
                                <div class="info-label">å‡½æ•°åç§°</div>
                                <div class="info-value">${this.currentFunctionName}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">è¾“å…¥å‚æ•°</div>
                                <div class="info-value">${inputKey.length > 30 ? inputKey.substring(0, 30) + '...' : inputKey}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ç¼“å­˜çŠ¶æ€</div>
                                <div class="info-value">${this.cachedFunction.cache.has(inputKey) ? 'å·²ç¼“å­˜' : 'æœªç¼“å­˜'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            displayPerformance(timeWithoutCache, timeWithCache, isCached) {
                const card = document.getElementById('performanceCard');
                const container = document.getElementById('performanceComparison');
                if (!card || !container) return;

                const speedup = timeWithoutCache > 0 ? (timeWithoutCache / timeWithCache).toFixed(2) : 'âˆ';
                const improvement = timeWithoutCache > 0 ? ((timeWithoutCache - timeWithCache) / timeWithoutCache * 100).toFixed(1) : '100';

                container.innerHTML = `
                    <div class="performance-card">
                        <h4>ğŸš« æ— ç¼“å­˜ç‰ˆæœ¬</h4>
                        <div class="performance-time">${timeWithoutCache.toFixed(3)} ms</div>
                        <p style="color:#64748b;font-size:0.85rem;">æ¯æ¬¡éƒ½éœ€è¦é‡æ–°è®¡ç®—</p>
                    </div>
                    <div class="performance-card cached">
                        <h4>âœ… ç¼“å­˜ç‰ˆæœ¬</h4>
                        <div class="performance-time cached">${timeWithCache.toFixed(3)} ms</div>
                        <p style="color:#64748b;font-size:0.85rem;">${isCached ? 'ä»ç¼“å­˜è¯»å–' : 'è®¡ç®—å¹¶ç¼“å­˜'}</p>
                        ${isCached ? `<div class="performance-speedup">ğŸš€ åŠ é€Ÿ ${speedup}x (æå‡ ${improvement}%)</div>` : ''}
                    </div>
                `;

                card.style.display = 'block';
            }

            updateCacheDisplay() {
                const card = document.getElementById('cacheCard');
                const container = document.getElementById('cacheDisplay');
                const size = document.getElementById('cacheSize');
                if (!card || !container) return;

                if (size) {
                    size.textContent = this.cachedFunction.cache.size;
                }

                if (!this.getCheckboxValue('showCache')) {
                    card.style.display = 'none';
                    return;
                }

                if (this.cachedFunction.cache.size === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¾</div>
                            <p>ç¼“å­˜ä¸ºç©º</p>
                        </div>
                    `;
                    card.style.display = 'block';
                    return;
                }

                const html = Array.from(this.cachedFunction.cache.entries()).map(([key, value]) => `
                    <div class="cache-item">
                        <div class="cache-key">${key.length > 50 ? key.substring(0, 50) + '...' : key}</div>
                        <div class="cache-value">${this.currentFunction.formatOutput(value)}</div>
                    </div>
                `).join('');

                container.innerHTML = html;
                card.style.display = 'block';
            }

            displayAnalysis() {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('comparisonGrid');
                if (!card || !grid) return;

                const hitRate = this.stats.totalCalls > 0 
                    ? (this.stats.cacheHits / this.stats.totalCalls * 100).toFixed(1) 
                    : '0';
                const avgTimeWithoutCache = this.stats.totalCalls > 0 
                    ? (this.stats.totalTimeWithoutCache / this.stats.totalCalls).toFixed(3)
                    : '0';
                const avgTimeWithCache = this.stats.totalCalls > 0 
                    ? (this.stats.totalTimeWithCache / this.stats.totalCalls).toFixed(3)
                    : '0';
                const avgSpeedup = avgTimeWithCache > 0 && avgTimeWithoutCache > 0
                    ? (avgTimeWithoutCache / avgTimeWithCache).toFixed(2)
                    : '1';

                grid.innerHTML = `
                    <div class="comparison-card">
                        <h4>ğŸ“Š ç¼“å­˜ç»Ÿè®¡</h4>
                        <p>æ€»è°ƒç”¨æ¬¡æ•°: ${this.stats.totalCalls}</p>
                        <p>ç¼“å­˜å‘½ä¸­: ${this.stats.cacheHits}</p>
                        <p>ç¼“å­˜æœªå‘½ä¸­: ${this.stats.cacheMisses}</p>
                        <p>å‘½ä¸­ç‡: ${hitRate}%</p>
                    </div>
                    <div class="comparison-card">
                        <h4>âš¡ æ€§èƒ½ç»Ÿè®¡</h4>
                        <p>å¹³å‡æ— ç¼“å­˜æ—¶é—´: ${avgTimeWithoutCache} ms</p>
                        <p>å¹³å‡ç¼“å­˜æ—¶é—´: ${avgTimeWithCache} ms</p>
                        <p>å¹³å‡åŠ é€Ÿæ¯”: ${avgSpeedup}x</p>
                        <p>ç¼“å­˜å¤§å°: ${this.cachedFunction.cache.size}</p>
                    </div>
                `;

                card.style.display = 'block';
            }

            addToHistory(inputKey, result, timeWithoutCache, timeWithCache, isCached) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    functionName: this.currentFunctionName,
                    input: inputKey,
                    result: this.currentFunction.formatOutput(result),
                    timeWithoutCache: timeWithoutCache.toFixed(3),
                    timeWithCache: timeWithCache.toFixed(3),
                    isCached
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æ‰§è¡Œå†å²</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item ${item.isCached ? 'cached' : ''}">
                        <div class="history-time">${item.time}</div>
                        <div class="history-summary">
                            ${item.functionName}(${item.input.length > 30 ? item.input.substring(0, 30) + '...' : item.input}) = ${item.result}
                            ${item.isCached ? '<span class="history-badge">ç¼“å­˜</span>' : ''}
                        </div>
                        <div style="font-size:0.75rem;color:#64748b;margin-top:4px;">
                            æ— ç¼“å­˜: ${item.timeWithoutCache}ms | ç¼“å­˜: ${item.timeWithCache}ms
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                const hitRate = this.stats.totalCalls > 0 
                    ? (this.stats.cacheHits / this.stats.totalCalls * 100).toFixed(1) 
                    : '0';
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalCalls}</div>
                        <div class="stat-label">æ€»è°ƒç”¨æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.cacheHits}</div>
                        <div class="stat-label">ç¼“å­˜å‘½ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.cacheMisses}</div>
                        <div class="stat-label">ç¼“å­˜æœªå‘½ä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${hitRate}%</div>
                        <div class="stat-label">å‘½ä¸­ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.cachedFunction.cache.size}</div>
                        <div class="stat-label">ç¼“å­˜å¤§å°</div>
                    </div>
                `;
            }

            showCode(inputKey, result, isCached) {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;

                const code = `const memoize = (fn) => {
  const cache = new Map();
  const cached = (val) =>
    cache.has(val)
      ? cache.get(val)
      : cache.set(val, fn.call(this, val)) && cache.get(val);
  cached.cache = cache;
  return cached;
};

// åŸå§‹å‡½æ•°
const ${this.currentFunctionName} = ${this.currentFunction.fn.toString()};

// åˆ›å»ºç¼“å­˜ç‰ˆæœ¬
const ${this.currentFunctionName}Cache = memoize(${this.currentFunctionName});

// æ‰§è¡Œå‡½æ•°
const input = ${this.currentFunction.formatInput === this.functions.median.formatInput ? inputKey : JSON.stringify(inputKey)};
const result = ${this.currentFunctionName}Cache(input);
console.log(result);
// ${result}

// æŸ¥çœ‹ç¼“å­˜
console.log(${this.currentFunctionName}Cache.cache);
// ${isCached ? 'ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥ä»ç¼“å­˜è¿”å›ç»“æœ' : 'ç¼“å­˜æœªå‘½ä¸­ï¼Œè®¡ç®—å¹¶ç¼“å­˜ç»“æœ'}

// è¯´æ˜ï¼š
// - ç¬¬ä¸€æ¬¡è°ƒç”¨: è®¡ç®—å¹¶ç¼“å­˜ç»“æœ
// - åç»­ç›¸åŒå‚æ•°è°ƒç”¨: ç›´æ¥ä»ç¼“å­˜è¿”å›
// - ç¼“å­˜å¤§å°: ${this.cachedFunction.cache.size}
// - å½“å‰ç¼“å­˜å‘½ä¸­: ${isCached ? 'æ˜¯' : 'å¦'}`;

                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            clearCache() {
                this.cachedFunction.cache.clear();
                this.updateCacheDisplay();
                this.updateStats();
                this.showNotification('ç¼“å­˜å·²æ¸…ç©º', 'info');
            }

            clearAll() {
                this.clearCache();
                this.history = [];
                this.stats = {
                    totalCalls: 0,
                    cacheHits: 0,
                    cacheMisses: 0,
                    totalTimeWithoutCache: 0,
                    totalTimeWithCache: 0
                };
                const functionInput = document.getElementById('functionInput');
                if (functionInput) functionInput.value = '';
                this.displayResult(null, '');
                const performanceCard = document.getElementById('performanceCard');
                if (performanceCard) performanceCard.style.display = 'none';
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                this.updateHistoryDisplay();
                this.updateStats();
                this.showNotification('å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®', 'info');
            }

            loadSample() {
                const functionInput = document.getElementById('functionInput');
                if (!functionInput || !this.currentFunction) return;

                const samples = {
                    median: '[5, 6, 50, 1, -5]',
                    fibonacci: '30',
                    factorial: '10',
                    sum: '[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]',
                    power: '2, 10'
                };

                functionInput.value = samples[this.currentFunctionName] || '';
                this.showNotification('ç¤ºä¾‹æ•°æ®å·²åŠ è½½', 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨å‡½æ•°ç¼“å­˜å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">âš¡</div>
                                <p style="color:#1f2937;line-height:1.8;">
                                    ä½¿ç”¨ <strong>memoize</strong> å‡½æ•°åˆ›å»ºå¸¦ç¼“å­˜çš„å‡½æ•°ï¼Œé€šè¿‡ç¼“å­˜è®¡ç®—ç»“æœæ¥æå‡æ€§èƒ½ã€‚
                                    å¯¹æ¯”ç¼“å­˜å‰åçš„æ€§èƒ½å·®å¼‚ï¼Œç›´è§‚äº†è§£ç¼“å­˜æœºåˆ¶çš„ä¼˜åŠ¿ã€‚
                                </p>
                                <div style="background:#e0e7ff;border-left:4px solid #667eea;padding:12px;border-radius:12px;color:#4338ca;margin-top:12px;">
                                    <strong>äº®ç‚¹ï¼š</strong> å¤šç§å‡½æ•°æ”¯æŒã€æ€§èƒ½å¯¹æ¯”ã€ç¼“å­˜å¯è§†åŒ–ã€ç»Ÿè®¡åˆ†æã€ä»£ç é¢„è§ˆã€‚
                                </div>
                                <ul style="color:#1f2937;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>æ”¯æŒå¤šç§å‡½æ•°ç±»å‹ï¼ˆmedianã€fibonacciã€factorialã€sumã€powerï¼‰</li>
                                    <li>å®æ—¶å¯¹æ¯”ç¼“å­˜å‰åçš„æ‰§è¡Œæ—¶é—´</li>
                                    <li>å¯è§†åŒ–å±•ç¤ºç¼“å­˜å†…å®¹å’Œå‘½ä¸­æƒ…å†µ</li>
                                    <li>æä¾›è¯¦ç»†çš„ç»Ÿè®¡åˆ†æå’Œæ€§èƒ½æŒ‡æ ‡</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.memoizeTool = new MemoizeTool();
        });

        if (document.readyState !== 'loading' && !window.memoizeTool) {
            window.memoizeTool = new MemoizeTool();
        }
    </script>
</body>

</html>
