<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ»šåŠ¨é˜…è¯»è¿½è¸ªç³»ç»Ÿ - onScrollStop</title>
    <!-- å¼•å…¥æ’ä»¶æ ·å¼ -->
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.8;
        }

        /* æ»šåŠ¨è¿›åº¦æ¡ */
        .scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            z-index: 10000;
            transition: width 0.1s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .top-nav.hidden {
            transform: translateY(-100%);
        }

        .nav-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 24px 40px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 14px 32px rgba(0, 0, 0, 0.15);
            margin-bottom: 32px;
        }

        .content-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .content-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #64748b;
        }

        .article-content {
            font-size: 1.1rem;
            line-height: 1.9;
            color: #374151;
        }

        .article-content p {
            margin-bottom: 20px;
        }

        .article-content h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1f2937;
            margin: 32px 0 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .article-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #374151;
            margin: 24px 0 12px;
        }

        /* æ‡’åŠ è½½å ä½ç¬¦ */
        .lazy-load-placeholder {
            min-height: 300px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 12px;
            margin: 24px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 1.1rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .lazy-content {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .lazy-content.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* é˜…è¯»ä½ç½®æ ‡è®° */
        .reading-marker {
            position: fixed;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            display: none;
        }

        .reading-marker.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .marker-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .marker-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .marker-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .marker-text {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 14px 32px rgba(0, 0, 0, 0.15);
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
        }

        .settings-group {
            margin-bottom: 24px;
        }

        .settings-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .select-container {
            margin-bottom: 16px;
        }

        .checkbox-container {
            margin-top: 12px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 80px 16px 24px;
            }

            .content-area {
                padding: 24px;
            }

            .stats-panel {
                grid-template-columns: 1fr;
            }

            .nav-actions {
                gap: 8px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .reading-marker {
                right: 12px;
                padding: 12px;
            }
        }

        /* æ»šåŠ¨æç¤º */
        .scroll-hint {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            font-size: 0.9rem;
            color: #374151;
            z-index: 9997;
            display: none;
            animation: bounce 2s infinite;
        }

        .scroll-hint.show {
            display: block;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- æ»šåŠ¨è¿›åº¦æ¡ -->
    <div class="scroll-progress" id="scrollProgress"></div>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-nav" id="topNav">
        <div class="nav-title">ğŸ“– æ»šåŠ¨é˜…è¯»è¿½è¸ªç³»ç»Ÿ</div>
        <div class="nav-actions">
            <button class="btn btn-secondary" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
            <button class="btn btn-primary" id="resetBtn">ğŸ”„ é‡ç½®</button>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-number" id="scrollDistance">0</div>
                <div class="stat-label">æ»šåŠ¨è·ç¦» (px)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-number" id="readingTime">0</div>
                <div class="stat-label">é˜…è¯»æ—¶é•¿ (ç§’)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-number" id="scrollStops">0</div>
                <div class="stat-label">åœæ­¢æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-number" id="scrollProgressPercent">0%</div>
                <div class="stat-label">é˜…è¯»è¿›åº¦</div>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="content-header">
                <h1 class="content-title">æ·±å…¥ç†è§£ JavaScript æ»šåŠ¨äº‹ä»¶ä¼˜åŒ–</h1>
                <div class="content-meta">
                    <span>ğŸ“… 2024å¹´1æœˆ15æ—¥</span>
                    <span>ğŸ‘¤ æŠ€æœ¯ä½œè€…</span>
                    <span>â±ï¸ é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ</span>
                </div>
            </div>
            <div class="article-content" id="articleContent">
                <p>
                    åœ¨ç°ä»£ Web å¼€å‘ä¸­ï¼Œæ»šåŠ¨äº‹ä»¶æ˜¯æœ€å¸¸ç”¨ä½†ä¹Ÿæ˜¯æœ€å®¹æ˜“é€ æˆæ€§èƒ½é—®é¢˜çš„äº¤äº’ä¹‹ä¸€ã€‚
                    æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä¼˜åŒ–æ»šåŠ¨äº‹ä»¶å¤„ç†ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•æ£€æµ‹æ»šåŠ¨åœæ­¢çŠ¶æ€ã€‚
                </p>

                <h2>ä¸ºä»€ä¹ˆéœ€è¦æ£€æµ‹æ»šåŠ¨åœæ­¢ï¼Ÿ</h2>
                <p>
                    æ»šåŠ¨äº‹ä»¶åœ¨ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå¦‚æœæ¯æ¬¡æ»šåŠ¨éƒ½æ‰§è¡Œå¤æ‚çš„æ“ä½œï¼ˆå¦‚ DOM æ“ä½œã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰ï¼Œ
                    ä¼šå¯¼è‡´é¡µé¢å¡é¡¿å’Œæ€§èƒ½é—®é¢˜ã€‚é€šè¿‡æ£€æµ‹æ»šåŠ¨åœæ­¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·åœæ­¢æ»šåŠ¨åå†æ‰§è¡Œè¿™äº›æ“ä½œï¼Œ
                    ä»è€Œæå‡ç”¨æˆ·ä½“éªŒå’Œé¡µé¢æ€§èƒ½ã€‚
                </p>

                <h2>onScrollStop å‡½æ•°å®ç°åŸç†</h2>
                <p>
                    onScrollStop å‡½æ•°çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä½¿ç”¨é˜²æŠ–ï¼ˆdebounceï¼‰æŠ€æœ¯ã€‚å½“æ»šåŠ¨äº‹ä»¶è§¦å‘æ—¶ï¼Œ
                    æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰æ–°çš„æ»šåŠ¨äº‹ä»¶ï¼Œå°±è®¤ä¸ºæ»šåŠ¨å·²åœæ­¢ï¼Œ
                    ç„¶åæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚
                </p>

                <h3>å…³é”®å®ç°æ­¥éª¤ï¼š</h3>
                <p>
                    1. ç›‘å¬ window çš„ scroll äº‹ä»¶<br>
                    2. æ¯æ¬¡æ»šåŠ¨æ—¶æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨<br>
                    3. è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå»¶è¿Ÿæ‰§è¡Œå›è°ƒ<br>
                    4. å¦‚æœå»¶è¿Ÿæ—¶é—´å†…æ²¡æœ‰æ–°çš„æ»šåŠ¨äº‹ä»¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°
                </p>

                <h2>å®é™…åº”ç”¨åœºæ™¯</h2>
                <p>
                    æ»šåŠ¨åœæ­¢æ£€æµ‹åœ¨ä»¥ä¸‹åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼š
                </p>
                <p>
                    â€¢ <strong>é˜…è¯»ä½ç½®ä¿å­˜</strong>ï¼šç”¨æˆ·åœæ­¢æ»šåŠ¨åè‡ªåŠ¨ä¿å­˜é˜…è¯»ä½ç½®ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ç»§ç»­é˜…è¯»<br>
                    â€¢ <strong>æ‡’åŠ è½½å†…å®¹</strong>ï¼šæ»šåŠ¨åœæ­¢ååŠ è½½æ›´å¤šå†…å®¹ï¼Œé¿å…æ»šåŠ¨è¿‡ç¨‹ä¸­çš„é¢‘ç¹è¯·æ±‚<br>
                    â€¢ <strong>ç»Ÿè®¡è¿½è¸ª</strong>ï¼šè®°å½•ç”¨æˆ·çš„é˜…è¯»è¡Œä¸ºå’Œåœç•™æ—¶é—´<br>
                    â€¢ <strong>UI æ›´æ–°</strong>ï¼šæ»šåŠ¨åœæ­¢åæ›´æ–°å¯¼èˆªæ ã€æ˜¾ç¤ºé˜…è¯»è¿›åº¦ç­‰
                </p>

                <!-- æ‡’åŠ è½½å†…å®¹å ä½ç¬¦ -->
                <div class="lazy-load-placeholder" id="lazyContent1">
                    æ­£åœ¨åŠ è½½æ›´å¤šå†…å®¹...
                </div>

                <h2>æ€§èƒ½ä¼˜åŒ–å»ºè®®</h2>
                <p>
                    è™½ç„¶ onScrollStop å·²ç»é€šè¿‡é˜²æŠ–ä¼˜åŒ–äº†æ»šåŠ¨äº‹ä»¶å¤„ç†ï¼Œä½†è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š
                </p>
                <p>
                    â€¢ ä½¿ç”¨ requestAnimationFrame æ¥èŠ‚æµæ»šåŠ¨äº‹ä»¶<br>
                    â€¢ é¿å…åœ¨æ»šåŠ¨å›è°ƒä¸­è¿›è¡Œé‡æ’å’Œé‡ç»˜æ“ä½œ<br>
                    â€¢ ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æ¥å¤„ç†å¤§é‡åˆ—è¡¨æ•°æ®<br>
                    â€¢ åˆç†è®¾ç½®é˜²æŠ–å»¶è¿Ÿæ—¶é—´ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦å’Œæ€§èƒ½
                </p>

                <!-- æ‡’åŠ è½½å†…å®¹å ä½ç¬¦ -->
                <div class="lazy-load-placeholder" id="lazyContent2">
                    æ­£åœ¨åŠ è½½æ›´å¤šå†…å®¹...
                </div>

                <h2>æœ€ä½³å®è·µ</h2>
                <p>
                    åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå»ºè®®å°† onScrollStop å°è£…æˆå¯é…ç½®çš„å·¥å…·å‡½æ•°ï¼Œ
                    æ”¯æŒè‡ªå®šä¹‰å»¶è¿Ÿæ—¶é—´ã€æ˜¯å¦ç«‹å³æ‰§è¡Œç­‰é€‰é¡¹ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œ
                    åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨ã€‚
                </p>

                <p>
                    é€šè¿‡åˆç†ä½¿ç”¨æ»šåŠ¨åœæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—æå‡é¡µé¢çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚
                    å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨æ»šåŠ¨äº‹ä»¶ä¼˜åŒ–æŠ€æœ¯ã€‚
                </p>

                <!-- æ‡’åŠ è½½å†…å®¹å ä½ç¬¦ -->
                <div class="lazy-load-placeholder" id="lazyContent3">
                    æ­£åœ¨åŠ è½½æ›´å¤šå†…å®¹...
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel" style="display: none;">
            <h2 class="settings-title">âš™ï¸ é˜…è¯»è®¾ç½®</h2>
            <div class="settings-group">
                <label class="settings-label">è‡ªåŠ¨ä¿å­˜é˜…è¯»ä½ç½®</label>
                <div id="autoSaveCheckbox" class="checkbox-container"></div>
            </div>
            <div class="settings-group">
                <label class="settings-label">æ»šåŠ¨åœæ­¢å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)</label>
                <div id="delaySelect" class="select-container"></div>
            </div>
            <div class="settings-group">
                <label class="settings-label">æ˜¾ç¤ºé˜…è¯»æ ‡è®°</label>
                <div id="showMarkerCheckbox" class="checkbox-container"></div>
            </div>
            <div class="settings-group">
                <label class="settings-label">è‡ªåŠ¨éšè—å¯¼èˆªæ </label>
                <div id="autoHideNavCheckbox" class="checkbox-container"></div>
            </div>
        </div>
    </div>

    <!-- é˜…è¯»ä½ç½®æ ‡è®° -->
    <div class="reading-marker" id="readingMarker">
        <div class="marker-title">é˜…è¯»è¿›åº¦</div>
        <div class="marker-progress">
            <div class="marker-progress-bar" id="markerProgressBar"></div>
        </div>
        <div class="marker-text" id="markerText">0%</div>
    </div>

    <!-- æ»šåŠ¨æç¤º -->
    <div class="scroll-hint" id="scrollHint">
        ğŸ‘† å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹æ›´å¤šå†…å®¹
    </div>

    <!-- å¼•å…¥æ’ä»¶è„šæœ¬ -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>

    <script>
        // onScrollStop å‡½æ•°ï¼šæ£€æµ‹æ»šåŠ¨åœæ­¢
        const onScrollStop = (callback, n = 150) => {
            let timer, isScrolling = false;
            window.addEventListener('scroll', e => {
                if (timer) {
            clearTimeout(timer);
        }
        timer = setTimeout(() => {
            isScrolling = true;
                    callback?.(e, isScrolling);
                }, n);
            }, false);
        };

        // æ»šåŠ¨é˜…è¯»è¿½è¸ªç³»ç»Ÿ
        class ScrollReadingTracker {
            constructor() {
                this.plugins = {};
                this.stats = {
                    scrollDistance: 0,
                    readingTime: 0,
                    scrollStops: 0,
                    startTime: Date.now(),
                    lastScrollTop: 0
                };
                this.settings = {
                    autoSave: true,
                    delay: 150,
                    showMarker: true,
                    autoHideNav: true
                };
                this.readingPosition = 0;
                this.scrollTimer = null;
                this.readingTimer = null;
                this.lazyLoaded = new Set();
                
                this.init();
            }

            async init() {
                await this.loadPlugins();
                this.loadSettings();
                this.setupUI();
                this.setupScrollTracking();
                this.setupLazyLoading();
                this.startReadingTimer();
                this.restoreReadingPosition();
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification({
                        position: 'top-right',
                        duration: 3000
                    });
                } catch (error) {
                    console.warn('æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('scrollReadingSettings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.warn('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                }
            }

            saveSettings() {
                try {
                    localStorage.setItem('scrollReadingSettings', JSON.stringify(this.settings));
                } catch (error) {
                    console.warn('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                }
            }

            setupUI() {
                // è®¾ç½®æŒ‰é’®
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        this.toggleSettings();
                    });
                }

                // é‡ç½®æŒ‰é’®
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        this.resetStats();
                    });
                }

                // è®¾ç½®é¢æ¿
                this.setupSettingsPanel();
            }

            setupSettingsPanel() {
                const panel = document.getElementById('settingsPanel');
                if (!panel) return;

                // è‡ªåŠ¨ä¿å­˜å¤é€‰æ¡†
                const autoSaveContainer = document.getElementById('autoSaveCheckbox');
                if (autoSaveContainer) {
                    const autoSaveCheckbox = new Checkbox({
                        label: 'æ»šåŠ¨åœæ­¢åè‡ªåŠ¨ä¿å­˜é˜…è¯»ä½ç½®',
                        checked: this.settings.autoSave
                    });
                    autoSaveCheckbox.mount(autoSaveContainer);
                    autoSaveCheckbox.element.querySelector('.checkbox-input').addEventListener('change', (e) => {
                        this.settings.autoSave = e.target.checked;
                        this.saveSettings();
                    });
                }

                // å»¶è¿Ÿæ—¶é—´é€‰æ‹©å™¨
                const delayContainer = document.getElementById('delaySelect');
                if (delayContainer) {
                    this.plugins.delaySelect = new Select({
                        container: delayContainer,
                        options: [
                            { value: '100', label: '100 æ¯«ç§’ (å¿«é€Ÿ)' },
                            { value: '150', label: '150 æ¯«ç§’ (é»˜è®¤)' },
                            { value: '200', label: '200 æ¯«ç§’ (æ ‡å‡†)' },
                            { value: '300', label: '300 æ¯«ç§’ (æ…¢é€Ÿ)' },
                            { value: '500', label: '500 æ¯«ç§’ (å¾ˆæ…¢)' }
                        ],
                        placeholder: 'é€‰æ‹©å»¶è¿Ÿæ—¶é—´',
                        onChange: (value) => {
                            this.settings.delay = parseInt(value);
                            this.saveSettings();
                            this.setupScrollTracking(); // é‡æ–°è®¾ç½®æ»šåŠ¨è¿½è¸ª
                        }
                    });
                    this.plugins.delaySelect.setValue(this.settings.delay.toString());
                }

                // æ˜¾ç¤ºæ ‡è®°å¤é€‰æ¡†
                const showMarkerContainer = document.getElementById('showMarkerCheckbox');
                if (showMarkerContainer) {
                    const showMarkerCheckbox = new Checkbox({
                        label: 'æ˜¾ç¤ºé˜…è¯»è¿›åº¦æ ‡è®°',
                        checked: this.settings.showMarker
                    });
                    showMarkerCheckbox.mount(showMarkerContainer);
                    showMarkerCheckbox.element.querySelector('.checkbox-input').addEventListener('change', (e) => {
                        this.settings.showMarker = e.target.checked;
                        this.saveSettings();
                        this.updateMarkerVisibility();
                    });
                }

                // è‡ªåŠ¨éšè—å¯¼èˆªæ å¤é€‰æ¡†
                const autoHideNavContainer = document.getElementById('autoHideNavCheckbox');
                if (autoHideNavContainer) {
                    const autoHideNavCheckbox = new Checkbox({
                        label: 'å‘ä¸‹æ»šåŠ¨æ—¶è‡ªåŠ¨éšè—å¯¼èˆªæ ',
                        checked: this.settings.autoHideNav
                    });
                    autoHideNavCheckbox.mount(autoHideNavContainer);
                    autoHideNavCheckbox.element.querySelector('.checkbox-input').addEventListener('change', (e) => {
                        this.settings.autoHideNav = e.target.checked;
                        this.saveSettings();
                    });
                }
            }

            toggleSettings() {
                const panel = document.getElementById('settingsPanel');
                if (panel) {
                    const isVisible = panel.style.display !== 'none';
                    panel.style.display = isVisible ? 'none' : 'block';
                }
            }

            setupScrollTracking() {
                // ç§»é™¤æ—§çš„æ»šåŠ¨ç›‘å¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                // æ³¨æ„ï¼šç”±äº onScrollStop å†…éƒ¨ä½¿ç”¨äº† addEventListenerï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°åˆ›å»º
                
                // æ»šåŠ¨è¿›åº¦æ¡
                let lastScrollTop = 0;
                window.addEventListener('scroll', () => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                    const scrollPercent = (scrollTop / scrollHeight) * 100;

                    // æ›´æ–°è¿›åº¦æ¡
                    const progressBar = document.getElementById('scrollProgress');
                    if (progressBar) {
                        progressBar.style.width = `${Math.min(scrollPercent, 100)}%`;
                    }

                    // æ›´æ–°ç»Ÿè®¡
                    const distance = Math.abs(scrollTop - lastScrollTop);
                    this.stats.scrollDistance += distance;
                    lastScrollTop = scrollTop;
                    this.updateStats();

                    // æ›´æ–°é˜…è¯»è¿›åº¦
                    this.updateReadingProgress(scrollPercent);

                    // è‡ªåŠ¨éšè—å¯¼èˆªæ 
                    if (this.settings.autoHideNav) {
                        const topNav = document.getElementById('topNav');
                        if (topNav) {
                            if (scrollTop > lastScrollTop && scrollTop > 100) {
                                topNav.classList.add('hidden');
                            } else {
                                topNav.classList.remove('hidden');
                            }
                        }
                    }

                    // æ˜¾ç¤º/éšè—æ»šåŠ¨æç¤º
                    const scrollHint = document.getElementById('scrollHint');
                    if (scrollHint) {
                        if (scrollTop < 100) {
                            scrollHint.classList.add('show');
                        } else {
                            scrollHint.classList.remove('show');
                        }
                    }
                });

                // ä½¿ç”¨ onScrollStop æ£€æµ‹æ»šåŠ¨åœæ­¢
                onScrollStop((e, isScrolling) => {
                    if (isScrolling) {
                        this.handleScrollStop();
                    }
                }, this.settings.delay);
            }

            handleScrollStop() {
                this.stats.scrollStops++;
                this.updateStats();

                // ä¿å­˜é˜…è¯»ä½ç½®
                if (this.settings.autoSave) {
                    this.saveReadingPosition();
                    this.plugins.notification?.show('é˜…è¯»ä½ç½®å·²è‡ªåŠ¨ä¿å­˜', 'success');
                }

                // è§¦å‘æ‡’åŠ è½½
                this.checkLazyLoading();
            }

            updateReadingProgress(percent) {
                const marker = document.getElementById('readingMarker');
                const markerBar = document.getElementById('markerProgressBar');
                const markerText = document.getElementById('markerText');

                if (markerBar) {
                    markerBar.style.width = `${percent}%`;
                }
                if (markerText) {
                    markerText.textContent = `${Math.round(percent)}%`;
                }

                if (this.settings.showMarker && marker) {
                    if (percent > 5) {
                        marker.classList.add('show');
                    } else {
                        marker.classList.remove('show');
                    }
                }
            }

            updateMarkerVisibility() {
                const marker = document.getElementById('readingMarker');
                if (marker) {
                    if (this.settings.showMarker) {
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                        const scrollPercent = (scrollTop / scrollHeight) * 100;
                        if (scrollPercent > 5) {
                            marker.classList.add('show');
                        }
                    } else {
                        marker.classList.remove('show');
                    }
                }
            }

            setupLazyLoading() {
                // åˆå§‹æ£€æŸ¥
                this.checkLazyLoading();

                // æ»šåŠ¨æ—¶æ£€æŸ¥
                window.addEventListener('scroll', () => {
                    this.checkLazyLoading();
                });
            }

            checkLazyLoading() {
                const lazyElements = ['lazyContent1', 'lazyContent2', 'lazyContent3'];
                
                lazyElements.forEach((id, index) => {
                    if (this.lazyLoaded.has(id)) return;

                    const element = document.getElementById(id);
                    if (!element) return;

                    const rect = element.getBoundingClientRect();
                    const isVisible = rect.top < window.innerHeight + 200;

                    if (isVisible) {
                        this.loadLazyContent(id, index);
                    }
                });
            }

            loadLazyContent(id, index) {
                if (this.lazyLoaded.has(id)) return;
                this.lazyLoaded.add(id);

                const element = document.getElementById(id);
                if (!element) return;

                // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
                setTimeout(() => {
                    const contents = [
                        {
                            title: 'ä»£ç ç¤ºä¾‹',
                            content: `
                                <h3>onScrollStop ä½¿ç”¨ç¤ºä¾‹</h3>
                                <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto;"><code>onScrollStop(() => {
  console.log('ç”¨æˆ·å·²åœæ­¢æ»šåŠ¨');
  // æ‰§è¡Œä½ çš„æ“ä½œ
}, 150);</code></pre>
                                <p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨ç”¨æˆ·åœæ­¢æ»šåŠ¨ 150 æ¯«ç§’åæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</p>
                            `
                        },
                        {
                            title: 'æ€§èƒ½å¯¹æ¯”',
                            content: `
                                <h3>ä¼˜åŒ–å‰åå¯¹æ¯”</h3>
                                <p><strong>ä¼˜åŒ–å‰ï¼š</strong>æ¯æ¬¡æ»šåŠ¨éƒ½æ‰§è¡Œæ“ä½œï¼Œå¯èƒ½å¯¼è‡´é¡µé¢å¡é¡¿</p>
                                <p><strong>ä¼˜åŒ–åï¼š</strong>åªåœ¨æ»šåŠ¨åœæ­¢åæ‰§è¡Œï¼Œæ€§èƒ½æå‡ 60%+</p>
                                <p>é€šè¿‡é˜²æŠ–æŠ€æœ¯ï¼Œæˆ‘ä»¬æˆåŠŸå‡å°‘äº†ä¸å¿…è¦çš„è®¡ç®—å’Œ DOM æ“ä½œã€‚</p>
                            `
                        },
                        {
                            title: 'æ€»ç»“',
                            content: `
                                <h3>å…³é”®è¦ç‚¹</h3>
                                <ul style="padding-left: 24px;">
                                    <li>ä½¿ç”¨é˜²æŠ–æŠ€æœ¯ä¼˜åŒ–æ»šåŠ¨äº‹ä»¶</li>
                                    <li>åˆç†è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦å’Œæ€§èƒ½</li>
                                    <li>åœ¨æ»šåŠ¨åœæ­¢åæ‰§è¡Œè€—æ—¶æ“ä½œ</li>
                                    <li>åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
                                </ul>
                            `
                        }
                    ];

                    const content = contents[index];
                    if (content) {
                        element.className = 'lazy-content loaded';
                        element.innerHTML = `
                            <div style="background: #f8fafc; padding: 24px; border-radius: 12px; border-left: 4px solid #667eea;">
                                <h3 style="color: #667eea; margin-bottom: 16px;">${content.title}</h3>
                                ${content.content}
                            </div>
                        `;
                    }
                }, 800);
            }

            updateStats() {
                const scrollDistanceEl = document.getElementById('scrollDistance');
                const readingTimeEl = document.getElementById('readingTime');
                const scrollStopsEl = document.getElementById('scrollStops');
                const scrollProgressEl = document.getElementById('scrollProgressPercent');

                if (scrollDistanceEl) {
                    scrollDistanceEl.textContent = Math.round(this.stats.scrollDistance).toLocaleString();
                }
                if (scrollStopsEl) {
                    scrollStopsEl.textContent = this.stats.scrollStops;
                }

                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = (scrollTop / scrollHeight) * 100;

                if (scrollProgressEl) {
                    scrollProgressEl.textContent = `${Math.round(scrollPercent)}%`;
                }
            }

            startReadingTimer() {
                this.readingTimer = setInterval(() => {
                    this.stats.readingTime = Math.floor((Date.now() - this.stats.startTime) / 1000);
                    const readingTimeEl = document.getElementById('readingTime');
                    if (readingTimeEl) {
                        readingTimeEl.textContent = this.stats.readingTime;
                    }
                }, 1000);
            }

            saveReadingPosition() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                this.readingPosition = scrollTop;
                try {
                    localStorage.setItem('scrollReadingPosition', scrollTop.toString());
                } catch (error) {
                    console.warn('ä¿å­˜é˜…è¯»ä½ç½®å¤±è´¥:', error);
                }
            }

            restoreReadingPosition() {
                try {
                    const saved = localStorage.getItem('scrollReadingPosition');
                    if (saved && this.settings.autoSave) {
                        const position = parseInt(saved);
                        if (position > 0) {
                            setTimeout(() => {
                                window.scrollTo({
                                    top: position,
                                    behavior: 'smooth'
                                });
                                this.plugins.notification?.show('å·²æ¢å¤ä¸Šæ¬¡é˜…è¯»ä½ç½®', 'info');
                            }, 500);
                        }
                    }
                } catch (error) {
                    console.warn('æ¢å¤é˜…è¯»ä½ç½®å¤±è´¥:', error);
                }
            }

            resetStats() {
                this.plugins.modal?.confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ').then(confirmed => {
                    if (confirmed) {
                        this.stats = {
                            scrollDistance: 0,
                            readingTime: 0,
                            scrollStops: 0,
                            startTime: Date.now(),
                            lastScrollTop: 0
                        };
                        this.updateStats();
                        this.plugins.notification?.show('ç»Ÿè®¡æ•°æ®å·²é‡ç½®', 'success');
                    }
                });
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.scrollTracker = new ScrollReadingTracker();
        });

        if (document.readyState !== 'loading' && !window.scrollTracker) {
            window.scrollTracker = new ScrollReadingTracker();
}
    </script>
</body>
</html>