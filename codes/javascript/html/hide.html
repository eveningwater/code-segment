<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片画廊管理系统 - 基于 hide 函数</title>
    <!-- 引入自定义插件 -->
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 193, 7, 0.3);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .gallery-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .gallery-item {
            border: 2px solid #e9ecef;
            background: linear-gradient(135deg, #9495e9 10%, #3d35e2 90%);
            border-radius: 12px;
            width: 280px;
            height: 280px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .gallery-item.hidden {
            background: linear-gradient(135deg, #f8f9fa 10%, #e9ecef 90%);
        }

        .gallery-item.hidden .gallery-item-img {
            opacity: 0;
        }

        .gallery-item-img {
            object-fit: cover;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .gallery-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gallery-item.hidden .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-overlay::after {
            content: attr(data-text);
        }

        .gallery-item-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gallery-item:hover .gallery-item-actions {
            opacity: 1;
        }

        .action-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-btn-hide {
            background: #dc3545;
            color: white;
        }

        .action-btn-show {
            background: #28a745;
            color: white;
        }

        .action-btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .gallery-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 15px;
            font-size: 14px;
        }

        .gallery-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .gallery-item-category {
            opacity: 0.8;
            font-size: 12px;
        }

        .filters {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .plugin-container {
            position: relative;
        }

        .bulk-actions {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .bulk-actions-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .select-all-checkbox {
            margin-right: 10px;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .plugin-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .gallery-container {
                justify-content: center;
            }
            
            .gallery-item {
                width: 100%;
                max-width: 300px;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🖼️ 图片画廊管理系统</h1>
            <p>基于 hide 函数的图片展示与控制工具</p>
        </div>

        <div class="main-content">
            <!-- 控制按钮 -->
            <div class="controls">
                <button class="btn btn-primary" onclick="showAddImageModal()">
                    ➕ 添加图片
                </button>
                <button class="btn btn-success" onclick="showCategoryManager()">
                    📂 分类管理
                </button>
                <button class="btn btn-warning" onclick="showBulkOperations()">
                    🔧 批量操作
                </button>
                <button class="btn btn-secondary" onclick="showGallerySettings()">
                    ⚙️ 画廊设置
                </button>
                <button class="btn btn-danger" onclick="resetGallery()">
                    🔄 重置画廊
                </button>
            </div>

            <!-- 统计信息 -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalImages">0</div>
                    <div class="stat-label">总图片数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="visibleImages">0</div>
                    <div class="stat-label">可见图片</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="hiddenImages">0</div>
                    <div class="stat-label">隐藏图片</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="categories">0</div>
                    <div class="stat-label">分类数量</div>
                </div>
            </div>

            <!-- 筛选器 -->
            <div class="filters">
                <h3>🔍 筛选与搜索</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">分类筛选</label>
                        <div class="plugin-container">
                            <div id="categoryFilter"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">显示状态</label>
                        <div class="plugin-container">
                            <div id="statusFilter"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">搜索图片</label>
                        <input type="text" class="filter-input" id="searchInput" placeholder="输入图片标题或描述...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">排序方式</label>
                        <div class="plugin-container">
                            <div id="sortFilter"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 批量操作 -->
            <div class="bulk-actions">
                            <div class="bulk-actions-header">
                <div class="plugin-container">
                    <div id="selectAllCheckbox"></div>
                </div>
                <span>全选</span>
                <span id="selectedCount">(0 个已选择)</span>
            </div>
                <div class="bulk-actions-buttons">
                    <button class="btn btn-success" onclick="bulkShow()">显示选中</button>
                    <button class="btn btn-danger" onclick="bulkHide()">隐藏选中</button>
                    <button class="btn btn-warning" onclick="bulkEdit()">批量编辑</button>
                    <button class="btn btn-secondary" onclick="bulkDelete()">删除选中</button>
                </div>
            </div>

            <!-- 图片画廊 -->
            <div class="gallery-container" id="galleryContainer">
                <!-- 图片将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>

    <script>
        // 核心 hide 函数 - 用于隐藏 DOM 元素
        // 设计逻辑：
        // 1. 单个图片隐藏：只隐藏 img 元素，保持卡片可见以便切换
        // 2. 批量隐藏：隐藏选中图片的 img 元素
        // 3. 筛选器：隐藏不符合条件的整个卡片
        // 4. 重置/删除：隐藏整个卡片
        const hide = (...elements) => elements.forEach(el => el.style.display = 'none');

        // 图片画廊管理类
        class GalleryManager {
            constructor() {
                this.images = [];
                this.categories = ['风景', '人物', '动物', '建筑', '抽象', '其他'];
                this.selectedImages = new Set();
                this.filters = {
                    category: 'all',
                    status: 'all',
                    search: '',
                    sort: 'name'
                };
                this.BASE_URL = "https://www.eveningwater.com/my-web-projects/jQuery/7/img/";
                this.init();
            }

            init() {
                this.loadDefaultImages();
                this.setupEventListeners();
                this.updateStats();
                this.initFilters();
            }

            // 加载默认图片
            loadDefaultImages() {
            for (let i = 0; i < 10; i++) {
                    this.images.push({
                        id: i + 1,
                        title: `图片 ${i + 1}`,
                        description: `这是第 ${i + 1} 张图片的描述`,
                        category: this.categories[i % this.categories.length],
                        url: `${this.BASE_URL}${i + 1}.jpg`,
                        visible: i < 2, // 前两张可见，其余隐藏
                        createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
                    });
                }
                this.renderGallery();
            }

            // 设置事件监听器
            setupEventListeners() {
                // 搜索输入
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filters.search = e.target.value;
                    this.applyFilters();
                });
            }

            // 初始化筛选器
            initFilters() {
                setTimeout(() => {
                    // 全选复选框
                    const selectAllCheckbox = new Checkbox({
                        label: '全选'
                    });
                    selectAllCheckbox.onChange = (checked) => {
                        this.toggleSelectAll(checked);
                    };
                    selectAllCheckbox.mount('#selectAllCheckbox');
                    window.selectAllCheckbox = selectAllCheckbox;

                    // 分类筛选
                    const categoryFilter = new Select({
                        container: '#categoryFilter',
                        options: [
                            { value: 'all', label: '全部分类' },
                            ...this.categories.map(cat => ({ value: cat, label: cat }))
                        ],
                        placeholder: '选择分类'
                    });
                    categoryFilter.setValue('all');
                    categoryFilter.onChange = (value) => {
                        this.filters.category = value;
                        this.applyFilters();
                    };
                    window.categoryFilter = categoryFilter;

                    // 状态筛选
                    const statusFilter = new Select({
                        container: '#statusFilter',
                        options: [
                            { value: 'all', label: '全部状态' },
                            { value: 'visible', label: '可见' },
                            { value: 'hidden', label: '隐藏' }
                        ],
                        placeholder: '选择状态'
                    });
                    statusFilter.setValue('all');
                    statusFilter.onChange = (value) => {
                        this.filters.status = value;
                        this.applyFilters();
                    };

                    // 排序筛选
                    const sortFilter = new Select({
                        container: '#sortFilter',
                        options: [
                            { value: 'name', label: '按名称排序' },
                            { value: 'date', label: '按日期排序' },
                            { value: 'category', label: '按分类排序' }
                        ],
                        placeholder: '选择排序'
                    });
                    sortFilter.setValue('name');
                    sortFilter.onChange = (value) => {
                        this.filters.sort = value;
                        this.applyFilters();
                    };
                }, 100);
            }

            // 渲染画廊
            renderGallery() {
                const container = document.getElementById('galleryContainer');
                container.innerHTML = '';

                this.images.forEach(image => {
                    const item = document.createElement('div');
                    item.className = `gallery-item ${image.visible ? '' : 'hidden'}`;
                    item.dataset.id = image.id;

                    item.innerHTML = `
                        <img class="gallery-item-img" src="${image.url}" alt="${image.title}">
                        <div class="gallery-item-overlay" data-text="已隐藏"></div>
                        <div class="gallery-item-actions">
                            ${image.visible ? 
                                `<button class="action-btn action-btn-hide" onclick="galleryManager.hideImage(${image.id})">👁️</button>` :
                                `<button class="action-btn action-btn-show" onclick="galleryManager.showImage(${image.id})">👁️‍🗨️</button>`
                            }
                            <button class="action-btn action-btn-edit" onclick="galleryManager.editImage(${image.id})">✏️</button>
                        </div>
                        <div class="gallery-item-info">
                            <div class="gallery-item-title">${image.title}</div>
                            <div class="gallery-item-category">${image.category}</div>
                        </div>
                    `;

                    // 添加选择功能
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('action-btn')) {
                            this.toggleImageSelection(image.id);
                        }
                    });

                    container.appendChild(item);
                });

                this.updateStats();
            }

            // 隐藏图片
            hideImage(id) {
                const image = this.images.find(img => img.id === id);
                if (image) {
                    image.visible = false;
                    
                    // 获取对应的 DOM 元素
                    const element = document.querySelector(`[data-id="${id}"]`);
                    if (element) {
                        // 隐藏图片元素
                        const imgElement = element.querySelector('.gallery-item-img');
                        if (imgElement) {
                            hide(imgElement);
                        }
                        
                        // 显示占位背景和隐藏提示
                        element.classList.add('hidden');
                        
                        // 更新按钮状态
                        this.updateImageButton(element, image);
                    }
                    
                    // 更新统计信息
                    this.updateStats();
                    notification.show(`图片 "${image.title}" 已隐藏`, 'success');
                }
            }

            // 显示图片
            showImage(id) {
                const image = this.images.find(img => img.id === id);
                if (image) {
                    image.visible = true;
                    
                    // 获取对应的 DOM 元素
                    const element = document.querySelector(`[data-id="${id}"]`);
                    if (element) {
                        // 显示图片元素
                        const imgElement = element.querySelector('.gallery-item-img');
                        if (imgElement) {
                            imgElement.style.display = 'block';
                        }
                        
                        // 移除隐藏状态
                        element.classList.remove('hidden');
                        
                        // 更新按钮状态
                        this.updateImageButton(element, image);
                    }
                    
                    // 更新统计信息
                    this.updateStats();
                    notification.show(`图片 "${image.title}" 已显示`, 'success');
                }
            }

            // 更新图片按钮状态
            updateImageButton(element, image) {
                const actionsContainer = element.querySelector('.gallery-item-actions');
                if (actionsContainer) {
                    const toggleButton = actionsContainer.querySelector('.action-btn-hide, .action-btn-show');
                    if (toggleButton) {
                        if (image.visible) {
                            // 当前是显示状态，按钮应该是隐藏按钮
                            toggleButton.className = 'action-btn action-btn-hide';
                            toggleButton.innerHTML = '👁️';
                            toggleButton.onclick = () => this.hideImage(image.id);
                        } else {
                            // 当前是隐藏状态，按钮应该是显示按钮
                            toggleButton.className = 'action-btn action-btn-show';
                            toggleButton.innerHTML = '👁️‍🗨️';
                            toggleButton.onclick = () => this.showImage(image.id);
                        }
                    }
                }
            }

            // 编辑图片
            editImage(id) {
                const image = this.images.find(img => img.id === id);
                if (!image) return;

                const modalContent = `
                    <div class="modal-body">
                        <form id="editImageForm">
                            <div class="form-group">
                                <label class="form-label">图片标题</label>
                                <input type="text" class="form-input" id="editTitle" value="${image.title}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">图片描述</label>
                                <textarea class="form-textarea" id="editDescription">${image.description}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="plugin-label">分类</label>
                                <div class="plugin-container">
                                    <div id="editCategory"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">图片URL</label>
                                <input type="text" class="form-input" id="editUrl" value="${image.url}">
                            </div>
                        </form>
                    </div>
                `;

                modal.show({
                    title: '编辑图片',
                    content: modalContent,
                    width: '600px',
                    onConfirm: () => {
                        this.saveImageEdit(id);
                    }
                });

                // 初始化分类选择器
                setTimeout(() => {
                    const editCategory = new Select({
                        container: '#editCategory',
                        options: this.categories.map(cat => ({ value: cat, label: cat })),
                        placeholder: '选择分类'
                    });
                    editCategory.setValue(image.category);
                    window.editCategory = editCategory;
                }, 100);
            }

            // 保存图片编辑
            saveImageEdit(id) {
                const image = this.images.find(img => img.id === id);
                if (!image) return;

                image.title = document.getElementById('editTitle').value;
                image.description = document.getElementById('editDescription').value;
                image.category = window.editCategory.getValue();
                image.url = document.getElementById('editUrl').value;

                this.renderGallery();
                notification.show(`图片 "${image.title}" 已更新`, 'success');
                modal.hide();
            }

            // 切换图片选择状态
            toggleImageSelection(id) {
                if (this.selectedImages.has(id)) {
                    this.selectedImages.delete(id);
                } else {
                    this.selectedImages.add(id);
                }
                this.updateSelectionUI();
            }

            // 全选/取消全选
            toggleSelectAll(checked) {
                if (checked) {
                    this.images.forEach(img => this.selectedImages.add(img.id));
                } else {
                    this.selectedImages.clear();
                }
                this.updateSelectionUI(true); // 传入 true 表示不更新 checkbox 状态
            }

            // 更新选择UI
            updateSelectionUI(skipCheckboxUpdate = false) {
                const selectedCount = document.getElementById('selectedCount');
                
                selectedCount.textContent = `(${this.selectedImages.size} 个已选择)`;
                
                // 如果跳过 checkbox 更新，则直接返回
                if (skipCheckboxUpdate) {
                    return;
                }
                
                // 更新全选复选框状态
                const visibleImages = this.images.filter(img => 
                    this.isImageVisible(img) && 
                    (this.filters.category === 'all' || img.category === this.filters.category) &&
                    (this.filters.status === 'all' || 
                     (this.filters.status === 'visible' && img.visible) ||
                     (this.filters.status === 'hidden' && !img.visible))
                );
                
                if (window.selectAllCheckbox) {
                    const allSelected = visibleImages.length > 0 && 
                        visibleImages.every(img => this.selectedImages.has(img.id));
                    const someSelected = visibleImages.length > 0 && 
                        this.selectedImages.size > 0 && 
                        this.selectedImages.size < visibleImages.length;
                    
                    if (allSelected) {
                        window.selectAllCheckbox.setChecked(true);
                    } else if (someSelected) {
                        // 对于自定义checkbox，我们设置为false但可以通过样式表示部分选中状态
                        window.selectAllCheckbox.setChecked(false);
                    } else {
                        window.selectAllCheckbox.setChecked(false);
                    }
                }
            }

            // 应用筛选器
            applyFilters() {
                const container = document.getElementById('galleryContainer');
                const items = container.querySelectorAll('.gallery-item');

                items.forEach(item => {
                    const imageId = parseInt(item.dataset.id);
                    const image = this.images.find(img => img.id === imageId);
                    
                    if (this.isImageVisible(image)) {
                        // 显示整个卡片
                        item.style.display = 'block';
                        // 确保图片可见
                        const imgElement = item.querySelector('.gallery-item-img');
                        if (imgElement) {
                            imgElement.style.display = 'block';
                        }
                    } else {
                        // 隐藏整个卡片（因为不符合筛选条件）
                        hide(item);
                    }
                });

                this.updateSelectionUI();
            }

            // 检查图片是否应该显示
            isImageVisible(image) {
                // 分类筛选
                if (this.filters.category !== 'all' && image.category !== this.filters.category) {
                    return false;
                }

                // 状态筛选
                if (this.filters.status === 'visible' && !image.visible) {
                    return false;
                }
                if (this.filters.status === 'hidden' && image.visible) {
                    return false;
                }

                // 搜索筛选
                if (this.filters.search) {
                    const searchTerm = this.filters.search.toLowerCase();
                    const matchesTitle = image.title.toLowerCase().includes(searchTerm);
                    const matchesDescription = image.description.toLowerCase().includes(searchTerm);
                    if (!matchesTitle && !matchesDescription) {
                        return false;
                    }
                }

                return true;
            }

            // 更新统计信息
            updateStats() {
                document.getElementById('totalImages').textContent = this.images.length;
                document.getElementById('visibleImages').textContent = this.images.filter(img => img.visible).length;
                document.getElementById('hiddenImages').textContent = this.images.filter(img => !img.visible).length;
                document.getElementById('categories').textContent = this.categories.length;
            }

            // 批量显示
            bulkShow() {
                if (this.selectedImages.size === 0) {
                    notification.show('请先选择要显示的图片', 'warning');
                    return;
                }

                const selectedCount = this.selectedImages.size;
                this.selectedImages.forEach(id => {
                    const image = this.images.find(img => img.id === id);
                    if (image) {
                        image.visible = true;
                        // 显示对应的 DOM 元素
                        const element = document.querySelector(`[data-id="${id}"]`);
                        if (element) {
                            const imgElement = element.querySelector('.gallery-item-img');
                            if (imgElement) {
                                imgElement.style.display = 'block';
                            }
                            element.classList.remove('hidden');
                            
                            // 更新按钮状态
                            this.updateImageButton(element, image);
                        }
                    }
                });

                // 更新统计信息
                this.updateStats();
                this.selectedImages.clear();
                this.updateSelectionUI();
                notification.show(`已显示 ${selectedCount} 张图片`, 'success');
            }

            // 批量隐藏
            bulkHide() {
                if (this.selectedImages.size === 0) {
                    notification.show('请先选择要隐藏的图片', 'warning');
                    return;
                }

                const selectedCount = this.selectedImages.size;
                const imgElements = [];
                
                this.selectedImages.forEach(id => {
                    const image = this.images.find(img => img.id === id);
                    if (image) {
                        image.visible = false;
                        // 获取对应的 DOM 元素
                        const element = document.querySelector(`[data-id="${id}"]`);
                        if (element) {
                            const imgElement = element.querySelector('.gallery-item-img');
                            if (imgElement) {
                                imgElements.push(imgElement);
                            }
                            // 添加隐藏状态
                            element.classList.add('hidden');
                            
                            // 更新按钮状态
                            this.updateImageButton(element, image);
                        }
                    }
                });

                // 使用核心 hide 函数隐藏图片元素
                if (imgElements.length > 0) {
                    hide(...imgElements);
                }

                // 更新统计信息
                this.updateStats();
                this.selectedImages.clear();
                this.updateSelectionUI();
                notification.show(`已隐藏 ${selectedCount} 张图片`, 'success');
            }

            // 批量编辑
            bulkEdit() {
                if (this.selectedImages.size === 0) {
                    notification.show('请先选择要编辑的图片', 'warning');
                    return;
                }

                const modalContent = `
                    <div class="modal-body">
                        <form id="bulkEditForm">
                            <div class="form-group">
                                <label class="plugin-label">批量设置分类</label>
                                <div class="plugin-container">
                                    <div id="bulkCategory"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="plugin-label">批量设置状态</label>
                                <div class="plugin-container">
                                    <div id="bulkStatus"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                `;

                modal.show({
                    title: '批量编辑',
                    content: modalContent,
                    width: '500px',
                    onConfirm: () => {
                        this.saveBulkEdit();
                    }
                });

                setTimeout(() => {
                    const bulkCategory = new Select({
                        container: '#bulkCategory',
                        options: this.categories.map(cat => ({ value: cat, label: cat })),
                        placeholder: '选择分类'
                    });
                    window.bulkCategory = bulkCategory;

                    const bulkStatus = new Select({
                        container: '#bulkStatus',
                        options: [
                            { value: 'visible', label: '显示' },
                            { value: 'hidden', label: '隐藏' }
                        ],
                        placeholder: '选择状态'
                    });
                    window.bulkStatus = bulkStatus;
                }, 100);
            }

            // 保存批量编辑
            saveBulkEdit() {
                const category = window.bulkCategory.getValue();
                const status = window.bulkStatus.getValue();

                this.selectedImages.forEach(id => {
                    const image = this.images.find(img => img.id === id);
                    if (image) {
                        if (category) image.category = category;
                        if (status !== undefined) {
                            const newVisible = status === 'visible';
                            image.visible = newVisible;
                            
                            // 更新对应的 DOM 元素
                            const element = document.querySelector(`[data-id="${id}"]`);
                            if (element) {
                                const imgElement = element.querySelector('.gallery-item-img');
                                if (imgElement) {
                                    if (newVisible) {
                                        imgElement.style.display = 'block';
                                        element.classList.remove('hidden');
                                    } else {
                                        hide(imgElement);
                                        element.classList.add('hidden');
                                    }
                                }
                                
                                // 更新按钮状态
                                this.updateImageButton(element, image);
                            }
                        }
                    }
                });

                this.updateStats();
                this.selectedImages.clear();
                this.updateSelectionUI();
                notification.show('批量编辑完成', 'success');
                modal.hide();
            }

            // 批量删除
            bulkDelete() {
                if (this.selectedImages.size === 0) {
                    notification.show('请先选择要删除的图片', 'warning');
                    return;
                }

                const modalContent = `
                    <div class="modal-body">
                        <p>确定要删除选中的 ${this.selectedImages.size} 张图片吗？此操作不可撤销。</p>
                    </div>
                `;

                modal.show({
                    title: '确认删除',
                    content: modalContent,
                    width: '400px',
                    onConfirm: () => {
                        this.confirmBulkDelete();
                    }
                });
            }

            // 确认批量删除
            confirmBulkDelete() {
                // 使用核心 hide 函数隐藏要删除的图片
                const selectedElements = [];
                this.selectedImages.forEach(id => {
                    const element = document.querySelector(`[data-id="${id}"]`);
                    if (element) {
                        selectedElements.push(element);
                    }
                });
                
                if (selectedElements.length > 0) {
                    hide(...selectedElements);
                }
                
                this.images = this.images.filter(img => !this.selectedImages.has(img.id));
                this.renderGallery();
                this.selectedImages.clear();
                this.updateSelectionUI();
                notification.show('批量删除完成', 'success');
                modal.hide();
            }

            // 添加新图片
            addImage(imageData) {
                const newImage = {
                    id: Date.now(),
                    title: imageData.title,
                    description: imageData.description,
                    category: imageData.category,
                    url: imageData.url,
                    visible: imageData.visible,
                    createdAt: new Date()
                };

                this.images.push(newImage);
                this.renderGallery();
                notification.show(`图片 "${newImage.title}" 已添加`, 'success');
            }

            // 重置画廊
            resetGallery() {
                const modalContent = `
                    <div class="modal-body">
                        <p>确定要重置画廊吗？这将删除所有自定义图片并恢复到默认状态。</p>
                    </div>
                `;

                modal.show({
                    title: '确认重置',
                    content: modalContent,
                    width: '400px',
                    onConfirm: () => {
                        this.confirmReset();
                    }
                });
            }

            // 更新分类筛选器
            updateCategoryFilters() {
                // 更新分类筛选器选项
                if (window.categoryFilter) {
                    const newOptions = [
                        { value: 'all', label: '全部分类' },
                        ...this.categories.map(cat => ({ value: cat, label: cat }))
                    ];
                    window.categoryFilter.setOptions(newOptions);
                }
                
                // 更新其他使用分类的筛选器
                this.updateAllCategorySelectors();
            }

            // 更新所有分类选择器
            updateAllCategorySelectors() {
                // 更新添加图片模态框中的分类选择器
                if (window.newCategory) {
                    const newOptions = this.categories.map(cat => ({ value: cat, label: cat }));
                    window.newCategory.setOptions(newOptions);
                }
                
                // 更新编辑图片模态框中的分类选择器
                if (window.editCategory) {
                    const newOptions = this.categories.map(cat => ({ value: cat, label: cat }));
                    window.editCategory.setOptions(newOptions);
                }
                
                // 更新批量编辑模态框中的分类选择器
                if (window.bulkCategory) {
                    const newOptions = this.categories.map(cat => ({ value: cat, label: cat }));
                    window.bulkCategory.setOptions(newOptions);
                }
            }

            // 确认重置
            confirmReset() {
                // 使用核心 hide 函数隐藏所有当前图片
                const allItems = document.querySelectorAll('.gallery-item');
                if (allItems.length > 0) {
                    hide(...allItems);
                }
                
                this.images = [];
                this.selectedImages.clear();
                this.loadDefaultImages();
                this.updateSelectionUI();
                notification.show('画廊已重置', 'success');
                modal.hide();
            }
        }

        // 全局变量
        let galleryManager;
        let modal;
        let notification;

        // 显示添加图片模态框
        function showAddImageModal() {
            const modalContent = `
                <div class="modal-body">
                    <form id="addImageForm">
                        <div class="form-group">
                            <label class="form-label">图片标题</label>
                            <input type="text" class="form-input" id="newTitle" placeholder="输入图片标题">
                        </div>
                        <div class="form-group">
                            <label class="form-label">图片描述</label>
                            <textarea class="form-textarea" id="newDescription" placeholder="输入图片描述"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="plugin-label">分类</label>
                            <div class="plugin-container">
                                <div id="newCategory"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">图片URL</label>
                            <input type="text" class="form-input" id="newUrl" placeholder="输入图片URL">
                        </div>
                        <div class="form-group">
                            <label class="plugin-label">初始状态</label>
                            <div class="plugin-container">
                                <div id="newStatus"></div>
                            </div>
                        </div>
                    </form>
                </div>
            `;

            modal.show({
                title: '添加新图片',
                content: modalContent,
                width: '600px',
                onConfirm: () => {
                    addNewImage();
                }
            });

            setTimeout(() => {
                const newCategory = new Select({
                    container: '#newCategory',
                    options: galleryManager.categories.map(cat => ({ value: cat, label: cat })),
                    placeholder: '选择分类'
                });
                window.newCategory = newCategory;

                const newStatus = new Select({
                    container: '#newStatus',
                    options: [
                        { value: true, label: '显示' },
                        { value: false, label: '隐藏' }
                    ],
                    placeholder: '选择状态'
                });
                newStatus.setValue(true);
                window.newStatus = newStatus;
            }, 100);
        }

        // 添加新图片
        function addNewImage() {
            const title = document.getElementById('newTitle').value;
            const description = document.getElementById('newDescription').value;
            const url = document.getElementById('newUrl').value;

            if (!title || !url) {
                notification.show('请填写图片标题和URL', 'error');
                return;
            }

            const imageData = {
                title,
                description,
                category: window.newCategory.getValue() || galleryManager.categories[0],
                url,
                visible: window.newStatus.getValue()
            };

            galleryManager.addImage(imageData);
            modal.hide();
        }

        // 显示分类管理
        function showCategoryManager() {
            const modalContent = `
                <div class="modal-body">
                    <h4>当前分类 (${galleryManager.categories.length} 个)</h4>
                    <div style="margin: 20px 0;">
                        ${galleryManager.categories.map(cat => `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                                <span style="flex: 1;">${cat}</span>
                                <button class="btn btn-danger" onclick="deleteCategory('${cat}')" style="padding: 5px 10px; font-size: 12px;">删除</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="form-group">
                        <label class="form-label">添加新分类</label>
                        <input type="text" class="form-input" id="newCategoryName" placeholder="输入分类名称">
                    </div>
                    <div style="margin-top: 20px; text-align: center; color: #6c757d; font-size: 14px;">
                        点击"确定"按钮添加新分类
                    </div>
                </div>
            `;

            modal.show({
                title: '分类管理',
                content: modalContent,
                type: 'confirm',
                onConfirm: () => {
                    addCategory();
                }
            });
        }

        // 添加分类
        function addCategory() {
            const name = document.getElementById('newCategoryName').value;
            if (!name) {
                notification.show('请输入分类名称', 'error');
                return;
            }

            if (galleryManager.categories.includes(name)) {
                notification.show('分类已存在', 'warning');
                return;
            }

            galleryManager.categories.push(name);
            notification.show(`分类 "${name}" 已添加`, 'success');
            
            // 更新筛选器中的分类选项
            galleryManager.updateCategoryFilters();
            
            modal.hide();
        }

        // 删除分类
        function deleteCategory(name) {
            if (galleryManager.categories.length <= 1) {
                notification.show('至少需要保留一个分类', 'warning');
                return;
            }

            const imagesInCategory = galleryManager.images.filter(img => img.category === name);
            if (imagesInCategory.length > 0) {
                notification.show(`无法删除分类 "${name}"，该分类下还有 ${imagesInCategory.length} 张图片`, 'error');
                return;
            }

            galleryManager.categories = galleryManager.categories.filter(cat => cat !== name);
            notification.show(`分类 "${name}" 已删除`, 'success');
            
            // 更新筛选器中的分类选项
            galleryManager.updateCategoryFilters();
        }

        // 显示批量操作
        function showBulkOperations() {
            const modalContent = `
                <div class="modal-body">
                    <h4>批量操作说明</h4>
                    <ul style="margin: 20px 0;">
                        <li>选择图片：点击图片卡片进行选择</li>
                        <li>全选：使用页面上的全选复选框</li>
                        <li>批量显示：显示所有选中的图片</li>
                        <li>批量隐藏：隐藏所有选中的图片</li>
                        <li>批量编辑：统一修改选中图片的分类和状态</li>
                        <li>批量删除：删除所有选中的图片</li>
                    </ul>
                    <p><strong>当前选中：</strong><span id="currentSelected">0</span> 张图片</p>
                </div>
            `;

            modal.show({
                title: '批量操作说明',
                content: modalContent,
                width: '500px'
            });

            // 更新选中数量
            setTimeout(() => {
                document.getElementById('currentSelected').textContent = galleryManager.selectedImages.size;
            }, 100);
        }

        // 显示画廊设置
        function showGallerySettings() {
            const modalContent = `
                <div class="modal-body">
                    <h4>画廊设置</h4>
                    <div class="form-group">
                        <label class="plugin-label">默认图片状态</label>
                        <div class="plugin-container">
                            <div id="defaultStatus"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="plugin-label">图片加载方式</label>
                        <div class="plugin-container">
                            <div id="loadMethod"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">每行显示图片数量</label>
                        <div class="plugin-container">
                            <div id="imagesPerRow"></div>
                        </div>
                    </div>
                </div>
            `;

            modal.show({
                title: '画廊设置',
                content: modalContent,
                width: '500px',
                onConfirm: () => {
                    saveGallerySettings();
                }
            });

            setTimeout(() => {
                const defaultStatus = new Select({
                    container: '#defaultStatus',
                    options: [
                        { value: 'visible', label: '显示' },
                        { value: 'hidden', label: '隐藏' }
                    ],
                    placeholder: '选择默认状态'
                });
                defaultStatus.setValue('visible');
                window.defaultStatus = defaultStatus;

                const loadMethod = new Select({
                    container: '#loadMethod',
                    options: [
                        { value: 'lazy', label: '懒加载' },
                        { value: 'eager', label: '立即加载' }
                    ],
                    placeholder: '选择加载方式'
                });
                loadMethod.setValue('eager');
                window.loadMethod = loadMethod;

                const imagesPerRow = new InputNumber({
                    container: '#imagesPerRow',
                    min: 1,
                    max: 6,
                    step: 1,
                    value: 4
                });
                window.imagesPerRow = imagesPerRow;
            }, 100);
        }

        // 保存画廊设置
        function saveGallerySettings() {
            const defaultStatus = window.defaultStatus.getValue();
            const loadMethod = window.loadMethod.getValue();
            const imagesPerRow = window.imagesPerRow.getValue();

            // 这里可以保存设置到 localStorage 或发送到服务器
            localStorage.setItem('gallerySettings', JSON.stringify({
                defaultStatus,
                loadMethod,
                imagesPerRow
            }));

            notification.show('画廊设置已保存', 'success');
            modal.hide();
        }

        // 重置画廊
        function resetGallery() {
            galleryManager.resetGallery();
        }

        // 全局函数，用于在 galleryManager 初始化前提供占位符
        function bulkShow() {
            if (window.galleryManager) {
                window.galleryManager.bulkShow();
            }
        }

        function bulkHide() {
            if (window.galleryManager) {
                window.galleryManager.bulkHide();
            }
        }

        function bulkEdit() {
            if (window.galleryManager) {
                window.galleryManager.bulkEdit();
            }
        }

        function bulkDelete() {
            if (window.galleryManager) {
                window.galleryManager.bulkDelete();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化全局插件实例
            modal = new Modal();
            notification = new Notification();
            
            // 初始化画廊管理器
            galleryManager = new GalleryManager();
            
            // 将 galleryManager 暴露到全局作用域
            window.galleryManager = galleryManager;
            
            // 显示欢迎通知
            setTimeout(() => {
                notification.show('欢迎使用图片画廊管理系统', 'success');
            }, 1000);
        });
    </script>
</body>

</html>