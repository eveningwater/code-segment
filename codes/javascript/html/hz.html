<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>性能测试与基准测试系统 - hz函数实战示例</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .performance-chart {
            height: 200px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .chart-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: 5px;
        }

        .chart-bar:hover {
            transform: scaleY(1.05);
        }

        .chart-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .chart-value {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .performance-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-excellent {
            background: #d4edda;
            color: #155724;
        }

        .badge-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-average {
            background: #fff3cd;
            color: #856404;
        }

        .badge-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .real-time-monitor {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .monitor-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .monitor-time {
            color: #a0aec0;
            margin-right: 10px;
        }

        .monitor-level-info {
            color: #63b3ed;
        }

        .monitor-level-success {
            color: #68d391;
        }

        .monitor-level-warning {
            color: #f6ad55;
        }

        .monitor-level-error {
            color: #fc8181;
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .algorithm-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .algorithm-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .algorithm-card.selected {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .algorithm-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .algorithm-checkbox-container {
            min-width: 20px;
        }

        .algorithm-name {
            font-weight: 600;
            color: #333;
        }

        .algorithm-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .algorithm-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #999;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .comparison-chart {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .chart-container {
            height: 100%;
            display: flex;
            align-items: end;
            gap: 10px;
            padding: 20px 0;
        }

        .chart-column {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-column:hover {
            transform: scaleY(1.05);
        }

        .chart-column-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
        }

        .chart-column-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .algorithm-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>⚡ 性能测试与基准测试系统</h1>
            <p>基于 hz 函数的实战示例 - 算法性能对比与实时监控</p>
        </div>

        <div class="content">
            <!-- 控制面板 -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>⚙️ 测试配置</h3>
                    <div class="controls-grid">
                        <div class="form-group">
                            <label>测试迭代次数</label>
                            <div id="iterationsInput"></div>
                        </div>
                        <div class="form-group">
                            <label>数据规模</label>
                            <div id="dataSizeInput"></div>
                        </div>
                        <div class="form-group">
                            <label>测试类型</label>
                            <div id="testTypeSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>运行模式</label>
                            <div id="runModeSelect"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>算法选择</label>
                        <div class="algorithm-grid" id="algorithmGrid">
                            <!-- 算法选择卡片将在这里动态生成 -->
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="runPerformanceTest()">开始性能测试</button>
                    <button class="btn btn-success" onclick="runComparisonTest()">对比测试</button>
                    <button class="btn btn-warning" onclick="clearResults()">清除结果</button>
                    <button class="btn btn-danger" onclick="exportResults()">导出结果</button>
                </div>
            </div>

            <!-- 仪表板 -->
            <div class="dashboard">
                <!-- 性能概览 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">📊</span>
                        <span class="card-title">性能概览</span>
                    </div>
                    <div class="performance-chart" id="performanceChart">
                        <!-- 性能图表将在这里显示 -->
                    </div>
                    <div id="performanceStats">
                        <p><strong>最高性能：</strong><span id="maxPerformance">--</span> Hz</p>
                        <p><strong>平均性能：</strong><span id="avgPerformance">--</span> Hz</p>
                        <p><strong>最低性能：</strong><span id="minPerformance">--</span> Hz</p>
                    </div>
                </div>

                <!-- 实时监控 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">📈</span>
                        <span class="card-title">实时监控</span>
                    </div>
                    <div class="real-time-monitor" id="realTimeMonitor">
                        <!-- 实时监控日志将在这里显示 -->
                    </div>
                </div>

                <!-- 测试结果 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">📋</span>
                        <span class="card-title">测试结果</span>
                    </div>
                    <div id="testResults">
                        <table class="results-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>算法</th>
                                    <th>性能 (Hz)</th>
                                    <th>时间 (ms)</th>
                                    <th>评级</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- 结果行将在这里动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 对比图表 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📊</span>
                    <span class="card-title">性能对比</span>
                </div>
                <div class="comparison-chart" id="comparisonChart">
                    <div class="chart-container" id="chartContainer">
                        <!-- 对比图表将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入插件 -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>

    <script>
        // 全局变量
        let modal, notification;
        let iterationsInput, dataSizeInput, testTypeSelect, runModeSelect;
        let selectedAlgorithms = [];
        let testResults = [];
        let performanceLog = [];

        // 兼容性处理：确保 performance.now 可用
        const getPerformanceTime = () => {
            if (typeof performance !== 'undefined' && performance.now) {
                return performance.now();
            } else if (typeof Date !== 'undefined' && Date.now) {
                return Date.now();
            } else {
                return new Date().getTime();
            }
        };

        // hz 函数
        const hz = (handler, iterations = 100) => {
            const before = getPerformanceTime();
            for (let i = 0; i < iterations; i++) {
                handler();
            }
            const after = getPerformanceTime();
            return 1000 * iterations / (after - before);
        };

        // 算法定义
        const algorithms = {
            sumReduce: {
                name: 'Array.reduce()',
                description: '使用 Array.reduce() 方法求和',
                handler: (data) => data.reduce((acc, n) => acc + n, 0),
                category: 'functional'
            },
            sumForLoop: {
                name: 'For 循环',
                description: '使用传统 for 循环求和',
                handler: (data) => {
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) sum += data[i];
                    return sum;
                },
                category: 'imperative'
            },
            sumForEach: {
                name: 'Array.forEach()',
                description: '使用 Array.forEach() 方法求和',
                handler: (data) => {
                    let sum = 0;
                    data.forEach(n => sum += n);
                    return sum;
                },
                category: 'functional'
            },
            sumForOf: {
                name: 'For...of 循环',
                description: '使用 for...of 循环求和',
                handler: (data) => {
                    let sum = 0;
                    for (const n of data) sum += n;
                    return sum;
                },
                category: 'modern'
            },
            sumWhile: {
                name: 'While 循环',
                description: '使用 while 循环求和',
                handler: (data) => {
                    let sum = 0;
                    let i = 0;
                    while (i < data.length) {
                        sum += data[i];
                        i++;
                    }
                    return sum;
                },
                category: 'imperative'
            },
            sumRecursive: {
                name: '递归求和',
                description: '使用递归方法求和',
                handler: (data) => {
                    const sumRec = (arr, index = 0) => {
                        if (index >= arr.length) return 0;
                        return arr[index] + sumRec(arr, index + 1);
                    };
                    return sumRec(data);
                },
                category: 'functional'
            },
            sortBubble: {
                name: '冒泡排序',
                description: '使用冒泡排序算法',
                handler: (data) => [...data].sort((a, b) => a - b),
                category: 'sorting'
            },
            sortQuick: {
                name: '快速排序',
                description: '使用快速排序算法',
                handler: (data) => {
                    const quickSort = (arr) => {
                        if (arr.length <= 1) return arr;
                        const pivot = arr[Math.floor(arr.length / 2)];
                        const left = arr.filter(x => x < pivot);
                        const middle = arr.filter(x => x === pivot);
                        const right = arr.filter(x => x > pivot);
                        return [...quickSort(left), ...middle, ...quickSort(right)];
                    };
                    return quickSort([...data]);
                },
                category: 'sorting'
            },
            filterEven: {
                name: '过滤偶数',
                description: '过滤数组中的偶数',
                handler: (data) => data.filter(n => n % 2 === 0),
                category: 'filtering'
            },
            mapSquare: {
                name: '平方映射',
                description: '将数组元素平方',
                handler: (data) => data.map(n => n * n),
                category: 'transformation'
            }
        };

        // 初始化应用
        function initApp() {
            // 初始化插件
            modal = new Modal();
            notification = new Notification({ position: 'top-right' });

            // 初始化输入控件
            iterationsInput = new InputNumber({
                container: document.getElementById('iterationsInput'),
                min: 10,
                max: 10000,
                value: 100,
                step: 10
            });

            dataSizeInput = new InputNumber({
                container: document.getElementById('dataSizeInput'),
                min: 100,
                max: 100000,
                value: 10000,
                step: 1000
            });

            testTypeSelect = new Select({
                container: document.getElementById('testTypeSelect'),
                options: [
                    { value: 'single', label: '单次测试' },
                    { value: 'multiple', label: '多次测试' },
                    { value: 'stress', label: '压力测试' }
                ],
                placeholder: '选择测试类型'
            });

            runModeSelect = new Select({
                container: document.getElementById('runModeSelect'),
                options: [
                    { value: 'sync', label: '同步模式' },
                    { value: 'async', label: '异步模式' },
                    { value: 'webworker', label: 'Web Worker' }
                ],
                placeholder: '选择运行模式'
            });

            // 生成算法选择网格
            generateAlgorithmGrid();

            // 初始化界面
            addMonitorLog('info', '系统初始化完成');
        }

        // 生成算法选择网格
        function generateAlgorithmGrid() {
            const container = document.getElementById('algorithmGrid');
            
            Object.entries(algorithms).forEach(([key, algorithm]) => {
                const card = document.createElement('div');
                card.className = 'algorithm-card';
                card.id = `card-${key}`;
                
                card.innerHTML = `
                    <div class="algorithm-header">
                        <div class="algorithm-checkbox-container" id="checkbox-container-${key}"></div>
                        <span class="algorithm-name">${algorithm.name}</span>
                    </div>
                    <div class="algorithm-description">${algorithm.description}</div>
                    <div class="algorithm-stats">
                        <span>类别: ${algorithm.category}</span>
                        <span>性能: -- Hz</span>
                    </div>
                `;
                
                container.appendChild(card);
                
                // 创建自定义 checkbox
                const checkbox = new Checkbox({
                    label: '',
                    checked: false,
                    onChange: (checked) => {
                        if (checked) {
                            selectedAlgorithms.push(key);
                            card.classList.add('selected');
                        } else {
                            selectedAlgorithms = selectedAlgorithms.filter(k => k !== key);
                            card.classList.remove('selected');
                        }
                    }
                });
                checkbox.mount(document.getElementById(`checkbox-container-${key}`));
            });
        }

        // 切换算法选择 - 已废弃，现在通过 checkbox onChange 处理
        function toggleAlgorithm(key, card) {
            // 这个方法现在由 checkbox onChange 处理
        }

        // 运行性能测试
        function runPerformanceTest() {
            if (selectedAlgorithms.length === 0) {
                notification.error('请至少选择一个算法进行测试');
                return;
            }

            const iterations = iterationsInput.getValue();
            const dataSize = dataSizeInput.getValue();
            const testType = testTypeSelect.getValue();
            const runMode = runModeSelect.getValue();

            addMonitorLog('info', `开始性能测试 - 迭代次数: ${iterations}, 数据规模: ${dataSize}`);

            // 生成测试数据
            const testData = Array(dataSize).fill().map((_, i) => i);
            testResults = [];

            // 执行测试
            let completedTests = 0;
            selectedAlgorithms.forEach((algorithmKey, index) => {
                setTimeout(() => {
                    const algorithm = algorithms[algorithmKey];
                    const startTime = getPerformanceTime();
                    
                    try {
                        // 修复：创建正确的测试函数，将 testData 传递给算法
                        const testFunction = () => {
                            const result = algorithm.handler(testData);
                            // 确保算法返回了有效结果
                            if (result === undefined || result === null) {
                                throw new Error('算法返回了无效结果');
                            }
                            return result;
                        };
                        
                        const performance = hz(testFunction, iterations);
                        const endTime = getPerformanceTime();
                        const executionTime = endTime - startTime;

                        const result = {
                            name: algorithm.name,
                            key: algorithmKey,
                            performance: Math.round(performance),
                            executionTime: Math.round(executionTime),
                            rating: getPerformanceRating(performance),
                            category: algorithm.category
                        };

                        testResults.push(result);
                        addMonitorLog('success', `${algorithm.name}: ${performance.toFixed(0)} Hz`);

                        // 更新算法卡片
                        updateAlgorithmCard(algorithmKey, performance);

                        completedTests++;
                        
                        // 调试信息
                        console.log(`测试完成: ${algorithm.name}, 性能: ${performance}, 已完成: ${completedTests}/${selectedAlgorithms.length}`);
                        
                        // 如果是最后一个算法，更新界面
                        if (completedTests === selectedAlgorithms.length) {
                            updateResults();
                            updatePerformanceChart();
                            updateComparisonChart();
                            addMonitorLog('info', `性能测试完成，共测试 ${testResults.length} 个算法`);
                            notification.success(`性能测试完成，共测试 ${testResults.length} 个算法`);
                            
                            // 调试信息
                            console.log('测试结果数组:', testResults);
                            console.log('测试结果数量:', testResults.length);
                        }
                    } catch (error) {
                        addMonitorLog('error', `${algorithm.name}: 测试失败 - ${error.message}`);
                        console.error(`测试失败: ${algorithm.name}`, error);
                        completedTests++;
                        
                        // 即使有错误也要检查是否所有测试都完成了
                        if (completedTests === selectedAlgorithms.length) {
                            updateResults();
                            updatePerformanceChart();
                            updateComparisonChart();
                            addMonitorLog('info', `性能测试完成，共测试 ${testResults.length} 个算法`);
                            notification.success(`性能测试完成，共测试 ${testResults.length} 个算法`);
                        }
                    }
                }, index * 500);
            });
        }

        // 运行对比测试
        function runComparisonTest() {
            console.log('对比测试 - testResults 数组:', testResults);
            console.log('对比测试 - testResults 长度:', testResults.length);
            
            if (testResults.length === 0) {
                notification.error('请先运行性能测试');
                addMonitorLog('error', 'testResults 数组为空，请先运行性能测试');
                return;
            }

            addMonitorLog('info', '开始深度对比测试...');

            // 1. 按类别分组对比
            const categories = {};
            testResults.forEach(result => {
                if (!categories[result.category]) {
                    categories[result.category] = [];
                }
                categories[result.category].push(result);
            });

            // 2. 找出每个类别的最佳算法
            const categoryBests = {};
            Object.entries(categories).forEach(([category, results]) => {
                const best = results.reduce((max, current) => 
                    current.performance > max.performance ? current : max
                );
                categoryBests[category] = best;
                addMonitorLog('success', `${category} 类别最佳: ${best.name} (${best.performance.toLocaleString()} Hz)`);
            });

            // 3. 找出全局最佳算法
            const globalBest = testResults.reduce((max, current) => 
                current.performance > max.performance ? current : max
            );
            addMonitorLog('success', `🏆 全局最佳: ${globalBest.name} (${globalBest.performance.toLocaleString()} Hz)`);

            // 4. 性能差异分析
            const sortedResults = [...testResults].sort((a, b) => b.performance - a.performance);
            const bestPerformance = sortedResults[0].performance;
            
            sortedResults.forEach((result, index) => {
                const performanceDiff = ((bestPerformance - result.performance) / bestPerformance * 100).toFixed(1);
                const rank = index + 1;
                const rankEmoji = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `${rank}.`;
                
                addMonitorLog('info', `${rankEmoji} ${result.name}: ${result.performance.toLocaleString()} Hz (比最佳慢 ${performanceDiff}%)`);
            });

            // 5. 类别性能对比
            const categoryAverages = {};
            Object.entries(categories).forEach(([category, results]) => {
                const avgPerformance = results.reduce((sum, r) => sum + r.performance, 0) / results.length;
                categoryAverages[category] = avgPerformance;
                addMonitorLog('info', `📊 ${category} 类别平均性能: ${avgPerformance.toFixed(0)} Hz`);
            });

            // 6. 性能分布分析
            const performances = testResults.map(r => r.performance);
            const avgPerformance = performances.reduce((a, b) => a + b, 0) / performances.length;
            const aboveAverage = testResults.filter(r => r.performance > avgPerformance).length;
            const belowAverage = testResults.length - aboveAverage;
            
            addMonitorLog('info', `📈 性能分布: ${aboveAverage} 个算法高于平均水平, ${belowAverage} 个算法低于平均水平`);

            // 7. 显示对比结果弹窗
            showComparisonResults({
                globalBest,
                categoryBests,
                categoryAverages,
                sortedResults,
                performanceStats: {
                    total: testResults.length,
                    aboveAverage,
                    belowAverage,
                    bestPerformance,
                    avgPerformance
                }
            });

            notification.success('深度对比测试完成');
        }

        // 显示对比结果弹窗
        function showComparisonResults(data) {
            const { globalBest, categoryBests, categoryAverages, sortedResults, performanceStats } = data;
            
            const content = `
                <div style="max-width: 600px; max-height: 500px; overflow-y: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">🏆 性能对比分析报告</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">🥇 全局最佳算法</h4>
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <strong>${globalBest.name}</strong><br>
                            性能: <span style="color: #667eea; font-weight: bold;">${globalBest.performance.toLocaleString()} Hz</span><br>
                            类别: ${globalBest.category}<br>
                            评级: <span class="performance-badge ${globalBest.rating.class}">${globalBest.rating.text}</span>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">📊 类别最佳算法</h4>
                        ${Object.entries(categoryBests).map(([category, best]) => `
                            <div style="background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 6px;">
                                <strong>${category}</strong>: ${best.name} (${best.performance.toLocaleString()} Hz)
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">📈 性能排名</h4>
                        ${sortedResults.slice(0, 5).map((result, index) => {
                            const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                            const performanceDiff = ((performanceStats.bestPerformance - result.performance) / performanceStats.bestPerformance * 100).toFixed(1);
                            return `
                                <div style="background: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 4px;">
                                    ${rankEmoji} ${result.name}: ${result.performance.toLocaleString()} Hz 
                                    ${index > 0 ? `<span style="color: #666;">(慢 ${performanceDiff}%)</span>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">📊 统计摘要</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #28a745;">${performanceStats.aboveAverage}</div>
                                <div style="font-size: 0.9em; color: #666;">高于平均</div>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.2em; font-weight: bold; color: #ffc107;">${performanceStats.belowAverage}</div>
                                <div style="font-size: 0.9em; color: #666;">低于平均</div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="exportComparisonReport(${JSON.stringify(data).replace(/"/g, '&quot;')})" 
                                style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            导出对比报告
                        </button>
                    </div>
                </div>
            `;

            modal.alert(content, '性能对比分析');
        }

        // 导出对比报告
        function exportComparisonReport(data) {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    globalBest: data.globalBest,
                    categoryBests: data.categoryBests,
                    performanceStats: data.performanceStats
                },
                detailedResults: data.sortedResults,
                categoryAverages: data.categoryAverages
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comparison-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            addMonitorLog('info', '对比报告已导出');
            notification.success('对比报告已导出');
        }

        // 获取性能评级
        function getPerformanceRating(performance) {
            if (performance >= 10000) return { text: '优秀', class: 'badge-excellent' };
            if (performance >= 5000) return { text: '良好', class: 'badge-good' };
            if (performance >= 1000) return { text: '一般', class: 'badge-average' };
            return { text: '较差', class: 'badge-poor' };
        }

        // 更新算法卡片
        function updateAlgorithmCard(key, performance) {
            const card = document.getElementById(`card-${key}`);
            const stats = card.querySelector('.algorithm-stats');
            stats.innerHTML = `
                <span>类别: ${algorithms[key].category}</span>
                <span>性能: ${performance.toFixed(0)} Hz</span>
            `;
        }

        // 更新结果表格
        function updateResults() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            testResults.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td>${result.performance.toLocaleString()}</td>
                    <td>${result.executionTime}</td>
                    <td><span class="performance-badge ${result.rating.class}">${result.rating.text}</span></td>
                `;
                tbody.appendChild(row);
            });

            // 更新统计信息
            const performances = testResults.map(r => r.performance);
            document.getElementById('maxPerformance').textContent = Math.max(...performances).toLocaleString();
            document.getElementById('avgPerformance').textContent = Math.round(performances.reduce((a, b) => a + b, 0) / performances.length).toLocaleString();
            document.getElementById('minPerformance').textContent = Math.min(...performances).toLocaleString();
        }

        // 更新性能图表
        function updatePerformanceChart() {
            const container = document.getElementById('performanceChart');
            container.innerHTML = '';

            const maxPerformance = Math.max(...testResults.map(r => r.performance));

            testResults.forEach(result => {
                const percentage = (result.performance / maxPerformance) * 100;
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${percentage}%`;
                bar.style.width = '100%';
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = result.name;
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = result.performance.toLocaleString();
                
                bar.appendChild(value);
                container.appendChild(label);
                container.appendChild(bar);
            });
        }

        // 更新对比图表
        function updateComparisonChart() {
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';

            const maxPerformance = Math.max(...testResults.map(r => r.performance));

            testResults.forEach(result => {
                const percentage = (result.performance / maxPerformance) * 100;
                
                const column = document.createElement('div');
                column.className = 'chart-column';
                column.style.height = `${percentage}%`;
                
                const label = document.createElement('div');
                label.className = 'chart-column-label';
                label.textContent = result.name;
                
                const value = document.createElement('div');
                value.className = 'chart-column-value';
                value.textContent = result.performance.toLocaleString();
                
                column.appendChild(label);
                column.appendChild(value);
                container.appendChild(column);
            });
        }

        // 添加监控日志
        function addMonitorLog(level, message) {
            const timestamp = new Date();
            const logEntry = {
                time: timestamp,
                level: level,
                message: message
            };
            
            performanceLog.unshift(logEntry);
            if (performanceLog.length > 50) {
                performanceLog.pop();
            }
            
            updateMonitorDisplay();
        }

        // 更新监控显示
        function updateMonitorDisplay() {
            const container = document.getElementById('realTimeMonitor');
            
            container.innerHTML = performanceLog.map(entry => `
                <div class="monitor-entry">
                    <span class="monitor-time">${formatDateTime(entry.time)}</span>
                    <span class="monitor-level-${entry.level}">[${entry.level.toUpperCase()}]</span>
                    <span>${entry.message}</span>
                </div>
            `).join('');
        }

        // 清除结果
        function clearResults() {
            modal.confirm('确定要清除所有测试结果吗？').then(confirmed => {
                if (confirmed) {
                    testResults = [];
                    performanceLog = [];
                    selectedAlgorithms = [];
                    
                    // 清除选择
                    selectedAlgorithms = [];
                    document.querySelectorAll('.algorithm-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    // 重新生成算法网格以重置 checkbox 状态
                    document.getElementById('algorithmGrid').innerHTML = '';
                    generateAlgorithmGrid();
                    
                    // 清除显示
                    document.getElementById('resultsTableBody').innerHTML = '';
                    document.getElementById('performanceChart').innerHTML = '';
                    document.getElementById('chartContainer').innerHTML = '';
                    document.getElementById('realTimeMonitor').innerHTML = '';
                    
                    // 重置统计
                    document.getElementById('maxPerformance').textContent = '--';
                    document.getElementById('avgPerformance').textContent = '--';
                    document.getElementById('minPerformance').textContent = '--';
                    
                    addMonitorLog('info', '所有结果已清除');
                    notification.success('所有结果已清除');
                }
            });
        }

        // 导出结果
        function exportResults() {
            if (testResults.length === 0) {
                notification.error('没有可导出的结果');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                testConfig: {
                    iterations: iterationsInput.getValue(),
                    dataSize: dataSizeInput.getValue(),
                    testType: testTypeSelect.getValue(),
                    runMode: runModeSelect.getValue()
                },
                results: testResults,
                log: performanceLog
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `performance-test-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            addMonitorLog('info', '结果已导出');
            notification.success('结果已导出');
        }

        // 格式化日期时间
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);

        // 全局调试函数
        window.debugPerformanceTest = function() {
            console.log('=== 性能测试调试信息 ===');
            console.log('选中的算法:', selectedAlgorithms);
            console.log('测试结果:', testResults);
            console.log('测试结果数量:', testResults.length);
            console.log('性能日志数量:', performanceLog.length);
            console.log('=======================');
        };

        // 测试 hz 函数是否正常工作
        window.testHzFunction = function() {
            console.log('=== 测试 hz 函数 ===');
            console.log('性能API可用性检查:');
            console.log('- performance:', typeof performance);
            console.log('- performance.now:', typeof performance?.now);
            console.log('- Date.now:', typeof Date?.now);
            
            const testData = [1, 2, 3, 4, 5];
            const testFunction = () => testData.reduce((a, b) => a + b, 0);
            const performance = hz(testFunction, 100);
            console.log('hz 函数测试结果:', performance);
            console.log('==================');
            return performance;
        };
    </script>
</body>

</html>