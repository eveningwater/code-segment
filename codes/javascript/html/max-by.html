<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€å¤§å€¼æŸ¥æ‰¾å¹³å° - maxBy</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: white;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.98rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 140px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .array-display,
        .result-display {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .array-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 14px;
        }

        .array-item {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
            border-left: 4px solid #f59e0b;
            transition: all 0.3s ease;
        }

        .array-item.max {
            border-left-color: #22c55e;
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .item-index {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .item-content {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.95rem;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .item-mapped {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .item-mapped.max {
            color: #15803d;
            font-weight: 700;
            font-size: 1rem;
        }

        .max-badge {
            display: inline-block;
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .result-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }

        .result-label {
            font-size: 0.9rem;
            color: #92400e;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #78350f;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .function-config {
            background: #f8fafc;
            border-radius: 14px;
            padding: 16px;
            margin-top: 12px;
        }

        .function-config h4 {
            font-size: 0.95rem;
            color: #f59e0b;
            margin-bottom: 10px;
        }

        .function-desc {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .comparison-card h4 {
            font-size: 0.95rem;
            color: #f59e0b;
            margin-bottom: 10px;
        }

        .comparison-card p {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #475569;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #1f2937;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #f59e0b;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æœ€å¤§å€¼æŸ¥æ‰¾å¹³å°</h1>
            <p>åŸºäº maxBy å‡½æ•°çš„æ•°ç»„æœ€å¤§å€¼æŸ¥æ‰¾å·¥å…·ï¼Œæ”¯æŒå‡½æ•°æ˜ å°„ã€å±æ€§åæ˜ å°„ã€å¯è§†åŒ–å±•ç¤ºã€æ‰¹é‡å¤„ç†</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ“ æ•°ç»„é…ç½®</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>æ•°ç»„æ•°æ® (JSON)</label>
                            <textarea id="arrayInput" class="textarea-field" placeholder='[{"n": 4}, {"n": 2}, {"n": 8}, {"n": 6}]'></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.maxByTool?.addArray()">â• æ·»åŠ æ•°ç»„</button>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.maxByTool?.findMax()">âš¡ æŸ¥æ‰¾æœ€å¤§å€¼</button>
                            <button class="btn btn-info" onclick="window.maxByTool?.loadSample()">ğŸ“„ ç¤ºä¾‹æ•°æ®</button>
                            <button class="btn btn-warning" onclick="window.maxByTool?.generateRandom()">ğŸ² éšæœºç”Ÿæˆ</button>
                            <button class="btn btn-danger" onclick="window.maxByTool?.clearAll()">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ”§ æ˜ å°„å‡½æ•°</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>é€‰æ‹©æ˜ å°„æ–¹å¼</label>
                            <div id="mappingSelect"></div>
                        </div>
                        <div id="functionConfig" class="function-config" style="display:none;">
                            <h4>å‡½æ•°è¯´æ˜</h4>
                            <div class="function-desc" id="functionDesc"></div>
                        </div>
                        <div class="input-group" id="propertyGroup" style="display:none;">
                            <label>å±æ€§å</label>
                            <input id="propertyInput" class="input-field" placeholder="ä¾‹å¦‚ï¼šn, score, value" />
                        </div>
                        <div class="input-group" id="customFunctionGroup" style="display:none;">
                            <label>è‡ªå®šä¹‰å‡½æ•°ä»£ç </label>
                            <textarea id="customFunctionInput" class="textarea-field" placeholder='x => x.n'></textarea>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ å†å²è®°å½• (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æŸ¥æ‰¾å†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>ğŸ“¦ æ•°ç»„å…ƒç´ </h2>
                    <div class="array-display" id="arrayDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ æ•°ç»„åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âœ¨ æœ€å¤§å€¼ç»“æœ</h2>
                    <div class="result-display" id="resultDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡ŒæŸ¥æ‰¾åå°†åœ¨æ­¤å±•ç¤ºæœ€å¤§å€¼</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“Š å¯¹æ¯”åˆ†æ</h2>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#f59e0b;margin-bottom:12px;">maxBy å‡½æ•°ï¼ˆé€šè¿‡æ˜ å°„æŸ¥æ‰¾æœ€å¤§å€¼ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const maxBy = (arr, fn) => 
  Math.max(...arr.map(typeof fn === "function" ? fn : val => val[fn]));</code></pre>
                </div>

                <h3 style="color:#f59e0b;margin:20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#374151;line-height:1.8;">
                    <strong>maxBy</strong> å‡½æ•°åœ¨ä½¿ç”¨æä¾›çš„å‡½æ•°å°†æ¯ä¸ªå…ƒç´ æ˜ å°„åˆ°ä¸€ä¸ªå€¼åï¼Œè¿”å›æ•°ç»„çš„æœ€å¤§å€¼ã€‚
                    æ”¯æŒä¸¤ç§æ˜ å°„æ–¹å¼ï¼šå‡½æ•°æ˜ å°„ï¼ˆå¦‚ <code>x => x.n</code>ï¼‰æˆ–å±æ€§åæ˜ å°„ï¼ˆå¦‚ <code>'n'</code>ï¼‰ã€‚
                    é€‚ç”¨äºæŸ¥æ‰¾å¯¹è±¡æ•°ç»„ä¸­æŸä¸ªå±æ€§çš„æœ€å¤§å€¼ï¼Œæˆ–é€šè¿‡å¤æ‚è®¡ç®—æ‰¾åˆ°æœ€å¤§å€¼ã€‚
                </p>

                <h3 style="color:#f59e0b;margin:20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">// ä½¿ç”¨å‡½æ•°æ˜ å°„
maxBy([{ n: 4 }, { n: 2 }, { n: 8 }, { n: 6 }], x => x.n);
// 8

// ä½¿ç”¨å±æ€§åæ˜ å°„
maxBy([{ n: 4 }, { n: 2 }, { n: 8 }, { n: 6 }], 'n');
// 8

// å¤æ‚è®¡ç®—
maxBy([{ x: 1, y: 2 }, { x: 3, y: 4 }], item => item.x * item.y);
// 12</code></pre>
                </div>

                <h3 style="color:#f59e0b;margin:20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="badge">æŸ¥æ‰¾æœ€é«˜åˆ†</span>
                    <span class="badge">æŸ¥æ‰¾æœ€å¤§é‡‘é¢</span>
                    <span class="badge">æŸ¥æ‰¾æœ€é•¿å­—ç¬¦ä¸²</span>
                    <span class="badge">æŸ¥æ‰¾æœ€å¤§æ—¥æœŸ</span>
                    <span class="badge">å¤æ‚è®¡ç®—æœ€å¤§å€¼</span>
                    <span class="badge">æ•°æ®åˆ†æ</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const maxBy = (arr, fn) => Math.max(...arr.map(typeof fn === "function" ? fn : val => val[fn]));

        class MaxByTool {
            constructor() {
                this.plugins = {};
                this.arrays = [];
                this.currentArray = null;
                this.currentMapping = null;
                this.maxValue = null;
                this.maxIndex = null;
                this.history = [];
                this.stats = {
                    totalFinds: 0,
                    totalArrays: 0,
                    mappingUsage: {}
                };
                this.arrayId = 1;
                this.mappingOptions = [
                    {
                        value: 'property',
                        label: 'å±æ€§åæ˜ å°„',
                        desc: 'é€šè¿‡å±æ€§åï¼ˆå¦‚ "n", "score"ï¼‰æ˜ å°„åˆ°å€¼',
                        type: 'property'
                    },
                    {
                        value: 'function',
                        label: 'å‡½æ•°æ˜ å°„',
                        desc: 'é€šè¿‡å‡½æ•°ï¼ˆå¦‚ x => x.nï¼‰æ˜ å°„åˆ°å€¼',
                        type: 'function'
                    },
                    {
                        value: 'custom',
                        label: 'è‡ªå®šä¹‰å‡½æ•°',
                        desc: 'ä½¿ç”¨è‡ªå®šä¹‰ JavaScript å‡½æ•°è¿›è¡Œæ˜ å°„',
                        type: 'custom'
                    }
                ];
                this.presetFunctions = [
                    {
                        value: 'x.n',
                        label: 'x => x.n',
                        desc: 'è·å–å¯¹è±¡çš„ n å±æ€§'
                    },
                    {
                        value: 'x.score',
                        label: 'x => x.score',
                        desc: 'è·å–å¯¹è±¡çš„ score å±æ€§'
                    },
                    {
                        value: 'x.value',
                        label: 'x => x.value',
                        desc: 'è·å–å¯¹è±¡çš„ value å±æ€§'
                    },
                    {
                        value: 'x.x * x.y',
                        label: 'x => x.x * x.y',
                        desc: 'è®¡ç®— x å’Œ y çš„ä¹˜ç§¯'
                    },
                    {
                        value: 'x.length',
                        label: 'x => x.length',
                        desc: 'è·å–å­—ç¬¦ä¸²æˆ–æ•°ç»„çš„é•¿åº¦'
                    }
                ];
                this.checkboxOptions = [
                    { id: 'showArray', label: 'æ˜¾ç¤ºæ•°ç»„å…ƒç´ ', checked: true },
                    { id: 'showResult', label: 'æ˜¾ç¤ºæœ€å¤§å€¼ç»“æœ', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºå¯¹æ¯”åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºä»£ç é¢„è§ˆ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupMappingSelect();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupMappingSelect() {
                const container = document.getElementById('mappingSelect');
                if (!container) return;
                try {
                    const select = new Select({
                        container,
                        options: this.mappingOptions,
                        placeholder: 'é€‰æ‹©æ˜ å°„æ–¹å¼',
                        onChange: (value) => this.onMappingChange(value)
                    });
                    select.setValue('property');
                    this.plugins.mappingSelect = select;
                    this.onMappingChange('property');
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿé€‰æ‹©æ¡†:', error);
                    const native = document.createElement('select');
                    native.className = 'input-field';
                    this.mappingOptions.forEach((option, index) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (index === 0) opt.selected = true;
                        native.appendChild(opt);
                    });
                    native.addEventListener('change', (event) => this.onMappingChange(event.target.value));
                    container.appendChild(native);
                }
            }

            onMappingChange(value) {
                const option = this.mappingOptions.find(o => o.value === value);
                if (!option) return;

                this.currentMapping = option;
                const configDiv = document.getElementById('functionConfig');
                const descDiv = document.getElementById('functionDesc');
                const propertyGroup = document.getElementById('propertyGroup');
                const customGroup = document.getElementById('customFunctionGroup');

                if (configDiv) configDiv.style.display = 'block';
                if (descDiv) descDiv.textContent = option.desc;

                if (value === 'property') {
                    if (propertyGroup) propertyGroup.style.display = 'block';
                    if (customGroup) customGroup.style.display = 'none';
                } else if (value === 'custom') {
                    if (propertyGroup) propertyGroup.style.display = 'none';
                    if (customGroup) customGroup.style.display = 'block';
                } else {
                    if (propertyGroup) propertyGroup.style.display = 'none';
                    if (customGroup) customGroup.style.display = 'none';
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: this.checkboxOptions.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    this.checkboxOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            getMappingFunction() {
                if (!this.currentMapping) {
                    const select = this.plugins.mappingSelect;
                    if (select?.getValue) {
                        const value = select.getValue();
                        this.currentMapping = this.mappingOptions.find(o => o.value === value) || this.mappingOptions[0];
                    } else {
                        const native = document.querySelector('#mappingSelect select');
                        if (native) {
                            const value = native.value;
                            this.currentMapping = this.mappingOptions.find(o => o.value === value) || this.mappingOptions[0];
                        } else {
                            this.currentMapping = this.mappingOptions[0];
                        }
                    }
                }

                if (this.currentMapping.value === 'property') {
                    const propertyInput = document.getElementById('propertyInput');
                    if (propertyInput && propertyInput.value.trim()) {
                        return propertyInput.value.trim();
                    }
                    return 'n';
                } else if (this.currentMapping.value === 'custom') {
                    const customInput = document.getElementById('customFunctionInput');
                    if (customInput && customInput.value.trim()) {
                        try {
                            return new Function('x', `return ${customInput.value}`);
                        } catch (error) {
                            throw new Error('è‡ªå®šä¹‰å‡½æ•°ä»£ç é”™è¯¯: ' + error.message);
                        }
                    }
                    return x => x.n;
                } else {
                    return x => x.n;
                }
            }

            addArray() {
                const arrayInput = document.getElementById('arrayInput');
                if (!arrayInput) return;

                const arrayStr = arrayInput.value.trim();
                if (!arrayStr) {
                    this.showError('è¯·è¾“å…¥æ•°ç»„æ•°æ®');
                    return;
                }

                try {
                    const arr = JSON.parse(arrayStr);
                    if (!Array.isArray(arr)) {
                        throw new Error('è¾“å…¥å¿…é¡»æ˜¯æ•°ç»„');
                    }

                    this.arrays.push({
                        id: this.arrayId++,
                        arr,
                        maxValue: null,
                        maxIndex: null,
                        mapping: null,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });

                    this.currentArray = arr;
                    this.displayArray();
                    arrayInput.value = '';
                    this.showNotification('æ•°ç»„å·²æ·»åŠ ', 'success');
                } catch (error) {
                    this.showError('JSON è§£æå¤±è´¥: ' + error.message);
                }
            }

            findMax() {
                if (!this.currentArray || this.currentArray.length === 0) {
                    if (this.arrays.length === 0) {
                        this.showError('è¯·å…ˆæ·»åŠ æ•°ç»„');
                        return;
                    }
                    this.currentArray = this.arrays[this.arrays.length - 1].arr;
                }

                let fn;
                try {
                    fn = this.getMappingFunction();
                } catch (error) {
                    this.showError(error.message);
                    return;
                }

                const start = performance.now();
                try {
                    const maxVal = maxBy(this.currentArray, fn);
                    const mappedValues = this.currentArray.map(typeof fn === "function" ? fn : val => val[fn]);
                    const maxIndex = mappedValues.indexOf(maxVal);
                    const end = performance.now();
                    const time = Math.round((end - start) * 1000) / 1000;

                    this.maxValue = maxVal;
                    this.maxIndex = maxIndex;

                    const currentArrayData = this.arrays[this.arrays.length - 1];
                    if (currentArrayData) {
                        currentArrayData.maxValue = maxVal;
                        currentArrayData.maxIndex = maxIndex;
                        currentArrayData.mapping = fn;
                    }

                    this.stats.totalFinds++;
                    this.stats.totalArrays += this.currentArray.length;
                    const mappingType = this.currentMapping?.value || 'property';
                    this.stats.mappingUsage[mappingType] = (this.stats.mappingUsage[mappingType] || 0) + 1;

                    this.displayArray();
                    this.displayResult();
                    this.updateStats();
                    this.addToHistory(maxVal, maxIndex, time, mappingType);

                    if (this.getCheckboxValue('showAnalysis')) {
                        this.displayAnalysis();
                    }

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode();
                    }

                    this.showNotification(`æœ€å¤§å€¼ï¼š${maxVal}ï¼Œç´¢å¼•ï¼š${maxIndex}ï¼Œç”¨æ—¶ ${time}Î¼s`, 'success');
                } catch (error) {
                    this.showError('æŸ¥æ‰¾å¤±è´¥: ' + error.message);
                }
            }

            displayArray() {
                const container = document.getElementById('arrayDisplay');
                if (!container) return;

                if (!this.getCheckboxValue('showArray')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­æ•°ç»„å…ƒç´ å±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (!this.currentArray || this.currentArray.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ æ•°ç»„åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>`;
                    return;
                }

                let fn;
                try {
                    fn = this.getMappingFunction();
                } catch (error) {
                    fn = x => x.n;
                }

                const mappedValues = this.currentArray.map(typeof fn === "function" ? fn : val => val[fn]);
                const maxVal = this.maxValue !== null ? this.maxValue : Math.max(...mappedValues);

                const html = this.currentArray.map((item, index) => {
                    const mappedVal = mappedValues[index];
                    const isMax = mappedVal === maxVal;
                    const itemClass = isMax ? 'max' : '';
                    const mappedClass = isMax ? 'max' : '';

                    return `
                        <div class="array-item ${itemClass}">
                            <div class="item-index">ç´¢å¼• ${index}</div>
                            <div class="item-content">${JSON.stringify(item, null, 2)}</div>
                            <div class="item-mapped ${mappedClass}">
                                æ˜ å°„å€¼: ${mappedVal}
                                ${isMax ? '<span class="max-badge">æœ€å¤§å€¼</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="array-grid">${html}</div>`;
            }

            displayResult() {
                const container = document.getElementById('resultDisplay');
                if (!container) return;

                if (!this.getCheckboxValue('showResult')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­æœ€å¤§å€¼ç»“æœå±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (this.maxValue === null) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡ŒæŸ¥æ‰¾åå°†åœ¨æ­¤å±•ç¤ºæœ€å¤§å€¼</p>
                        </div>`;
                    return;
                }

                container.innerHTML = `
                    <div class="result-card">
                        <div class="result-label">æœ€å¤§å€¼</div>
                        <div class="result-value">${this.maxValue}</div>
                        <div style="margin-top:16px;color:#92400e;font-size:0.9rem;">
                            ç´¢å¼•ä½ç½®: ${this.maxIndex} | 
                            æ•°ç»„é•¿åº¦: ${this.currentArray.length}
                        </div>
                        ${this.maxIndex !== null ? `
                            <div style="margin-top:12px;padding:12px;background:white;border-radius:10px;">
                                <div style="font-size:0.85rem;color:#64748b;margin-bottom:6px;">å¯¹åº”å…ƒç´ :</div>
                                <div style="font-family:'Monaco','Menlo',monospace;color:#1f2937;">
                                    ${JSON.stringify(this.currentArray[this.maxIndex], null, 2)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            displayAnalysis() {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('comparisonGrid');
                if (!card || !grid) return;

                if (!this.currentArray || this.maxValue === null) {
                    card.style.display = 'none';
                    return;
                }

                let fn;
                try {
                    fn = this.getMappingFunction();
                } catch (error) {
                    fn = x => x.n;
                }

                const mappedValues = this.currentArray.map(typeof fn === "function" ? fn : val => val[fn]);
                const minVal = Math.min(...mappedValues);
                const avgVal = mappedValues.reduce((a, b) => a + b, 0) / mappedValues.length;
                const mappingDesc = this.currentMapping?.label || 'å±æ€§åæ˜ å°„';

                grid.innerHTML = `
                    <div class="comparison-card">
                        <h4>æ•°ç»„ä¿¡æ¯</h4>
                        <p>é•¿åº¦: ${this.currentArray.length}</p>
                        <p>æœ€å¤§å€¼: ${this.maxValue}</p>
                        <p>æœ€å°å€¼: ${minVal}</p>
                        <p>å¹³å‡å€¼: ${Math.round(avgVal * 100) / 100}</p>
                    </div>
                    <div class="comparison-card">
                        <h4>æ˜ å°„æ–¹å¼</h4>
                        <p>${mappingDesc}</p>
                        <p style="font-size:0.85rem;color:#64748b;margin-top:8px;">
                            ${this.currentMapping?.desc || ''}
                        </p>
                    </div>
                    <div class="comparison-card">
                        <h4>ç»Ÿè®¡ä¿¡æ¯</h4>
                        <p>æŸ¥æ‰¾æ¬¡æ•°: ${this.stats.totalFinds}</p>
                        <p>ç´¯è®¡å…ƒç´ : ${this.stats.totalArrays}</p>
                        <p>æœ€å¤§å€¼ç´¢å¼•: ${this.maxIndex}</p>
                    </div>
                `;

                card.style.display = 'block';
            }

            addToHistory(maxVal, maxIndex, time, mappingType) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    maxValue: maxVal,
                    maxIndex,
                    arrayLength: this.currentArray.length,
                    execTime: time,
                    mappingType: mappingType || 'property'
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æŸ¥æ‰¾å†å²</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.execTime}Î¼s</div>
                        <div class="history-summary">æœ€å¤§å€¼: ${item.maxValue} | ç´¢å¼•: ${item.maxIndex} | æ•°ç»„é•¿åº¦: ${item.arrayLength}</div>
                        <div style="color:#64748b;font-size:0.8rem;margin-top:6px;">æ˜ å°„æ–¹å¼: ${item.mappingType}</div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalFinds}</div>
                        <div class="stat-label">æŸ¥æ‰¾æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalArrays}</div>
                        <div class="stat-label">ç´¯è®¡å…ƒç´ </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.currentArray ? this.currentArray.length : 0}</div>
                        <div class="stat-label">å½“å‰æ•°ç»„é•¿åº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.maxValue !== null ? this.maxValue : '-'}</div>
                        <div class="stat-label">å½“å‰æœ€å¤§å€¼</div>
                    </div>
                `;
            }

            showCode() {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;

                if (!this.currentArray || this.currentArray.length === 0) {
                    if (section) section.style.display = 'none';
                    return;
                }

                let fn = this.getMappingFunction();
                let fnCode = 'x => x.n';
                let fnDesc = 'å±æ€§åæ˜ å°„';

                if (typeof fn === 'string') {
                    fnCode = `'${fn}'`;
                    fnDesc = `å±æ€§å "${fn}"`;
                } else if (this.currentMapping?.value === 'custom') {
                    const customInput = document.getElementById('customFunctionInput');
                    fnCode = customInput?.value || 'x => x.n';
                    fnDesc = 'è‡ªå®šä¹‰å‡½æ•°';
                } else {
                    fnCode = 'x => x.n';
                    fnDesc = 'å‡½æ•°æ˜ å°„';
                }

                const code = `const maxBy = (arr, fn) => 
  Math.max(...arr.map(typeof fn === "function" ? fn : val => val[fn]));

const arr = ${JSON.stringify(this.currentArray, null, 2)};

// æ˜ å°„æ–¹å¼ï¼š${fnDesc}
const fn = ${fnCode};

// æŸ¥æ‰¾æœ€å¤§å€¼
const maxValue = maxBy(arr, fn);
console.log(maxValue); // ${this.maxValue !== null ? this.maxValue : 'ç»“æœ'}

// è·å–æ˜ å°„åçš„æ‰€æœ‰å€¼
const mappedValues = arr.map(typeof fn === "function" ? fn : val => val[fn]);
console.log(mappedValues); // ${JSON.stringify(this.currentArray.map(typeof fn === "function" ? fn : val => val[fn]))}

// æŸ¥æ‰¾æœ€å¤§å€¼å¯¹åº”çš„å…ƒç´ 
const maxIndex = mappedValues.indexOf(maxValue);
const maxElement = arr[maxIndex];
console.log(maxElement); // ${JSON.stringify(this.maxIndex !== null ? this.currentArray[this.maxIndex] : {})}`;

                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            clearAll() {
                this.arrays = [];
                this.currentArray = null;
                this.maxValue = null;
                this.maxIndex = null;
                const arrayInput = document.getElementById('arrayInput');
                if (arrayInput) arrayInput.value = '';
                this.displayArray();
                this.displayResult();
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                this.showNotification('å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®', 'info');
            }

            loadSample() {
                const arrayInput = document.getElementById('arrayInput');
                if (arrayInput) {
                    arrayInput.value = JSON.stringify([{ n: 4 }, { n: 2 }, { n: 8 }, { n: 6 }], null, 2);
                }
                const propertyInput = document.getElementById('propertyInput');
                if (propertyInput) {
                    propertyInput.value = 'n';
                }
                const mappingSelect = this.plugins.mappingSelect;
                if (mappingSelect?.setValue) {
                    mappingSelect.setValue('property');
                    this.onMappingChange('property');
                } else {
                    const native = document.querySelector('#mappingSelect select');
                    if (native) {
                        native.value = 'property';
                        this.onMappingChange('property');
                    }
                }
                this.showNotification('ç¤ºä¾‹æ•°æ®å·²åŠ è½½', 'info');
            }

            generateRandom() {
                const count = Math.floor(Math.random() * 5) + 5;
                const randomArray = [];
                for (let i = 0; i < count; i++) {
                    randomArray.push({
                        n: Math.floor(Math.random() * 100),
                        score: Math.floor(Math.random() * 1000),
                        value: Math.random() * 100
                    });
                }
                const arrayInput = document.getElementById('arrayInput');
                if (arrayInput) {
                    arrayInput.value = JSON.stringify(randomArray, null, 2);
                }
                this.showNotification(`å·²ç”Ÿæˆ ${count} ä¸ªéšæœºå¯¹è±¡`, 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨æœ€å¤§å€¼æŸ¥æ‰¾å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">ğŸ“Š</div>
                                <p style="color:#1f2937;line-height:1.8;">
                                    ä½¿ç”¨ <strong>maxBy</strong> å‡½æ•°å¿«é€ŸæŸ¥æ‰¾æ•°ç»„ä¸­çš„æœ€å¤§å€¼ï¼Œæ”¯æŒå±æ€§åæ˜ å°„ã€å‡½æ•°æ˜ å°„å’Œè‡ªå®šä¹‰å‡½æ•°ï¼Œå¯è§†åŒ–å±•ç¤ºæ¯ä¸ªå…ƒç´ çš„æ˜ å°„å€¼å’Œæœ€å¤§å€¼ã€‚
                                </p>
                                <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;border-radius:12px;color:#92400e;margin-top:12px;">
                                    <strong>äº®ç‚¹ï¼š</strong> å¤šç§æ˜ å°„æ–¹å¼ã€å¯è§†åŒ–å±•ç¤ºã€æœ€å¤§å€¼é«˜äº®ã€è¯¦ç»†åˆ†æã€ä»£ç é¢„è§ˆã€å†å²è®°å½•ã€‚
                                </div>
                                <ul style="color:#1f2937;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>æ”¯æŒå±æ€§åæ˜ å°„ï¼ˆå¦‚ "n", "score"ï¼‰å’Œå‡½æ•°æ˜ å°„ï¼ˆå¦‚ x => x.nï¼‰</li>
                                    <li>å¯è§†åŒ–å±•ç¤ºæ¯ä¸ªæ•°ç»„å…ƒç´ åŠå…¶æ˜ å°„å€¼</li>
                                    <li>è‡ªåŠ¨é«˜äº®æ˜¾ç¤ºæœ€å¤§å€¼å…ƒç´ </li>
                                    <li>æä¾›è¯¦ç»†çš„å¯¹æ¯”åˆ†æå’Œç»Ÿè®¡ä¿¡æ¯</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.maxByTool = new MaxByTool();
        });

        if (document.readyState !== 'loading' && !window.maxByTool) {
            window.maxByTool = new MaxByTool();
        }
    </script>
</body>

</html>
