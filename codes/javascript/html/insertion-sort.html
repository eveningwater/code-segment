<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插入排序可视化器与算法演示工具</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-header p {
            font-size: 1.1rem;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .array-input-section {
            margin-bottom: 20px;
        }

        .array-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .array-input-section textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .sort-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sort-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sort-group label {
            font-weight: 600;
            color: #555;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .preview-header h3 {
            color: #333;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .sort-visualization {
            margin-bottom: 30px;
        }

        .sort-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            min-height: 120px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #e9ecef;
            align-items: center;
            justify-content: center;
        }

        .sort-container.empty {
            color: #666;
            font-size: 1.1rem;
        }

        .sort-item {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease;
            position: relative;
            cursor: pointer;
        }

        .sort-item:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .sort-item.comparing {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 0.8s infinite;
        }

        .sort-item.sorted {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .sort-item.inserting {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            animation: bounce 0.6s ease-in-out;
        }

        .sort-item .index {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: normal;
        }

        .sort-item .value {
            font-size: 1.1rem;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .step-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .step-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .step-info p {
            color: #424242;
            line-height: 1.6;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4facfe;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .template-gallery {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .template-gallery h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .template-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .template-item:hover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .template-item h5 {
            margin-bottom: 8px;
            color: #333;
        }

        .template-item p {
            font-size: 0.9rem;
            color: #666;
        }

        .algorithm-explanation {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .algorithm-explanation h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .algorithm-explanation p {
            color: #424242;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .algorithm-explanation code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: #e83e8c;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 2rem;
            }
            
            .preview-actions {
                flex-direction: column;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
            
            .sort-item {
                min-width: 50px;
                height: 50px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>🔢 插入排序可视化器</h1>
            <p>基于 insertionSort 函数的算法演示工具</p>
        </header>

        <main class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>📝 数组输入</h3>
                    <div class="array-input-section">
                        <label>输入数组 (用逗号分隔):</label>
                        <textarea id="array-input" placeholder="例如: 6, 3, 4, 1, 8, 2">6, 3, 4, 1, 8, 2</textarea>
                    </div>
                </div>

                <div class="control-section">
                    <h3>⚙️ 排序控制</h3>
                    <div class="sort-controls">
                        <div class="sort-group">
                            <label>排序速度:</label>
                            <div id="speed-select"></div>
                        </div>
                        <div class="sort-group">
                            <label>显示步骤:</label>
                            <div id="step-toggle"></div>
                        </div>
                        <div class="action-buttons">
                            <button id="start-sort-btn" class="btn btn-primary">开始排序</button>
                            <button id="step-sort-btn" class="btn btn-secondary">单步执行</button>
                            <button id="reset-btn" class="btn btn-warning">重置</button>
                            <button id="random-array-btn" class="btn btn-success">随机数组</button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>🔧 高级选项</h3>
                    <div id="advanced-options">
                        <!-- 复选框将在这里动态生成 -->
                    </div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="preview-header">
                    <h3>👁️ 排序可视化</h3>
                    <div class="preview-actions">
                        <button id="pause-btn" class="btn btn-secondary" disabled>暂停</button>
                        <button id="resume-btn" class="btn btn-secondary" disabled>继续</button>
                        <button id="export-btn" class="btn btn-success">导出结果</button>
                    </div>
                </div>

                <div class="sort-visualization">
                    <h4>当前数组状态</h4>
                    <div class="sort-container" id="sort-container">
                        <div class="sort-container empty">
                            请输入数组并开始排序
                        </div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="step-info" id="step-info" style="display: none;">
                    <h4>当前步骤</h4>
                    <p id="step-description">准备开始排序...</p>
                </div>

                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-value" id="array-length">0</div>
                        <div class="stat-label">数组长度</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="comparisons">0</div>
                        <div class="stat-label">比较次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="swaps">0</div>
                        <div class="stat-label">插入次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="current-step">0</div>
                        <div class="stat-label">当前步骤</div>
                    </div>
                </div>

                <div class="template-gallery">
                    <h4>📋 快速测试数组</h4>
                    <div class="template-grid">
                        <div class="template-item" data-template="small">
                            <h5>小数组</h5>
                            <p>快速测试排序</p>
                        </div>
                        <div class="template-item" data-template="medium">
                            <h5>中等数组</h5>
                            <p>标准测试用例</p>
                        </div>
                        <div class="template-item" data-template="large">
                            <h5>大数组</h5>
                            <p>性能测试</p>
                        </div>
                        <div class="template-item" data-template="reverse">
                            <h5>逆序数组</h5>
                            <p>最坏情况测试</p>
                        </div>
                    </div>
                </div>

                <div class="algorithm-explanation">
                    <h4>📚 插入排序算法说明</h4>
                    <p><strong>插入排序</strong>是一种简单直观的排序算法，它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入。</p>
                    <p><strong>算法步骤：</strong></p>
                    <ol style="margin-left: 20px; color: #424242;">
                        <li>从第一个元素开始，该元素可以认为已经被排序</li>
                        <li>取出下一个元素，在已经排序的元素序列中从后向前扫描</li>
                        <li>如果该元素（已排序）大于新元素，将该元素移到下一位置</li>
                        <li>重复步骤3，直到找到已排序的元素小于或者等于新元素的位置</li>
                        <li>将新元素插入到该位置后</li>
                        <li>重复步骤2~5</li>
                    </ol>
                    <p><strong>时间复杂度：</strong> <code>O(n²)</code>，<strong>空间复杂度：</strong> <code>O(1)</code></p>
                </div>
            </div>
        </main>
    </div>

    <!-- 引入插件 -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>

    <script>
        // 核心函数
        const insertionSort = arr =>
            arr.reduce((res, i) => {
                if (!res.length) {
                    return [i];
                }
                res.some((j, index) => {
                    if (i <= j) {
                        res.splice(index, 0, i);
                        return true;
                    }
                    if (i >= j && index === res.length - 1) {
                        res.splice(index + 1, 0, i);
                        return true;
                    }
                    return false;
                });
                return res;
            }, []);

        // 插入排序可视化器主类
        class InsertionSortVisualizer {
            constructor() {
                this.array = [6, 3, 4, 1, 8, 2];
                this.originalArray = [...this.array];
                this.sortedArray = [];
                this.currentStep = 0;
                this.totalSteps = 0;
                this.comparisons = 0;
                this.insertions = 0;
                this.isSorting = false;
                this.isPaused = false;
                this.sortInterval = null;
                this.sortSpeed = 1000;
                this.showSteps = true;
                this.advancedOptions = {
                    highlightComparing: true,
                    showAnimations: true,
                    autoProgress: true
                };

                this.modal = new Modal();
                this.notification = new Notification();
                
                this.init();
            }

            init() {
                this.setupControls();
                this.setupEventListeners();
                this.renderArray();
                this.updateStats();
                this.calculateTotalSteps();
            }

            setupControls() {
                // 排序速度选择器
                this.speedSelect = new Select({
                    container: '#speed-select',
                    options: [
                        { value: 2000, label: '慢速 (2秒)' },
                        { value: 1000, label: '中速 (1秒)' },
                        { value: 500, label: '快速 (0.5秒)' },
                        { value: 200, label: '极速 (0.2秒)' }
                    ],
                    onChange: (value) => {
                        this.sortSpeed = parseInt(value);
                    }
                });

                // 显示步骤开关
                this.stepToggle = new Select({
                    container: '#step-toggle',
                    options: [
                        { value: 'true', label: '显示步骤' },
                        { value: 'false', label: '隐藏步骤' }
                    ],
                    onChange: (value) => {
                        this.showSteps = value === 'true';
                        document.getElementById('step-info').style.display = this.showSteps ? 'block' : 'none';
                    }
                });

                // 高级选项复选框
                try {
                    const container = document.querySelector('#advanced-options');
                    if (container) {
                        this.advancedOptionsGroup = Checkbox.createCheckboxGroup({
                            items: [
                                { label: '高亮比较元素', checked: true },
                                { label: '显示动画效果', checked: true },
                                { label: '自动进度条', checked: true }
                            ],
                            onChange: (values) => {
                                this.advancedOptions.highlightComparing = values[0];
                                this.advancedOptions.showAnimations = values[1];
                                this.advancedOptions.autoProgress = values[2];
                                
                                // 更新全选复选框状态
                                this.updateAllCheckboxState();
                            }
                        });
                        
                        container.appendChild(this.advancedOptionsGroup.container);
                        
                        // 修复全选复选框的初始状态
                        this.updateAllCheckboxState();
                    }
                } catch (error) {
                    console.warn('复选框插件加载失败，使用默认选项');
                }
            }

            setupEventListeners() {
                // 开始排序按钮
                document.getElementById('start-sort-btn').addEventListener('click', () => {
                    this.startSort();
                });

                // 单步执行按钮
                document.getElementById('step-sort-btn').addEventListener('click', () => {
                    this.stepSort();
                });

                // 重置按钮
                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.resetSort();
                });

                // 随机数组按钮
                document.getElementById('random-array-btn').addEventListener('click', () => {
                    this.generateRandomArray();
                });

                // 暂停按钮
                document.getElementById('pause-btn').addEventListener('click', () => {
                    this.pauseSort();
                });

                // 继续按钮
                document.getElementById('resume-btn').addEventListener('click', () => {
                    this.resumeSort();
                });

                // 导出按钮
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportResults();
                });

                // 数组输入变化
                document.getElementById('array-input').addEventListener('input', (e) => {
                    this.parseArrayInput(e.target.value);
                });

                // 模板点击
                document.querySelectorAll('.template-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const template = item.dataset.template;
                        this.loadTemplate(template);
                    });
                });
            }

            parseArrayInput(input) {
                try {
                    const newArray = input.split(',').map(item => {
                        const trimmed = item.trim();
                        return isNaN(trimmed) ? 0 : Number(trimmed);
                    }).filter(item => item !== 0);
                    
                    if (newArray.length > 0) {
                        this.array = newArray;
                        this.originalArray = [...this.array];
                        this.sortedArray = [];
                        this.currentStep = 0;
                        this.comparisons = 0;
                        this.insertions = 0;
                        this.renderArray();
                        this.updateStats();
                        this.calculateTotalSteps();
                        this.updateProgress();
                    }
                } catch (error) {
                    console.warn('数组解析失败:', error);
                }
            }

            calculateTotalSteps() {
                // 计算总步骤数（每个元素都需要插入）
                this.totalSteps = this.array.length;
                document.getElementById('current-step').textContent = `${this.currentStep}/${this.totalSteps}`;
            }

            startSort() {
                if (this.isSorting) return;

                this.isSorting = true;
                this.isPaused = false;
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('start-sort-btn').disabled = true;
                document.getElementById('step-sort-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('resume-btn').disabled = true;

                this.sortInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.stepSort();
                    }
                }, this.sortSpeed);
            }

            stepSort() {
                if (this.currentStep >= this.array.length) {
                    this.finishSort();
                    return;
                }

                const currentElement = this.array[this.currentStep];
                this.currentStep++;
                this.comparisons++;

                // 找到插入位置
                let insertIndex = this.sortedArray.length;
                for (let i = 0; i < this.sortedArray.length; i++) {
                    if (currentElement <= this.sortedArray[i]) {
                        insertIndex = i;
                        break;
                    }
                }

                // 插入元素
                this.sortedArray.splice(insertIndex, 0, currentElement);
                this.insertions++;

                // 更新显示
                this.renderSortedArray();
                this.updateStats();
                this.updateProgress();
                this.updateStepInfo(currentElement, insertIndex);

                if (this.currentStep >= this.array.length) {
                    this.finishSort();
                }
            }

            updateStepInfo(element, insertIndex) {
                if (!this.showSteps) return;

                const stepInfo = document.getElementById('step-info');
                const stepDescription = document.getElementById('step-description');
                
                stepInfo.style.display = 'block';
                stepDescription.innerHTML = `
                    步骤 ${this.currentStep}: 将元素 <strong>${element}</strong> 插入到位置 <strong>${insertIndex}</strong><br>
                    当前已排序数组: [${this.sortedArray.join(', ')}]<br>
                    剩余未排序元素: [${this.array.slice(this.currentStep).join(', ')}]
                `;
            }

            pauseSort() {
                if (!this.isSorting) return;
                
                this.isPaused = true;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = false;
            }

            resumeSort() {
                if (!this.isSorting) return;
                
                this.isPaused = false;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('resume-btn').disabled = true;
            }

            finishSort() {
                this.isSorting = false;
                clearInterval(this.sortInterval);
                
                document.getElementById('start-sort-btn').disabled = false;
                document.getElementById('step-sort-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;

                // 显示完成信息
                if (this.showSteps) {
                    const stepInfo = document.getElementById('step-info');
                    const stepDescription = document.getElementById('step-description');
                    
                    stepInfo.style.display = 'block';
                    stepDescription.innerHTML = `
                        <strong>🎉 排序完成！</strong><br>
                        最终排序结果: [${this.sortedArray.join(', ')}]<br>
                        总比较次数: ${this.comparisons}, 总插入次数: ${this.insertions}
                    `;
                }

                this.notification.success('排序完成！');
            }

            resetSort() {
                this.isSorting = false;
                this.isPaused = false;
                clearInterval(this.sortInterval);
                
                this.array = [...this.originalArray];
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('start-sort-btn').disabled = false;
                document.getElementById('step-sort-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;

                this.renderArray();
                this.updateStats();
                this.updateProgress();
                document.getElementById('step-info').style.display = 'none';
            }

            generateRandomArray() {
                const length = Math.floor(Math.random() * 10) + 5; // 5-14个元素
                this.array = Array.from({length}, () => Math.floor(Math.random() * 100) + 1);
                this.originalArray = [...this.array];
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('array-input').value = this.array.join(', ');
                this.renderArray();
                this.updateStats();
                this.calculateTotalSteps();
                this.updateProgress();
                document.getElementById('step-info').style.display = 'none';
                
                this.notification.success('已生成随机数组');
            }

            exportResults() {
                const data = {
                    originalArray: this.array,
                    sortedArray: this.sortedArray,
                    comparisons: this.comparisons,
                    insertions: this.insertions,
                    totalSteps: this.totalSteps,
                    exportedAt: new Date().toISOString()
                };

                const arrayStr = JSON.stringify(data, null, 2);
                const blob = new Blob([arrayStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `insertion-sort-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                this.notification.success('排序结果导出成功！');
            }

            renderArray() {
                const container = document.getElementById('sort-container');
                
                if (this.array.length === 0) {
                    container.innerHTML = '<div class="sort-container empty">数组为空</div>';
                    return;
                }

                container.innerHTML = '';
                
                this.array.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item';
                    itemElement.innerHTML = `
                        <div class="index">${index}</div>
                        <div class="value">${item}</div>
                    `;
                    
                    if (index < this.currentStep) {
                        itemElement.classList.add('sorted');
                    } else if (index === this.currentStep) {
                        itemElement.classList.add('comparing');
                    }
                    
                    container.appendChild(itemElement);
                });
            }

            renderSortedArray() {
                const container = document.getElementById('sort-container');
                container.innerHTML = '';
                
                this.sortedArray.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item sorted';
                    itemElement.innerHTML = `
                        <div class="index">${index}</div>
                        <div class="value">${item}</div>
                    `;
                    container.appendChild(itemElement);
                });

                // 显示剩余未排序的元素
                const remainingElements = this.array.slice(this.currentStep);
                remainingElements.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item';
                    itemElement.innerHTML = `
                        <div class="index">${this.currentStep + index}</div>
                        <div class="value">${item}</div>
                    `;
                    container.appendChild(itemElement);
                });
            }

            updateStats() {
                document.getElementById('array-length').textContent = this.array.length;
                document.getElementById('comparisons').textContent = this.comparisons;
                document.getElementById('swaps').textContent = this.insertions;
                document.getElementById('current-step').textContent = `${this.currentStep}/${this.totalSteps}`;
            }

            updateProgress() {
                if (!this.advancedOptions.autoProgress) return;
                
                const progress = (this.currentStep / this.totalSteps) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
            }

            loadTemplate(templateName) {
                const templates = {
                    small: [3, 1, 2],
                    medium: [6, 3, 4, 1, 8, 2],
                    large: [9, 7, 5, 3, 1, 8, 6, 4, 2, 0],
                    reverse: [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]
                };

                const template = templates[templateName];
                if (template) {
                    this.array = [...template];
                    this.originalArray = [...this.array];
                    this.sortedArray = [];
                    this.currentStep = 0;
                    this.comparisons = 0;
                    this.insertions = 0;
                    
                    document.getElementById('array-input').value = this.array.join(', ');
                    this.renderArray();
                    this.updateStats();
                    this.calculateTotalSteps();
                    this.updateProgress();
                    document.getElementById('step-info').style.display = 'none';
                    
                    this.notification.success(`已加载 ${templateName} 模板`);
                }
            }

            updateAllCheckboxState() {
                if (this.advancedOptionsGroup && this.advancedOptionsGroup.checkboxes) {
                    const allChecked = this.advancedOptionsGroup.checkboxes.every(cb => cb.isChecked());
                    const noneChecked = this.advancedOptionsGroup.checkboxes.every(cb => !cb.isChecked());
                    
                    // 更新全选复选框的状态，但不触发onChange事件
                    if (this.advancedOptionsGroup.allCheckbox) {
                        // 直接设置状态，避免调用setChecked方法
                        this.advancedOptionsGroup.allCheckbox.checked = allChecked;
                        const allCheckboxInput = this.advancedOptionsGroup.allCheckbox.element.querySelector('.checkbox-input');
                        if (allCheckboxInput) {
                            allCheckboxInput.checked = allChecked;
                            allCheckboxInput.indeterminate = !allChecked && !noneChecked;
                        }
                    }
                }
            }
        }

        // 初始化应用
        let app;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                app = new InsertionSortVisualizer();
            });
        } else {
            app = new InsertionSortVisualizer();
        }
    </script>
</body>
</html>