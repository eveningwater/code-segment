<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’å…¥æ’åºå¯è§†åŒ–å™¨ä¸ç®—æ³•æ¼”ç¤ºå·¥å…·</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-header p {
            font-size: 1.1rem;
            color: #666;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .array-input-section {
            margin-bottom: 20px;
        }

        .array-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .array-input-section textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .sort-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sort-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sort-group label {
            font-weight: 600;
            color: #555;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .preview-header h3 {
            color: #333;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .sort-visualization {
            margin-bottom: 30px;
        }

        .sort-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            min-height: 120px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #e9ecef;
            align-items: center;
            justify-content: center;
        }

        .sort-container.empty {
            color: #666;
            font-size: 1.1rem;
        }

        .sort-item {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease;
            position: relative;
            cursor: pointer;
        }

        .sort-item:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .sort-item.comparing {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 0.8s infinite;
        }

        .sort-item.sorted {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .sort-item.inserting {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            animation: bounce 0.6s ease-in-out;
        }

        .sort-item .index {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: normal;
        }

        .sort-item .value {
            font-size: 1.1rem;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .step-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .step-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .step-info p {
            color: #424242;
            line-height: 1.6;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4facfe;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .template-gallery {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .template-gallery h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .template-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .template-item:hover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .template-item h5 {
            margin-bottom: 8px;
            color: #333;
        }

        .template-item p {
            font-size: 0.9rem;
            color: #666;
        }

        .algorithm-explanation {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .algorithm-explanation h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .algorithm-explanation p {
            color: #424242;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .algorithm-explanation code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: #e83e8c;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 2rem;
            }
            
            .preview-actions {
                flex-direction: column;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
            
            .sort-item {
                min-width: 50px;
                height: 50px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>ğŸ”¢ æ’å…¥æ’åºå¯è§†åŒ–å™¨</h1>
            <p>åŸºäº insertionSort å‡½æ•°çš„ç®—æ³•æ¼”ç¤ºå·¥å…·</p>
        </header>

        <main class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>ğŸ“ æ•°ç»„è¾“å…¥</h3>
                    <div class="array-input-section">
                        <label>è¾“å…¥æ•°ç»„ (ç”¨é€—å·åˆ†éš”):</label>
                        <textarea id="array-input" placeholder="ä¾‹å¦‚: 6, 3, 4, 1, 8, 2">6, 3, 4, 1, 8, 2</textarea>
                    </div>
                </div>

                <div class="control-section">
                    <h3>âš™ï¸ æ’åºæ§åˆ¶</h3>
                    <div class="sort-controls">
                        <div class="sort-group">
                            <label>æ’åºé€Ÿåº¦:</label>
                            <div id="speed-select"></div>
                        </div>
                        <div class="sort-group">
                            <label>æ˜¾ç¤ºæ­¥éª¤:</label>
                            <div id="step-toggle"></div>
                        </div>
                        <div class="action-buttons">
                            <button id="start-sort-btn" class="btn btn-primary">å¼€å§‹æ’åº</button>
                            <button id="step-sort-btn" class="btn btn-secondary">å•æ­¥æ‰§è¡Œ</button>
                            <button id="reset-btn" class="btn btn-warning">é‡ç½®</button>
                            <button id="random-array-btn" class="btn btn-success">éšæœºæ•°ç»„</button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>ğŸ”§ é«˜çº§é€‰é¡¹</h3>
                    <div id="advanced-options">
                        <!-- å¤é€‰æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="preview-header">
                    <h3>ğŸ‘ï¸ æ’åºå¯è§†åŒ–</h3>
                    <div class="preview-actions">
                        <button id="pause-btn" class="btn btn-secondary" disabled>æš‚åœ</button>
                        <button id="resume-btn" class="btn btn-secondary" disabled>ç»§ç»­</button>
                        <button id="export-btn" class="btn btn-success">å¯¼å‡ºç»“æœ</button>
                    </div>
                </div>

                <div class="sort-visualization">
                    <h4>å½“å‰æ•°ç»„çŠ¶æ€</h4>
                    <div class="sort-container" id="sort-container">
                        <div class="sort-container empty">
                            è¯·è¾“å…¥æ•°ç»„å¹¶å¼€å§‹æ’åº
                        </div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="step-info" id="step-info" style="display: none;">
                    <h4>å½“å‰æ­¥éª¤</h4>
                    <p id="step-description">å‡†å¤‡å¼€å§‹æ’åº...</p>
                </div>

                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-value" id="array-length">0</div>
                        <div class="stat-label">æ•°ç»„é•¿åº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="comparisons">0</div>
                        <div class="stat-label">æ¯”è¾ƒæ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="swaps">0</div>
                        <div class="stat-label">æ’å…¥æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="current-step">0</div>
                        <div class="stat-label">å½“å‰æ­¥éª¤</div>
                    </div>
                </div>

                <div class="template-gallery">
                    <h4>ğŸ“‹ å¿«é€Ÿæµ‹è¯•æ•°ç»„</h4>
                    <div class="template-grid">
                        <div class="template-item" data-template="small">
                            <h5>å°æ•°ç»„</h5>
                            <p>å¿«é€Ÿæµ‹è¯•æ’åº</p>
                        </div>
                        <div class="template-item" data-template="medium">
                            <h5>ä¸­ç­‰æ•°ç»„</h5>
                            <p>æ ‡å‡†æµ‹è¯•ç”¨ä¾‹</p>
                        </div>
                        <div class="template-item" data-template="large">
                            <h5>å¤§æ•°ç»„</h5>
                            <p>æ€§èƒ½æµ‹è¯•</p>
                        </div>
                        <div class="template-item" data-template="reverse">
                            <h5>é€†åºæ•°ç»„</h5>
                            <p>æœ€åæƒ…å†µæµ‹è¯•</p>
                        </div>
                    </div>
                </div>

                <div class="algorithm-explanation">
                    <h4>ğŸ“š æ’å…¥æ’åºç®—æ³•è¯´æ˜</h4>
                    <p><strong>æ’å…¥æ’åº</strong>æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ï¼Œå®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚</p>
                    <p><strong>ç®—æ³•æ­¥éª¤ï¼š</strong></p>
                    <ol style="margin-left: 20px; color: #424242;">
                        <li>ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åº</li>
                        <li>å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æ</li>
                        <li>å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®</li>
                        <li>é‡å¤æ­¥éª¤3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®</li>
                        <li>å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®å</li>
                        <li>é‡å¤æ­¥éª¤2~5</li>
                    </ol>
                    <p><strong>æ—¶é—´å¤æ‚åº¦ï¼š</strong> <code>O(nÂ²)</code>ï¼Œ<strong>ç©ºé—´å¤æ‚åº¦ï¼š</strong> <code>O(1)</code></p>
                </div>
            </div>
        </main>
    </div>

    <!-- å¼•å…¥æ’ä»¶ -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>

    <script>
        // æ ¸å¿ƒå‡½æ•°
        const insertionSort = arr =>
            arr.reduce((res, i) => {
                if (!res.length) {
                    return [i];
                }
                res.some((j, index) => {
                    if (i <= j) {
                        res.splice(index, 0, i);
                        return true;
                    }
                    if (i >= j && index === res.length - 1) {
                        res.splice(index + 1, 0, i);
                        return true;
                    }
                    return false;
                });
                return res;
            }, []);

        // æ’å…¥æ’åºå¯è§†åŒ–å™¨ä¸»ç±»
        class InsertionSortVisualizer {
            constructor() {
                this.array = [6, 3, 4, 1, 8, 2];
                this.originalArray = [...this.array];
                this.sortedArray = [];
                this.currentStep = 0;
                this.totalSteps = 0;
                this.comparisons = 0;
                this.insertions = 0;
                this.isSorting = false;
                this.isPaused = false;
                this.sortInterval = null;
                this.sortSpeed = 1000;
                this.showSteps = true;
                this.advancedOptions = {
                    highlightComparing: true,
                    showAnimations: true,
                    autoProgress: true
                };

                this.modal = new Modal();
                this.notification = new Notification();
                
                this.init();
            }

            init() {
                this.setupControls();
                this.setupEventListeners();
                this.renderArray();
                this.updateStats();
                this.calculateTotalSteps();
            }

            setupControls() {
                // æ’åºé€Ÿåº¦é€‰æ‹©å™¨
                this.speedSelect = new Select({
                    container: '#speed-select',
                    options: [
                        { value: 2000, label: 'æ…¢é€Ÿ (2ç§’)' },
                        { value: 1000, label: 'ä¸­é€Ÿ (1ç§’)' },
                        { value: 500, label: 'å¿«é€Ÿ (0.5ç§’)' },
                        { value: 200, label: 'æé€Ÿ (0.2ç§’)' }
                    ],
                    onChange: (value) => {
                        this.sortSpeed = parseInt(value);
                    }
                });

                // æ˜¾ç¤ºæ­¥éª¤å¼€å…³
                this.stepToggle = new Select({
                    container: '#step-toggle',
                    options: [
                        { value: 'true', label: 'æ˜¾ç¤ºæ­¥éª¤' },
                        { value: 'false', label: 'éšè—æ­¥éª¤' }
                    ],
                    onChange: (value) => {
                        this.showSteps = value === 'true';
                        document.getElementById('step-info').style.display = this.showSteps ? 'block' : 'none';
                    }
                });

                // é«˜çº§é€‰é¡¹å¤é€‰æ¡†
                try {
                    const container = document.querySelector('#advanced-options');
                    if (container) {
                        this.advancedOptionsGroup = Checkbox.createCheckboxGroup({
                            items: [
                                { label: 'é«˜äº®æ¯”è¾ƒå…ƒç´ ', checked: true },
                                { label: 'æ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ', checked: true },
                                { label: 'è‡ªåŠ¨è¿›åº¦æ¡', checked: true }
                            ],
                            onChange: (values) => {
                                this.advancedOptions.highlightComparing = values[0];
                                this.advancedOptions.showAnimations = values[1];
                                this.advancedOptions.autoProgress = values[2];
                                
                                // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
                                this.updateAllCheckboxState();
                            }
                        });
                        
                        container.appendChild(this.advancedOptionsGroup.container);
                        
                        // ä¿®å¤å…¨é€‰å¤é€‰æ¡†çš„åˆå§‹çŠ¶æ€
                        this.updateAllCheckboxState();
                    }
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹');
                }
            }

            setupEventListeners() {
                // å¼€å§‹æ’åºæŒ‰é’®
                document.getElementById('start-sort-btn').addEventListener('click', () => {
                    this.startSort();
                });

                // å•æ­¥æ‰§è¡ŒæŒ‰é’®
                document.getElementById('step-sort-btn').addEventListener('click', () => {
                    this.stepSort();
                });

                // é‡ç½®æŒ‰é’®
                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.resetSort();
                });

                // éšæœºæ•°ç»„æŒ‰é’®
                document.getElementById('random-array-btn').addEventListener('click', () => {
                    this.generateRandomArray();
                });

                // æš‚åœæŒ‰é’®
                document.getElementById('pause-btn').addEventListener('click', () => {
                    this.pauseSort();
                });

                // ç»§ç»­æŒ‰é’®
                document.getElementById('resume-btn').addEventListener('click', () => {
                    this.resumeSort();
                });

                // å¯¼å‡ºæŒ‰é’®
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportResults();
                });

                // æ•°ç»„è¾“å…¥å˜åŒ–
                document.getElementById('array-input').addEventListener('input', (e) => {
                    this.parseArrayInput(e.target.value);
                });

                // æ¨¡æ¿ç‚¹å‡»
                document.querySelectorAll('.template-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const template = item.dataset.template;
                        this.loadTemplate(template);
                    });
                });
            }

            parseArrayInput(input) {
                try {
                    const newArray = input.split(',').map(item => {
                        const trimmed = item.trim();
                        return isNaN(trimmed) ? 0 : Number(trimmed);
                    }).filter(item => item !== 0);
                    
                    if (newArray.length > 0) {
                        this.array = newArray;
                        this.originalArray = [...this.array];
                        this.sortedArray = [];
                        this.currentStep = 0;
                        this.comparisons = 0;
                        this.insertions = 0;
                        this.renderArray();
                        this.updateStats();
                        this.calculateTotalSteps();
                        this.updateProgress();
                    }
                } catch (error) {
                    console.warn('æ•°ç»„è§£æå¤±è´¥:', error);
                }
            }

            calculateTotalSteps() {
                // è®¡ç®—æ€»æ­¥éª¤æ•°ï¼ˆæ¯ä¸ªå…ƒç´ éƒ½éœ€è¦æ’å…¥ï¼‰
                this.totalSteps = this.array.length;
                document.getElementById('current-step').textContent = `${this.currentStep}/${this.totalSteps}`;
            }

            startSort() {
                if (this.isSorting) return;

                this.isSorting = true;
                this.isPaused = false;
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('start-sort-btn').disabled = true;
                document.getElementById('step-sort-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('resume-btn').disabled = true;

                this.sortInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.stepSort();
                    }
                }, this.sortSpeed);
            }

            stepSort() {
                if (this.currentStep >= this.array.length) {
                    this.finishSort();
                    return;
                }

                const currentElement = this.array[this.currentStep];
                this.currentStep++;
                this.comparisons++;

                // æ‰¾åˆ°æ’å…¥ä½ç½®
                let insertIndex = this.sortedArray.length;
                for (let i = 0; i < this.sortedArray.length; i++) {
                    if (currentElement <= this.sortedArray[i]) {
                        insertIndex = i;
                        break;
                    }
                }

                // æ’å…¥å…ƒç´ 
                this.sortedArray.splice(insertIndex, 0, currentElement);
                this.insertions++;

                // æ›´æ–°æ˜¾ç¤º
                this.renderSortedArray();
                this.updateStats();
                this.updateProgress();
                this.updateStepInfo(currentElement, insertIndex);

                if (this.currentStep >= this.array.length) {
                    this.finishSort();
                }
            }

            updateStepInfo(element, insertIndex) {
                if (!this.showSteps) return;

                const stepInfo = document.getElementById('step-info');
                const stepDescription = document.getElementById('step-description');
                
                stepInfo.style.display = 'block';
                stepDescription.innerHTML = `
                    æ­¥éª¤ ${this.currentStep}: å°†å…ƒç´  <strong>${element}</strong> æ’å…¥åˆ°ä½ç½® <strong>${insertIndex}</strong><br>
                    å½“å‰å·²æ’åºæ•°ç»„: [${this.sortedArray.join(', ')}]<br>
                    å‰©ä½™æœªæ’åºå…ƒç´ : [${this.array.slice(this.currentStep).join(', ')}]
                `;
            }

            pauseSort() {
                if (!this.isSorting) return;
                
                this.isPaused = true;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = false;
            }

            resumeSort() {
                if (!this.isSorting) return;
                
                this.isPaused = false;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('resume-btn').disabled = true;
            }

            finishSort() {
                this.isSorting = false;
                clearInterval(this.sortInterval);
                
                document.getElementById('start-sort-btn').disabled = false;
                document.getElementById('step-sort-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;

                // æ˜¾ç¤ºå®Œæˆä¿¡æ¯
                if (this.showSteps) {
                    const stepInfo = document.getElementById('step-info');
                    const stepDescription = document.getElementById('step-description');
                    
                    stepInfo.style.display = 'block';
                    stepDescription.innerHTML = `
                        <strong>ğŸ‰ æ’åºå®Œæˆï¼</strong><br>
                        æœ€ç»ˆæ’åºç»“æœ: [${this.sortedArray.join(', ')}]<br>
                        æ€»æ¯”è¾ƒæ¬¡æ•°: ${this.comparisons}, æ€»æ’å…¥æ¬¡æ•°: ${this.insertions}
                    `;
                }

                this.notification.success('æ’åºå®Œæˆï¼');
            }

            resetSort() {
                this.isSorting = false;
                this.isPaused = false;
                clearInterval(this.sortInterval);
                
                this.array = [...this.originalArray];
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('start-sort-btn').disabled = false;
                document.getElementById('step-sort-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;

                this.renderArray();
                this.updateStats();
                this.updateProgress();
                document.getElementById('step-info').style.display = 'none';
            }

            generateRandomArray() {
                const length = Math.floor(Math.random() * 10) + 5; // 5-14ä¸ªå…ƒç´ 
                this.array = Array.from({length}, () => Math.floor(Math.random() * 100) + 1);
                this.originalArray = [...this.array];
                this.sortedArray = [];
                this.currentStep = 0;
                this.comparisons = 0;
                this.insertions = 0;
                
                document.getElementById('array-input').value = this.array.join(', ');
                this.renderArray();
                this.updateStats();
                this.calculateTotalSteps();
                this.updateProgress();
                document.getElementById('step-info').style.display = 'none';
                
                this.notification.success('å·²ç”Ÿæˆéšæœºæ•°ç»„');
            }

            exportResults() {
                const data = {
                    originalArray: this.array,
                    sortedArray: this.sortedArray,
                    comparisons: this.comparisons,
                    insertions: this.insertions,
                    totalSteps: this.totalSteps,
                    exportedAt: new Date().toISOString()
                };

                const arrayStr = JSON.stringify(data, null, 2);
                const blob = new Blob([arrayStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `insertion-sort-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                this.notification.success('æ’åºç»“æœå¯¼å‡ºæˆåŠŸï¼');
            }

            renderArray() {
                const container = document.getElementById('sort-container');
                
                if (this.array.length === 0) {
                    container.innerHTML = '<div class="sort-container empty">æ•°ç»„ä¸ºç©º</div>';
                    return;
                }

                container.innerHTML = '';
                
                this.array.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item';
                    itemElement.innerHTML = `
                        <div class="index">${index}</div>
                        <div class="value">${item}</div>
                    `;
                    
                    if (index < this.currentStep) {
                        itemElement.classList.add('sorted');
                    } else if (index === this.currentStep) {
                        itemElement.classList.add('comparing');
                    }
                    
                    container.appendChild(itemElement);
                });
            }

            renderSortedArray() {
                const container = document.getElementById('sort-container');
                container.innerHTML = '';
                
                this.sortedArray.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item sorted';
                    itemElement.innerHTML = `
                        <div class="index">${index}</div>
                        <div class="value">${item}</div>
                    `;
                    container.appendChild(itemElement);
                });

                // æ˜¾ç¤ºå‰©ä½™æœªæ’åºçš„å…ƒç´ 
                const remainingElements = this.array.slice(this.currentStep);
                remainingElements.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'sort-item';
                    itemElement.innerHTML = `
                        <div class="index">${this.currentStep + index}</div>
                        <div class="value">${item}</div>
                    `;
                    container.appendChild(itemElement);
                });
            }

            updateStats() {
                document.getElementById('array-length').textContent = this.array.length;
                document.getElementById('comparisons').textContent = this.comparisons;
                document.getElementById('swaps').textContent = this.insertions;
                document.getElementById('current-step').textContent = `${this.currentStep}/${this.totalSteps}`;
            }

            updateProgress() {
                if (!this.advancedOptions.autoProgress) return;
                
                const progress = (this.currentStep / this.totalSteps) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
            }

            loadTemplate(templateName) {
                const templates = {
                    small: [3, 1, 2],
                    medium: [6, 3, 4, 1, 8, 2],
                    large: [9, 7, 5, 3, 1, 8, 6, 4, 2, 0],
                    reverse: [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]
                };

                const template = templates[templateName];
                if (template) {
                    this.array = [...template];
                    this.originalArray = [...this.array];
                    this.sortedArray = [];
                    this.currentStep = 0;
                    this.comparisons = 0;
                    this.insertions = 0;
                    
                    document.getElementById('array-input').value = this.array.join(', ');
                    this.renderArray();
                    this.updateStats();
                    this.calculateTotalSteps();
                    this.updateProgress();
                    document.getElementById('step-info').style.display = 'none';
                    
                    this.notification.success(`å·²åŠ è½½ ${templateName} æ¨¡æ¿`);
                }
            }

            updateAllCheckboxState() {
                if (this.advancedOptionsGroup && this.advancedOptionsGroup.checkboxes) {
                    const allChecked = this.advancedOptionsGroup.checkboxes.every(cb => cb.isChecked());
                    const noneChecked = this.advancedOptionsGroup.checkboxes.every(cb => !cb.isChecked());
                    
                    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çš„çŠ¶æ€ï¼Œä½†ä¸è§¦å‘onChangeäº‹ä»¶
                    if (this.advancedOptionsGroup.allCheckbox) {
                        // ç›´æ¥è®¾ç½®çŠ¶æ€ï¼Œé¿å…è°ƒç”¨setCheckedæ–¹æ³•
                        this.advancedOptionsGroup.allCheckbox.checked = allChecked;
                        const allCheckboxInput = this.advancedOptionsGroup.allCheckbox.element.querySelector('.checkbox-input');
                        if (allCheckboxInput) {
                            allCheckboxInput.checked = allChecked;
                            allCheckboxInput.indeterminate = !allChecked && !noneChecked;
                        }
                    }
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let app;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                app = new InsertionSortVisualizer();
            });
        } else {
            app = new InsertionSortVisualizer();
        }
    </script>
</body>
</html>