<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能单位换算工具平台 - kmToMiles</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <!-- Highlight.js 代码高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .result-display {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .result-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .result-unit {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .conversion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .conversion-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .conversion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .conversion-card-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .conversion-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }

        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .history-item .conversion-text {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #495057;
        }

        .history-item .time {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .stats-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .code-block {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            overflow-x: auto;
            background: #282c34;
            border-radius: 8px;
        }

        .code-block pre code {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            display: block;
        }

        .hljs {
            background: #282c34;
            padding: 0;
        }

        .advanced-options {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .options-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .modal-content {
            max-height: 400px;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .result-value {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 多功能单位换算工具平台</h1>
            <p>基于 kmToMiles 函数的智能单位转换工具，支持长度、重量、温度、面积、体积等多种单位互转</p>
        </div>

        <!-- 换算类别选择 -->
        <div class="card">
            <h2>📂 换算类别</h2>
            <div class="category-tabs" id="categoryTabs">
                <!-- 类别标签将动态生成 -->
            </div>
        </div>

        <div class="main-content">
            <!-- 左侧：输入区域 -->
            <div class="input-area">
                <div class="card">
                    <h2>📝 输入值</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label for="fromUnit">源单位</label>
                            <div id="fromUnitSelect"></div>
                        </div>

                        <div class="input-group">
                            <label for="inputValue">数值</label>
                            <div id="inputValueNumber"></div>
                        </div>

                        <div class="input-group">
                            <label for="toUnit">目标单位</label>
                            <div id="toUnitSelect"></div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.converter?.convert()">🔄 转换</button>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.converter?.swapUnits()">⇆ 交换单位</button>
                            <button class="btn btn-warning" onclick="window.converter?.clearInput()">🗑️ 清空</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>⚙️ 快捷换算</h2>
                    <div class="button-group">
                        <button class="btn btn-info" onclick="window.converter?.quickConvert(1)">1 单位</button>
                        <button class="btn btn-info" onclick="window.converter?.quickConvert(10)">10 单位</button>
                        <button class="btn btn-info" onclick="window.converter?.quickConvert(100)">100 单位</button>
                        <button class="btn btn-info" onclick="window.converter?.quickConvert(1000)">1000 单位</button>
                    </div>
                </div>

                <div class="card">
                    <h2>⚙️ 高级选项</h2>
                    <div class="advanced-options">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>
            </div>

            <!-- 右侧：结果区域 -->
            <div class="result-area">
                <div class="card">
                    <h2>📊 换算结果</h2>
                    <div class="result-display" id="resultDisplay">
                        <div class="result-label">转换结果</div>
                        <div class="result-value" id="resultValue">-</div>
                        <div class="result-unit" id="resultUnit">请输入数值并选择单位</div>
                    </div>
                </div>

                <div class="card">
                    <h2>🔢 全部换算</h2>
                    <div class="conversion-grid" id="conversionGrid">
                        <div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">
                            输入数值后将显示所有可用单位的换算结果
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 换算历史 -->
        <div class="card">
            <h2>📜 换算历史</h2>
            <div class="history-list" id="historyList">
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    暂无换算历史
                </div>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="window.converter?.clearHistory()">🗑️ 清空历史</button>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="card">
            <h2>📈 统计信息</h2>
            <div class="stats-section">
                <div class="stats-grid" id="statsGrid">
                    <!-- 统计信息将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 代码预览 -->
        <div class="card" id="codeSection" style="display: none;">
            <h2>💻 执行代码</h2>
            <div class="code-block">
                <pre><code class="language-javascript" id="codePreview">// 代码将在这里显示</code></pre>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="card">
            <h2>📖 函数说明</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">kmToMiles 函数</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const kmToMiles = km => km * 0.621371;</code></pre>
                </div>

                <h3 style="color: #667eea; margin: 20px 0 15px 0;">核心原理</h3>
                <ul style="color: #495057; padding-left: 20px; line-height: 1.8;">
                    <li>1 千米 (km) = 0.621371 英里 (mile)</li>
                    <li>简单的乘法运算实现单位转换</li>
                    <li>可扩展到其他单位转换</li>
                </ul>

                <h3 style="color: #667eea; margin: 20px 0 15px 0;">支持的换算类别</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <ul style="color: #495057; padding-left: 20px; line-height: 1.8;">
                        <li>📏 <strong>长度</strong>：千米、米、厘米、毫米、英里、码、英尺、英寸</li>
                        <li>⚖️ <strong>重量</strong>：千克、克、毫克、磅、盎司、吨</li>
                        <li>🌡️ <strong>温度</strong>：摄氏度、华氏度、开尔文</li>
                        <li>📐 <strong>面积</strong>：平方米、平方千米、公顷、英亩、平方英尺</li>
                        <li>🧊 <strong>体积</strong>：立方米、升、毫升、加仑、品脱</li>
                        <li>⏱️ <strong>时间</strong>：秒、分钟、小时、天、周</li>
                    </ul>
                </div>

                <h3 style="color: #667eea; margin: 20px 0 15px 0;">使用示例</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">// 千米转英里
const miles = kmToMiles(10);
console.log(miles); // 6.21371

// 扩展：其他单位转换
const mToFt = m => m * 3.28084;      // 米转英尺
const kgToLb = kg => kg * 2.20462;   // 千克转磅
const cToF = c => c * 9/5 + 32;      // 摄氏度转华氏度</code></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <!-- Highlight.js 代码高亮 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // 核心 kmToMiles 函数
        const kmToMiles = km => km * 0.621371;

        // 单位换算工具类
        class UnitConverter {
            constructor() {
                this.plugins = {};
                this.currentCategory = 'length';
                this.fromUnit = 'km';
                this.toUnit = 'mile';
                this.inputValue = 0;
                this.result = 0;
                this.history = [];
                this.stats = {
                    totalConversions: 0,
                    categoryUsage: {}
                };

                // 单位定义和转换因子（所有单位统一转换到基准单位，然后再转换到目标单位）
                this.units = {
                    length: {
                        name: '长度',
                        icon: '📏',
                        base: 'm', // 基准单位：米
                        units: {
                            km: { name: '千米', symbol: 'km', toBase: 1000 },
                            m: { name: '米', symbol: 'm', toBase: 1 },
                            cm: { name: '厘米', symbol: 'cm', toBase: 0.01 },
                            mm: { name: '毫米', symbol: 'mm', toBase: 0.001 },
                            mile: { name: '英里', symbol: 'mi', toBase: 1609.34 },
                            yard: { name: '码', symbol: 'yd', toBase: 0.9144 },
                            foot: { name: '英尺', symbol: 'ft', toBase: 0.3048 },
                            inch: { name: '英寸', symbol: 'in', toBase: 0.0254 }
                        }
                    },
                    weight: {
                        name: '重量',
                        icon: '⚖️',
                        base: 'kg',
                        units: {
                            ton: { name: '吨', symbol: 't', toBase: 1000 },
                            kg: { name: '千克', symbol: 'kg', toBase: 1 },
                            g: { name: '克', symbol: 'g', toBase: 0.001 },
                            mg: { name: '毫克', symbol: 'mg', toBase: 0.000001 },
                            lb: { name: '磅', symbol: 'lb', toBase: 0.453592 },
                            oz: { name: '盎司', symbol: 'oz', toBase: 0.0283495 }
                        }
                    },
                    temperature: {
                        name: '温度',
                        icon: '🌡️',
                        base: 'celsius',
                        special: true, // 温度转换需要特殊处理
                        units: {
                            celsius: { name: '摄氏度', symbol: '°C' },
                            fahrenheit: { name: '华氏度', symbol: '°F' },
                            kelvin: { name: '开尔文', symbol: 'K' }
                        }
                    },
                    area: {
                        name: '面积',
                        icon: '📐',
                        base: 'sqm',
                        units: {
                            sqkm: { name: '平方千米', symbol: 'km²', toBase: 1000000 },
                            hectare: { name: '公顷', symbol: 'ha', toBase: 10000 },
                            sqm: { name: '平方米', symbol: 'm²', toBase: 1 },
                            acre: { name: '英亩', symbol: 'ac', toBase: 4046.86 },
                            sqft: { name: '平方英尺', symbol: 'ft²', toBase: 0.092903 }
                        }
                    },
                    volume: {
                        name: '体积',
                        icon: '🧊',
                        base: 'liter',
                        units: {
                            cum: { name: '立方米', symbol: 'm³', toBase: 1000 },
                            liter: { name: '升', symbol: 'L', toBase: 1 },
                            ml: { name: '毫升', symbol: 'ml', toBase: 0.001 },
                            gallon: { name: '加仑', symbol: 'gal', toBase: 3.78541 },
                            pint: { name: '品脱', symbol: 'pt', toBase: 0.473176 }
                        }
                    },
                    time: {
                        name: '时间',
                        icon: '⏱️',
                        base: 'second',
                        units: {
                            week: { name: '周', symbol: 'week', toBase: 604800 },
                            day: { name: '天', symbol: 'd', toBase: 86400 },
                            hour: { name: '小时', symbol: 'h', toBase: 3600 },
                            minute: { name: '分钟', symbol: 'min', toBase: 60 },
                            second: { name: '秒', symbol: 's', toBase: 1 }
                        }
                    }
                };

                this.init();
            }

            // 初始化
            async init() {
                try {
                    await this.loadPlugins();
                    this.setupInputNumber();
                    this.setupSelects();
                    this.setupCheckboxes();
                    this.renderCategoryTabs();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showError('初始化失败: ' + error.message);
                }
            }

            // 初始化代码高亮
            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    console.log('Highlight.js 初始化完成');
                } else {
                    console.warn('Highlight.js 未加载');
                }
            }

            // 加载插件
            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('部分插件加载失败:', error);
                }
            }

            // 渲染类别标签
            renderCategoryTabs() {
                const tabs = document.getElementById('categoryTabs');
                if (!tabs) return;

                let html = '';
                Object.keys(this.units).forEach(key => {
                    const category = this.units[key];
                    const isActive = key === this.currentCategory;
                    html += `
                        <button class="tab-btn ${isActive ? 'active' : ''}" 
                                onclick="window.converter?.switchCategory('${key}')">
                            ${category.icon} ${category.name}
                        </button>
                    `;
                });

                tabs.innerHTML = html;
            }

            // 切换类别
            switchCategory(category) {
                this.currentCategory = category;
                this.renderCategoryTabs();
                this.updateUnitSelects();
                
                const units = Object.keys(this.units[category].units);
                this.fromUnit = units[0];
                this.toUnit = units[1] || units[0];
                
                this.updateSelects();
                this.clearInput();
            }

            // 设置下拉框
            setupSelects() {
                this.setupFromUnitSelect();
                this.setupToUnitSelect();
            }

            // 设置源单位下拉框
            setupFromUnitSelect() {
                const fromUnitSelect = document.getElementById('fromUnitSelect');
                if (!fromUnitSelect) return;

                const units = this.units[this.currentCategory].units;
                const options = Object.keys(units).map(key => ({
                    value: key,
                    label: `${units[key].name} (${units[key].symbol})`
                }));

                try {
                    this.plugins.fromUnitSelect = new Select({
                        container: fromUnitSelect,
                        options: options,
                        placeholder: '选择源单位',
                        onChange: (value) => {
                            this.fromUnit = value;
                            if (this.getCheckboxValue('autoConvert') && this.inputValue) {
                                this.convert();
                            }
                        }
                    });

                    this.plugins.fromUnitSelect.setValue(this.fromUnit);
                } catch (error) {
                    console.warn('Select 插件加载失败，使用原生下拉框:', error);
                    this.setupNativeSelect(fromUnitSelect, options, 'fromUnitNative', (value) => {
                        this.fromUnit = value;
                        if (this.getCheckboxValue('autoConvert') && this.inputValue) {
                            this.convert();
                        }
                    });
                }
            }

            // 设置目标单位下拉框
            setupToUnitSelect() {
                const toUnitSelect = document.getElementById('toUnitSelect');
                if (!toUnitSelect) return;

                const units = this.units[this.currentCategory].units;
                const options = Object.keys(units).map(key => ({
                    value: key,
                    label: `${units[key].name} (${units[key].symbol})`
                }));

                try {
                    this.plugins.toUnitSelect = new Select({
                        container: toUnitSelect,
                        options: options,
                        placeholder: '选择目标单位',
                        onChange: (value) => {
                            this.toUnit = value;
                            if (this.getCheckboxValue('autoConvert') && this.inputValue) {
                                this.convert();
                            }
                        }
                    });

                    this.plugins.toUnitSelect.setValue(this.toUnit);
                } catch (error) {
                    console.warn('Select 插件加载失败，使用原生下拉框:', error);
                    this.setupNativeSelect(toUnitSelect, options, 'toUnitNative', (value) => {
                        this.toUnit = value;
                        if (this.getCheckboxValue('autoConvert') && this.inputValue) {
                            this.convert();
                        }
                    });
                }
            }

            // 设置原生下拉框
            setupNativeSelect(container, options, id, onChange) {
                let html = `<select id="${id}" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">`;
                options.forEach(opt => {
                    html += `<option value="${opt.value}">${opt.label}</option>`;
                });
                html += '</select>';
                container.innerHTML = html;

                const select = document.getElementById(id);
                if (select) {
                    select.addEventListener('change', (e) => onChange(e.target.value));
                }
            }

            // 更新下拉框选项
            updateUnitSelects() {
                this.setupFromUnitSelect();
                this.setupToUnitSelect();
            }

            // 更新下拉框选中值
            updateSelects() {
                if (this.plugins.fromUnitSelect) {
                    this.plugins.fromUnitSelect.setValue(this.fromUnit);
                }
                if (this.plugins.toUnitSelect) {
                    this.plugins.toUnitSelect.setValue(this.toUnit);
                }
            }

            // 设置 InputNumber
            setupInputNumber() {
                const inputValueNumber = document.getElementById('inputValueNumber');
                if (!inputValueNumber) return;

                try {
                    this.plugins.inputValueNumber = new InputNumber({
                        container: inputValueNumber,
                        value: 0,
                        min: -Infinity,
                        max: Infinity,
                        step: 1,
                        precision: 6,
                        placeholder: '输入要转换的数值',
                        onChange: (value) => {
                            this.inputValue = value;
                            if (this.getCheckboxValue('autoConvert') && value !== 0) {
                                this.convert();
                            }
                        }
                    });
                } catch (error) {
                    console.warn('InputNumber 插件加载失败，使用原生输入:', error);
                    inputValueNumber.innerHTML = '<input type="number" id="inputValueNative" placeholder="输入要转换的数值" step="any" style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1.2rem; font-weight: 500;">';
                    const nativeInput = document.getElementById('inputValueNative');
                    if (nativeInput) {
                        nativeInput.addEventListener('input', (e) => {
                            this.inputValue = parseFloat(e.target.value) || 0;
                            if (this.getCheckboxValue('autoConvert') && this.inputValue) {
                                this.convert();
                            }
                        });
                    }
                }
            }

            // 设置复选框
            setupCheckboxes() {
                const checkboxGroup = document.getElementById('checkboxGroup');
                if (!checkboxGroup) return;

                const options = [
                    { id: 'autoConvert', label: '自动转换', checked: true },
                    { id: 'showAllUnits', label: '显示全部单位', checked: true },
                    { id: 'showNotifications', label: '显示通知提醒', checked: true },
                    { id: 'showCode', label: '显示执行代码', checked: true },
                    { id: 'saveHistory', label: '保存历史记录', checked: true }
                ];

                try {
                    const checkboxGroupInstance = Checkbox.createCheckboxGroup({
                        items: options.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: (checkedStates) => {
                            console.log('复选框状态变化:', checkedStates);
                        }
                    });

                    checkboxGroup.appendChild(checkboxGroupInstance.container);
                    this.plugins.checkboxGroup = checkboxGroupInstance;
                    this.checkboxOptions = options;
                } catch (error) {
                    console.warn('自定义复选框加载失败，使用原生复选框:', error);
                    this.setupNativeCheckboxes(options, checkboxGroup);
                }
            }

            // 设置原生复选框
            setupNativeCheckboxes(options, container) {
                options.forEach(option => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.style.marginBottom = '10px';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>
                        <label for="${option.id}" style="margin-left: 8px; cursor: pointer;">${option.label}</label>
                    `;
                    container.appendChild(checkboxItem);
                });
            }

            // 获取复选框值
            getCheckboxValue(checkboxId) {
                if (this.plugins.checkboxGroup && this.checkboxOptions) {
                    try {
                        const optionIndex = this.checkboxOptions.findIndex(option => option.id === checkboxId);
                        if (optionIndex !== -1) {
                            const checkedStates = this.plugins.checkboxGroup.getAllChecked();
                            return checkedStates[optionIndex] || false;
                        }
                    } catch (error) {
                        console.warn('获取复选框值失败，使用原生方法:', error);
                    }
                }

                const checkbox = document.getElementById(checkboxId);
                return checkbox ? checkbox.checked : false;
            }


            // 核心转换函数
            convertValue(value, fromUnit, toUnit, category) {
                const categoryData = this.units[category];
                
                // 温度转换需要特殊处理
                if (category === 'temperature') {
                    return this.convertTemperature(value, fromUnit, toUnit);
                }

                // 其他单位：先转换到基准单位，再转换到目标单位
                const fromFactor = categoryData.units[fromUnit].toBase;
                const toFactor = categoryData.units[toUnit].toBase;
                
                const baseValue = value * fromFactor;
                const result = baseValue / toFactor;
                
                return result;
            }

            // 温度转换
            convertTemperature(value, from, to) {
                // 先转换到摄氏度
                let celsius = value;
                if (from === 'fahrenheit') {
                    celsius = (value - 32) * 5 / 9;
                } else if (from === 'kelvin') {
                    celsius = value - 273.15;
                }

                // 从摄氏度转换到目标单位
                if (to === 'celsius') {
                    return celsius;
                } else if (to === 'fahrenheit') {
                    return celsius * 9 / 5 + 32;
                } else if (to === 'kelvin') {
                    return celsius + 273.15;
                }
                
                return celsius;
            }

            // 执行转换
            convert() {
                // 从 InputNumber 插件或原生输入框获取值
                let value = this.inputValue;
                
                if (this.plugins.inputValueNumber) {
                    try {
                        value = this.plugins.inputValueNumber.getValue();
                    } catch (error) {
                        console.warn('从 InputNumber 获取值失败:', error);
                    }
                } else {
                    const inputValueNative = document.getElementById('inputValueNative');
                    if (inputValueNative) {
                        value = parseFloat(inputValueNative.value) || 0;
                    }
                }

                if (isNaN(value) || value === 0) {
                    this.showError('请输入有效的数值');
                    return;
                }

                try {
                    this.inputValue = value;
                    this.result = this.convertValue(value, this.fromUnit, this.toUnit, this.currentCategory);
                    
                    this.stats.totalConversions++;
                    this.stats.categoryUsage[this.currentCategory] = 
                        (this.stats.categoryUsage[this.currentCategory] || 0) + 1;

                    this.displayResult();
                    
                    if (this.getCheckboxValue('showAllUnits')) {
                        this.displayAllConversions();
                    }
                    
                    if (this.getCheckboxValue('saveHistory')) {
                        this.addToHistory();
                    }
                    
                    if (this.getCheckboxValue('showCode')) {
                        this.showCode();
                    }

                    this.updateStats();
                    this.showNotification('转换完成！', 'success');
                } catch (error) {
                    this.showError('转换失败: ' + error.message);
                    console.error('转换错误:', error);
                }
            }

            // 显示主要结果
            displayResult() {
                const resultValue = document.getElementById('resultValue');
                const resultUnit = document.getElementById('resultUnit');
                const resultDisplay = document.getElementById('resultDisplay');

                if (!resultValue || !resultUnit) return;

                const fromUnitData = this.units[this.currentCategory].units[this.fromUnit];
                const toUnitData = this.units[this.currentCategory].units[this.toUnit];

                resultValue.textContent = this.formatNumber(this.result);
                resultUnit.textContent = toUnitData.symbol;

                // 添加动画
                if (resultDisplay) {
                    resultDisplay.classList.remove('animate-in');
                    void resultDisplay.offsetWidth; // 触发重排
                    resultDisplay.classList.add('animate-in');
                }
            }

            // 显示所有单位的转换结果
            displayAllConversions() {
                const conversionGrid = document.getElementById('conversionGrid');
                if (!conversionGrid) return;

                const units = this.units[this.currentCategory].units;
                
                let html = '';
                Object.keys(units).forEach(unitKey => {
                    if (unitKey === this.fromUnit) return; // 跳过源单位本身
                    
                    const converted = this.convertValue(this.inputValue, this.fromUnit, unitKey, this.currentCategory);
                    const unitData = units[unitKey];
                    
                    html += `
                        <div class="conversion-card">
                            <div class="conversion-card-title">${unitData.name}</div>
                            <div class="conversion-card-value">${this.formatNumber(converted)} ${unitData.symbol}</div>
                        </div>
                    `;
                });

                conversionGrid.innerHTML = html;
            }

            // 格式化数字
            formatNumber(num) {
                if (Math.abs(num) < 0.01 && num !== 0) {
                    return num.toExponential(6);
                }
                return num.toFixed(6).replace(/\.?0+$/, '');
            }

            // 快捷转换
            quickConvert(value) {
                // 设置 InputNumber 插件或原生输入框的值
                if (this.plugins.inputValueNumber) {
                    try {
                        this.plugins.inputValueNumber.setValue(value);
                    } catch (error) {
                        console.warn('设置 InputNumber 值失败:', error);
                    }
                } else {
                    const inputValueNative = document.getElementById('inputValueNative');
                    if (inputValueNative) {
                        inputValueNative.value = value;
                    }
                }
                
                this.inputValue = value;
                this.convert();
            }

            // 交换单位
            swapUnits() {
                const temp = this.fromUnit;
                this.fromUnit = this.toUnit;
                this.toUnit = temp;
                
                this.updateSelects();
                
                if (this.inputValue) {
                    this.convert();
                }
                
                this.showNotification('单位已交换', 'info');
            }

            // 清空输入
            clearInput() {
                const resultValue = document.getElementById('resultValue');
                const resultUnit = document.getElementById('resultUnit');
                const conversionGrid = document.getElementById('conversionGrid');
                const codeSection = document.getElementById('codeSection');

                // 清空 InputNumber 插件或原生输入框
                if (this.plugins.inputValueNumber) {
                    try {
                        this.plugins.inputValueNumber.setValue(0);
                    } catch (error) {
                        console.warn('清空 InputNumber 失败:', error);
                    }
                } else {
                    const inputValueNative = document.getElementById('inputValueNative');
                    if (inputValueNative) inputValueNative.value = '';
                }

                if (resultValue) resultValue.textContent = '-';
                if (resultUnit) resultUnit.textContent = '请输入数值并选择单位';
                if (conversionGrid) {
                    conversionGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">输入数值后将显示所有可用单位的换算结果</div>';
                }
                if (codeSection) codeSection.style.display = 'none';

                this.inputValue = 0;
                this.result = 0;
                
                this.showNotification('输入已清空', 'info');
            }

            // 添加到历史记录
            addToHistory() {
                const fromUnitData = this.units[this.currentCategory].units[this.fromUnit];
                const toUnitData = this.units[this.currentCategory].units[this.toUnit];
                
                const record = {
                    category: this.currentCategory,
                    categoryName: this.units[this.currentCategory].name,
                    from: `${this.formatNumber(this.inputValue)} ${fromUnitData.symbol}`,
                    to: `${this.formatNumber(this.result)} ${toUnitData.symbol}`,
                    timestamp: new Date()
                };

                this.history.unshift(record);
                
                // 限制历史记录数量
                if (this.history.length > 50) {
                    this.history = this.history.slice(0, 50);
                }

                this.updateHistoryList();
            }

            // 更新历史记录列表
            updateHistoryList() {
                const historyList = document.getElementById('historyList');
                if (!historyList) return;

                if (this.history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">暂无换算历史</div>';
                    return;
                }

                let html = '';
                this.history.forEach((record, index) => {
                    const timeStr = record.timestamp.toLocaleTimeString('zh-CN');
                    html += `
                        <div class="history-item">
                            <div>
                                <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 10px;">
                                    ${record.categoryName}
                                </span>
                                <span class="conversion-text">${record.from} → ${record.to}</span>
                            </div>
                            <span class="time">${timeStr}</span>
                        </div>
                    `;
                });

                historyList.innerHTML = html;
            }

            // 清空历史记录
            clearHistory() {
                this.history = [];
                this.updateHistoryList();
                this.showNotification('历史记录已清空', 'info');
            }

            // 显示代码
            showCode() {
                const codeSection = document.getElementById('codeSection');
                const codePreview = document.getElementById('codePreview');

                if (!codePreview) return;

                const fromUnitData = this.units[this.currentCategory].units[this.fromUnit];
                const toUnitData = this.units[this.currentCategory].units[this.toUnit];

                let code = '';
                
                if (this.currentCategory === 'length' && this.fromUnit === 'km' && this.toUnit === 'mile') {
                    // 使用原始的 kmToMiles 函数
                    code = `// 使用核心函数
const kmToMiles = km => km * 0.621371;

const inputValue = ${this.inputValue};
const result = kmToMiles(inputValue);

console.log(\`\${inputValue} km = \${result.toFixed(6)} miles\`);
// 输出: ${this.inputValue} km = ${this.result.toFixed(6)} miles`;
                } else if (this.currentCategory === 'temperature') {
                    code = `// 温度转换（特殊处理）
const convertTemperature = (value, from, to) => {
    // 先转换到摄氏度
    let celsius = value;
    if (from === 'fahrenheit') celsius = (value - 32) * 5 / 9;
    else if (from === 'kelvin') celsius = value - 273.15;
    
    // 从摄氏度转换到目标单位
    if (to === 'celsius') return celsius;
    else if (to === 'fahrenheit') return celsius * 9 / 5 + 32;
    else if (to === 'kelvin') return celsius + 273.15;
    return celsius;
};

const result = convertTemperature(${this.inputValue}, '${this.fromUnit}', '${this.toUnit}');
console.log(\`\${${this.inputValue}} ${fromUnitData.symbol} = \${result.toFixed(6)} ${toUnitData.symbol}\`);
// 输出: ${this.inputValue} ${fromUnitData.symbol} = ${this.result.toFixed(6)} ${toUnitData.symbol}`;
                } else {
                    code = `// 单位转换（通过基准单位）
const fromFactor = ${fromUnitData.toBase}; // ${fromUnitData.name} 到 基准单位
const toFactor = ${toUnitData.toBase};     // ${toUnitData.name} 到 基准单位

const inputValue = ${this.inputValue};
const baseValue = inputValue * fromFactor;
const result = baseValue / toFactor;

console.log(\`\${inputValue} ${fromUnitData.symbol} = \${result.toFixed(6)} ${toUnitData.symbol}\`);
// 输出: ${this.inputValue} ${fromUnitData.symbol} = ${this.result.toFixed(6)} ${toUnitData.symbol}`;
                }

                codePreview.textContent = code;
                if (window.hljs) {
                    hljs.highlightElement(codePreview);
                }

                if (codeSection) {
                    codeSection.style.display = 'block';
                }
            }

            // 更新统计信息
            updateStats() {
                const statsGrid = document.getElementById('statsGrid');
                if (!statsGrid) return;

                const categoryCount = Object.keys(this.stats.categoryUsage).length;
                const mostUsed = Object.entries(this.stats.categoryUsage)
                    .sort((a, b) => b[1] - a[1])[0];
                const mostUsedCategory = mostUsed 
                    ? `${this.units[mostUsed[0]].name} (${mostUsed[1]}次)` 
                    : '暂无';

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalConversions}</div>
                        <div class="stat-label">总换算次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.history.length}</div>
                        <div class="stat-label">历史记录数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${categoryCount}</div>
                        <div class="stat-label">使用类别数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(this.units).length}</div>
                        <div class="stat-label">支持类别</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(this.units[this.currentCategory].units).length}</div>
                        <div class="stat-label">当前类别单位数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="font-size: 1.2rem;">${mostUsedCategory}</div>
                        <div class="stat-label">最常用类别</div>
                    </div>
                `;
            }

            // 显示通知
            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            // 显示错误
            showError(message) {
                this.showNotification(message, 'error');
            }

            // 显示欢迎消息
            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: '🎉 欢迎使用多功能单位换算工具平台',
                        content: `
                            <div style="padding: 20px;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">🔄</div>
                                    <h3 style="margin: 0 0 10px 0; color: #667eea;">功能特色</h3>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <ul style="margin: 0; padding-left: 20px; color: #495057;">
                                        <li>6 大类别，40+ 种单位互转</li>
                                        <li>基于 kmToMiles 的扩展换算系统</li>
                                        <li>实时自动转换</li>
                                        <li>显示所有可用单位的换算结果</li>
                                        <li>换算历史记录</li>
                                        <li>代码预览和执行说明</li>
                                    </ul>
                                </div>

                                <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; border-left: 4px solid #10b981; margin-bottom: 15px;">
                                    <p style="margin: 0; font-size: 14px; color: #16a34a;">
                                        <strong>💡 使用步骤：</strong>
                                    </p>
                                    <ol style="margin: 8px 0 0 0; padding-left: 20px; color: #16a34a; font-size: 14px;">
                                        <li>选择换算类别（长度/重量/温度等）</li>
                                        <li>选择源单位和目标单位</li>
                                        <li>输入数值（支持自动转换）</li>
                                        <li>查看主要结果和全部单位换算</li>
                                        <li>在历史记录中查看过往换算</li>
                                    </ol>
                                </div>

                                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <p style="margin: 0; font-size: 14px; color: #d97706;">
                                        <strong>🎯 核心函数：</strong> kmToMiles(km) = km × 0.621371，扩展支持 6 大类别的单位换算。
                                    </p>
                                </div>
                            </div>
                        `,
                        type: "alert"
                    });
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM内容加载完成，开始初始化...');
            window.converter = new UnitConverter();
            console.log('多功能单位换算工具平台初始化完成');
        });

        // 如果 DOMContentLoaded 已经触发，立即执行
        if (document.readyState === 'loading') {
            console.log('文档仍在加载，等待 DOMContentLoaded 事件...');
        } else {
            console.log('文档已加载完成，立即执行初始化...');
            window.converter = new UnitConverter();
        }
    </script>
</body>
</html>