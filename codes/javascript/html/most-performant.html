<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡½æ•°æ€§èƒ½æµ‹è¯•å¹³å° - mostPerformant</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: white;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.98rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #fa709a;
            box-shadow: 0 0 0 3px rgba(250, 112, 154, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(250, 112, 154, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .function-list {
            margin-bottom: 16px;
        }

        .function-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 4px solid #e5e7eb;
            position: relative;
        }

        .function-item.winner {
            border-left-color: #22c55e;
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
        }

        .function-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .function-index {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .function-item.winner .function-index {
            background: linear-gradient(135deg, #22c55e, #15803d);
        }

        .function-code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #1f2937;
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .function-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .function-remove:hover {
            background: #dc2626;
        }

        .result-display {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(250, 112, 154, 0.2);
            margin-bottom: 16px;
        }

        .result-label {
            font-size: 0.9rem;
            color: #9f1239;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #be185d;
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 12px 0;
        }

        .performance-grid {
            display: grid;
            gap: 14px;
            margin-top: 16px;
        }

        .performance-item {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            align-items: center;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .performance-item.winner {
            border-left-color: #22c55e;
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            transform: scale(1.02);
        }

        .performance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
        }

        .performance-item.winner:hover {
            transform: scale(1.02) translateY(-2px);
        }

        .performance-rank {
            font-size: 1.2rem;
            font-weight: 800;
            color: #64748b;
            min-width: 40px;
            text-align: center;
        }

        .performance-item.winner .performance-rank {
            color: #22c55e;
        }

        .performance-info {
            flex: 1;
        }

        .performance-name {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.95rem;
        }

        .performance-bar-container {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .performance-bar {
            height: 100%;
            background: linear-gradient(135deg, #fa709a, #fee140);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .performance-item.winner .performance-bar {
            background: linear-gradient(135deg, #22c55e, #15803d);
        }

        .performance-time {
            text-align: right;
            min-width: 100px;
        }

        .performance-time-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: #1f2937;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .performance-item.winner .performance-time-value {
            color: #22c55e;
        }

        .performance-time-unit {
            font-size: 0.75rem;
            color: #64748b;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #fa709a;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #1f2937;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fa709a;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .comparison-card h4 {
            font-size: 0.95rem;
            color: #fa709a;
            margin-bottom: 10px;
        }

        .comparison-card p {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #475569;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #fa709a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ å‡½æ•°æ€§èƒ½æµ‹è¯•å¹³å°</h1>
            <p>åŸºäº mostPerformant å‡½æ•°çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒå¤šå‡½æ•°å¯¹æ¯”ã€å¯è§†åŒ–å±•ç¤ºã€å†å²è¿½è¸ªä¸ä»£ç é¢„è§ˆ</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ“ å‡½æ•°é…ç½®</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>å‡½æ•°ä»£ç  (JavaScript)</label>
                            <textarea id="functionInput" class="textarea-field" placeholder='() => { [1,2,3].map(x => x * 2); }'></textarea>
                        </div>
                        <div class="input-group">
                            <label>è¿­ä»£æ¬¡æ•°</label>
                            <div id="iterationsInput"></div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.mostPerformantTool?.addFunction()">â• æ·»åŠ å‡½æ•°</button>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.mostPerformantTool?.runTest()">âš¡ è¿è¡Œæµ‹è¯•</button>
                            <button class="btn btn-info" onclick="window.mostPerformantTool?.loadSample()">ğŸ“„ ç¤ºä¾‹å‡½æ•°</button>
                            <button class="btn btn-danger" onclick="window.mostPerformantTool?.clearAll()">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“‹ å‡½æ•°åˆ—è¡¨ (<span id="functionCount">0</span>)</h2>
                    <div class="function-list" id="functionList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>æ·»åŠ å‡½æ•°åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ å†å²è®°å½• (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æµ‹è¯•å†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>âœ¨ æµ‹è¯•ç»“æœ</h2>
                    <div class="result-display" id="resultDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>è¿è¡Œæµ‹è¯•åå°†åœ¨æ­¤å±•ç¤ºç»“æœ</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="performanceCard" style="display:none;">
                    <h2>ğŸ“Š æ€§èƒ½å¯¹æ¯”</h2>
                    <div class="performance-grid" id="performanceGrid"></div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“ˆ å¯¹æ¯”åˆ†æ</h2>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background: #f8fafc; padding: 20px; border-radius: 14px;">
                <h3 style="color: #fa709a; margin-bottom: 12px;">mostPerformant å‡½æ•°ï¼ˆæ€§èƒ½æœ€å¼ºçš„å‡½æ•°ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const mostPerformant = (fns, iterations = 10000) => {
    const times = fns.map(fn => {
        const before = performance.now();
        for (let i = 0; i < iterations; i++) {
            fn();
        }
        return performance.now() - before;
    });
    return times.indexOf(Math.min(...times));
};</code></pre>
                </div>

                <h3 style="color: #fa709a; margin: 20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color: #334155; line-height: 1.8;">
                    <strong>mostPerformant</strong> å‡½æ•°è¿”å›è¯¥å‡½æ•°åœ¨æ‰§è¡Œé€Ÿåº¦æœ€å¿«çš„å‡½æ•°æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚
                    ä½¿ç”¨ <code>Array.prototype.map()</code> ç”Ÿæˆä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå€¼éƒ½æ˜¯è¿­ä»£æ¬¡æ•°ä¹‹åæ‰§è¡Œå‡½æ•°æ‰€èŠ±è´¹çš„æ€»æ—¶é—´ã€‚
                    ä½¿ç”¨ä¹‹å‰å’Œä¹‹åçš„ <code>performance.now()</code> å€¼çš„å·®å¼‚æ¥è·å¾—ä»¥æ¯«ç§’ä¸ºå•ä½çš„æ€»æ—¶é—´ï¼Œä»¥è¾¾åˆ°è¾ƒé«˜çš„ç²¾åº¦ã€‚
                    ä½¿ç”¨ <code>Math.min()</code> æ‰¾åˆ°æœ€å°çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶è¿”å›ä¸æ€§èƒ½æœ€å¥½çš„å‡½æ•°çš„ç´¢å¼•ç›¸å¯¹åº”çš„æœ€çŸ­æ—¶é—´çš„ç´¢å¼•ã€‚
                    çœç•¥ç¬¬äºŒä¸ªå‚æ•° iterationsï¼Œä»¥ä½¿ç”¨é»˜è®¤å€¼ 10000ã€‚è¿­ä»£æ¬¡æ•°è¶Šå¤šï¼Œç»“æœå°±è¶Šå¯é ï¼Œä½†è€—æ—¶ä¹Ÿè¶Šé•¿ã€‚
                </p>

                <h3 style="color: #fa709a; margin: 20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">mostPerformant([
    () => {
        // Loops through the entire array before returning `false`
        [1, 2, 3, 4, 5, 6, 7, 8, 9, '10'].every(el => typeof el === 'number');
    },
    () => {
        // Only needs to reach index `1` before returning `false`
        [1, '2', 3, 4, 5, 6, 7, 8, 9, 10].every(el => typeof el === 'number');
    }
]); // 1</code></pre>
                </div>

                <h3 style="color: #fa709a; margin: 20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="badge">æ€§èƒ½ä¼˜åŒ–</span>
                    <span class="badge">ç®—æ³•å¯¹æ¯”</span>
                    <span class="badge">ä»£ç ä¼˜åŒ–</span>
                    <span class="badge">åŸºå‡†æµ‹è¯•</span>
                    <span class="badge">æ€§èƒ½åˆ†æ</span>
                    <span class="badge">å‡½æ•°é€‰æ‹©</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const mostPerformant = (fns, iterations = 10000) => {
            const times = fns.map(fn => {
                const before = performance.now();
                for (let i = 0; i < iterations; i++) {
                    fn();
                }
                return performance.now() - before;
            });
            return times.indexOf(Math.min(...times));
        };

        class MostPerformantTool {
            constructor() {
                this.plugins = {};
                this.functions = [];
                this.testResults = null;
                this.history = [];
                this.stats = {
                    totalTests: 0,
                    totalFunctions: 0,
                    averageIterations: 0
                };
                this.checkboxOptions = [
                    { id: 'showResult', label: 'æ˜¾ç¤ºæµ‹è¯•ç»“æœ', checked: true },
                    { id: 'showPerformance', label: 'æ˜¾ç¤ºæ€§èƒ½å¯¹æ¯”', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºå¯¹æ¯”åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºæ‰§è¡Œä»£ç ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupInputNumber();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.updateFunctionList();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupInputNumber() {
                const container = document.getElementById('iterationsInput');
                if (!container) return;
                try {
                    this.plugins.iterationsInput = new InputNumber({
                        container,
                        value: 10000,
                        min: 100,
                        max: 1000000,
                        step: 1000,
                        onChange: () => {}
                    });
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰æ•°å­—è¾“å…¥åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿè¾“å…¥æ¡†:', error);
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = 'iterationsNative';
                    input.value = '10000';
                    input.min = '100';
                    input.max = '1000000';
                    input.step = '1000';
                    input.className = 'input-field';
                    container.appendChild(input);
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: this.checkboxOptions.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    this.checkboxOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            getIterationsValue() {
                if (this.plugins.iterationsInput?.getValue) {
                    return Number(this.plugins.iterationsInput.getValue() || 10000);
                }
                const native = document.getElementById('iterationsNative');
                return native ? Number(native.value || 10000) : 10000;
            }

            addFunction() {
                const input = document.getElementById('functionInput');
                if (!input) return;
                const functionCode = input.value.trim();

                if (!functionCode) {
                    this.showError('è¯·è¾“å…¥å‡½æ•°ä»£ç ');
                    return;
                }

                try {
                    // éªŒè¯å‡½æ•°ä»£ç 
                    let fn;
                    if (functionCode.startsWith('() =>') || functionCode.startsWith('function')) {
                        fn = eval(`(${functionCode})`);
                    } else {
                        fn = eval(`(() => { ${functionCode} })`);
                    }

                    if (typeof fn !== 'function') {
                        throw new Error('è¾“å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å‡½æ•°');
                    }

                    this.functions.push({
                        id: Date.now() + Math.random(),
                        code: functionCode,
                        fn: fn
                    });

                    input.value = '';
                    this.updateFunctionList();
                    this.showNotification(`å·²æ·»åŠ å‡½æ•° #${this.functions.length}`, 'success');
                } catch (error) {
                    this.showError('å‡½æ•°ä»£ç æ— æ•ˆ: ' + error.message);
                }
            }

            removeFunction(id) {
                this.functions = this.functions.filter(f => f.id !== id);
                this.updateFunctionList();
                this.showNotification('å·²ç§»é™¤å‡½æ•°', 'info');
            }

            updateFunctionList() {
                const container = document.getElementById('functionList');
                const count = document.getElementById('functionCount');
                if (!container) return;
                if (count) count.textContent = this.functions.length;

                if (this.functions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <p>æ·»åŠ å‡½æ•°åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>`;
                    return;
                }

                const html = this.functions.map((func, index) => {
                    const isWinner = this.testResults && this.testResults.winnerIndex === index;
                    return `
                        <div class="function-item ${isWinner ? 'winner' : ''}">
                            <div class="function-header">
                                <span class="function-index">å‡½æ•° #${index + 1}</span>
                                ${isWinner ? '<span style="color:#22c55e;font-weight:700;">ğŸ† æœ€å¿«</span>' : ''}
                            </div>
                            <div class="function-code">${this.escapeHtml(func.code)}</div>
                            <button class="function-remove" onclick="window.mostPerformantTool?.removeFunction('${func.id}')">åˆ é™¤</button>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async runTest() {
                if (this.functions.length < 2) {
                    this.showError('è‡³å°‘éœ€è¦æ·»åŠ  2 ä¸ªå‡½æ•°æ‰èƒ½è¿›è¡Œæ€§èƒ½æµ‹è¯•');
                    return;
                }

                const iterations = this.getIterationsValue();
                if (iterations < 100) {
                    this.showError('è¿­ä»£æ¬¡æ•°è‡³å°‘ä¸º 100');
                    return;
                }

                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const resultDisplay = document.getElementById('resultDisplay');
                    if (resultDisplay) {
                        resultDisplay.innerHTML = `
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p style="margin-top:12px;">æ­£åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•...</p>
                                <p style="font-size:0.85rem;color:#64748b;">è¿­ä»£æ¬¡æ•°: ${iterations.toLocaleString()}</p>
                            </div>
                        `;
                    }

                    // ä½¿ç”¨ setTimeout è®© UI æ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const start = performance.now();
                    const fns = this.functions.map(f => f.fn);
                    const winnerIndex = mostPerformant(fns, iterations);
                    const end = performance.now();
                    const totalTime = Math.round((end - start) * 1000) / 1000;

                    // è®¡ç®—æ¯ä¸ªå‡½æ•°çš„æ‰§è¡Œæ—¶é—´
                    const times = fns.map(fn => {
                        const before = performance.now();
                        for (let i = 0; i < iterations; i++) {
                            fn();
                        }
                        return performance.now() - before;
                    });

                    this.testResults = {
                        winnerIndex,
                        times,
                        iterations,
                        totalTime
                    };

                    this.stats.totalTests++;
                    this.stats.totalFunctions += this.functions.length;
                    this.stats.averageIterations = Math.round(
                        (this.stats.totalTests > 0 ? (this.stats.averageIterations * (this.stats.totalTests - 1) + iterations) / this.stats.totalTests : iterations) * 100
                    ) / 100;

                    this.displayResult();
                    this.updateFunctionList();
                    this.updateStats();
                    this.addToHistory();

                    if (this.getCheckboxValue('showPerformance')) {
                        this.displayPerformance();
                    }

                    if (this.getCheckboxValue('showAnalysis')) {
                        this.displayAnalysis();
                    }

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode();
                    }

                    const winner = this.functions[winnerIndex];
                    this.showNotification(`æµ‹è¯•å®Œæˆï¼æœ€å¿«å‡½æ•°: #${winnerIndex + 1}ï¼Œç”¨æ—¶ ${times[winnerIndex].toFixed(2)}ms`, 'success');
                } catch (error) {
                    this.showError('æµ‹è¯•å¤±è´¥: ' + error.message);
                }
            }

            displayResult() {
                const container = document.getElementById('resultDisplay');
                if (!container) return;

                if (!this.getCheckboxValue('showResult')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­æµ‹è¯•ç»“æœå±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (!this.testResults) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>è¿è¡Œæµ‹è¯•åå°†åœ¨æ­¤å±•ç¤ºç»“æœ</p>
                        </div>`;
                    return;
                }

                const winner = this.functions[this.testResults.winnerIndex];
                const winnerTime = this.testResults.times[this.testResults.winnerIndex];

                container.innerHTML = `
                    <div class="result-card">
                        <div class="result-label">æ€§èƒ½æœ€å¿«çš„å‡½æ•°</div>
                        <div class="result-value">å‡½æ•° #${this.testResults.winnerIndex + 1}</div>
                        <div style="color:#9f1239;margin-top:12px;">
                            æ‰§è¡Œæ—¶é—´: ${winnerTime.toFixed(2)}ms (${this.testResults.iterations.toLocaleString()} æ¬¡è¿­ä»£)
                        </div>
                    </div>
                `;
            }

            displayPerformance() {
                const card = document.getElementById('performanceCard');
                const grid = document.getElementById('performanceGrid');
                if (!card || !grid) return;

                if (!this.testResults) {
                    card.style.display = 'none';
                    return;
                }

                const maxTime = Math.max(...this.testResults.times);
                const sortedResults = this.testResults.times
                    .map((time, index) => ({ index, time }))
                    .sort((a, b) => a.time - b.time);

                const html = sortedResults.map((result, rank) => {
                    const func = this.functions[result.index];
                    const isWinner = result.index === this.testResults.winnerIndex;
                    const percentage = Math.round((result.time / maxTime) * 100);
                    const barWidth = 100 - percentage;

                    return `
                        <div class="performance-item ${isWinner ? 'winner' : ''}">
                            <div class="performance-rank">#${rank + 1}</div>
                            <div class="performance-info">
                                <div class="performance-name">å‡½æ•° #${result.index + 1}</div>
                                <div class="performance-bar-container">
                                    <div class="performance-bar" style="width: ${100 - barWidth}%"></div>
                                </div>
                            </div>
                            <div class="performance-time">
                                <div class="performance-time-value">${result.time.toFixed(2)}</div>
                                <div class="performance-time-unit">ms</div>
                            </div>
                        </div>
                    `;
                }).join('');

                grid.innerHTML = html;
                card.style.display = 'block';
            }

            displayAnalysis() {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('comparisonGrid');
                if (!card || !grid) return;

                if (!this.testResults) {
                    card.style.display = 'none';
                    return;
                }

                const winnerTime = this.testResults.times[this.testResults.winnerIndex];
                const slowestTime = Math.max(...this.testResults.times);
                const averageTime = this.testResults.times.reduce((a, b) => a + b, 0) / this.testResults.times.length;
                const speedup = (slowestTime / winnerTime).toFixed(2);

                grid.innerHTML = `
                    <div class="comparison-card">
                        <h4>ğŸ“Š æµ‹è¯•ä¿¡æ¯</h4>
                        <p>å‡½æ•°æ•°é‡: ${this.functions.length}</p>
                        <p>è¿­ä»£æ¬¡æ•°: ${this.testResults.iterations.toLocaleString()}</p>
                        <p>æ€»æµ‹è¯•æ—¶é—´: ${this.testResults.totalTime.toFixed(2)}ms</p>
                    </div>
                    <div class="comparison-card">
                        <h4>âš¡ æ€§èƒ½æ•°æ®</h4>
                        <p>æœ€å¿«: ${winnerTime.toFixed(2)}ms</p>
                        <p>æœ€æ…¢: ${slowestTime.toFixed(2)}ms</p>
                        <p>å¹³å‡: ${averageTime.toFixed(2)}ms</p>
                    </div>
                    <div class="comparison-card">
                        <h4>ğŸ“ˆ æ€§èƒ½æå‡</h4>
                        <p>é€Ÿåº¦æå‡: ${speedup}x</p>
                        <p>æ€§èƒ½å·®å¼‚: ${((slowestTime - winnerTime) / winnerTime * 100).toFixed(1)}%</p>
                        <p>æµ‹è¯•æ¬¡æ•°: ${this.stats.totalTests}</p>
                    </div>
                `;

                card.style.display = 'block';
            }

            addToHistory() {
                if (!this.testResults) return;

                const winner = this.functions[this.testResults.winnerIndex];
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    functionCount: this.functions.length,
                    iterations: this.testResults.iterations,
                    winnerIndex: this.testResults.winnerIndex,
                    winnerTime: this.testResults.times[this.testResults.winnerIndex],
                    totalTime: this.testResults.totalTime
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— æµ‹è¯•å†å²</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.totalTime.toFixed(2)}ms</div>
                        <div class="history-summary">
                            ${item.functionCount} ä¸ªå‡½æ•° | ${item.iterations.toLocaleString()} æ¬¡è¿­ä»£ | æœ€å¿«: å‡½æ•° #${item.winnerIndex + 1} (${item.winnerTime.toFixed(2)}ms)
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalTests}</div>
                        <div class="stat-label">æµ‹è¯•æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalFunctions}</div>
                        <div class="stat-label">ç´¯è®¡å‡½æ•°æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.functions.length}</div>
                        <div class="stat-label">å½“å‰å‡½æ•°æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.averageIterations.toLocaleString()}</div>
                        <div class="stat-label">å¹³å‡è¿­ä»£æ¬¡æ•°</div>
                    </div>
                `;
            }

            showCode() {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;

                if (this.functions.length === 0) {
                    if (section) section.style.display = 'none';
                    return;
                }

                const fnsCode = this.functions.map(f => f.code).join(',\n    ');
                const iterations = this.testResults ? this.testResults.iterations : this.getIterationsValue();

                const code = `const mostPerformant = (fns, iterations = 10000) => {
    const times = fns.map(fn => {
        const before = performance.now();
        for (let i = 0; i < iterations; i++) {
            fn();
        }
        return performance.now() - before;
    });
    return times.indexOf(Math.min(...times));
};

// å®šä¹‰æµ‹è¯•å‡½æ•°
const fns = [
    ${fnsCode}
];

// æ‰§è¡Œæ€§èƒ½æµ‹è¯•
const iterations = ${iterations};
const winnerIndex = mostPerformant(fns, iterations);

console.log('æ€§èƒ½æœ€å¿«çš„å‡½æ•°ç´¢å¼•:', winnerIndex);
console.log('å‡½æ•° #' + (winnerIndex + 1) + ' æ€§èƒ½æœ€å¥½');

// è¯´æ˜ï¼š
// 1. ä½¿ç”¨ performance.now() è·å–é«˜ç²¾åº¦æ—¶é—´
// 2. å¯¹æ¯ä¸ªå‡½æ•°æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„è¿­ä»£
// 3. è¿”å›æ‰§è¡Œæ—¶é—´æœ€çŸ­çš„å‡½æ•°çš„ç´¢å¼•
// æ—¶é—´å¤æ‚åº¦: O(n * m)ï¼Œn ä¸ºå‡½æ•°æ•°é‡ï¼Œm ä¸ºè¿­ä»£æ¬¡æ•°`;

                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            clearAll() {
                this.functions = [];
                this.testResults = null;
                this.updateFunctionList();
                this.displayResult();
                const performanceCard = document.getElementById('performanceCard');
                if (performanceCard) performanceCard.style.display = 'none';
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                const input = document.getElementById('functionInput');
                if (input) input.value = '';
                this.updateStats();
                this.showNotification('å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®', 'info');
            }

            loadSample() {
                const samples = [
                    {
                        code: '() => { [1,2,3,4,5].map(x => x * 2); }',
                        label: 'Array.map'
                    },
                    {
                        code: '() => { const arr = [1,2,3,4,5]; for(let i = 0; i < arr.length; i++) arr[i] * 2; }',
                        label: 'for å¾ªç¯'
                    },
                    {
                        code: '() => { [1,2,3,4,5].forEach(x => x * 2); }',
                        label: 'Array.forEach'
                    }
                ];

                // æ¸…ç©ºç°æœ‰å‡½æ•°
                this.functions = [];
                
                // æ·»åŠ ç¤ºä¾‹å‡½æ•°
                samples.forEach(sample => {
                    try {
                        const fn = eval(`(${sample.code})`);
                        this.functions.push({
                            id: Date.now() + Math.random(),
                            code: sample.code,
                            fn: fn
                        });
                    } catch (error) {
                        console.warn('åŠ è½½ç¤ºä¾‹å‡½æ•°å¤±è´¥:', error);
                    }
                });

                this.updateFunctionList();
                this.showNotification('å·²åŠ è½½ç¤ºä¾‹å‡½æ•°', 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨å‡½æ•°æ€§èƒ½æµ‹è¯•å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">âš¡</div>
                                <p style="color:#1f2937;line-height:1.8;">
                                    ä½¿ç”¨ <strong>mostPerformant</strong> å‡½æ•°æµ‹è¯•å¤šä¸ªå‡½æ•°çš„æ€§èƒ½ï¼Œæ‰¾å‡ºæ‰§è¡Œé€Ÿåº¦æœ€å¿«çš„å‡½æ•°ã€‚
                                    æ”¯æŒå¯è§†åŒ–å±•ç¤ºã€æ€§èƒ½å¯¹æ¯”ã€å†å²è¿½è¸ªä¸ä»£ç é¢„è§ˆã€‚
                                </p>
                                <div style="background:#fce7f3;border-left:4px solid #fa709a;padding:12px;border-radius:12px;color:#9f1239;margin-top:12px;">
                                    <strong>äº®ç‚¹ï¼š</strong> å¤šå‡½æ•°å¯¹æ¯”ã€æ€§èƒ½å¯è§†åŒ–ã€è¯¦ç»†åˆ†æã€ä»£ç é¢„è§ˆã€å†å²è®°å½•ã€‚
                                </div>
                                <ul style="color:#1f2937;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>æ”¯æŒæ·»åŠ å¤šä¸ªå‡½æ•°è¿›è¡Œæ€§èƒ½å¯¹æ¯”</li>
                                    <li>å¯é…ç½®è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤ 10000 æ¬¡ï¼‰</li>
                                    <li>å¯è§†åŒ–å±•ç¤ºæ€§èƒ½å¯¹æ¯”ç»“æœ</li>
                                    <li>æä¾›è¯¦ç»†çš„æ€§èƒ½åˆ†æå’Œç»Ÿè®¡ä¿¡æ¯</li>
                                    <li>è®°å½•æµ‹è¯•å†å²å¹¶æ”¯æŒä»£ç é¢„è§ˆ</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.mostPerformantTool = new MostPerformantTool();
        });

        if (document.readyState !== 'loading' && !window.mostPerformantTool) {
            window.mostPerformantTool = new MostPerformantTool();
        }
    </script>
</body>

</html>
