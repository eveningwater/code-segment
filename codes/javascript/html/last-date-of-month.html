<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月末日期查询平台 - lastDateOfMonth</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <!-- Highlight.js 代码高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .result-display {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            padding: 30px;
            color: white;
            text-align: center;
            margin-top: 20px;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .result-value {
            font-size: 3rem;
            font-weight: 700;
            margin: 15px 0;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .result-info {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .calendar-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            padding: 8px;
            font-size: 0.9rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background: #f8f9fa;
        }

        .calendar-day:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            background: #f8f9fa;
            transform: none;
        }

        .calendar-day.today {
            background: #3b82f6;
            color: white;
            font-weight: 700;
        }

        .calendar-day.last-day {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .quick-query {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .month-list {
            max-height: 350px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .month-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f093fb;
            transition: all 0.3s ease;
        }

        .month-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .month-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .month-date {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f5576c;
            font-family: 'Monaco', 'Menlo', monospace;
            margin-bottom: 6px;
        }

        .month-info {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .stats-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #f5576c;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .code-block {
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            overflow-x: auto;
            background: #282c34;
            border-radius: 8px;
        }

        .code-block pre code {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            display: block;
        }

        .hljs {
            background: #282c34;
            padding: 0;
        }

        .advanced-options {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .year-range {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .year-range > div {
            flex: 1;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .modal-content {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>📅 月末日期查询平台</h1>
            <p>基于 lastDateOfMonth 函数的智能日历工具，快速查询任意月份的最后一天、可视化日历展示</p>
        </div>

        <div class="main-content">
            <!-- 左侧：控制面板 -->
            <div class="sidebar">
                <div class="card">
                    <h2>📆 日期查询</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>选择日期</label>
                            <div id="datePickerContainer"></div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.lastDateTool?.queryLastDate()">🔍 查询月末</button>
                        </div>

                        <div class="quick-query">
                            <button class="btn btn-info btn-sm" onclick="window.lastDateTool?.queryToday()">📅 本月</button>
                            <button class="btn btn-success btn-sm" onclick="window.lastDateTool?.queryNextMonth()">➡️ 下月</button>
                            <button class="btn btn-warning btn-sm" onclick="window.lastDateTool?.queryPrevMonth()">⬅️ 上月</button>
                            <button class="btn btn-danger btn-sm" onclick="window.lastDateTool?.queryThisYear()">📊 全年</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>📋 批量查询</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>查询类型</label>
                            <div id="queryTypeSelect"></div>
                        </div>

                        <div class="input-group" id="yearRangeGroup" style="display: none;">
                            <label>年份范围</label>
                            <div class="year-range">
                                <div id="startYearInput"></div>
                                <div id="endYearInput"></div>
                            </div>
                        </div>

                        <div class="input-group" id="monthCountGroup" style="display: none;">
                            <label>查询月数</label>
                            <div id="monthCountInput"></div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-success btn-block" onclick="window.lastDateTool?.batchQuery()">🚀 批量查询</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>⚙️ 高级选项</h2>
                    <div class="advanced-options">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>
            </div>

            <!-- 右侧：显示区域 -->
            <div class="visualization">
                <div class="card">
                    <h2>📊 查询结果</h2>
                    <div id="resultSection" style="display: none;">
                        <div class="result-display">
                            <div class="result-title">月末日期</div>
                            <div class="result-value" id="resultValue">-</div>
                            <div class="result-info" id="resultInfo">-</div>
                        </div>
                    </div>
                    <div id="noResultSection">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            请选择日期并点击"查询月末"按钮
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>📅 日历视图</h2>
                    <div class="calendar" id="calendar">
                        <div class="calendar-header">
                            <button class="btn btn-sm btn-info" onclick="window.lastDateTool?.prevMonthCalendar()">‹ 上月</button>
                            <div class="calendar-title" id="calendarTitle">2024年1月</div>
                            <button class="btn btn-sm btn-info" onclick="window.lastDateTool?.nextMonthCalendar()">下月 ›</button>
                        </div>
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">日</div>
                            <div class="calendar-weekday">一</div>
                            <div class="calendar-weekday">二</div>
                            <div class="calendar-weekday">三</div>
                            <div class="calendar-weekday">四</div>
                            <div class="calendar-weekday">五</div>
                            <div class="calendar-weekday">六</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- 日历天数将动态生成 -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>📜 查询记录 (<span id="queryCount">0</span>)</h2>
                    <div class="month-list" id="monthList">
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            暂无查询记录
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="card">
            <h2>📈 统计信息</h2>
            <div class="stats-section">
                <div class="stats-grid" id="statsGrid">
                    <!-- 统计信息将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 代码预览 -->
        <div class="card" id="codeSection" style="display: none;">
            <h2>💻 执行代码</h2>
            <div class="code-block">
                <pre><code class="language-javascript" id="codePreview">// 代码将在这里显示</code></pre>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="card">
            <h2>📖 函数说明</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                <h3 style="color: #f5576c; margin-bottom: 15px;">lastDateOfMonth 函数</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const lastDateOfMonth = (date = new Date()) => {
    const d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return d.toISOString().split('T')[0];
};</code></pre>
                </div>

                <h3 style="color: #f5576c; margin: 20px 0 15px 0;">函数说明</h3>
                <p style="color: #495057; line-height: 1.8;">
                    <strong>lastDateOfMonth</strong> 函数返回给定日期所在月份的最后一天的字符串表示形式（YYYY-MM-DD 格式）。
                    它通过创建下个月第0天的日期对象来获取当前月份的最后一天。
                </p>

                <h3 style="color: #f5576c; margin: 20px 0 15px 0;">使用方式</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">lastDateOfMonth(new Date('2024-01-15'));  // '2024-01-31'
lastDateOfMonth(new Date('2024-02-15'));  // '2024-02-29' (闰年)
lastDateOfMonth(new Date('2023-02-15'));  // '2023-02-28' (平年)
lastDateOfMonth();                         // 当前月份的最后一天</code></pre>
                </div>

                <h3 style="color: #f5576c; margin: 20px 0 15px 0;">应用场景</h3>
                <ul style="color: #495057; padding-left: 20px; line-height: 1.8;">
                    <li>💰 <strong>财务结算</strong>：计算月度账单截止日期</li>
                    <li>📊 <strong>数据统计</strong>：生成月度报表的结束日期</li>
                    <li>📅 <strong>日程管理</strong>：设置月末提醒事项</li>
                    <li>🏢 <strong>工资发放</strong>：确定工资结算周期</li>
                    <li>📝 <strong>订阅服务</strong>：计算订阅到期日期</li>
                    <li>🗓️ <strong>日历应用</strong>：显示月份边界信息</li>
                </ul>

                <h3 style="color: #f5576c; margin: 20px 0 15px 0;">特点</h3>
                <ul style="color: #495057; padding-left: 20px; line-height: 1.8;">
                    <li>✅ 自动处理大小月（28、29、30、31天）</li>
                    <li>✅ 正确处理闰年2月（29天）</li>
                    <li>✅ 返回标准 ISO 日期格式</li>
                    <li>✅ 支持任意年份和月份</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <!-- Highlight.js 代码高亮 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // 核心 lastDateOfMonth 函数
        const lastDateOfMonth = (date = new Date()) => {
            const d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            return d.toISOString().split('T')[0];
        };

        // LastDateTool 工具类
        class LastDateTool {
            constructor() {
                this.plugins = {};
                this.currentDate = new Date();
                this.calendarDate = new Date();
                this.queryHistory = [];
                this.stats = {
                    totalQueries: 0,
                    uniqueMonths: new Set(),
                    monthDays: {
                        28: 0,
                        29: 0,
                        30: 0,
                        31: 0
                    }
                };
                this.init();
            }

            // 初始化
            async init() {
                try {
                    await this.loadPlugins();
                    this.setupDatePicker();
                    this.setupSelect();
                    this.setupInputNumbers();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.renderCalendar();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showError('初始化失败: ' + error.message);
                }
            }

            // 初始化代码高亮
            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    console.log('Highlight.js 初始化完成');
                } else {
                    console.warn('Highlight.js 未加载');
                }
            }

            // 加载插件
            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('部分插件加载失败:', error);
                }
            }

            // 设置 DatePicker
            setupDatePicker() {
                const datePickerContainer = document.getElementById('datePickerContainer');
                if (!datePickerContainer) return;

                try {
                    this.plugins.datePicker = new DateTimePicker({
                        container: datePickerContainer,
                        format: 'YYYY-MM-DD',
                        onChange: (value) => {
                            if (value) {
                                this.currentDate = new Date(value);
                                if (this.getCheckboxValue('autoQuery')) {
                                    this.queryLastDate();
                                }
                            }
                        }
                    });
                    
                    // 设置初始值为今天
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    this.plugins.datePicker.setValue(todayStr);
                } catch (error) {
                    console.warn('DatePicker 初始化失败:', error);
                    datePickerContainer.innerHTML = `
                        <input type="date" id="datePicker" value="${new Date().toISOString().split('T')[0]}" 
                               style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">
                    `;
                    const nativeInput = document.getElementById('datePicker');
                    if (nativeInput) {
                        nativeInput.addEventListener('change', (e) => {
                            this.currentDate = new Date(e.target.value);
                            if (this.getCheckboxValue('autoQuery')) {
                                this.queryLastDate();
                            }
                        });
                    }
                }
            }

            // 设置 Select
            setupSelect() {
                const queryTypeSelect = document.getElementById('queryTypeSelect');
                if (!queryTypeSelect) return;

                try {
                    const typeOptions = [
                        { value: 'single', label: '单个查询' },
                        { value: 'year', label: '整年查询' },
                        { value: 'range', label: '年份范围' },
                        { value: 'future', label: '未来N月' }
                    ];

                    this.plugins.queryTypeSelect = new Select({
                        container: queryTypeSelect,
                        options: typeOptions,
                        placeholder: '选择查询类型',
                        onChange: (value) => {
                            this.updateBatchQueryUI(value);
                        }
                    });

                    this.plugins.queryTypeSelect.setValue('single');
                } catch (error) {
                    console.warn('Select 插件加载失败，使用原生下拉框:', error);
                    queryTypeSelect.innerHTML = `
                        <select id="queryTypeSelectNative" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">
                            <option value="single">单个查询</option>
                            <option value="year">整年查询</option>
                            <option value="range">年份范围</option>
                            <option value="future">未来N月</option>
                        </select>
                    `;
                    const nativeSelect = document.getElementById('queryTypeSelectNative');
                    if (nativeSelect) {
                        nativeSelect.addEventListener('change', (e) => {
                            this.updateBatchQueryUI(e.target.value);
                        });
                    }
                }
            }

            // 设置 InputNumber
            setupInputNumbers() {
                const currentYear = new Date().getFullYear();

                // 开始年份
                const startYearInput = document.getElementById('startYearInput');
                if (startYearInput) {
                    try {
                        this.plugins.startYearInput = new InputNumber({
                            container: startYearInput,
                            value: currentYear,
                            min: 1900,
                            max: 2100,
                            step: 1
                        });
                    } catch (error) {
                        console.warn('开始年份 InputNumber 失败:', error);
                        startYearInput.innerHTML = `<input type="number" id="startYear" value="${currentYear}" min="1900" max="2100" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">`;
                    }
                }

                // 结束年份
                const endYearInput = document.getElementById('endYearInput');
                if (endYearInput) {
                    try {
                        this.plugins.endYearInput = new InputNumber({
                            container: endYearInput,
                            value: currentYear,
                            min: 1900,
                            max: 2100,
                            step: 1
                        });
                    } catch (error) {
                        console.warn('结束年份 InputNumber 失败:', error);
                        endYearInput.innerHTML = `<input type="number" id="endYear" value="${currentYear}" min="1900" max="2100" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">`;
                    }
                }

                // 月数
                const monthCountInput = document.getElementById('monthCountInput');
                if (monthCountInput) {
                    try {
                        this.plugins.monthCountInput = new InputNumber({
                            container: monthCountInput,
                            value: 6,
                            min: 1,
                            max: 24,
                            step: 1
                        });
                    } catch (error) {
                        console.warn('月数 InputNumber 失败:', error);
                        monthCountInput.innerHTML = `<input type="number" id="monthCount" value="6" min="1" max="24" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1rem;">`;
                    }
                }
            }

            // 设置复选框
            setupCheckboxes() {
                const checkboxGroup = document.getElementById('checkboxGroup');
                if (!checkboxGroup) return;

                const options = [
                    { id: 'autoQuery', label: '自动查询', checked: true },
                    { id: 'showCalendar', label: '显示日历', checked: true },
                    { id: 'showNotifications', label: '显示通知', checked: true },
                    { id: 'showCode', label: '显示代码', checked: true }
                ];

                try {
                    const checkboxGroupInstance = Checkbox.createCheckboxGroup({
                        items: options.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: (checkedStates) => {
                            // 可以在这里添加响应逻辑
                        }
                    });

                    checkboxGroup.appendChild(checkboxGroupInstance.container);
                    this.plugins.checkboxGroup = checkboxGroupInstance;
                    this.checkboxOptions = options;
                } catch (error) {
                    console.warn('自定义复选框加载失败，使用原生复选框:', error);
                    this.setupNativeCheckboxes(options, checkboxGroup);
                }
            }

            // 设置原生复选框
            setupNativeCheckboxes(options, container) {
                options.forEach(option => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.style.marginBottom = '10px';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>
                        <label for="${option.id}" style="margin-left: 8px; cursor: pointer;">${option.label}</label>
                    `;
                    container.appendChild(checkboxItem);
                });
            }

            // 获取复选框值
            getCheckboxValue(checkboxId) {
                if (this.plugins.checkboxGroup && this.checkboxOptions) {
                    try {
                        const optionIndex = this.checkboxOptions.findIndex(option => option.id === checkboxId);
                        if (optionIndex !== -1) {
                            const checkedStates = this.plugins.checkboxGroup.getAllChecked();
                            return checkedStates[optionIndex] || false;
                        }
                    } catch (error) {
                        console.warn('获取复选框值失败，使用原生方法:', error);
                    }
                }

                const checkbox = document.getElementById(checkboxId);
                return checkbox ? checkbox.checked : false;
            }

            // 更新批量查询 UI
            updateBatchQueryUI(type) {
                const yearRangeGroup = document.getElementById('yearRangeGroup');
                const monthCountGroup = document.getElementById('monthCountGroup');

                if (yearRangeGroup) yearRangeGroup.style.display = 'none';
                if (monthCountGroup) monthCountGroup.style.display = 'none';

                if (type === 'range') {
                    if (yearRangeGroup) yearRangeGroup.style.display = 'block';
                } else if (type === 'future') {
                    if (monthCountGroup) monthCountGroup.style.display = 'block';
                }
            }

            // 查询月末日期
            queryLastDate() {
                try {
                    const lastDate = lastDateOfMonth(this.currentDate);
                    const lastDay = new Date(lastDate).getDate();
                    
                    this.stats.totalQueries++;
                    const monthKey = `${this.currentDate.getFullYear()}-${this.currentDate.getMonth() + 1}`;
                    this.stats.uniqueMonths.add(monthKey);
                    this.stats.monthDays[lastDay]++;

                    this.addToHistory({
                        date: this.currentDate,
                        lastDate: lastDate,
                        lastDay: lastDay
                    });

                    this.displayResult(lastDate);
                    this.updateCalendar(this.currentDate);
                    this.updateStats();

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode(this.currentDate, lastDate);
                    }

                    this.showNotification(`${this.currentDate.getFullYear()}年${this.currentDate.getMonth() + 1}月的最后一天是 ${lastDate}`, 'success');
                } catch (error) {
                    this.showError('查询失败: ' + error.message);
                }
            }

            // 快捷查询 - 今天所在月
            queryToday() {
                this.currentDate = new Date();
                if (this.plugins.datePicker) {
                    this.plugins.datePicker.setValue(this.currentDate.toISOString().split('T')[0]);
                }
                this.queryLastDate();
            }

            // 快捷查询 - 下个月
            queryNextMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
                if (this.plugins.datePicker) {
                    this.plugins.datePicker.setValue(this.currentDate.toISOString().split('T')[0]);
                }
                this.queryLastDate();
            }

            // 快捷查询 - 上个月
            queryPrevMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
                if (this.plugins.datePicker) {
                    this.plugins.datePicker.setValue(this.currentDate.toISOString().split('T')[0]);
                }
                this.queryLastDate();
            }

            // 快捷查询 - 全年
            queryThisYear() {
                this.batchQueryYear(this.currentDate.getFullYear());
            }

            // 批量查询
            batchQuery() {
                let queryType = 'single';
                
                if (this.plugins.queryTypeSelect) {
                    try {
                        queryType = this.plugins.queryTypeSelect.getValue();
                    } catch (e) {
                        const select = document.getElementById('queryTypeSelectNative');
                        if (select) queryType = select.value;
                    }
                }

                switch (queryType) {
                    case 'year':
                        this.batchQueryYear(this.currentDate.getFullYear());
                        break;
                    case 'range':
                        this.batchQueryRange();
                        break;
                    case 'future':
                        this.batchQueryFuture();
                        break;
                    default:
                        this.queryLastDate();
                }
            }

            // 批量查询 - 整年
            batchQueryYear(year) {
                for (let month = 0; month < 12; month++) {
                    const date = new Date(year, month, 1);
                    const lastDate = lastDateOfMonth(date);
                    const lastDay = new Date(lastDate).getDate();
                    
                    this.stats.totalQueries++;
                    const monthKey = `${year}-${month + 1}`;
                    this.stats.uniqueMonths.add(monthKey);
                    this.stats.monthDays[lastDay]++;

                    this.addToHistory({
                        date: date,
                        lastDate: lastDate,
                        lastDay: lastDay
                    });
                }

                this.updateStats();
                this.showNotification(`已查询 ${year} 年全部 12 个月`, 'success');
            }

            // 批量查询 - 年份范围
            batchQueryRange() {
                let startYear, endYear;

                if (this.plugins.startYearInput && this.plugins.endYearInput) {
                    try {
                        startYear = this.plugins.startYearInput.getValue();
                        endYear = this.plugins.endYearInput.getValue();
                    } catch (e) {
                        const startInput = document.getElementById('startYear');
                        const endInput = document.getElementById('endYear');
                        if (startInput && endInput) {
                            startYear = parseInt(startInput.value);
                            endYear = parseInt(endInput.value);
                        }
                    }
                } else {
                    startYear = this.currentDate.getFullYear();
                    endYear = startYear;
                }

                if (startYear > endYear) {
                    this.showError('开始年份不能大于结束年份');
                    return;
                }

                if (endYear - startYear > 10) {
                    this.showError('年份范围不能超过 10 年');
                    return;
                }

                for (let year = startYear; year <= endYear; year++) {
                    this.batchQueryYear(year);
                }

                this.showNotification(`已查询 ${startYear}-${endYear} 年共 ${(endYear - startYear + 1) * 12} 个月`, 'success');
            }

            // 批量查询 - 未来N月
            batchQueryFuture() {
                let monthCount = 6;

                if (this.plugins.monthCountInput) {
                    try {
                        monthCount = this.plugins.monthCountInput.getValue();
                    } catch (e) {
                        const input = document.getElementById('monthCount');
                        if (input) monthCount = parseInt(input.value);
                    }
                }

                for (let i = 0; i < monthCount; i++) {
                    const date = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + i, 1);
                    const lastDate = lastDateOfMonth(date);
                    const lastDay = new Date(lastDate).getDate();
                    
                    this.stats.totalQueries++;
                    const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    this.stats.uniqueMonths.add(monthKey);
                    this.stats.monthDays[lastDay]++;

                    this.addToHistory({
                        date: date,
                        lastDate: lastDate,
                        lastDay: lastDay
                    });
                }

                this.updateStats();
                this.showNotification(`已查询未来 ${monthCount} 个月`, 'success');
            }

            // 渲染日历
            renderCalendar() {
                this.updateCalendar(this.calendarDate);
            }

            // 更新日历
            updateCalendar(date) {
                if (!this.getCheckboxValue('showCalendar')) return;

                this.calendarDate = new Date(date);
                const year = this.calendarDate.getFullYear();
                const month = this.calendarDate.getMonth();
                
                // 更新标题
                const calendarTitle = document.getElementById('calendarTitle');
                if (calendarTitle) {
                    calendarTitle.textContent = `${year}年${month + 1}月`;
                }

                // 获取月份信息
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();
                
                // 上个月的天数
                const prevMonthLastDay = new Date(year, month, 0).getDate();

                const calendarDays = document.getElementById('calendarDays');
                if (!calendarDays) return;

                let html = '';
                
                // 上个月的日期
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    html += `<div class="calendar-day other-month">${prevMonthLastDay - i}</div>`;
                }

                // 当前月的日期
                const today = new Date();
                const lastDateOfThisMonth = lastDay.getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    const isToday = year === today.getFullYear() && 
                                   month === today.getMonth() && 
                                   day === today.getDate();
                    const isLastDay = day === lastDateOfThisMonth;
                    
                    const classes = ['calendar-day'];
                    if (isToday) classes.push('today');
                    if (isLastDay) classes.push('last-day');

                    html += `<div class="${classes.join(' ')}">${day}</div>`;
                }

                // 下个月的日期（填充剩余格子）
                const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
                const remainingCells = totalCells - (startDayOfWeek + daysInMonth);
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-day other-month">${day}</div>`;
                }

                calendarDays.innerHTML = html;
            }

            // 日历 - 上个月
            prevMonthCalendar() {
                this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() - 1, 1);
                this.updateCalendar(this.calendarDate);
            }

            // 日历 - 下个月
            nextMonthCalendar() {
                this.calendarDate = new Date(this.calendarDate.getFullYear(), this.calendarDate.getMonth() + 1, 1);
                this.updateCalendar(this.calendarDate);
            }

            // 显示结果
            displayResult(lastDate) {
                const resultSection = document.getElementById('resultSection');
                const noResultSection = document.getElementById('noResultSection');
                const resultValue = document.getElementById('resultValue');
                const resultInfo = document.getElementById('resultInfo');

                if (resultSection) resultSection.style.display = 'block';
                if (noResultSection) noResultSection.style.display = 'none';

                if (resultValue) {
                    resultValue.textContent = lastDate;
                }

                if (resultInfo) {
                    const date = new Date(lastDate);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
                    const dayName = dayNames[date.getDay()];
                    
                    resultInfo.textContent = `${year}年${month}月共 ${day} 天，最后一天是${dayName}`;
                }
            }

            // 添加到历史记录
            addToHistory(item) {
                this.queryHistory.unshift(item);
                
                // 限制历史记录数量
                if (this.queryHistory.length > 50) {
                    this.queryHistory = this.queryHistory.slice(0, 50);
                }

                this.updateHistoryDisplay();
            }

            // 更新历史显示
            updateHistoryDisplay() {
                const monthList = document.getElementById('monthList');
                const queryCount = document.getElementById('queryCount');

                if (!monthList) return;

                if (queryCount) {
                    queryCount.textContent = this.queryHistory.length;
                }

                if (this.queryHistory.length === 0) {
                    monthList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">暂无查询记录</div>';
                    return;
                }

                let html = '';
                this.queryHistory.slice(0, 20).forEach((item) => {
                    const year = item.date.getFullYear();
                    const month = item.date.getMonth() + 1;
                    
                    html += `
                        <div class="month-item">
                            <div class="month-title">${year}年${month}月</div>
                            <div class="month-date">${item.lastDate}</div>
                            <div class="month-info">共 ${item.lastDay} 天</div>
                        </div>
                    `;
                });

                monthList.innerHTML = html;
            }

            // 更新统计信息
            updateStats() {
                const statsGrid = document.getElementById('statsGrid');
                if (!statsGrid) return;

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalQueries}</div>
                        <div class="stat-label">查询次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.uniqueMonths.size}</div>
                        <div class="stat-label">不同月份</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.monthDays[28]}</div>
                        <div class="stat-label">28天月份</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.monthDays[29]}</div>
                        <div class="stat-label">29天月份</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.monthDays[30]}</div>
                        <div class="stat-label">30天月份</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.monthDays[31]}</div>
                        <div class="stat-label">31天月份</div>
                    </div>
                `;
            }

            // 显示代码
            showCode(date, lastDate) {
                const codeSection = document.getElementById('codeSection');
                const codePreview = document.getElementById('codePreview');

                if (!codePreview) return;

                const dateStr = date.toISOString().split('T')[0];
                const code = `// 查询日期
const date = new Date('${dateStr}');

// 获取月末日期
const lastDate = lastDateOfMonth(date);

// 结果: '${lastDate}'
// ${date.getFullYear()}年${date.getMonth() + 1}月共 ${new Date(lastDate).getDate()} 天`;

                codePreview.textContent = code;
                if (window.hljs) {
                    hljs.highlightElement(codePreview);
                }

                if (codeSection) {
                    codeSection.style.display = 'block';
                }
            }

            // 显示通知
            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            // 显示错误
            showError(message) {
                this.showNotification(message, 'error');
            }

            // 显示欢迎消息
            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: '🎉 欢迎使用月末日期查询平台',
                        content: `
                            <div style="padding: 20px;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">📅</div>
                                    <h3 style="margin: 0 0 10px 0; color: #f5576c;">功能特色</h3>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <ul style="margin: 0; padding-left: 20px; color: #495057;">
                                        <li>快速查询任意月份的最后一天</li>
                                        <li>可视化日历展示（高亮月末日期）</li>
                                        <li>批量查询（整年、年份范围、未来N月）</li>
                                        <li>自动处理闰年和大小月</li>
                                        <li>查询历史记录和统计分析</li>
                                        <li>代码预览和实时反馈</li>
                                    </ul>
                                </div>

                                <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; border-left: 4px solid #10b981; margin-bottom: 15px;">
                                    <p style="margin: 0; font-size: 14px; color: #16a34a;">
                                        <strong>💡 使用步骤：</strong>
                                    </p>
                                    <ol style="margin: 8px 0 0 0; padding-left: 20px; color: #16a34a; font-size: 14px;">
                                        <li>选择日期（或使用快捷按钮）</li>
                                        <li>点击"查询月末"按钮</li>
                                        <li>查看日历视图中的高亮月末日期</li>
                                        <li>尝试批量查询整年或多年数据</li>
                                        <li>查看统计信息和历史记录</li>
                                    </ol>
                                </div>

                                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <p style="margin: 0; font-size: 14px; color: #d97706;">
                                        <strong>🎨 日历说明：</strong> 蓝色表示今天，渐变色（动画）表示当月最后一天。
                                    </p>
                                </div>
                            </div>
                        `,
                        type: "alert"
                    });
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM内容加载完成，开始初始化...');
            window.lastDateTool = new LastDateTool();
            console.log('月末日期查询平台初始化完成');
        });

        // 如果 DOMContentLoaded 已经触发，立即执行
        if (document.readyState === 'loading') {
            console.log('文档仍在加载，等待 DOMContentLoaded 事件...');
        } else {
            console.log('文档已加载完成，立即执行初始化...');
            window.lastDateTool = new LastDateTool();
        }
    </script>
</body>

</html>

