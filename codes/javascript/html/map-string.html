<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—ç¬¦ä¸²æ˜ å°„ä¸å¯è§†åŒ–å¹³å° - mapString</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #b6fbff 0%, #83a4d4 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.15rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 28px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
            font-size: 1rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.3s ease;
        }

        .textarea-field {
            min-height: 140px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 18px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #60a5fa, #2563eb);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #818cf8, #4338ca);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(30, 64, 175, 0.25);
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .string-visualization,
        .result-visualization {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 12px;
        }

        .char-card {
            background: white;
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s ease;
        }

        .char-card.highlight {
            border: 2px solid #60a5fa;
            transform: translateY(-4px);
        }

        .char-index {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }

        .char-before,
        .char-after {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            font-family: 'Fira Code', 'Monaco', monospace;
        }

        .char-after {
            color: #2563eb;
        }

        .char-meta {
            font-size: 0.75rem;
            color: #0f172a;
            text-align: center;
        }

        .result-preview {
            margin-top: 18px;
            background: #0f172a;
            color: #e2e8f0;
            padding: 18px;
            border-radius: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 1.05rem;
            word-break: break-word;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
            margin-top: 14px;
        }

        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
        }

        .analysis-card h4 {
            font-size: 0.95rem;
            color: #1d4ed8;
            margin-bottom: 8px;
        }

        .analysis-card p {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            color: #475569;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 10px;
        }

        .history-item {
            background: white;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #0f172a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px;
            margin-top: 14px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 800;
            color: #2563eb;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 6px;
        }

        .timeline {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .timeline-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #60a5fa, #2563eb);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .timeline-content {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 12px 14px;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
        }

        .code-block {
            margin-top: 16px;
            border-radius: 10px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
            border-radius: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .function-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 100px;
            background: linear-gradient(135deg, #60a5fa, #2563eb);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¤ å­—ç¬¦ä¸²æ˜ å°„ä¸å¯è§†åŒ–å¹³å°</h1>
            <p>åŸºäº mapString çš„ä¸€ç«™å¼å­—ç¬¦ä¸²å¤„ç†å®éªŒå®¤ï¼Œæ”¯æŒå¤šç§æ˜ å°„å‡½æ•°ã€å­—ç¬¦çº§å¯è§†åŒ–ã€ç»Ÿè®¡åˆ†æã€å†å²è¿½è¸ªä¸ä»£ç é¢„è§ˆ</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>âœï¸ è¾“å…¥é…ç½®</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>åŸå§‹å­—ç¬¦ä¸²</label>
                            <textarea id="stringInput" class="textarea-field" placeholder="Hello, world!">Hello, world!</textarea>
                        </div>

                        <div class="input-group">
                            <label>æ˜ å°„å‡½æ•°</label>
                            <div id="functionSelect"></div>
                        </div>

                        <div class="input-group" id="shiftInputContainer" style="display:none;">
                            <label>ä½ç§»é‡ï¼ˆç”¨äº ROT/Shift æ˜ å°„ï¼‰</label>
                            <div id="shiftInput"></div>
                        </div>

                        <div class="input-group">
                            <label>è‡ªå®šä¹‰å‚æ•°ï¼ˆå¯é€‰ï¼Œå¦‚ JSON æˆ–æ›¿æ¢è¡¨ï¼‰</label>
                            <input id="customParam" class="input-field" placeholder='ä¾‹å¦‚ï¼š{"from":"o","to":"0"}' />
                        </div>

                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.stringTool?.execute()">âš¡ æ‰§è¡Œæ˜ å°„</button>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.stringTool?.loadSample()">ğŸ“„ ç¤ºä¾‹</button>
                            <button class="btn btn-info" onclick="window.stringTool?.reverseString()">ğŸ” ç¿»è½¬</button>
                            <button class="btn btn-warning" onclick="window.stringTool?.shuffleString()">ğŸ² æ‰“ä¹±</button>
                            <button class="btn btn-danger" onclick="window.stringTool?.clear()">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ å†å²è®°å½• (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— å†å²è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>ğŸ” å­—ç¬¦çº§æ˜ å°„</h2>
                    <div class="string-visualization" id="stringVisualization">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ§±</div>
                            <p>æ‰§è¡Œæ˜ å°„åå°†å±•ç¤ºå­—ç¬¦çº§æ˜ å°„è¿‡ç¨‹</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âœ¨ æ˜ å°„ç»“æœ</h2>
                    <div class="result-visualization" id="resultVisualization">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸŒˆ</div>
                            <p>æ˜ å°„åçš„å­—ç¬¦ä¸²å°†åœ¨æ­¤å±•ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background: #f8fafc; padding: 20px; border-radius: 14px;">
                <h3 style="color:#2563eb; margin-bottom: 12px;">mapString å‡½æ•°ï¼ˆå­—ç¬¦æ˜ å°„ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const mapString = (str, fn) => str
  .split('')
  .map((char, index) => fn(char, index, str))
  .join('');</code></pre>
                </div>

                <h3 style="color:#2563eb; margin: 20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#334155; line-height:1.8;">
                    <strong>mapString</strong> å°†å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå­—ç¬¦æ•°ç»„ï¼Œå¯¹æ¯ä¸ªå­—ç¬¦è°ƒç”¨æ˜ å°„å‡½æ•° <code>fn</code>ï¼Œå¹¶å°†æ˜ å°„ç»“æœé‡æ–°æ‹¼æ¥æˆæ–°å­—ç¬¦ä¸²ã€‚
                    æ˜ å°„å‡½æ•°å¯ä»¥è®¿é—®å­—ç¬¦æœ¬èº«ã€ç´¢å¼•ä»¥åŠåŸå§‹å­—ç¬¦ä¸²ï¼Œé€‚åˆç”¨äºæ–‡æœ¬ç¾åŒ–ã€ä¿¡æ¯åŠ å¯†ã€æ ¼å¼è½¬æ¢ã€æ¨¡æ¿ç”Ÿæˆç­‰åœºæ™¯ã€‚
                </p>

                <h3 style="color:#2563eb; margin: 20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">// å¤§å†™æ˜ å°„
mapString('Hello', (char) => char.toUpperCase());
// "HELLO"

// ä½ç½®æ ‡è®°
mapString('ABC', (char, index) => `${index}:${char}`);
// "0:A1:B2:C"

// ROT åŠ å¯†ï¼ˆä½ç§» 2ï¼‰
const shift = 2;
mapString('abc', (char) => {
  const code = char.charCodeAt(0);
  if (code < 97 || code > 122) return char;
  return String.fromCharCode(((code - 97 + shift) % 26) + 97);
});
// "cde"</code></pre>
                </div>

                <h3 style="color:#2563eb; margin: 20px 0 12px;">å…¸å‹åº”ç”¨</h3>
                <div>
                    <span class="function-badge">æ–‡æœ¬ç¾åŒ–</span>
                    <span class="function-badge">åŠ å¯†/ç¼–ç </span>
                    <span class="function-badge">æ¨¡æ¿ç”Ÿæˆ</span>
                    <span class="function-badge">æ•æ„Ÿä¿¡æ¯è„±æ•</span>
                    <span class="function-badge">å­—ç¬¦ç»Ÿè®¡</span>
                    <span class="function-badge">å¯è§†åŒ–æ ‡æ³¨</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const mapString = (str, fn) => str.split('').map((char, index) => fn(char, index, str)).join('');

        class MapStringTool {
            constructor() {
                this.plugins = {};
                this.history = [];
                this.stats = {
                    totalMappings: 0,
                    totalCharacters: 0,
                    uniqueCharacters: new Set(),
                    mostUsedFunction: '-' 
                };
                this.functionUsage = {};

                this.mappingFunctions = [
                    {
                        value: 'upper',
                        label: 'å¤§å†™è½¬æ¢ (Upper Case)',
                        desc: 'å°†æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™',
                        fn: (char) => char.toUpperCase()
                    },
                    {
                        value: 'lower',
                        label: 'å°å†™è½¬æ¢ (Lower Case)',
                        desc: 'å°†æ‰€æœ‰å­—ç¬¦è½¬æ¢ä¸ºå°å†™',
                        fn: (char) => char.toLowerCase()
                    },
                    {
                        value: 'alternating',
                        label: 'äº¤æ›¿å¤§å°å†™ (Alternating)',
                        desc: 'å¥‡å¶ä½äº¤æ›¿å˜æ¢å¤§å°å†™',
                        fn: (char, index) => index % 2 === 0 ? char.toUpperCase() : char.toLowerCase()
                    },
                    {
                        value: 'rotN',
                        label: 'å­—æ¯ä½ç§» (ROT/Shift)',
                        desc: 'æŒ‰æŒ‡å®šä½ç§»åŠ å¯†å­—æ¯ï¼Œå…¶ä»–å­—ç¬¦ä¿æŒä¸å˜',
                        fn: (char, index, str, param, shift) => {
                            const value = shift ?? 13;
                            const isUpper = char >= 'A' && char <= 'Z';
                            const isLower = char >= 'a' && char <= 'z';
                            if (!isUpper && !isLower) return char;
                            const base = isUpper ? 65 : 97;
                            const code = char.charCodeAt(0) - base;
                            const shifted = (code + value + 26) % 26;
                            return String.fromCharCode(base + shifted);
                        }
                    },
                    {
                        value: 'leet',
                        label: 'æå®¢æ›¿æ¢ (Leet Speak)',
                        desc: 'å°†å­—ç¬¦æ›¿æ¢ä¸ºå¸¸è§çš„ Leet å½¢å¼',
                        fn: (char) => {
                            const map = { 'a': '4', 'e': '3', 'i': '1', 'o': '0', 's': '5', 't': '7' };
                            const lower = char.toLowerCase();
                            return map[lower] || char;
                        }
                    },
                    {
                        value: 'indexTag',
                        label: 'ç´¢å¼•æ ‡æ³¨ (Index Tag)',
                        desc: 'å°†æ¯ä¸ªå­—ç¬¦è½¬æ¢ä¸ºå¸¦ç´¢å¼•çš„æ ‡ç­¾',
                        fn: (char, index) => `[${index}:${char}]`
                    },
                    {
                        value: 'customJSON',
                        label: 'è‡ªå®šä¹‰æ˜ å°„ (JSON é…ç½®)',
                        desc: 'ä½¿ç”¨ JSON å®šä¹‰çš„æ›¿æ¢è§„åˆ™æ˜ å°„å­—ç¬¦',
                        fn: (char, index, str, param) => {
                            let map = {};
                            try {
                                map = param ? JSON.parse(param) : {};
                            } catch (error) {
                                map = {};
                            }
                            const lower = char.toLowerCase();
                            if (map[char] !== undefined) return map[char];
                            if (map[lower] !== undefined) return map[lower];
                            return char;
                        }
                    }
                ];

                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupSelect();
                    this.setupInputNumber();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupSelect() {
                const functionSelect = document.getElementById('functionSelect');
                if (!functionSelect) return;

                try {
                    const selectInstance = new Select({
                        container: functionSelect,
                        options: this.mappingFunctions,
                        placeholder: 'é€‰æ‹©æ˜ å°„å‡½æ•°',
                        onChange: (value) => {
                            const shiftContainer = document.getElementById('shiftInputContainer');
                            if (shiftContainer) {
                                shiftContainer.style.display = value === 'rotN' ? 'block' : 'none';
                            }
                        }
                    });
                    selectInstance.setValue('upper');
                    this.plugins.functionSelect = selectInstance;
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿç»„ä»¶:', error);
                    const select = document.createElement('select');
                    select.className = 'input-field';
                    this.mappingFunctions.forEach((option, index) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (index === 0) opt.selected = true;
                        select.appendChild(opt);
                    });
                    select.addEventListener('change', (event) => {
                        const shiftContainer = document.getElementById('shiftInputContainer');
                        if (shiftContainer) {
                            shiftContainer.style.display = event.target.value === 'rotN' ? 'block' : 'none';
                        }
                    });
                    functionSelect.appendChild(select);
                }
            }

            setupInputNumber() {
                const shiftContainer = document.getElementById('shiftInput');
                if (!shiftContainer) return;

                try {
                    this.plugins.shiftInput = new InputNumber({
                        container: shiftContainer,
                        value: 13,
                        min: -25,
                        max: 25,
                        step: 1,
                        onChange: () => {}
                    });
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰æ•°å­—è¾“å…¥åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿè¾“å…¥æ¡†:', error);
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = 'shiftNative';
                    input.value = '13';
                    input.min = '-25';
                    input.max = '25';
                    input.className = 'input-field';
                    shiftContainer.appendChild(input);
                }
            }

            setupCheckboxes() {
                const checkboxGroup = document.getElementById('checkboxGroup');
                if (!checkboxGroup) return;

                const options = [
                    { id: 'showVisualization', label: 'æ˜¾ç¤ºå­—ç¬¦çº§å¯è§†åŒ–', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºç»Ÿè®¡åˆ†æ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºæ‰§è¡Œä»£ç ', checked: true }
                ];

                try {
                    const instance = Checkbox.createCheckboxGroup({
                        items: options.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    checkboxGroup.appendChild(instance.container);
                    this.plugins.checkboxGroup = instance;
                    this.checkboxOptions = options;
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰å¤é€‰æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    options.forEach(option => {
                        const wrapper = document.createElement('div');
                        wrapper.style.marginBottom = '10px';
                        wrapper.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left: 6px;">${option.label}</label>`;
                        checkboxGroup.appendChild(wrapper);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup && this.checkboxOptions) {
                    try {
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            const states = this.plugins.checkboxGroup.getAllChecked();
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è·å–å¤é€‰æ¡†å€¼å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }

                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            getMappingFunction() {
                let value = 'upper';
                if (this.plugins.functionSelect?.getValue) {
                    try {
                        value = this.plugins.functionSelect.getValue();
                    } catch (error) {
                        console.warn('è·å–æ˜ å°„å‡½æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
                    }
                } else {
                    const select = document.querySelector('#functionSelect select');
                    if (select) value = select.value;
                }
                return this.mappingFunctions.find(item => item.value === value) || this.mappingFunctions[0];
            }

            getShiftValue() {
                if (this.plugins.shiftInput?.getValue) {
                    try {
                        return Number(this.plugins.shiftInput.getValue());
                    } catch (error) {
                        console.warn('è¯»å–ä½ç§»é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ 13:', error);
                    }
                }
                const native = document.getElementById('shiftNative');
                return native ? Number(native.value || 13) : 13;
            }

            execute() {
                const input = document.getElementById('stringInput');
                if (!input) return;
                const str = input.value;

                if (!str.length) {
                    this.showError('è¯·è¾“å…¥å­—ç¬¦ä¸²å†…å®¹');
                    return;
                }

                const func = this.getMappingFunction();
                const shiftValue = func.value === 'rotN' ? this.getShiftValue() : undefined;
                const param = document.getElementById('customParam')?.value || '';

                try {
                    const t0 = performance.now();
                    const mapped = mapString(str, (char, index) => func.fn(char, index, str, param, shiftValue));
                    const t1 = performance.now();
                    const time = Math.round((t1 - t0) * 1000) / 1000;

                    this.stats.totalMappings++;
                    this.stats.totalCharacters += str.length;
                    str.split('').forEach(char => this.stats.uniqueCharacters.add(char));
                    this.functionUsage[func.value] = (this.functionUsage[func.value] || 0) + 1;
                    this.stats.mostUsedFunction = Object.keys(this.functionUsage)
                        .reduce((a, b) => this.functionUsage[a] > this.functionUsage[b] ? a : b, func.value);

                    this.displayVisualization(str, mapped, func, shiftValue);
                    this.displayResult(str, mapped, func, param, shiftValue);
                    this.updateStats();
                    this.addToHistory(str, mapped, func, time, shiftValue, param);

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode(str, mapped, func, param, shiftValue);
                    }

                    this.showNotification(`å·²å®Œæˆæ˜ å°„ï¼šå­—ç¬¦ ${str.length} ä¸ªï¼Œç”¨æ—¶ ${time}Î¼s`, 'success');
                } catch (error) {
                    this.showError('æ˜ å°„å¤±è´¥: ' + error.message);
                }
            }

            displayVisualization(original, mapped, func, shiftValue) {
                const visualization = document.getElementById('stringVisualization');
                if (!visualization) return;

                if (!this.getCheckboxValue('showVisualization')) {
                    visualization.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­å­—ç¬¦çº§å¯è§†åŒ–å±•ç¤º</p>
                        </div>`;
                    return;
                }

                const chars = original.split('');
                const mappedChars = mapped.split('');

                const charCards = chars.map((char, index) => {
                    const ascii = char.charCodeAt(0);
                    const mappedAscii = mappedChars[index].charCodeAt(0);
                    const highlight = char !== mappedChars[index] ? 'highlight' : '';
                    return `
                        <div class="char-card ${highlight}">
                            <div class="char-index">ç´¢å¼• ${index}</div>
                            <div class="char-before">${char === ' ' ? 'â ' : char}</div>
                            <div class="char-after">${mappedChars[index] === ' ' ? 'â ' : mappedChars[index]}</div>
                            <div class="char-meta">${ascii} â†’ ${mappedAscii}</div>
                        </div>
                    `;
                }).join('');

                visualization.innerHTML = `
                    <div class="list-title" style="font-weight:700;color:#1d4ed8;margin-bottom:16px;">
                        æ˜ å°„å‡½æ•°ï¼š${func.label}${func.value === 'rotN' ? `ï¼ˆä½ç§» ${shiftValue}ï¼‰` : ''}
                    </div>
                    <div class="char-grid">${charCards}</div>
                `;
            }

            displayResult(original, mapped, func, param, shiftValue) {
                const resultVisualization = document.getElementById('resultVisualization');
                if (!resultVisualization) return;

                const diffCount = original.split('').reduce((count, char, index) => char !== mapped[index] ? count + 1 : count, 0);
                const uppercaseCount = mapped.split('').filter(char => /[A-Z]/.test(char)).length;
                const lowercaseCount = mapped.split('').filter(char => /[a-z]/.test(char)).length;

                resultVisualization.innerHTML = `
                    <div class="result-preview">${mapped || '<ç©ºå­—ç¬¦ä¸²>'}</div>
                    <div class="analysis-grid" id="analysisGrid">
                        <div class="analysis-card">
                            <h4>å­—ç¬¦å˜åŒ–</h4>
                            <p>åŸå­—ç¬¦ï¼š${original.length} ä¸ª</p>
                            <p>ä¿®æ”¹å­—ç¬¦ï¼š${diffCount} ä¸ª</p>
                        </div>
                        <div class="analysis-card">
                            <h4>å¤§å°å†™ç»Ÿè®¡</h4>
                            <p>å¤§å†™ï¼š${uppercaseCount}</p>
                            <p>å°å†™ï¼š${lowercaseCount}</p>
                        </div>
                        <div class="analysis-card">
                            <h4>æ˜ å°„å‚æ•°</h4>
                            <p>å‡½æ•°ï¼š${func.label}</p>
                            <p>${func.value === 'rotN' ? 'ä½ç§»ï¼š' + (shiftValue ?? 13) : 'å‚æ•°ï¼š' + (param || 'æ— ')}</p>
                        </div>
                    </div>
                `;
            }

            addToHistory(original, mapped, func, time, shiftValue, param) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    length: original.length,
                    preview: mapped.slice(0, 40) + (mapped.length > 40 ? '...' : ''),
                    function: func.label,
                    shift: shiftValue,
                    param,
                    execTime: time
                });

                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const historyList = document.getElementById('historyList');
                const historyCount = document.getElementById('historyCount');
                if (!historyList) return;

                if (historyCount) historyCount.textContent = this.history.length;

                if (this.history.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— å†å²è®°å½•</p>
                        </div>`;
                    return;
                }

                historyList.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.execTime}Î¼s</div>
                        <div class="history-summary">å‡½æ•°ï¼š${item.function} | å­—ç¬¦ï¼š${item.length}</div>
                        ${item.shift !== undefined ? `<div style="color:#2563eb;font-size:0.8rem;margin-top:6px;">ä½ç§»ï¼š${item.shift}</div>` : ''}
                        ${item.param ? `<div style="color:#2563eb;font-size:0.8rem;margin-top:6px;">å‚æ•°ï¼š${item.param}</div>` : ''}
                        <div style="color:#64748b;font-size:0.8rem;margin-top:6px;">ç»“æœé¢„è§ˆï¼š${item.preview}</div>
                    </div>
                `).join('');
            }

            updateStats() {
                const statsGrid = document.getElementById('statsGrid');
                if (!statsGrid) return;

                const mostUsedLabel = this.mappingFunctions.find(f => f.value === this.stats.mostUsedFunction)?.label || '-';

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalMappings}</div>
                        <div class="stat-label">æ˜ å°„æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalCharacters}</div>
                        <div class="stat-label">ç´¯è®¡å¤„ç†å­—ç¬¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.uniqueCharacters.size}</div>
                        <div class="stat-label">ä¸åŒå­—ç¬¦æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="font-size:1rem;">${mostUsedLabel}</div>
                        <div class="stat-label">æœ€å¸¸ç”¨å‡½æ•°</div>
                    </div>
                `;
            }

            showCode(original, mapped, func, param, shiftValue) {
                const codeSection = document.getElementById('codeSection');
                const codePreview = document.getElementById('codePreview');
                if (!codePreview) return;

                const code = `// mapString å‡½æ•°
const mapString = (str, fn) => str.split('').map((char, index) => fn(char, index, str)).join('');

const original = ${JSON.stringify(original)};
const mappingFn = ${func.fn.toString().replace(/\n/g, '\n  ')};
const param = ${param ? JSON.stringify(param) : 'undefined'};
const shift = ${shiftValue !== undefined ? shiftValue : 'undefined'};

const result = mapString(original, (char, index, str) => mappingFn(char, index, str, param, shift));

console.log(result);
// ${JSON.stringify(mapped)}`;

                codePreview.textContent = code;
                if (window.hljs) {
                    delete codePreview.dataset.highlighted;
                    codePreview.className = 'language-javascript';
                    hljs.highlightElement(codePreview);
                }
                if (codeSection) codeSection.style.display = 'block';
            }

            loadSample() {
                const samples = [
                    'MapString makes text processing fun!',
                    'å‰ç«¯å¼€å‘ğŸ§‘â€ğŸ’» + å­—ç¬¦æ˜ å°„ = æ— é™å¯èƒ½',
                    '123-456-7890',
                    'Transform me with ROT13!',
                    'æ•æ„Ÿä¿¡æ¯éœ€è¦è„±æ•å¤„ç†'
                ];
                const sample = samples[Math.floor(Math.random() * samples.length)];
                const input = document.getElementById('stringInput');
                if (input) input.value = sample;
                this.showNotification('ç¤ºä¾‹å­—ç¬¦ä¸²å·²åŠ è½½', 'info');
            }

            reverseString() {
                const input = document.getElementById('stringInput');
                if (!input) return;
                input.value = input.value.split('').reverse().join('');
                this.showNotification('å­—ç¬¦ä¸²å·²ç¿»è½¬', 'info');
            }

            shuffleString() {
                const input = document.getElementById('stringInput');
                if (!input) return;
                const arr = input.value.split('');
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                input.value = arr.join('');
                this.showNotification('å­—ç¬¦é¡ºåºå·²æ‰“ä¹±', 'info');
            }

            clear() {
                const input = document.getElementById('stringInput');
                if (input) input.value = '';
                const param = document.getElementById('customParam');
                if (param) param.value = '';
                const visualization = document.getElementById('stringVisualization');
                const resultVisualization = document.getElementById('resultVisualization');
                const codeSection = document.getElementById('codeSection');
                if (visualization) {
                    visualization.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ§±</div>
                            <p>æ‰§è¡Œæ˜ å°„åå°†å±•ç¤ºå­—ç¬¦çº§æ˜ å°„è¿‡ç¨‹</p>
                        </div>`;
                }
                if (resultVisualization) {
                    resultVisualization.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸŒˆ</div>
                            <p>æ˜ å°„åçš„å­—ç¬¦ä¸²å°†åœ¨æ­¤å±•ç¤º</p>
                        </div>`;
                }
                if (codeSection) codeSection.style.display = 'none';
                this.showNotification('å·²æ¸…ç©ºè¾“å…¥ä¸å±•ç¤ºåŒºåŸŸ', 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨å­—ç¬¦ä¸²æ˜ å°„å¹³å°',
                        content: `
                            <div style="padding: 18px;">
                                <div style="text-align:center;font-size:48px;">ğŸ”¤</div>
                                <p style="color:#334155;margin:12px 0;">
                                    å€ŸåŠ© <strong>mapString</strong>ï¼Œæ‚¨å¯ä»¥è‡ªå®šä¹‰ä»»æ„å­—ç¬¦çº§æ˜ å°„é€»è¾‘ï¼Œåœ¨å¯è§†åŒ–ç•Œé¢ä¸­ç›´è§‚æŸ¥çœ‹æ¯ä¸ªå­—ç¬¦çš„å˜åŒ–è¿‡ç¨‹ï¼Œå¹¶å³æ—¶è·å–ç»Ÿè®¡ä¿¡æ¯ä¸ä»£ç ç‰‡æ®µã€‚
                                </p>
                                <div style="background:#eef2ff;padding:12px;border-radius:10px;margin-bottom:12px;color:#1d4ed8;">
                                    æ”¯æŒåŠŸèƒ½ï¼šå¤§å°å†™è½¬æ¢ã€ROT ä½ç§»ã€Leet æ›¿æ¢ã€ç´¢å¼•æ ‡æ³¨ã€è‡ªå®šä¹‰ JSON æ˜ å°„ç­‰å¤šç§å¸¸è§åœºæ™¯ã€‚
                                </div>
                                <ul style="color:#0f172a;margin-left:18px;line-height:1.8;">
                                    <li>å®æ—¶å­—ç¬¦çº§å¯è§†åŒ–ï¼Œæ´å¯Ÿæ¯ä¸€æ¬¡è½¬æ¢</li>
                                    <li>å†å²è®°å½• & ç»Ÿè®¡é¢æ¿ï¼Œè¿½è¸ªæ˜ å°„è¡Œä¸º</li>
                                    <li>ä»£ç é¢„è§ˆä¸€é”®å¤åˆ¶ï¼Œæ–¹ä¾¿æ•´åˆåˆ°é¡¹ç›®ä¸­</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.stringTool = new MapStringTool();
        });

        if (document.readyState !== 'loading' && !window.stringTool) {
            window.stringTool = new MapStringTool();
        }
    </script>
</body>

</html>