<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç»‡æ¶æ„ç®¡ç†ç³»ç»Ÿ - nest å‡½æ•°å®æˆ˜</title>
    <!-- å¼•å…¥æ’ä»¶æ ·å¼ -->
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 18px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .tree-container {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .tree-node {
            margin-bottom: 8px;
        }

        .tree-item {
            background: white;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 6px;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tree-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .tree-item.department {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
        }

        .tree-item.employee {
            border-left-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .tree-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tree-item-icon {
            font-size: 1.2rem;
        }

        .tree-item-info {
            flex: 1;
        }

        .tree-item-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .tree-item-meta {
            font-size: 0.8rem;
            color: #64748b;
        }

        .tree-item-actions {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            padding: 6px 10px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .tree-children {
            margin-left: 32px;
            margin-top: 6px;
            border-left: 2px dashed #cbd5e1;
            padding-left: 16px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 80px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .form-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .select-container {
            margin-bottom: 16px;
        }

        .checkbox-container {
            margin-top: 12px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
        .modal-content {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ç»„ç»‡æ¶æ„ç®¡ç†ç³»ç»Ÿ</h1>
            <p>åŸºäº nest å‡½æ•°çš„æ ‘å½¢ç»“æ„ç»„ç»‡æ¶æ„ç®¡ç†ï¼Œæ”¯æŒå¤šçº§åµŒå¥—éƒ¨é—¨ä¸å‘˜å·¥ç®¡ç†</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§æ“ä½œé¢æ¿ -->
            <div class="sidebar">
                <div class="card">
                    <h2>â• æ·»åŠ ç»„ç»‡</h2>
                    <div class="button-group">
                        <button class="btn btn-success btn-block" onclick="window.orgManager?.showAddModal('department')">
                            ğŸ›ï¸ æ·»åŠ éƒ¨é—¨
                        </button>
                        <button class="btn btn-info btn-block" onclick="window.orgManager?.showAddModal('employee')">
                            ğŸ‘¤ æ·»åŠ å‘˜å·¥
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ æ‰¹é‡æ“ä½œ</h2>
                    <div id="checkboxGroup" class="checkbox-container"></div>
                    <div class="button-group">
                        <button class="btn btn-warning btn-sm" onclick="window.orgManager?.batchEdit()">
                            âœï¸ æ‰¹é‡ç¼–è¾‘
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="window.orgManager?.batchDelete()">
                            ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">æ€»èŠ‚ç‚¹æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="departmentCount">0</div>
                            <div class="stat-label">éƒ¨é—¨æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="employeeCount">0</div>
                            <div class="stat-label">å‘˜å·¥æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="maxDepth">0</div>
                            <div class="stat-label">æœ€å¤§å±‚çº§</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ”§ å·¥å…·</h2>
                    <div class="button-group">
                        <button class="btn btn-info btn-sm" onclick="window.orgManager?.loadSampleData()">
                            ğŸ“ åŠ è½½ç¤ºä¾‹æ•°æ®
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="window.orgManager?.exportData()">
                            ğŸ’¾ å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="window.orgManager?.clearAll()">
                            ğŸ§¹ æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ ‘å½¢ç»“æ„å±•ç¤º -->
            <div class="visualization">
                <div class="card">
                    <h2>ğŸŒ³ ç»„ç»‡æ¶æ„æ ‘</h2>
                    <div class="tree-container" id="treeContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¢</div>
                            <p>æš‚æ— ç»„ç»‡æ¶æ„æ•°æ®</p>
                            <p style="margin-top: 8px; font-size: 0.9rem;">ç‚¹å‡»å·¦ä¾§æŒ‰é’®æ·»åŠ éƒ¨é—¨æˆ–å‘˜å·¥</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ’ä»¶è„šæœ¬ -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>

    <script>
        // nest å‡½æ•°ï¼šåœ¨å¹³é¢æ•°ç»„ä¸­é€’å½’åµŒå¥—ç›¸äº’é“¾æ¥çš„å¯¹è±¡
        const nest = (items, id = null, link = 'parent_id') => 
            items.filter(item => item[link] === id).map(item => ({ 
                ...item, 
                children: nest(items, item.id, link) 
            }));

        // ç»„ç»‡æ¶æ„ç®¡ç†ç³»ç»Ÿ
        class OrganizationManager {
            constructor() {
                this.items = [];
                this.nextId = 1;
                this.selectedItems = new Set();
                this.plugins = {};
                
                this.init();
            }

            async init() {
                await this.loadPlugins();
                this.setupCheckboxes();
                this.loadFromStorage();
                this.render();
                this.updateStats();
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;

                const options = [
                    { id: 'enableNotifications', label: 'å¯ç”¨é€šçŸ¥æé†’', checked: true },
                    { id: 'showDetails', label: 'æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯', checked: true },
                    { id: 'autoExpand', label: 'è‡ªåŠ¨å±•å¼€æ ‘', checked: false }
                ];

                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: options,
                        onChange: (checkedStates) => {
                            // å“åº”å¤é€‰æ¡†å˜åŒ–
                        }
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.plugins.checkboxGroup.checkboxes.findIndex(
                            (cb, idx) => cb.options?.id === id || idx === ['enableNotifications', 'showDetails', 'autoExpand'].indexOf(id)
                        );
                        return index !== -1 ? states[index] : false;
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥:', error);
                    }
                }
                return false;
            }

            showNotification(message, type = 'info') {
                if (this.plugins.notification && this.getCheckboxValue('enableNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showAddModal(type) {
                const isDepartment = type === 'department';
                const title = isDepartment ? 'ğŸ›ï¸ æ·»åŠ éƒ¨é—¨' : 'ğŸ‘¤ æ·»åŠ å‘˜å·¥';
                
                // è·å–çˆ¶èŠ‚ç‚¹é€‰é¡¹
                const parentOptions = [
                    { value: null, label: 'æ ¹èŠ‚ç‚¹ï¼ˆé¡¶çº§ï¼‰' }
                ];
                
                this.items.forEach(item => {
                    if (item.type === 'department') {
                        parentOptions.push({
                            value: item.id,
                            label: `ğŸ“ ${item.name}`
                        });
                    }
                });

                let modalContent = `
                    <div style="padding: 8px 0;">
                        <div class="input-group">
                            <label>${isDepartment ? 'éƒ¨é—¨' : 'å‘˜å·¥'}åç§° *</label>
                            <input type="text" id="itemName" class="input-field" placeholder="è¯·è¾“å…¥${isDepartment ? 'éƒ¨é—¨' : 'å‘˜å·¥'}åç§°">
                        </div>
                        <div class="input-group">
                            <label>ä¸Šçº§${isDepartment ? 'éƒ¨é—¨' : 'éƒ¨é—¨'}</label>
                            <div id="parentSelect" class="select-container"></div>
                        </div>
                        ${isDepartment ? `
                        <div class="input-group">
                            <label>éƒ¨é—¨æè¿°</label>
                            <textarea id="itemDescription" class="textarea-field" placeholder="è¯·è¾“å…¥éƒ¨é—¨æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                        ` : `
                        <div class="input-group">
                            <label>èŒä½</label>
                            <input type="text" id="itemPosition" class="input-field" placeholder="è¯·è¾“å…¥èŒä½">
                        </div>
                        <div class="input-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="itemEmail" class="input-field" placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>
                        <div class="input-group">
                            <label>å…¥èŒæ—¥æœŸ</label>
                            <div id="hireDatePicker" class="select-container"></div>
                        </div>
                        <div class="input-group">
                            <label>è–ªèµ„</label>
                            <div id="salaryInput" class="select-container"></div>
                        </div>
                        `}
                    </div>
                `;

                this.plugins.modal.show({
                    title: title,
                    content: modalContent,
                    type: 'confirm',
                    onConfirm: () => {
                        this.submitAddForm(type, parentOptions);
                    },
                    onCancel: () => {}
                });

                // åˆå§‹åŒ–è¡¨å•æ§ä»¶
                setTimeout(() => {
                    // åˆå§‹åŒ–çˆ¶èŠ‚ç‚¹é€‰æ‹©å™¨
                    try {
                        const parentSelect = new Select({
                            container: '#parentSelect',
                            options: parentOptions,
                            placeholder: 'é€‰æ‹©ä¸Šçº§éƒ¨é—¨',
                            onChange: (value) => {
                                console.log('é€‰æ‹©çš„çˆ¶èŠ‚ç‚¹:', value);
                            }
                        });
                        window.tempParentSelect = parentSelect;
                    } catch (error) {
                        console.warn('Select æ’ä»¶åŠ è½½å¤±è´¥:', error);
                    }

                    // å¦‚æœæ˜¯å‘˜å·¥ï¼Œåˆå§‹åŒ–æ—¥æœŸå’Œæ•°å­—è¾“å…¥
                    if (!isDepartment) {
                        try {
                            const hireDatePicker = new DateTimePicker({
                                container: document.getElementById('hireDatePicker'),
                                placeholder: 'é€‰æ‹©å…¥èŒæ—¥æœŸ',
                                format: 'YYYY-MM-DD'
                            });
                            window.tempHireDatePicker = hireDatePicker;

                            const salaryInput = new InputNumber({
                                container: document.getElementById('salaryInput'),
                                min: 0,
                                max: 1000000,
                                step: 500,
                                value: 10000,
                                placeholder: 'è¯·è¾“å…¥è–ªèµ„'
                            });
                            window.tempSalaryInput = salaryInput;
                        } catch (error) {
                            console.warn('æ—¥æœŸæˆ–æ•°å­—è¾“å…¥æ’ä»¶åŠ è½½å¤±è´¥:', error);
                        }
                    }
                }, 100);
            }

            submitAddForm(type, parentOptions) {
                const nameInput = document.getElementById('itemName');
                const name = nameInput?.value.trim();

                if (!name) {
                    this.showNotification('è¯·è¾“å…¥åç§°', 'error');
                    return;
                }

                let parentId = window.tempParentSelect?.getValue() || null;
                if (parentId === 'null' || parentId === null || parentId === '') {
                    parentId = null;
                } else {
                    parentId = parseInt(parentId);
                }

                const item = {
                    id: this.nextId++,
                    type: type,
                    name: name,
                    parent_id: parentId
                };

                if (type === 'department') {
                    const descriptionInput = document.getElementById('itemDescription');
                    item.description = descriptionInput?.value.trim() || '';
                } else {
                    const positionInput = document.getElementById('itemPosition');
                    const emailInput = document.getElementById('itemEmail');
                    item.position = positionInput?.value.trim() || '';
                    item.email = emailInput?.value.trim() || '';
                    item.hireDate = window.tempHireDatePicker?.getValue() || '';
                    item.salary = window.tempSalaryInput?.getValue() || 0;
                }

                this.items.push(item);
                this.saveToStorage();
                this.render();
                this.updateStats();
                
                const typeName = type === 'department' ? 'éƒ¨é—¨' : 'å‘˜å·¥';
                this.showNotification(`æˆåŠŸæ·»åŠ ${typeName}ï¼š${name}`, 'success');

                // æ¸…ç†ä¸´æ—¶å˜é‡
                window.tempParentSelect = null;
                window.tempHireDatePicker = null;
                window.tempSalaryInput = null;
            }

            showEditModal(item) {
                const isDepartment = item.type === 'department';
                const title = isDepartment ? 'âœï¸ ç¼–è¾‘éƒ¨é—¨' : 'âœï¸ ç¼–è¾‘å‘˜å·¥';

                // è·å–çˆ¶èŠ‚ç‚¹é€‰é¡¹ï¼ˆæ’é™¤è‡ªå·±å’Œè‡ªå·±çš„å­èŠ‚ç‚¹ï¼‰
                const parentOptions = [
                    { value: null, label: 'æ ¹èŠ‚ç‚¹ï¼ˆé¡¶çº§ï¼‰' }
                ];
                
                const excludeIds = this.getDescendantIds(item.id);
                excludeIds.push(item.id);

                this.items.forEach(item_ => {
                    if (item_.type === 'department' && !excludeIds.includes(item_.id)) {
                        parentOptions.push({
                            value: item_.id,
                            label: `ğŸ“ ${item_.name}`
                        });
                    }
                });

                let modalContent = `
                    <div style="padding: 8px 0;">
                        <div class="input-group">
                            <label>${isDepartment ? 'éƒ¨é—¨' : 'å‘˜å·¥'}åç§° *</label>
                            <input type="text" id="itemName" class="input-field" value="${this.escapeHtml(item.name)}">
                        </div>
                        <div class="input-group">
                            <label>ä¸Šçº§${isDepartment ? 'éƒ¨é—¨' : 'éƒ¨é—¨'}</label>
                            <div id="parentSelect" class="select-container"></div>
                        </div>
                        ${isDepartment ? `
                        <div class="input-group">
                            <label>éƒ¨é—¨æè¿°</label>
                            <textarea id="itemDescription" class="textarea-field">${this.escapeHtml(item.description || '')}</textarea>
                        </div>
                        ` : `
                        <div class="input-group">
                            <label>èŒä½</label>
                            <input type="text" id="itemPosition" class="input-field" value="${this.escapeHtml(item.position || '')}">
                        </div>
                        <div class="input-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="itemEmail" class="input-field" value="${this.escapeHtml(item.email || '')}">
                        </div>
                        <div class="input-group">
                            <label>å…¥èŒæ—¥æœŸ</label>
                            <div id="hireDatePicker" class="select-container"></div>
                        </div>
                        <div class="input-group">
                            <label>è–ªèµ„</label>
                            <div id="salaryInput" class="select-container"></div>
                        </div>
                        `}
                    </div>
                `;

                this.plugins.modal.show({
                    title: title,
                    content: modalContent,
                    type: 'confirm',
                    onConfirm: () => {
                        this.submitEditForm(item.id, parentOptions);
                    },
                    onCancel: () => {}
                });

                // åˆå§‹åŒ–è¡¨å•æ§ä»¶
                setTimeout(() => {
                    try {
                        const parentSelect = new Select({
                            container: '#parentSelect',
                            options: parentOptions,
                            placeholder: 'é€‰æ‹©ä¸Šçº§éƒ¨é—¨',
                            onChange: () => {}
                        });
                        parentSelect.setValue(item.parent_id === null ? null : item.parent_id.toString());
                        window.tempParentSelect = parentSelect;
                    } catch (error) {
                        console.warn('Select æ’ä»¶åŠ è½½å¤±è´¥:', error);
                    }

                    if (!isDepartment) {
                        try {
                            const hireDatePicker = new DateTimePicker({
                                container: document.getElementById('hireDatePicker'),
                                placeholder: 'é€‰æ‹©å…¥èŒæ—¥æœŸ',
                                format: 'YYYY-MM-DD'
                            });
                            if (item.hireDate) {
                                hireDatePicker.setValue(item.hireDate);
                            }
                            window.tempHireDatePicker = hireDatePicker;

                            const salaryInput = new InputNumber({
                                container: document.getElementById('salaryInput'),
                                min: 0,
                                max: 1000000,
                                step: 500,
                                value: item.salary || 0
                            });
                            window.tempSalaryInput = salaryInput;
                        } catch (error) {
                            console.warn('æ—¥æœŸæˆ–æ•°å­—è¾“å…¥æ’ä»¶åŠ è½½å¤±è´¥:', error);
                        }
                    }
                }, 100);
            }

            submitEditForm(itemId, parentOptions) {
                const item = this.items.find(i => i.id === itemId);
                if (!item) return;

                const nameInput = document.getElementById('itemName');
                const name = nameInput?.value.trim();

                if (!name) {
                    this.showNotification('è¯·è¾“å…¥åç§°', 'error');
                    return;
                }

                let parentId = window.tempParentSelect?.getValue() || null;
                if (parentId === 'null' || parentId === null || parentId === '') {
                    parentId = null;
                } else {
                    parentId = parseInt(parentId);
                }

                item.name = name;
                item.parent_id = parentId;

                if (item.type === 'department') {
                    const descriptionInput = document.getElementById('itemDescription');
                    item.description = descriptionInput?.value.trim() || '';
                } else {
                    const positionInput = document.getElementById('itemPosition');
                    const emailInput = document.getElementById('itemEmail');
                    item.position = positionInput?.value.trim() || '';
                    item.email = emailInput?.value.trim() || '';
                    item.hireDate = window.tempHireDatePicker?.getValue() || '';
                    item.salary = window.tempSalaryInput?.getValue() || 0;
                }

                this.saveToStorage();
                this.render();
                this.updateStats();
                this.showNotification('ç¼–è¾‘æˆåŠŸ', 'success');

                // æ¸…ç†ä¸´æ—¶å˜é‡
                window.tempParentSelect = null;
                window.tempHireDatePicker = null;
                window.tempSalaryInput = null;
            }

            deleteItem(itemId) {
                const item = this.items.find(i => i.id === itemId);
                if (!item) return;

                // æ£€æŸ¥æ˜¯å¦æœ‰å­èŠ‚ç‚¹
                const hasChildren = this.items.some(i => i.parent_id === itemId);
                
                if (hasChildren) {
                    this.plugins.modal.confirm(`åˆ é™¤ ${item.name} å°†åŒæ—¶åˆ é™¤å…¶æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`).then(confirmed => {
                        if (confirmed) {
                            this.performDelete(itemId);
                        }
                    });
                } else {
                    this.plugins.modal.confirm(`ç¡®å®šè¦åˆ é™¤ ${item.name} å—ï¼Ÿ`).then(confirmed => {
                        if (confirmed) {
                            this.performDelete(itemId);
                        }
                    });
                }
            }

            performDelete(itemId) {
                // é€’å½’åˆ é™¤æ‰€æœ‰å­èŠ‚ç‚¹
                const toDelete = [itemId];
                const findChildren = (parentId) => {
                    this.items.forEach(item => {
                        if (item.parent_id === parentId) {
                            toDelete.push(item.id);
                            findChildren(item.id);
                        }
                    });
                };
                findChildren(itemId);

                // åˆ é™¤èŠ‚ç‚¹
                this.items = this.items.filter(item => !toDelete.includes(item.id));
                this.selectedItems.clear();
                this.saveToStorage();
                this.render();
                this.updateStats();
                this.showNotification('åˆ é™¤æˆåŠŸ', 'success');
            }

            getDescendantIds(parentId) {
                const descendants = [];
                const findDescendants = (id) => {
                    this.items.forEach(item => {
                        if (item.parent_id === id) {
                            descendants.push(item.id);
                            findDescendants(item.id);
                        }
                    });
                };
                findDescendants(parentId);
                return descendants;
            }

            render() {
                const container = document.getElementById('treeContainer');
                if (!container) return;

                if (this.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¢</div>
                            <p>æš‚æ— ç»„ç»‡æ¶æ„æ•°æ®</p>
                            <p style="margin-top: 8px; font-size: 0.9rem;">ç‚¹å‡»å·¦ä¾§æŒ‰é’®æ·»åŠ éƒ¨é—¨æˆ–å‘˜å·¥</p>
                        </div>
                    `;
                    return;
                }

                // ä½¿ç”¨ nest å‡½æ•°å°†å¹³é¢æ•°æ®è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„
                const nestedItems = nest(this.items);

                container.innerHTML = '';
                nestedItems.forEach(item => {
                    container.appendChild(this.renderTreeNode(item));
                });
            }

            renderTreeNode(item, level = 0) {
                const node = document.createElement('div');
                node.className = 'tree-node';
                
                const isDepartment = item.type === 'department';
                const itemDiv = document.createElement('div');
                itemDiv.className = `tree-item ${item.type}`;
                itemDiv.style.paddingLeft = `${level * 16 + 16}px`;

                const icon = isDepartment ? 'ğŸ›ï¸' : 'ğŸ‘¤';
                const meta = isDepartment 
                    ? `éƒ¨é—¨ | ID: ${item.id}`
                    : `${item.position || 'å‘˜å·¥'} | ${item.email || 'æ— é‚®ç®±'} | ID: ${item.id}`;

                itemDiv.innerHTML = `
                    <div class="tree-item-content">
                        <span class="tree-item-icon">${icon}</span>
                        <div class="tree-item-info">
                            <div class="tree-item-name">${this.escapeHtml(item.name)}</div>
                            <div class="tree-item-meta">${this.escapeHtml(meta)}</div>
                        </div>
                    </div>
                    <div class="tree-item-actions">
                        <button class="btn btn-info btn-icon" onclick="window.orgManager?.showEditModal(window.orgManager?.items.find(i => i.id === ${item.id}))">
                            âœï¸
                        </button>
                        <button class="btn btn-danger btn-icon" onclick="window.orgManager?.deleteItem(${item.id})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;

                node.appendChild(itemDiv);

                // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
                if (item.children && item.children.length > 0) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tree-children';
                    item.children.forEach(child => {
                        childrenContainer.appendChild(this.renderTreeNode(child, level + 1));
                    });
                    node.appendChild(childrenContainer);
                }

                return node;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStats() {
                const totalCount = this.items.length;
                const departmentCount = this.items.filter(i => i.type === 'department').length;
                const employeeCount = this.items.filter(i => i.type === 'employee').length;
                
                // è®¡ç®—æœ€å¤§å±‚çº§
                const maxDepth = this.calculateMaxDepth();

                document.getElementById('totalCount').textContent = totalCount;
                document.getElementById('departmentCount').textContent = departmentCount;
                document.getElementById('employeeCount').textContent = employeeCount;
                document.getElementById('maxDepth').textContent = maxDepth;
            }

            calculateMaxDepth() {
                if (this.items.length === 0) return 0;

                const getDepth = (itemId) => {
                    let maxChildDepth = 0;
                    this.items.forEach(item => {
                        if (item.parent_id === itemId) {
                            maxChildDepth = Math.max(maxChildDepth, getDepth(item.id));
                        }
                    });
                    return maxChildDepth + 1;
                };

                let maxDepth = 0;
                this.items.forEach(item => {
                    if (item.parent_id === null) {
                        maxDepth = Math.max(maxDepth, getDepth(item.id));
                    }
                });
                return maxDepth;
            }

            batchEdit() {
                if (this.selectedItems.size === 0) {
                    this.showNotification('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„é¡¹ç›®', 'warning');
                    return;
                }
                this.showNotification('æ‰¹é‡ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
            }

            batchDelete() {
                if (this.selectedItems.size === 0) {
                    this.showNotification('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®', 'warning');
                    return;
                }

                this.plugins.modal.confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${this.selectedItems.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`).then(confirmed => {
                    if (confirmed) {
                        this.items = this.items.filter(item => !this.selectedItems.has(item.id));
                        this.selectedItems.clear();
                        this.saveToStorage();
                        this.render();
                        this.updateStats();
                        this.showNotification('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                    }
                });
            }

            loadSampleData() {
                this.plugins.modal.confirm('åŠ è½½ç¤ºä¾‹æ•°æ®å°†æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ').then(confirmed => {
                    if (confirmed) {
                        this.items = [
                            { id: 1, type: 'department', name: 'æŠ€æœ¯éƒ¨', parent_id: null, description: 'è´Ÿè´£æŠ€æœ¯å¼€å‘' },
                            { id: 2, type: 'department', name: 'äº§å“éƒ¨', parent_id: null, description: 'è´Ÿè´£äº§å“è§„åˆ’' },
                            { id: 3, type: 'department', name: 'å‰ç«¯ç»„', parent_id: 1, description: 'å‰ç«¯å¼€å‘å›¢é˜Ÿ' },
                            { id: 4, type: 'department', name: 'åç«¯ç»„', parent_id: 1, description: 'åç«¯å¼€å‘å›¢é˜Ÿ' },
                            { id: 5, type: 'employee', name: 'å¼ ä¸‰', parent_id: 3, position: 'å‰ç«¯å·¥ç¨‹å¸ˆ', email: 'zhangsan@example.com', hireDate: '2023-01-15', salary: 15000 },
                            { id: 6, type: 'employee', name: 'æå››', parent_id: 3, position: 'é«˜çº§å‰ç«¯å·¥ç¨‹å¸ˆ', email: 'lisi@example.com', hireDate: '2022-06-01', salary: 20000 },
                            { id: 7, type: 'employee', name: 'ç‹äº”', parent_id: 4, position: 'åç«¯å·¥ç¨‹å¸ˆ', email: 'wangwu@example.com', hireDate: '2023-03-10', salary: 16000 },
                            { id: 8, type: 'employee', name: 'èµµå…­', parent_id: 2, position: 'äº§å“ç»ç†', email: 'zhaoliu@example.com', hireDate: '2021-09-01', salary: 25000 },
                            { id: 9, type: 'employee', name: 'é’±ä¸ƒ', parent_id: 1, position: 'æŠ€æœ¯æ€»ç›‘', email: 'qianqi@example.com', hireDate: '2020-01-01', salary: 35000 }
                        ];
                        this.nextId = 10;
                        this.saveToStorage();
                        this.render();
                        this.updateStats();
                        this.showNotification('ç¤ºä¾‹æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                    }
                });
            }

            exportData() {
                const data = {
                    items: this.items,
                    nextId: this.nextId,
                    exportTime: new Date().toISOString()
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç»„ç»‡æ¶æ„_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            }

            clearAll() {
                this.plugins.modal.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼').then(confirmed => {
                    if (confirmed) {
                        this.items = [];
                        this.selectedItems.clear();
                        this.nextId = 1;
                        this.saveToStorage();
                        this.render();
                        this.updateStats();
                        this.showNotification('æ•°æ®å·²æ¸…ç©º', 'info');
                    }
                });
            }

            saveToStorage() {
                try {
                    localStorage.setItem('orgManager_data', JSON.stringify({
                        items: this.items,
                        nextId: this.nextId
                    }));
                } catch (error) {
                    console.warn('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('orgManager_data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.items = data.items || [];
                        this.nextId = data.nextId || 1;
                    }
                } catch (error) {
                    console.warn('ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', error);
                }
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.orgManager = new OrganizationManager();
        });

        if (document.readyState !== 'loading' && !window.orgManager) {
            window.orgManager = new OrganizationManager();
        }
    </script>
</body>
</html>