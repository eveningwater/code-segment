<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰åŒ¹é…éªŒè¯å¹³å° - matchesWith</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: white;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.98rem;
        }

        .input-field,
        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
        }

        .input-field:focus,
        .textarea-field:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(6, 182, 212, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .object-display,
        .match-results {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .object-list {
            display: grid;
            gap: 14px;
        }

        .object-card {
            background: white;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
            border-left: 4px solid #06b6d4;
        }

        .object-card.matched {
            border-left-color: #22c55e;
        }

        .object-card.not-matched {
            border-left-color: #ef4444;
        }

        .object-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .object-id {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .match-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .match-badge.true {
            background: #dcfce7;
            color: #15803d;
        }

        .match-badge.false {
            background: #fee2e2;
            color: #b91c1c;
        }

        .object-content {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.95rem;
            color: #1f2937;
            background: #f8fafc;
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
        }

        .function-config {
            background: #f8fafc;
            border-radius: 14px;
            padding: 16px;
            margin-top: 12px;
        }

        .function-config h4 {
            font-size: 0.95rem;
            color: #06b6d4;
            margin-bottom: 10px;
        }

        .function-desc {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .comparison-card h4 {
            font-size: 0.95rem;
            color: #06b6d4;
            margin-bottom: 10px;
        }

        .comparison-card ul {
            list-style: none;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            color: #475569;
        }

        .comparison-card li {
            margin-bottom: 6px;
            padding-left: 20px;
            position: relative;
        }

        .comparison-card li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #06b6d4;
        }

        .comparison-card li.match {
            color: #15803d;
        }

        .comparison-card li.mismatch {
            color: #b91c1c;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #06b6d4;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #1f2937;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #06b6d4;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }
        }

        .modal-content {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ è‡ªå®šä¹‰åŒ¹é…éªŒè¯å¹³å°</h1>
            <p>åŸºäº matchesWith å‡½æ•°çš„çµæ´»å¯¹è±¡åŒ¹é…å·¥å…·ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ã€é¢„è®¾åŒ¹é…ç­–ç•¥ã€æ‰¹é‡éªŒè¯ã€è¯¦ç»†åˆ†æ</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ“ å¯¹è±¡é…ç½®</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>å¾…åŒ¹é…å¯¹è±¡ (JSON)</label>
                            <textarea id="objectInput" class="textarea-field" placeholder='{"greeting": "hello", "age": 25}'></textarea>
                        </div>
                        <div class="input-group">
                            <label>åŒ¹é…æ¡ä»¶å¯¹è±¡ (Source)</label>
                            <textarea id="sourceInput" class="textarea-field" placeholder='{"greeting": "hi"}'></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.matchWithTool?.addObject()">â• æ·»åŠ å¯¹è±¡</button>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.matchWithTool?.matchAll()">âš¡ æ‰§è¡ŒåŒ¹é…</button>
                            <button class="btn btn-info" onclick="window.matchWithTool?.loadSample()">ğŸ“„ ç¤ºä¾‹æ•°æ®</button>
                            <button class="btn btn-warning" onclick="window.matchWithTool?.generateRandom()">ğŸ² éšæœºç”Ÿæˆ</button>
                            <button class="btn btn-danger" onclick="window.matchWithTool?.clearAll()">ğŸ§¹ æ¸…ç©º</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ”§ æ¯”è¾ƒå‡½æ•°</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>é€‰æ‹©æ¯”è¾ƒå‡½æ•°</label>
                            <div id="functionSelect"></div>
                        </div>
                        <div id="functionConfig" class="function-config" style="display:none;">
                            <h4>å‡½æ•°è¯´æ˜</h4>
                            <div class="function-desc" id="functionDesc"></div>
                        </div>
                        <div class="input-group" id="customFunctionGroup" style="display:none;">
                            <label>è‡ªå®šä¹‰å‡½æ•°ä»£ç </label>
                            <textarea id="customFunctionInput" class="textarea-field" placeholder='(oV, sV, k, obj, source) => oV === sV'></textarea>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ å†å²è®°å½• (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— åŒ¹é…å†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>ğŸ“¦ å¯¹è±¡åˆ—è¡¨</h2>
                    <div class="object-display" id="objectDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ å¯¹è±¡åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âœ… åŒ¹é…ç»“æœ</h2>
                    <div class="match-results" id="matchResults">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡ŒåŒ¹é…åå°†åœ¨æ­¤å±•ç¤ºç»“æœ</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“Š å¯¹æ¯”åˆ†æ</h2>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#06b6d4;margin-bottom:12px;">matchesWith å‡½æ•°ï¼ˆè‡ªå®šä¹‰åŒ¹é…ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const matchesWith = (obj, source, fn) => 
  Object.keys(source).every(k => 
    obj.hasOwnProperty(k) && 
    (fn ? fn(obj[k], source[k], k, obj, source) : obj[k] === source[k])
  );</code></pre>
                </div>

                <h3 style="color:#06b6d4;margin:20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#374151;line-height:1.8;">
                    <strong>matchesWith</strong> å‡½æ•°ç”¨äºæ£€æŸ¥å¯¹è±¡ <code>obj</code> æ˜¯å¦åŒ…å« <code>source</code> å¯¹è±¡ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ã€‚
                    ä¸ <code>matches</code> ä¸åŒçš„æ˜¯ï¼Œå®ƒå…è®¸ä¼ å…¥è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•° <code>fn</code> æ¥å®šä¹‰åŒ¹é…é€»è¾‘ã€‚
                    å¦‚æœæ²¡æœ‰æä¾› <code>fn</code>ï¼Œåˆ™ä½¿ç”¨ä¸¥æ ¼ç›¸ç­‰æ¯”è¾ƒï¼ˆ<code>===</code>ï¼‰ã€‚
                </p>

                <h3 style="color:#06b6d4;margin:20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">// ä½¿ç”¨é»˜è®¤ä¸¥æ ¼ç›¸ç­‰æ¯”è¾ƒ
matchesWith({ age: 25, name: 'John' }, { age: 25 });
// true

// ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
const isGreeting = val => /^h(?:i|ello)$/.test(val);
matchesWith(
  { greeting: 'hello' },
  { greeting: 'hi' },
  (oV, sV) => isGreeting(oV) && isGreeting(sV)
);
// true

// æ•°å€¼èŒƒå›´åŒ¹é…
matchesWith(
  { score: 85 },
  { score: 80 },
  (oV, sV) => Math.abs(oV - sV) <= 10
);
// true</code></pre>
                </div>

                <h3 style="color:#06b6d4;margin:20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="badge">æ¨¡ç³ŠåŒ¹é…</span>
                    <span class="badge">èŒƒå›´åŒ¹é…</span>
                    <span class="badge">æ­£åˆ™åŒ¹é…</span>
                    <span class="badge">ç±»å‹è½¬æ¢åŒ¹é…</span>
                    <span class="badge">è‡ªå®šä¹‰éªŒè¯è§„åˆ™</span>
                    <span class="badge">å¤æ‚æ¡ä»¶ç­›é€‰</span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const matchesWith = (obj, source, fn) => Object.keys(source).every(k => obj.hasOwnProperty(k) && fn ? fn(obj[k], source[k], k, obj, source) : obj[k] === source[k]);

        class MatchWithTool {
            constructor() {
                this.plugins = {};
                this.objects = [];
                this.source = null;
                this.currentFunction = null;
                this.history = [];
                this.stats = {
                    totalMatches: 0,
                    totalObjects: 0,
                    matchedCount: 0,
                    unmatchedCount: 0,
                    functionUsage: {}
                };
                this.objectId = 1;
                this.comparisonFunctions = [
                    {
                        value: 'default',
                        label: 'é»˜è®¤ä¸¥æ ¼ç›¸ç­‰ (===)',
                        desc: 'ä½¿ç”¨ä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦è¿›è¡Œæ¯”è¾ƒï¼Œè¦æ±‚å€¼å®Œå…¨ç›¸ç­‰',
                        fn: null
                    },
                    {
                        value: 'loose',
                        label: 'å®½æ¾ç›¸ç­‰ (==)',
                        desc: 'ä½¿ç”¨å®½æ¾ç›¸ç­‰è¿ç®—ç¬¦ï¼Œå…è®¸ç±»å‹è½¬æ¢',
                        fn: (oV, sV) => oV == sV
                    },
                    {
                        value: 'greeting',
                        label: 'é—®å€™è¯­åŒ¹é… (hello/hi)',
                        desc: 'åŒ¹é…é—®å€™è¯­ï¼Œhello å’Œ hi è§†ä¸ºç›¸ç­‰',
                        fn: (oV, sV) => {
                            const isGreeting = val => /^h(?:i|ello)$/.test(String(val).toLowerCase());
                            return isGreeting(oV) && isGreeting(sV);
                        }
                    },
                    {
                        value: 'numberRange',
                        label: 'æ•°å€¼èŒƒå›´åŒ¹é… (Â±10)',
                        desc: 'æ•°å€¼åŒ¹é…ï¼Œå…è®¸ Â±10 çš„è¯¯å·®èŒƒå›´',
                        fn: (oV, sV) => {
                            if (typeof oV !== 'number' || typeof sV !== 'number') return oV === sV;
                            return Math.abs(oV - sV) <= 10;
                        }
                    },
                    {
                        value: 'stringContains',
                        label: 'å­—ç¬¦ä¸²åŒ…å«åŒ¹é…',
                        desc: 'æ£€æŸ¥å¯¹è±¡å€¼æ˜¯å¦åŒ…å«æºå€¼ï¼ˆä½œä¸ºå­å­—ç¬¦ä¸²ï¼‰',
                        fn: (oV, sV) => {
                            if (typeof oV !== 'string' || typeof sV !== 'string') return oV === sV;
                            return oV.toLowerCase().includes(sV.toLowerCase());
                        }
                    },
                    {
                        value: 'arrayIncludes',
                        label: 'æ•°ç»„åŒ…å«åŒ¹é…',
                        desc: 'å¦‚æœå€¼æ˜¯æ•°ç»„ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«æºå€¼',
                        fn: (oV, sV) => {
                            if (Array.isArray(oV)) return oV.includes(sV);
                            return oV === sV;
                        }
                    },
                    {
                        value: 'custom',
                        label: 'è‡ªå®šä¹‰å‡½æ•°',
                        desc: 'ä½¿ç”¨è‡ªå®šä¹‰ JavaScript å‡½æ•°è¿›è¡Œæ¯”è¾ƒ',
                        fn: null
                    }
                ];
                this.checkboxOptions = [
                    { id: 'showOriginal', label: 'æ˜¾ç¤ºåŸå§‹å¯¹è±¡', checked: true },
                    { id: 'showMatched', label: 'æ˜¾ç¤ºåŒ¹é…ç»“æœ', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºå¯¹æ¯”åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºä»£ç é¢„è§ˆ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupFunctionSelect();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupFunctionSelect() {
                const container = document.getElementById('functionSelect');
                if (!container) return;
                try {
                    const select = new Select({
                        container,
                        options: this.comparisonFunctions,
                        placeholder: 'é€‰æ‹©æ¯”è¾ƒå‡½æ•°',
                        onChange: (value) => this.onFunctionChange(value)
                    });
                    select.setValue('default');
                    this.plugins.functionSelect = select;
                    this.onFunctionChange('default');
                } catch (error) {
                    console.warn('è‡ªå®šä¹‰é€‰æ‹©æ¡†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿé€‰æ‹©æ¡†:', error);
                    const native = document.createElement('select');
                    native.className = 'input-field';
                    this.comparisonFunctions.forEach((option, index) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        if (index === 0) opt.selected = true;
                        native.appendChild(opt);
                    });
                    native.addEventListener('change', (event) => this.onFunctionChange(event.target.value));
                    container.appendChild(native);
                }
            }

            onFunctionChange(value) {
                const func = this.comparisonFunctions.find(f => f.value === value);
                if (!func) return;

                this.currentFunction = func;
                const configDiv = document.getElementById('functionConfig');
                const descDiv = document.getElementById('functionDesc');
                const customGroup = document.getElementById('customFunctionGroup');

                if (value === 'custom') {
                    if (configDiv) configDiv.style.display = 'block';
                    if (descDiv) descDiv.textContent = func.desc;
                    if (customGroup) customGroup.style.display = 'block';
                } else {
                    if (configDiv) configDiv.style.display = 'block';
                    if (descDiv) descDiv.textContent = func.desc;
                    if (customGroup) customGroup.style.display = 'none';
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: this.checkboxOptions.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    this.checkboxOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            getComparisonFunction() {
                if (!this.currentFunction) {
                    const select = this.plugins.functionSelect;
                    if (select?.getValue) {
                        const value = select.getValue();
                        this.currentFunction = this.comparisonFunctions.find(f => f.value === value) || this.comparisonFunctions[0];
                    } else {
                        const native = document.querySelector('#functionSelect select');
                        if (native) {
                            const value = native.value;
                            this.currentFunction = this.comparisonFunctions.find(f => f.value === value) || this.comparisonFunctions[0];
                        } else {
                            this.currentFunction = this.comparisonFunctions[0];
                        }
                    }
                }

                if (this.currentFunction.value === 'custom') {
                    const customInput = document.getElementById('customFunctionInput');
                    if (customInput && customInput.value.trim()) {
                        try {
                            return new Function('oV', 'sV', 'k', 'obj', 'source', `return ${customInput.value}`);
                        } catch (error) {
                            throw new Error('è‡ªå®šä¹‰å‡½æ•°ä»£ç é”™è¯¯: ' + error.message);
                        }
                    }
                    return null;
                }

                return this.currentFunction.fn;
            }

            addObject() {
                const objectInput = document.getElementById('objectInput');
                const sourceInput = document.getElementById('sourceInput');
                if (!objectInput || !sourceInput) return;

                const objectStr = objectInput.value.trim();
                const sourceStr = sourceInput.value.trim();

                if (!objectStr) {
                    this.showError('è¯·è¾“å…¥å¾…åŒ¹é…å¯¹è±¡');
                    return;
                }

                if (!sourceStr) {
                    this.showError('è¯·è¾“å…¥åŒ¹é…æ¡ä»¶å¯¹è±¡');
                    return;
                }

                try {
                    const obj = JSON.parse(objectStr);
                    const source = JSON.parse(sourceStr);
                    
                    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {
                        throw new Error('å¾…åŒ¹é…å¯¹è±¡å¿…é¡»æ˜¯æ™®é€šå¯¹è±¡');
                    }
                    if (typeof source !== 'object' || source === null || Array.isArray(source)) {
                        throw new Error('åŒ¹é…æ¡ä»¶å¿…é¡»æ˜¯æ™®é€šå¯¹è±¡');
                    }

                    this.objects.push({
                        id: this.objectId++,
                        obj,
                        source,
                        matched: null,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });

                    this.source = source;
                    this.displayObjects();
                    objectInput.value = '';
                    this.showNotification('å¯¹è±¡å·²æ·»åŠ ', 'success');
                } catch (error) {
                    this.showError('JSON è§£æå¤±è´¥: ' + error.message);
                }
            }

            matchAll() {
                if (this.objects.length === 0) {
                    this.showError('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªå¯¹è±¡');
                    return;
                }

                const sourceInput = document.getElementById('sourceInput');
                if (sourceInput && sourceInput.value.trim()) {
                    try {
                        this.source = JSON.parse(sourceInput.value.trim());
                    } catch (error) {
                        this.showError('åŒ¹é…æ¡ä»¶å¯¹è±¡ JSON è§£æå¤±è´¥: ' + error.message);
                        return;
                    }
                }

                if (!this.source || Object.keys(this.source).length === 0) {
                    this.showError('è¯·è®¾ç½®åŒ¹é…æ¡ä»¶å¯¹è±¡');
                    return;
                }

                let fn;
                try {
                    fn = this.getComparisonFunction();
                } catch (error) {
                    this.showError(error.message);
                    return;
                }

                const start = performance.now();
                this.objects = this.objects.map(item => {
                    try {
                        const matched = matchesWith(item.obj, this.source, fn);
                        return { ...item, matched, source: this.source, fn: this.currentFunction };
                    } catch (error) {
                        console.error('åŒ¹é…å¤±è´¥:', error);
                        return { ...item, matched: false, source: this.source, fn: this.currentFunction, error: error.message };
                    }
                });
                const end = performance.now();
                const time = Math.round((end - start) * 1000) / 1000;

                this.stats.totalMatches++;
                this.stats.totalObjects += this.objects.length;
                this.stats.matchedCount = this.objects.filter(item => item.matched).length;
                this.stats.unmatchedCount = this.objects.length - this.stats.matchedCount;
                
                const funcName = this.currentFunction?.value || 'default';
                this.stats.functionUsage[funcName] = (this.stats.functionUsage[funcName] || 0) + 1;

                this.displayObjects();
                this.displayResults();
                this.updateStats();
                this.addToHistory(this.objects.length, this.stats.matchedCount, time, funcName);

                if (this.getCheckboxValue('showAnalysis')) {
                    this.displayAnalysis();
                }

                if (this.getCheckboxValue('showCode')) {
                    this.showCode();
                }

                this.showNotification(`åŒ¹é…å®Œæˆï¼š${this.stats.matchedCount}/${this.objects.length} åŒ¹é…æˆåŠŸï¼Œç”¨æ—¶ ${time}Î¼s`, 'success');
            }

            displayObjects() {
                const container = document.getElementById('objectDisplay');
                if (!container) return;

                if (!this.getCheckboxValue('showOriginal')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­åŸå§‹å¯¹è±¡å±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (this.objects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ å¯¹è±¡åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>`;
                    return;
                }

                const html = this.objects.map(item => {
                    const cardClass = item.matched === null ? '' : (item.matched ? 'matched' : 'not-matched');
                    return `
                        <div class="object-card ${cardClass}">
                            <div class="object-header">
                                <div class="object-id">å¯¹è±¡ #${item.id}</div>
                                ${item.matched !== null ? `
                                    <div class="match-badge ${item.matched}">${item.matched ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}</div>
                                ` : ''}
                            </div>
                            <div class="object-content">${JSON.stringify(item.obj, null, 2)}</div>
                            <div style="margin-top:8px;font-size:0.8rem;color:#64748b;">æ·»åŠ æ—¶é—´ï¼š${item.timestamp}</div>
                            <button class="btn btn-sm btn-danger" style="margin-top:8px;" onclick="window.matchWithTool?.removeObject(${item.id})">ç§»é™¤</button>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="object-list">${html}</div>`;
            }

            displayResults() {
                const container = document.getElementById('matchResults');
                if (!container) return;

                if (!this.getCheckboxValue('showMatched')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­åŒ¹é…ç»“æœå±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (this.objects.length === 0 || this.objects.every(item => item.matched === null)) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¯</div>
                            <p>æ‰§è¡ŒåŒ¹é…åå°†åœ¨æ­¤å±•ç¤ºç»“æœ</p>
                        </div>`;
                    return;
                }

                const matched = this.objects.filter(item => item.matched);
                const unmatched = this.objects.filter(item => !item.matched);

                container.innerHTML = `
                    <div style="margin-bottom:16px;">
                        <h3 style="color:#15803d;margin-bottom:12px;">âœ“ åŒ¹é…æˆåŠŸ (${matched.length})</h3>
                        ${matched.length > 0 ? `
                            <div class="object-list">
                                ${matched.map(item => `
                                    <div class="object-card matched">
                                        <div class="object-header">
                                            <div class="object-id">å¯¹è±¡ #${item.id}</div>
                                            <div class="match-badge true">åŒ¹é…</div>
                                        </div>
                                        <div class="object-content">${JSON.stringify(item.obj, null, 2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color:#64748b;">æš‚æ— åŒ¹é…å¯¹è±¡</p>'}
                    </div>
                    <div>
                        <h3 style="color:#b91c1c;margin-bottom:12px;">âœ— ä¸åŒ¹é… (${unmatched.length})</h3>
                        ${unmatched.length > 0 ? `
                            <div class="object-list">
                                ${unmatched.map(item => `
                                    <div class="object-card not-matched">
                                        <div class="object-header">
                                            <div class="object-id">å¯¹è±¡ #${item.id}</div>
                                            <div class="match-badge false">ä¸åŒ¹é…</div>
                                        </div>
                                        <div class="object-content">${JSON.stringify(item.obj, null, 2)}</div>
                                        ${item.error ? `<div style="color:#b91c1c;font-size:0.8rem;margin-top:8px;">é”™è¯¯: ${item.error}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color:#64748b;">æ‰€æœ‰å¯¹è±¡å‡åŒ¹é…</p>'}
                    </div>
                `;
            }

            displayAnalysis() {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('comparisonGrid');
                if (!card || !grid) return;

                if (this.objects.length === 0 || !this.source) {
                    card.style.display = 'none';
                    return;
                }

                const sourceKeys = Object.keys(this.source);
                const funcName = this.currentFunction?.label || 'é»˜è®¤ä¸¥æ ¼ç›¸ç­‰';
                
                grid.innerHTML = `
                    <div class="comparison-card">
                        <h4>åŒ¹é…æ¡ä»¶</h4>
                        <div class="object-content" style="margin-top:10px;">${JSON.stringify(this.source, null, 2)}</div>
                    </div>
                    <div class="comparison-card">
                        <h4>æ¯”è¾ƒå‡½æ•°</h4>
                        <p style="color:#374151;margin-top:10px;">${funcName}</p>
                        <p style="color:#64748b;font-size:0.85rem;margin-top:6px;">${this.currentFunction?.desc || ''}</p>
                    </div>
                    <div class="comparison-card">
                        <h4>åŒ¹é…æ¦‚è§ˆ</h4>
                        <ul>
                            <li>æ€»å¯¹è±¡æ•°ï¼š${this.objects.length}</li>
                            <li class="match">åŒ¹é…æˆåŠŸï¼š${this.stats.matchedCount}</li>
                            <li class="mismatch">ä¸åŒ¹é…ï¼š${this.stats.unmatchedCount}</li>
                            <li>åŒ¹é…ç‡ï¼š${this.objects.length > 0 ? Math.round((this.stats.matchedCount / this.objects.length) * 100) : 0}%</li>
                        </ul>
                    </div>
                `;

                card.style.display = 'block';
            }

            addToHistory(count, matched, time, funcName) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    count,
                    matched,
                    unmatched: count - matched,
                    execTime: time,
                    funcName: funcName || 'default',
                    source: JSON.stringify(this.source).slice(0, 60) + (JSON.stringify(this.source).length > 60 ? '...' : '')
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— åŒ¹é…å†å²</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.execTime}Î¼s</div>
                        <div class="history-summary">å¯¹è±¡ï¼š${item.count} ï½œ åŒ¹é…ï¼š${item.matched} ï½œ ä¸åŒ¹é…ï¼š${item.unmatched}</div>
                        <div style="color:#64748b;font-size:0.8rem;margin-top:6px;">å‡½æ•°ï¼š${item.funcName} ï½œ æ¡ä»¶ï¼š${item.source}</div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                const matchRate = this.objects.length > 0 ? Math.round((this.stats.matchedCount / this.objects.length) * 100) : 0;
                const mostUsedFunc = Object.keys(this.stats.functionUsage).reduce((a, b) => 
                    this.stats.functionUsage[a] > this.stats.functionUsage[b] ? a : b, '-');
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalMatches}</div>
                        <div class="stat-label">åŒ¹é…æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalObjects}</div>
                        <div class="stat-label">ç´¯è®¡å¯¹è±¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.matchedCount}</div>
                        <div class="stat-label">åŒ¹é…æˆåŠŸ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${matchRate}%</div>
                        <div class="stat-label">åŒ¹é…ç‡</div>
                    </div>
                `;
            }

            showCode() {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;

                if (this.objects.length === 0 || !this.source) {
                    if (section) section.style.display = 'none';
                    return;
                }

                const sampleObj = this.objects[0].obj;
                const fn = this.getComparisonFunction();
                let fnCode = 'null';
                let fnDesc = 'é»˜è®¤ä¸¥æ ¼ç›¸ç­‰æ¯”è¾ƒ';

                if (fn) {
                    if (this.currentFunction?.value === 'custom') {
                        const customInput = document.getElementById('customFunctionInput');
                        fnCode = customInput?.value || '(oV, sV) => oV === sV';
                        fnDesc = 'è‡ªå®šä¹‰å‡½æ•°';
                    } else {
                        fnCode = fn.toString();
                        fnDesc = this.currentFunction?.label || 'è‡ªå®šä¹‰å‡½æ•°';
                    }
                }

                const code = `const matchesWith = (obj, source, fn) => 
  Object.keys(source).every(k => 
    obj.hasOwnProperty(k) && 
    (fn ? fn(obj[k], source[k], k, obj, source) : obj[k] === source[k])
  );

const source = ${JSON.stringify(this.source, null, 2)};

// æ¯”è¾ƒå‡½æ•°ï¼š${fnDesc}
const compareFn = ${fnCode};

// å•ä¸ªå¯¹è±¡åŒ¹é…
const obj1 = ${JSON.stringify(sampleObj, null, 2)};
const result1 = matchesWith(obj1, source, compareFn);
console.log(result1); // ${matchesWith(sampleObj, this.source, fn)}

// æ‰¹é‡åŒ¹é…
const objects = ${JSON.stringify(this.objects.map(item => item.obj).slice(0, 3), null, 2)};
const results = objects.map(obj => matchesWith(obj, source, compareFn));
console.log(results); // ${JSON.stringify(this.objects.slice(0, 3).map(item => item.matched))}

// è¿‡æ»¤åŒ¹é…çš„å¯¹è±¡
const matched = objects.filter(obj => matchesWith(obj, source, compareFn));
console.log(matched);`;

                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            removeObject(id) {
                this.objects = this.objects.filter(item => item.id !== id);
                this.displayObjects();
                this.displayResults();
                this.displayAnalysis();
                this.showNotification(`å·²ç§»é™¤å¯¹è±¡ #${id}`, 'info');
            }

            clearAll() {
                this.objects = [];
                this.source = null;
                const objectInput = document.getElementById('objectInput');
                const sourceInput = document.getElementById('sourceInput');
                if (objectInput) objectInput.value = '';
                if (sourceInput) sourceInput.value = '';
                this.displayObjects();
                this.displayResults();
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                this.showNotification('å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®', 'info');
            }

            loadSample() {
                const objectInput = document.getElementById('objectInput');
                const sourceInput = document.getElementById('sourceInput');
                if (objectInput && sourceInput) {
                    objectInput.value = JSON.stringify({ greeting: 'hello', age: 25, name: 'John' }, null, 2);
                    sourceInput.value = JSON.stringify({ greeting: 'hi' }, null, 2);
                }
                const functionSelect = this.plugins.functionSelect;
                if (functionSelect?.setValue) {
                    functionSelect.setValue('greeting');
                    this.onFunctionChange('greeting');
                } else {
                    const native = document.querySelector('#functionSelect select');
                    if (native) {
                        native.value = 'greeting';
                        this.onFunctionChange('greeting');
                    }
                }
                this.showNotification('ç¤ºä¾‹æ•°æ®å·²åŠ è½½', 'info');
            }

            generateRandom() {
                const templates = [
                    { greeting: 'hello', age: 25, name: 'Alice' },
                    { greeting: 'hi', age: 30, name: 'Bob' },
                    { greeting: 'hey', age: 25, name: 'Charlie' },
                    { greeting: 'hello', age: 28, name: 'David' },
                    { greeting: 'hi', age: 25, name: 'Eve' }
                ];
                const sourceInput = document.getElementById('sourceInput');
                if (sourceInput && !sourceInput.value.trim()) {
                    sourceInput.value = JSON.stringify({ greeting: 'hi' }, null, 2);
                }
                templates.forEach(template => {
                    this.objects.push({
                        id: this.objectId++,
                        obj: template,
                        source: null,
                        matched: null,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });
                });
                this.displayObjects();
                this.showNotification('å·²ç”Ÿæˆéšæœºå¯¹è±¡', 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨è‡ªå®šä¹‰åŒ¹é…éªŒè¯å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">ğŸ¯</div>
                                <p style="color:#1f2937;line-height:1.8;">
                                    ä½¿ç”¨ <strong>matchesWith</strong> å‡½æ•°è¿›è¡Œçµæ´»çš„å¯¹è±¡åŒ¹é…éªŒè¯ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ã€é¢„è®¾åŒ¹é…ç­–ç•¥ã€æ‰¹é‡éªŒè¯ä¸è¯¦ç»†åˆ†æã€‚
                                </p>
                                <div style="background:#cffafe;border-left:4px solid #06b6d4;padding:12px;border-radius:12px;color:#0e7490;margin-top:12px;">
                                    <strong>äº®ç‚¹ï¼š</strong> å¤šç§é¢„è®¾æ¯”è¾ƒå‡½æ•°ã€è‡ªå®šä¹‰å‡½æ•°æ”¯æŒã€å®æ—¶åŒ¹é…éªŒè¯ã€è¯¦ç»†å¯¹æ¯”åˆ†æã€åŒ¹é…ç‡ç»Ÿè®¡ã€ä»£ç ä¸€é”®å¤åˆ¶ã€‚
                                </div>
                                <ul style="color:#1f2937;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>æ”¯æŒé»˜è®¤ä¸¥æ ¼ç›¸ç­‰ã€å®½æ¾ç›¸ç­‰ã€é—®å€™è¯­åŒ¹é…ç­‰å¤šç§é¢„è®¾å‡½æ•°</li>
                                    <li>å¯è‡ªå®šä¹‰ JavaScript å‡½æ•°å®ç°å¤æ‚åŒ¹é…é€»è¾‘</li>
                                    <li>å¯è§†åŒ–å±•ç¤ºåŒ¹é…æˆåŠŸä¸å¤±è´¥çš„å¯¹è±¡</li>
                                    <li>è¯¦ç»†åˆ†ææ¯ä¸ªé”®å€¼çš„åŒ¹é…æƒ…å†µ</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.matchWithTool = new MatchWithTool();
        });

        if (document.readyState !== 'loading' && !window.matchWithTool) {
            window.matchWithTool = new MatchWithTool();
        }
    </script>
</body>

</html>
