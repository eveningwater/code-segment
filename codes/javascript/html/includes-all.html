<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能权限与功能管理系统 - includesAll函数实战示例</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .permission-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .permission-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .permission-card.granted {
            border-color: #28a745;
            background: #f8fff9;
        }

        .permission-card.denied {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .permission-card.partial {
            border-color: #ffc107;
            background: #fffef8;
        }

        .permission-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .permission-icon {
            font-size: 1.2em;
        }

        .permission-name {
            font-weight: 600;
            color: #333;
        }

        .permission-status {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status-granted {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        .permission-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .permission-requirements {
            font-size: 0.8em;
            color: #999;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-manager {
            background: #fd7e14;
            color: white;
        }

        .role-user {
            background: #28a745;
            color: white;
        }

        .role-guest {
            background: #6c757d;
            color: white;
        }

        .permission-checker {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .check-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .check-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .check-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .check-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .feature-module {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .feature-module:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .feature-module.accessible {
            border-color: #28a745;
            background: #f8fff9;
        }

        .feature-module.inaccessible {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .feature-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feature-icon {
            font-size: 1.5em;
        }

        .feature-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .feature-status {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .feature-description {
            color: #666;
            margin-bottom: 15px;
        }

        .required-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .required-permission {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #666;
        }

        .required-permission.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .required-permission.granted {
            background: #d4edda;
            color: #155724;
        }

        .access-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-time {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-user {
            color: #68d391;
            margin-right: 10px;
        }

        .log-action {
            color: #63b3ed;
        }

        .log-result {
            margin-left: 10px;
        }

        .log-result.success {
            color: #68d391;
        }

        .log-result.error {
            color: #fc8181;
        }

        .log-result.warning {
            color: #f6ad55;
        }

        .role-manager {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .role-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .role-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .role-name {
            font-weight: 600;
            color: #333;
        }

        .role-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .role-permission {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .permission-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🔐 智能权限与功能管理系统</h1>
            <p>基于 includesAll 函数的实战示例 - 权限验证、角色管理、功能访问控制</p>
        </div>

        <div class="content">
            <!-- 控制面板 -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>⚙️ 系统配置</h3>
                    <div class="controls-grid">
                        <div class="form-group">
                            <label>当前用户</label>
                            <div id="currentUserSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>操作类型</label>
                            <div id="operationTypeSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>权限级别</label>
                            <div id="permissionLevelSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>自动检查</label>
                            <div id="autoCheckCheckbox"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkPermissions()">检查权限</button>
                    <button class="btn btn-success" onclick="addUser()">添加用户</button>
                    <button class="btn btn-warning" onclick="manageRoles()">角色管理</button>
                    <button class="btn btn-danger" onclick="clearLogs()">清除日志</button>
                </div>
            </div>

            <!-- 仪表板 -->
            <div class="dashboard">
                <!-- 权限检查器 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">🔍</span>
                        <span class="card-title">权限检查器</span>
                    </div>
                    <div class="permission-checker">
                        <div class="controls-grid">
                            <div class="form-group">
                                <label>用户ID</label>
                                <div id="checkUserInput"></div>
                            </div>
                            <div class="form-group">
                                <label>所需权限</label>
                                <div id="requiredPermissionsSelect"></div>
                            </div>
                            <div class="form-group">
                                <label>检查模式</label>
                                <div id="checkModeSelect"></div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="performPermissionCheck()">执行检查</button>
                        <button class="btn btn-success" onclick="batchPermissionCheck()">批量检查</button>
                        <div id="checkResult" class="check-result" style="display: none;"></div>
                    </div>
                </div>

                <!-- 用户管理 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">👥</span>
                        <span class="card-title">用户管理</span>
                    </div>
                    <table class="user-table" id="userTable">
                        <thead>
                            <tr>
                                <th>用户ID</th>
                                <th>用户名</th>
                                <th>角色</th>
                                <th>权限</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- 用户行将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 功能模块 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">📦</span>
                        <span class="card-title">功能模块</span>
                    </div>
                    <div id="featureModules">
                        <!-- 功能模块将在这里动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 权限网格 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🎯</span>
                    <span class="card-title">权限网格</span>
                </div>
                <div class="permission-grid" id="permissionGrid">
                    <!-- 权限卡片将在这里动态生成 -->
                </div>
            </div>

            <!-- 角色管理 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">👑</span>
                    <span class="card-title">角色管理</span>
                </div>
                <div class="role-manager">
                    <div id="roleCards">
                        <!-- 角色卡片将在这里动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 访问日志 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📋</span>
                    <span class="card-title">访问日志</span>
                </div>
                <div class="access-log" id="accessLog">
                    <!-- 访问日志将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 引入插件 -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>

    <script>
        // 全局变量
        let modal, notification;
        let currentUserSelect, operationTypeSelect, permissionLevelSelect, autoCheckCheckbox;
        let checkUserInput, requiredPermissionsSelect, checkModeSelect;
        let users = [];
        let roles = [];
        let permissions = [];
        let features = [];
        let accessLogs = [];

        // includesAll 函数
        const includesAll = (arr, values) => values.every(v => arr.includes(v));

        // 初始化应用
        function initApp() {
            // 初始化插件
            modal = new Modal();
            notification = new Notification({ position: 'top-right' });

            // 初始化选择控件
            currentUserSelect = new Select({
                container: document.getElementById('currentUserSelect'),
                options: [
                    { value: 'admin', label: '管理员' },
                    { value: 'manager', label: '经理' },
                    { value: 'user', label: '普通用户' },
                    { value: 'guest', label: '访客' }
                ],
                placeholder: '选择当前用户'
            });

            operationTypeSelect = new Select({
                container: document.getElementById('operationTypeSelect'),
                options: [
                    { value: 'read', label: '读取操作' },
                    { value: 'write', label: '写入操作' },
                    { value: 'delete', label: '删除操作' },
                    { value: 'admin', label: '管理操作' }
                ],
                placeholder: '选择操作类型'
            });

            permissionLevelSelect = new Select({
                container: document.getElementById('permissionLevelSelect'),
                options: [
                    { value: 'basic', label: '基础权限' },
                    { value: 'advanced', label: '高级权限' },
                    { value: 'admin', label: '管理员权限' },
                    { value: 'super', label: '超级权限' }
                ],
                placeholder: '选择权限级别'
            });

            autoCheckCheckbox = new Checkbox({
                label: '自动权限检查',
                checked: true,
                onChange: (checked) => {
                    console.log('自动检查状态:', checked);
                }
            });
            autoCheckCheckbox.mount(document.getElementById('autoCheckCheckbox'));

            // 初始化检查控件
            checkUserInput = new InputNumber({
                container: document.getElementById('checkUserInput'),
                min: 1,
                max: 100,
                value: 1,
                step: 1
            });

            requiredPermissionsSelect = new Select({
                container: document.getElementById('requiredPermissionsSelect'),
                options: [
                    { value: 'read', label: '读取权限' },
                    { value: 'write', label: '写入权限' },
                    { value: 'delete', label: '删除权限' },
                    { value: 'admin', label: '管理权限' }
                ],
                placeholder: '选择所需权限',
                multiple: true
            });

            checkModeSelect = new Select({
                container: document.getElementById('checkModeSelect'),
                options: [
                    { value: 'strict', label: '严格模式 (必须包含所有权限)' },
                    { value: 'loose', label: '宽松模式 (包含任一权限)' },
                    { value: 'partial', label: '部分模式 (包含部分权限)' }
                ],
                placeholder: '选择检查模式'
            });

            // 初始化数据
            initializeData();

            // 初始化界面
            updateUserTable();
            updatePermissionGrid();
            updateFeatureModules();
            updateRoleCards();
            addAccessLog('系统初始化完成', 'system', 'info');
        }

        // 初始化数据
        function initializeData() {
            // 初始化权限
            permissions = [
                { id: 'read', name: '读取权限', description: '允许读取数据', icon: '📖' },
                { id: 'write', name: '写入权限', description: '允许写入数据', icon: '✏️' },
                { id: 'delete', name: '删除权限', description: '允许删除数据', icon: '🗑️' },
                { id: 'admin', name: '管理权限', description: '允许管理用户和系统', icon: '⚙️' },
                { id: 'export', name: '导出权限', description: '允许导出数据', icon: '📤' },
                { id: 'import', name: '导入权限', description: '允许导入数据', icon: '📥' },
                { id: 'report', name: '报表权限', description: '允许生成报表', icon: '📊' },
                { id: 'audit', name: '审计权限', description: '允许查看审计日志', icon: '🔍' }
            ];

            // 初始化角色
            roles = [
                {
                    id: 'admin',
                    name: '管理员',
                    permissions: ['read', 'write', 'delete', 'admin', 'export', 'import', 'report', 'audit'],
                    color: 'role-admin'
                },
                {
                    id: 'manager',
                    name: '经理',
                    permissions: ['read', 'write', 'export', 'report'],
                    color: 'role-manager'
                },
                {
                    id: 'user',
                    name: '普通用户',
                    permissions: ['read', 'write'],
                    color: 'role-user'
                },
                {
                    id: 'guest',
                    name: '访客',
                    permissions: ['read'],
                    color: 'role-guest'
                }
            ];

            // 初始化用户
            users = [
                { id: 1, name: '张三', role: 'admin', permissions: ['read', 'write', 'delete', 'admin', 'export', 'import', 'report', 'audit'], status: 'active' },
                { id: 2, name: '李四', role: 'manager', permissions: ['read', 'write', 'export', 'report'], status: 'active' },
                { id: 3, name: '王五', role: 'user', permissions: ['read', 'write'], status: 'active' },
                { id: 4, name: '赵六', role: 'guest', permissions: ['read'], status: 'inactive' }
            ];

            // 初始化功能模块
            features = [
                {
                    id: 'dashboard',
                    name: '仪表板',
                    description: '系统主仪表板，显示关键指标和统计信息',
                    icon: '📊',
                    requiredPermissions: ['read']
                },
                {
                    id: 'user-management',
                    name: '用户管理',
                    description: '管理系统用户，包括添加、编辑、删除用户',
                    icon: '👥',
                    requiredPermissions: ['read', 'write', 'admin']
                },
                {
                    id: 'data-export',
                    name: '数据导出',
                    description: '导出系统数据到各种格式',
                    icon: '📤',
                    requiredPermissions: ['read', 'export']
                },
                {
                    id: 'system-settings',
                    name: '系统设置',
                    description: '配置系统参数和全局设置',
                    icon: '⚙️',
                    requiredPermissions: ['admin']
                },
                {
                    id: 'audit-logs',
                    name: '审计日志',
                    description: '查看系统操作审计日志',
                    icon: '📋',
                    requiredPermissions: ['read', 'audit']
                },
                {
                    id: 'reports',
                    name: '报表生成',
                    description: '生成各种统计报表和分析报告',
                    icon: '📈',
                    requiredPermissions: ['read', 'report']
                }
            ];
        }

        // 更新用户表格
        function updateUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                const role = roles.find(r => r.id === user.role);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td><span class="role-badge ${role.color}">${role.name}</span></td>
                    <td>${user.permissions.join(', ')}</td>
                    <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                    <td>
                        <button onclick="editUser(${user.id})" 
                                style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px;">
                            编辑
                        </button>
                        <button onclick="deleteUser(${user.id})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                            删除
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 更新权限网格
        function updatePermissionGrid() {
            const container = document.getElementById('permissionGrid');
            container.innerHTML = '';

            permissions.forEach(permission => {
                const card = document.createElement('div');
                card.className = 'permission-card';
                card.onclick = () => togglePermission(permission.id);

                const grantedCount = users.filter(u => u.permissions.includes(permission.id)).length;
                const totalCount = users.length;
                const percentage = totalCount > 0 ? (grantedCount / totalCount) * 100 : 0;
                
                let status = 'denied';
                let statusClass = 'status-denied';
                if (percentage === 100) {
                    status = 'granted';
                    statusClass = 'status-granted';
                } else if (percentage > 0) {
                    status = 'partial';
                    statusClass = 'status-partial';
                }

                card.innerHTML = `
                    <div class="permission-header">
                        <span class="permission-icon">${permission.icon}</span>
                        <span class="permission-name">${permission.name}</span>
                        <span class="permission-status ${statusClass}">${status}</span>
                    </div>
                    <div class="permission-description">${permission.description}</div>
                    <div class="permission-requirements">
                        授权率: ${grantedCount}/${totalCount} (${percentage.toFixed(1)}%)
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // 更新功能模块
        function updateFeatureModules() {
            const container = document.getElementById('featureModules');
            container.innerHTML = '';

            features.forEach(feature => {
                const module = document.createElement('div');
                module.className = 'feature-module';

                // 检查当前用户是否有访问权限
                const currentUser = users.find(u => u.id == checkUserInput.getValue()) || users[0];
                const hasAccess = includesAll(currentUser.permissions, feature.requiredPermissions);
                module.classList.add(hasAccess ? 'accessible' : 'inaccessible');

                const requiredPermissionsHtml = feature.requiredPermissions.map(permId => {
                    const hasPermission = currentUser.permissions.includes(permId);
                    return `<span class="required-permission ${hasPermission ? 'granted' : 'missing'}">${permId}</span>`;
                }).join('');

                module.innerHTML = `
                    <div class="feature-header">
                        <span class="feature-icon">${feature.icon}</span>
                        <span class="feature-name">${feature.name}</span>
                        <span class="feature-status ${hasAccess ? 'status-granted' : 'status-denied'}">
                            ${hasAccess ? '可访问' : '不可访问'}
                        </span>
                    </div>
                    <div class="feature-description">${feature.description}</div>
                    <div class="required-permissions">
                        <strong>所需权限:</strong> ${requiredPermissionsHtml}
                    </div>
                `;

                container.appendChild(module);
            });
        }

        // 更新角色卡片
        function updateRoleCards() {
            const container = document.getElementById('roleCards');
            container.innerHTML = '';

            roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'role-card';

                const permissionsHtml = role.permissions.map(permId => {
                    const permission = permissions.find(p => p.id === permId);
                    return `<span class="role-permission">${permission ? permission.name : permId}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="role-header">
                        <span class="role-name">${role.name}</span>
                        <span class="role-badge ${role.color}">${role.name}</span>
                    </div>
                    <div class="role-permissions">
                        ${permissionsHtml}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // 切换权限
        function togglePermission(permissionId) {
            const currentUser = users.find(u => u.id == checkUserInput.getValue()) || users[0];
            const hasPermission = currentUser.permissions.includes(permissionId);
            
            if (hasPermission) {
                currentUser.permissions = currentUser.permissions.filter(p => p !== permissionId);
                addAccessLog(`移除权限: ${permissionId}`, currentUser.name, 'warning');
            } else {
                currentUser.permissions.push(permissionId);
                addAccessLog(`添加权限: ${permissionId}`, currentUser.name, 'success');
            }

            updateUserTable();
            updatePermissionGrid();
            updateFeatureModules();
            notification.success(`权限${hasPermission ? '移除' : '添加'}成功`);
        }

        // 检查权限
        function checkPermissions() {
            const currentUser = currentUserSelect.getValue();
            const operationType = operationTypeSelect.getValue();
            const permissionLevel = permissionLevelSelect.getValue();

            console.log('检查权限 - 当前用户:', currentUser);
            console.log('检查权限 - 操作类型:', operationType);
            console.log('检查权限 - 权限级别:', permissionLevel);
            console.log('检查权限 - 可用角色:', roles.map(r => r.id));
            console.log('检查权限 - 现有用户:', users.map(u => ({ name: u.name, role: u.role })));

            if (!currentUser || !operationType || !permissionLevel) {
                notification.error('请选择所有参数');
                return;
            }

            // 修复：根据角色查找用户，而不是直接匹配角色
            const user = users.find(u => u.role === currentUser);
            console.log('检查权限 - 找到的用户:', user);
            
            if (!user) {
                // 如果没有找到对应角色的用户，创建一个模拟用户
                const role = roles.find(r => r.id === currentUser);
                console.log('检查权限 - 找到的角色:', role);
                
                if (role) {
                    const mockUser = {
                        id: 999,
                        name: `${role.name}用户`,
                        role: currentUser,
                        permissions: role.permissions,
                        status: 'active'
                    };
                    
                    const requiredPermissions = [operationType];
                    if (permissionLevel === 'admin') {
                        requiredPermissions.push('admin');
                    }

                    const hasPermission = includesAll(mockUser.permissions, requiredPermissions);
                    
                    addAccessLog(`权限检查: ${operationType}`, mockUser.name, hasPermission ? 'success' : 'error');
                    
                    if (hasPermission) {
                        notification.success('权限检查通过');
                    } else {
                        notification.error('权限不足');
                    }
                } else {
                    notification.error('无效的角色');
                }
                return;
            }

            const requiredPermissions = [operationType];
            if (permissionLevel === 'admin') {
                requiredPermissions.push('admin');
            }

            const hasPermission = includesAll(user.permissions, requiredPermissions);
            
            addAccessLog(`权限检查: ${operationType}`, user.name, hasPermission ? 'success' : 'error');
            
            if (hasPermission) {
                notification.success('权限检查通过');
            } else {
                notification.error('权限不足');
            }
        }

        // 添加用户
        function addUser() {
            modal.prompt('请输入用户名:', '新用户').then(name => {
                if (name) {
                    modal.prompt('请选择角色 (admin/manager/user/guest):', 'user').then(role => {
                        if (role && roles.find(r => r.id === role)) {
                            const newUser = {
                                id: users.length + 1,
                                name: name,
                                role: role,
                                permissions: roles.find(r => r.id === role).permissions,
                                status: 'active'
                            };
                            users.push(newUser);
                            updateUserTable();
                            updatePermissionGrid();
                            addAccessLog(`添加用户: ${name}`, 'system', 'info');
                            notification.success('用户添加成功');
                        } else {
                            notification.error('无效的角色');
                        }
                    });
                }
            });
        }

        // 编辑用户
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                modal.prompt('请输入新用户名:', user.name).then(name => {
                    if (name) {
                        user.name = name;
                        updateUserTable();
                        addAccessLog(`编辑用户: ${name}`, 'system', 'info');
                        notification.success('用户编辑成功');
                    }
                });
            }
        }

        // 删除用户
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                modal.confirm(`确定要删除用户 ${user.name} 吗？`).then(confirmed => {
                    if (confirmed) {
                        users = users.filter(u => u.id !== userId);
                        updateUserTable();
                        updatePermissionGrid();
                        addAccessLog(`删除用户: ${user.name}`, 'system', 'warning');
                        notification.success('用户删除成功');
                    }
                });
            }
        }

        // 管理角色
        function manageRoles() {
            const content = `
                <div style="max-width: 600px;">
                    <h4>角色管理</h4>
                    <p>当前系统包含 ${roles.length} 个角色，${users.length} 个用户</p>
                    <div style="margin-top: 15px;">
                        ${roles.map(role => `
                            <div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 6px;">
                                <strong>${role.name}</strong> (${role.permissions.length} 个权限)
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    权限: ${role.permissions.join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            modal.alert(content, '角色管理');
        }

        // 执行权限检查
        function performPermissionCheck() {
            const userId = checkUserInput.getValue();
            const requiredPerms = requiredPermissionsSelect.getValue();
            const checkMode = checkModeSelect.getValue();

            if (!userId || !requiredPerms || !checkMode) {
                notification.error('请填写所有检查参数');
                return;
            }

            const user = users.find(u => u.id === userId);
            if (!user) {
                notification.error('用户不存在');
                return;
            }

            let result = false;
            let message = '';

            switch (checkMode) {
                case 'strict':
                    result = includesAll(user.permissions, requiredPerms);
                    message = `严格模式: 用户 ${user.name} 是否包含所有权限 [${requiredPerms.join(', ')}]`;
                    break;
                case 'loose':
                    result = requiredPerms.some(perm => user.permissions.includes(perm));
                    message = `宽松模式: 用户 ${user.name} 是否包含任一权限 [${requiredPerms.join(', ')}]`;
                    break;
                case 'partial':
                    const matchedPerms = requiredPerms.filter(perm => user.permissions.includes(perm));
                    result = matchedPerms.length > 0;
                    message = `部分模式: 用户 ${user.name} 包含 ${matchedPerms.length}/${requiredPerms.length} 个权限`;
                    break;
            }

            const resultDiv = document.getElementById('checkResult');
            resultDiv.style.display = 'block';
            resultDiv.className = `check-result ${result ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <div>${message}</div>
                <div style="margin-top: 5px; font-size: 0.9em;">
                    结果: <strong>${result ? '✅ 检查通过' : '❌ 检查失败'}</strong>
                </div>
            `;

            addAccessLog(`权限检查: ${checkMode}模式`, user.name, result ? 'success' : 'error');
        }

        // 批量权限检查
        function batchPermissionCheck() {
            const requiredPerms = ['read', 'write'];
            const results = users.map(user => {
                const hasAllPermissions = includesAll(user.permissions, requiredPerms);
                return { user, hasAllPermissions };
            });

            const content = `
                <div style="max-width: 500px;">
                    <h4>批量权限检查结果</h4>
                    <p>检查所有用户是否包含权限: [${requiredPerms.join(', ')}]</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #dee2e6;">用户</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">角色</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">结果</th>
                        </tr>
                        ${results.map(r => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${r.user.name}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${r.user.role}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">
                                    <span style="color: ${r.hasAllPermissions ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                        ${r.hasAllPermissions ? '✅ 通过' : '❌ 失败'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;

            modal.alert(content, '批量权限检查结果');
            addAccessLog('批量权限检查', 'system', 'info');
        }

        // 清除日志
        function clearLogs() {
            modal.confirm('确定要清除所有访问日志吗？').then(confirmed => {
                if (confirmed) {
                    accessLogs = [];
                    updateAccessLog();
                    notification.success('日志已清除');
                }
            });
        }

        // 添加访问日志
        function addAccessLog(action, user, status) {
            const timestamp = new Date();
            const logEntry = {
                time: timestamp,
                action: action,
                user: user,
                status: status
            };

            accessLogs.unshift(logEntry);
            if (accessLogs.length > 50) {
                accessLogs.pop();
            }

            updateAccessLog();
        }

        // 更新访问日志
        function updateAccessLog() {
            const container = document.getElementById('accessLog');
            
            container.innerHTML = accessLogs.map(entry => `
                <div class="log-entry">
                    <span class="log-time">${formatDateTime(entry.time)}</span>
                    <span class="log-user">${entry.user}</span>
                    <span class="log-action">${entry.action}</span>
                    <span class="log-result ${entry.status}">${entry.status}</span>
                </div>
            `).join('');
        }

        // 格式化日期时间
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);

        // 全局调试函数
        window.debugPermissionSystem = function() {
            console.log('=== 权限系统调试信息 ===');
            console.log('角色列表:', roles);
            console.log('用户列表:', users);
            console.log('权限列表:', permissions);
            console.log('功能列表:', features);
            console.log('访问日志数量:', accessLogs.length);
            console.log('=======================');
        };
    </script>
</body>

</html>