<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æƒé™ä¸åŠŸèƒ½ç®¡ç†ç³»ç»Ÿ - includesAllå‡½æ•°å®æˆ˜ç¤ºä¾‹</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <link rel="stylesheet" href="../../demo/plugins/select/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/datetime-picker/style.css">
    <link rel="stylesheet" href="../../demo/plugins/input-number/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 30px;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .permission-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .permission-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .permission-card.granted {
            border-color: #28a745;
            background: #f8fff9;
        }

        .permission-card.denied {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .permission-card.partial {
            border-color: #ffc107;
            background: #fffef8;
        }

        .permission-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .permission-icon {
            font-size: 1.2em;
        }

        .permission-name {
            font-weight: 600;
            color: #333;
        }

        .permission-status {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status-granted {
            background: #d4edda;
            color: #155724;
        }

        .status-denied {
            background: #f8d7da;
            color: #721c24;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        .permission-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .permission-requirements {
            font-size: 0.8em;
            color: #999;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin: 2px;
            display: inline-block;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-manager {
            background: #fd7e14;
            color: white;
        }

        .role-user {
            background: #28a745;
            color: white;
        }

        .role-guest {
            background: #6c757d;
            color: white;
        }

        .permission-checker {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .check-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .check-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .check-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .check-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .feature-module {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .feature-module:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .feature-module.accessible {
            border-color: #28a745;
            background: #f8fff9;
        }

        .feature-module.inaccessible {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .feature-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feature-icon {
            font-size: 1.5em;
        }

        .feature-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .feature-status {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .feature-description {
            color: #666;
            margin-bottom: 15px;
        }

        .required-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .required-permission {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #666;
        }

        .required-permission.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .required-permission.granted {
            background: #d4edda;
            color: #155724;
        }

        .access-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-time {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-user {
            color: #68d391;
            margin-right: 10px;
        }

        .log-action {
            color: #63b3ed;
        }

        .log-result {
            margin-left: 10px;
        }

        .log-result.success {
            color: #68d391;
        }

        .log-result.error {
            color: #fc8181;
        }

        .log-result.warning {
            color: #f6ad55;
        }

        .role-manager {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .role-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .role-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .role-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .role-name {
            font-weight: 600;
            color: #333;
        }

        .role-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .role-permission {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .permission-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ™ºèƒ½æƒé™ä¸åŠŸèƒ½ç®¡ç†ç³»ç»Ÿ</h1>
            <p>åŸºäº includesAll å‡½æ•°çš„å®æˆ˜ç¤ºä¾‹ - æƒé™éªŒè¯ã€è§’è‰²ç®¡ç†ã€åŠŸèƒ½è®¿é—®æ§åˆ¶</p>
        </div>

        <div class="content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
                    <div class="controls-grid">
                        <div class="form-group">
                            <label>å½“å‰ç”¨æˆ·</label>
                            <div id="currentUserSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>æ“ä½œç±»å‹</label>
                            <div id="operationTypeSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>æƒé™çº§åˆ«</label>
                            <div id="permissionLevelSelect"></div>
                        </div>
                        <div class="form-group">
                            <label>è‡ªåŠ¨æ£€æŸ¥</label>
                            <div id="autoCheckCheckbox"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
                    <button class="btn btn-success" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
                    <button class="btn btn-warning" onclick="manageRoles()">è§’è‰²ç®¡ç†</button>
                    <button class="btn btn-danger" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
                </div>
            </div>

            <!-- ä»ªè¡¨æ¿ -->
            <div class="dashboard">
                <!-- æƒé™æ£€æŸ¥å™¨ -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ”</span>
                        <span class="card-title">æƒé™æ£€æŸ¥å™¨</span>
                    </div>
                    <div class="permission-checker">
                        <div class="controls-grid">
                            <div class="form-group">
                                <label>ç”¨æˆ·ID</label>
                                <div id="checkUserInput"></div>
                            </div>
                            <div class="form-group">
                                <label>æ‰€éœ€æƒé™</label>
                                <div id="requiredPermissionsSelect"></div>
                            </div>
                            <div class="form-group">
                                <label>æ£€æŸ¥æ¨¡å¼</label>
                                <div id="checkModeSelect"></div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="performPermissionCheck()">æ‰§è¡Œæ£€æŸ¥</button>
                        <button class="btn btn-success" onclick="batchPermissionCheck()">æ‰¹é‡æ£€æŸ¥</button>
                        <div id="checkResult" class="check-result" style="display: none;"></div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ‘¥</span>
                        <span class="card-title">ç”¨æˆ·ç®¡ç†</span>
                    </div>
                    <table class="user-table" id="userTable">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>è§’è‰²</th>
                                <th>æƒé™</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- ç”¨æˆ·è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <!-- åŠŸèƒ½æ¨¡å— -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ“¦</span>
                        <span class="card-title">åŠŸèƒ½æ¨¡å—</span>
                    </div>
                    <div id="featureModules">
                        <!-- åŠŸèƒ½æ¨¡å—å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æƒé™ç½‘æ ¼ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ¯</span>
                    <span class="card-title">æƒé™ç½‘æ ¼</span>
                </div>
                <div class="permission-grid" id="permissionGrid">
                    <!-- æƒé™å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è§’è‰²ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ‘‘</span>
                    <span class="card-title">è§’è‰²ç®¡ç†</span>
                </div>
                <div class="role-manager">
                    <div id="roleCards">
                        <!-- è§’è‰²å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- è®¿é—®æ—¥å¿— -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“‹</span>
                    <span class="card-title">è®¿é—®æ—¥å¿—</span>
                </div>
                <div class="access-log" id="accessLog">
                    <!-- è®¿é—®æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ’ä»¶ -->
    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="../../demo/plugins/select/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/datetime-picker/index.js"></script>
    <script src="../../demo/plugins/input-number/index.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let modal, notification;
        let currentUserSelect, operationTypeSelect, permissionLevelSelect, autoCheckCheckbox;
        let checkUserInput, requiredPermissionsSelect, checkModeSelect;
        let users = [];
        let roles = [];
        let permissions = [];
        let features = [];
        let accessLogs = [];

        // includesAll å‡½æ•°
        const includesAll = (arr, values) => values.every(v => arr.includes(v));

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // åˆå§‹åŒ–æ’ä»¶
            modal = new Modal();
            notification = new Notification({ position: 'top-right' });

            // åˆå§‹åŒ–é€‰æ‹©æ§ä»¶
            currentUserSelect = new Select({
                container: document.getElementById('currentUserSelect'),
                options: [
                    { value: 'admin', label: 'ç®¡ç†å‘˜' },
                    { value: 'manager', label: 'ç»ç†' },
                    { value: 'user', label: 'æ™®é€šç”¨æˆ·' },
                    { value: 'guest', label: 'è®¿å®¢' }
                ],
                placeholder: 'é€‰æ‹©å½“å‰ç”¨æˆ·'
            });

            operationTypeSelect = new Select({
                container: document.getElementById('operationTypeSelect'),
                options: [
                    { value: 'read', label: 'è¯»å–æ“ä½œ' },
                    { value: 'write', label: 'å†™å…¥æ“ä½œ' },
                    { value: 'delete', label: 'åˆ é™¤æ“ä½œ' },
                    { value: 'admin', label: 'ç®¡ç†æ“ä½œ' }
                ],
                placeholder: 'é€‰æ‹©æ“ä½œç±»å‹'
            });

            permissionLevelSelect = new Select({
                container: document.getElementById('permissionLevelSelect'),
                options: [
                    { value: 'basic', label: 'åŸºç¡€æƒé™' },
                    { value: 'advanced', label: 'é«˜çº§æƒé™' },
                    { value: 'admin', label: 'ç®¡ç†å‘˜æƒé™' },
                    { value: 'super', label: 'è¶…çº§æƒé™' }
                ],
                placeholder: 'é€‰æ‹©æƒé™çº§åˆ«'
            });

            autoCheckCheckbox = new Checkbox({
                label: 'è‡ªåŠ¨æƒé™æ£€æŸ¥',
                checked: true,
                onChange: (checked) => {
                    console.log('è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€:', checked);
                }
            });
            autoCheckCheckbox.mount(document.getElementById('autoCheckCheckbox'));

            // åˆå§‹åŒ–æ£€æŸ¥æ§ä»¶
            checkUserInput = new InputNumber({
                container: document.getElementById('checkUserInput'),
                min: 1,
                max: 100,
                value: 1,
                step: 1
            });

            requiredPermissionsSelect = new Select({
                container: document.getElementById('requiredPermissionsSelect'),
                options: [
                    { value: 'read', label: 'è¯»å–æƒé™' },
                    { value: 'write', label: 'å†™å…¥æƒé™' },
                    { value: 'delete', label: 'åˆ é™¤æƒé™' },
                    { value: 'admin', label: 'ç®¡ç†æƒé™' }
                ],
                placeholder: 'é€‰æ‹©æ‰€éœ€æƒé™',
                multiple: true
            });

            checkModeSelect = new Select({
                container: document.getElementById('checkModeSelect'),
                options: [
                    { value: 'strict', label: 'ä¸¥æ ¼æ¨¡å¼ (å¿…é¡»åŒ…å«æ‰€æœ‰æƒé™)' },
                    { value: 'loose', label: 'å®½æ¾æ¨¡å¼ (åŒ…å«ä»»ä¸€æƒé™)' },
                    { value: 'partial', label: 'éƒ¨åˆ†æ¨¡å¼ (åŒ…å«éƒ¨åˆ†æƒé™)' }
                ],
                placeholder: 'é€‰æ‹©æ£€æŸ¥æ¨¡å¼'
            });

            // åˆå§‹åŒ–æ•°æ®
            initializeData();

            // åˆå§‹åŒ–ç•Œé¢
            updateUserTable();
            updatePermissionGrid();
            updateFeatureModules();
            updateRoleCards();
            addAccessLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'system', 'info');
        }

        // åˆå§‹åŒ–æ•°æ®
        function initializeData() {
            // åˆå§‹åŒ–æƒé™
            permissions = [
                { id: 'read', name: 'è¯»å–æƒé™', description: 'å…è®¸è¯»å–æ•°æ®', icon: 'ğŸ“–' },
                { id: 'write', name: 'å†™å…¥æƒé™', description: 'å…è®¸å†™å…¥æ•°æ®', icon: 'âœï¸' },
                { id: 'delete', name: 'åˆ é™¤æƒé™', description: 'å…è®¸åˆ é™¤æ•°æ®', icon: 'ğŸ—‘ï¸' },
                { id: 'admin', name: 'ç®¡ç†æƒé™', description: 'å…è®¸ç®¡ç†ç”¨æˆ·å’Œç³»ç»Ÿ', icon: 'âš™ï¸' },
                { id: 'export', name: 'å¯¼å‡ºæƒé™', description: 'å…è®¸å¯¼å‡ºæ•°æ®', icon: 'ğŸ“¤' },
                { id: 'import', name: 'å¯¼å…¥æƒé™', description: 'å…è®¸å¯¼å…¥æ•°æ®', icon: 'ğŸ“¥' },
                { id: 'report', name: 'æŠ¥è¡¨æƒé™', description: 'å…è®¸ç”ŸæˆæŠ¥è¡¨', icon: 'ğŸ“Š' },
                { id: 'audit', name: 'å®¡è®¡æƒé™', description: 'å…è®¸æŸ¥çœ‹å®¡è®¡æ—¥å¿—', icon: 'ğŸ”' }
            ];

            // åˆå§‹åŒ–è§’è‰²
            roles = [
                {
                    id: 'admin',
                    name: 'ç®¡ç†å‘˜',
                    permissions: ['read', 'write', 'delete', 'admin', 'export', 'import', 'report', 'audit'],
                    color: 'role-admin'
                },
                {
                    id: 'manager',
                    name: 'ç»ç†',
                    permissions: ['read', 'write', 'export', 'report'],
                    color: 'role-manager'
                },
                {
                    id: 'user',
                    name: 'æ™®é€šç”¨æˆ·',
                    permissions: ['read', 'write'],
                    color: 'role-user'
                },
                {
                    id: 'guest',
                    name: 'è®¿å®¢',
                    permissions: ['read'],
                    color: 'role-guest'
                }
            ];

            // åˆå§‹åŒ–ç”¨æˆ·
            users = [
                { id: 1, name: 'å¼ ä¸‰', role: 'admin', permissions: ['read', 'write', 'delete', 'admin', 'export', 'import', 'report', 'audit'], status: 'active' },
                { id: 2, name: 'æå››', role: 'manager', permissions: ['read', 'write', 'export', 'report'], status: 'active' },
                { id: 3, name: 'ç‹äº”', role: 'user', permissions: ['read', 'write'], status: 'active' },
                { id: 4, name: 'èµµå…­', role: 'guest', permissions: ['read'], status: 'inactive' }
            ];

            // åˆå§‹åŒ–åŠŸèƒ½æ¨¡å—
            features = [
                {
                    id: 'dashboard',
                    name: 'ä»ªè¡¨æ¿',
                    description: 'ç³»ç»Ÿä¸»ä»ªè¡¨æ¿ï¼Œæ˜¾ç¤ºå…³é”®æŒ‡æ ‡å’Œç»Ÿè®¡ä¿¡æ¯',
                    icon: 'ğŸ“Š',
                    requiredPermissions: ['read']
                },
                {
                    id: 'user-management',
                    name: 'ç”¨æˆ·ç®¡ç†',
                    description: 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·ï¼ŒåŒ…æ‹¬æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ç”¨æˆ·',
                    icon: 'ğŸ‘¥',
                    requiredPermissions: ['read', 'write', 'admin']
                },
                {
                    id: 'data-export',
                    name: 'æ•°æ®å¯¼å‡º',
                    description: 'å¯¼å‡ºç³»ç»Ÿæ•°æ®åˆ°å„ç§æ ¼å¼',
                    icon: 'ğŸ“¤',
                    requiredPermissions: ['read', 'export']
                },
                {
                    id: 'system-settings',
                    name: 'ç³»ç»Ÿè®¾ç½®',
                    description: 'é…ç½®ç³»ç»Ÿå‚æ•°å’Œå…¨å±€è®¾ç½®',
                    icon: 'âš™ï¸',
                    requiredPermissions: ['admin']
                },
                {
                    id: 'audit-logs',
                    name: 'å®¡è®¡æ—¥å¿—',
                    description: 'æŸ¥çœ‹ç³»ç»Ÿæ“ä½œå®¡è®¡æ—¥å¿—',
                    icon: 'ğŸ“‹',
                    requiredPermissions: ['read', 'audit']
                },
                {
                    id: 'reports',
                    name: 'æŠ¥è¡¨ç”Ÿæˆ',
                    description: 'ç”Ÿæˆå„ç§ç»Ÿè®¡æŠ¥è¡¨å’Œåˆ†ææŠ¥å‘Š',
                    icon: 'ğŸ“ˆ',
                    requiredPermissions: ['read', 'report']
                }
            ];
        }

        // æ›´æ–°ç”¨æˆ·è¡¨æ ¼
        function updateUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                const role = roles.find(r => r.id === user.role);
                
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td><span class="role-badge ${role.color}">${role.name}</span></td>
                    <td>${user.permissions.join(', ')}</td>
                    <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                    <td>
                        <button onclick="editUser(${user.id})" 
                                style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-right: 5px;">
                            ç¼–è¾‘
                        </button>
                        <button onclick="deleteUser(${user.id})" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                            åˆ é™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°æƒé™ç½‘æ ¼
        function updatePermissionGrid() {
            const container = document.getElementById('permissionGrid');
            container.innerHTML = '';

            permissions.forEach(permission => {
                const card = document.createElement('div');
                card.className = 'permission-card';
                card.onclick = () => togglePermission(permission.id);

                const grantedCount = users.filter(u => u.permissions.includes(permission.id)).length;
                const totalCount = users.length;
                const percentage = totalCount > 0 ? (grantedCount / totalCount) * 100 : 0;
                
                let status = 'denied';
                let statusClass = 'status-denied';
                if (percentage === 100) {
                    status = 'granted';
                    statusClass = 'status-granted';
                } else if (percentage > 0) {
                    status = 'partial';
                    statusClass = 'status-partial';
                }

                card.innerHTML = `
                    <div class="permission-header">
                        <span class="permission-icon">${permission.icon}</span>
                        <span class="permission-name">${permission.name}</span>
                        <span class="permission-status ${statusClass}">${status}</span>
                    </div>
                    <div class="permission-description">${permission.description}</div>
                    <div class="permission-requirements">
                        æˆæƒç‡: ${grantedCount}/${totalCount} (${percentage.toFixed(1)}%)
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // æ›´æ–°åŠŸèƒ½æ¨¡å—
        function updateFeatureModules() {
            const container = document.getElementById('featureModules');
            container.innerHTML = '';

            features.forEach(feature => {
                const module = document.createElement('div');
                module.className = 'feature-module';

                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™
                const currentUser = users.find(u => u.id == checkUserInput.getValue()) || users[0];
                const hasAccess = includesAll(currentUser.permissions, feature.requiredPermissions);
                module.classList.add(hasAccess ? 'accessible' : 'inaccessible');

                const requiredPermissionsHtml = feature.requiredPermissions.map(permId => {
                    const hasPermission = currentUser.permissions.includes(permId);
                    return `<span class="required-permission ${hasPermission ? 'granted' : 'missing'}">${permId}</span>`;
                }).join('');

                module.innerHTML = `
                    <div class="feature-header">
                        <span class="feature-icon">${feature.icon}</span>
                        <span class="feature-name">${feature.name}</span>
                        <span class="feature-status ${hasAccess ? 'status-granted' : 'status-denied'}">
                            ${hasAccess ? 'å¯è®¿é—®' : 'ä¸å¯è®¿é—®'}
                        </span>
                    </div>
                    <div class="feature-description">${feature.description}</div>
                    <div class="required-permissions">
                        <strong>æ‰€éœ€æƒé™:</strong> ${requiredPermissionsHtml}
                    </div>
                `;

                container.appendChild(module);
            });
        }

        // æ›´æ–°è§’è‰²å¡ç‰‡
        function updateRoleCards() {
            const container = document.getElementById('roleCards');
            container.innerHTML = '';

            roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'role-card';

                const permissionsHtml = role.permissions.map(permId => {
                    const permission = permissions.find(p => p.id === permId);
                    return `<span class="role-permission">${permission ? permission.name : permId}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="role-header">
                        <span class="role-name">${role.name}</span>
                        <span class="role-badge ${role.color}">${role.name}</span>
                    </div>
                    <div class="role-permissions">
                        ${permissionsHtml}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // åˆ‡æ¢æƒé™
        function togglePermission(permissionId) {
            const currentUser = users.find(u => u.id == checkUserInput.getValue()) || users[0];
            const hasPermission = currentUser.permissions.includes(permissionId);
            
            if (hasPermission) {
                currentUser.permissions = currentUser.permissions.filter(p => p !== permissionId);
                addAccessLog(`ç§»é™¤æƒé™: ${permissionId}`, currentUser.name, 'warning');
            } else {
                currentUser.permissions.push(permissionId);
                addAccessLog(`æ·»åŠ æƒé™: ${permissionId}`, currentUser.name, 'success');
            }

            updateUserTable();
            updatePermissionGrid();
            updateFeatureModules();
            notification.success(`æƒé™${hasPermission ? 'ç§»é™¤' : 'æ·»åŠ '}æˆåŠŸ`);
        }

        // æ£€æŸ¥æƒé™
        function checkPermissions() {
            const currentUser = currentUserSelect.getValue();
            const operationType = operationTypeSelect.getValue();
            const permissionLevel = permissionLevelSelect.getValue();

            console.log('æ£€æŸ¥æƒé™ - å½“å‰ç”¨æˆ·:', currentUser);
            console.log('æ£€æŸ¥æƒé™ - æ“ä½œç±»å‹:', operationType);
            console.log('æ£€æŸ¥æƒé™ - æƒé™çº§åˆ«:', permissionLevel);
            console.log('æ£€æŸ¥æƒé™ - å¯ç”¨è§’è‰²:', roles.map(r => r.id));
            console.log('æ£€æŸ¥æƒé™ - ç°æœ‰ç”¨æˆ·:', users.map(u => ({ name: u.name, role: u.role })));

            if (!currentUser || !operationType || !permissionLevel) {
                notification.error('è¯·é€‰æ‹©æ‰€æœ‰å‚æ•°');
                return;
            }

            // ä¿®å¤ï¼šæ ¹æ®è§’è‰²æŸ¥æ‰¾ç”¨æˆ·ï¼Œè€Œä¸æ˜¯ç›´æ¥åŒ¹é…è§’è‰²
            const user = users.find(u => u.role === currentUser);
            console.log('æ£€æŸ¥æƒé™ - æ‰¾åˆ°çš„ç”¨æˆ·:', user);
            
            if (!user) {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”è§’è‰²çš„ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿç”¨æˆ·
                const role = roles.find(r => r.id === currentUser);
                console.log('æ£€æŸ¥æƒé™ - æ‰¾åˆ°çš„è§’è‰²:', role);
                
                if (role) {
                    const mockUser = {
                        id: 999,
                        name: `${role.name}ç”¨æˆ·`,
                        role: currentUser,
                        permissions: role.permissions,
                        status: 'active'
                    };
                    
                    const requiredPermissions = [operationType];
                    if (permissionLevel === 'admin') {
                        requiredPermissions.push('admin');
                    }

                    const hasPermission = includesAll(mockUser.permissions, requiredPermissions);
                    
                    addAccessLog(`æƒé™æ£€æŸ¥: ${operationType}`, mockUser.name, hasPermission ? 'success' : 'error');
                    
                    if (hasPermission) {
                        notification.success('æƒé™æ£€æŸ¥é€šè¿‡');
                    } else {
                        notification.error('æƒé™ä¸è¶³');
                    }
                } else {
                    notification.error('æ— æ•ˆçš„è§’è‰²');
                }
                return;
            }

            const requiredPermissions = [operationType];
            if (permissionLevel === 'admin') {
                requiredPermissions.push('admin');
            }

            const hasPermission = includesAll(user.permissions, requiredPermissions);
            
            addAccessLog(`æƒé™æ£€æŸ¥: ${operationType}`, user.name, hasPermission ? 'success' : 'error');
            
            if (hasPermission) {
                notification.success('æƒé™æ£€æŸ¥é€šè¿‡');
            } else {
                notification.error('æƒé™ä¸è¶³');
            }
        }

        // æ·»åŠ ç”¨æˆ·
        function addUser() {
            modal.prompt('è¯·è¾“å…¥ç”¨æˆ·å:', 'æ–°ç”¨æˆ·').then(name => {
                if (name) {
                    modal.prompt('è¯·é€‰æ‹©è§’è‰² (admin/manager/user/guest):', 'user').then(role => {
                        if (role && roles.find(r => r.id === role)) {
                            const newUser = {
                                id: users.length + 1,
                                name: name,
                                role: role,
                                permissions: roles.find(r => r.id === role).permissions,
                                status: 'active'
                            };
                            users.push(newUser);
                            updateUserTable();
                            updatePermissionGrid();
                            addAccessLog(`æ·»åŠ ç”¨æˆ·: ${name}`, 'system', 'info');
                            notification.success('ç”¨æˆ·æ·»åŠ æˆåŠŸ');
                        } else {
                            notification.error('æ— æ•ˆçš„è§’è‰²');
                        }
                    });
                }
            });
        }

        // ç¼–è¾‘ç”¨æˆ·
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                modal.prompt('è¯·è¾“å…¥æ–°ç”¨æˆ·å:', user.name).then(name => {
                    if (name) {
                        user.name = name;
                        updateUserTable();
                        addAccessLog(`ç¼–è¾‘ç”¨æˆ·: ${name}`, 'system', 'info');
                        notification.success('ç”¨æˆ·ç¼–è¾‘æˆåŠŸ');
                    }
                });
            }
        }

        // åˆ é™¤ç”¨æˆ·
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                modal.confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${user.name} å—ï¼Ÿ`).then(confirmed => {
                    if (confirmed) {
                        users = users.filter(u => u.id !== userId);
                        updateUserTable();
                        updatePermissionGrid();
                        addAccessLog(`åˆ é™¤ç”¨æˆ·: ${user.name}`, 'system', 'warning');
                        notification.success('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
                    }
                });
            }
        }

        // ç®¡ç†è§’è‰²
        function manageRoles() {
            const content = `
                <div style="max-width: 600px;">
                    <h4>è§’è‰²ç®¡ç†</h4>
                    <p>å½“å‰ç³»ç»ŸåŒ…å« ${roles.length} ä¸ªè§’è‰²ï¼Œ${users.length} ä¸ªç”¨æˆ·</p>
                    <div style="margin-top: 15px;">
                        ${roles.map(role => `
                            <div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 6px;">
                                <strong>${role.name}</strong> (${role.permissions.length} ä¸ªæƒé™)
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    æƒé™: ${role.permissions.join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            modal.alert(content, 'è§’è‰²ç®¡ç†');
        }

        // æ‰§è¡Œæƒé™æ£€æŸ¥
        function performPermissionCheck() {
            const userId = checkUserInput.getValue();
            const requiredPerms = requiredPermissionsSelect.getValue();
            const checkMode = checkModeSelect.getValue();

            if (!userId || !requiredPerms || !checkMode) {
                notification.error('è¯·å¡«å†™æ‰€æœ‰æ£€æŸ¥å‚æ•°');
                return;
            }

            const user = users.find(u => u.id === userId);
            if (!user) {
                notification.error('ç”¨æˆ·ä¸å­˜åœ¨');
                return;
            }

            let result = false;
            let message = '';

            switch (checkMode) {
                case 'strict':
                    result = includesAll(user.permissions, requiredPerms);
                    message = `ä¸¥æ ¼æ¨¡å¼: ç”¨æˆ· ${user.name} æ˜¯å¦åŒ…å«æ‰€æœ‰æƒé™ [${requiredPerms.join(', ')}]`;
                    break;
                case 'loose':
                    result = requiredPerms.some(perm => user.permissions.includes(perm));
                    message = `å®½æ¾æ¨¡å¼: ç”¨æˆ· ${user.name} æ˜¯å¦åŒ…å«ä»»ä¸€æƒé™ [${requiredPerms.join(', ')}]`;
                    break;
                case 'partial':
                    const matchedPerms = requiredPerms.filter(perm => user.permissions.includes(perm));
                    result = matchedPerms.length > 0;
                    message = `éƒ¨åˆ†æ¨¡å¼: ç”¨æˆ· ${user.name} åŒ…å« ${matchedPerms.length}/${requiredPerms.length} ä¸ªæƒé™`;
                    break;
            }

            const resultDiv = document.getElementById('checkResult');
            resultDiv.style.display = 'block';
            resultDiv.className = `check-result ${result ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <div>${message}</div>
                <div style="margin-top: 5px; font-size: 0.9em;">
                    ç»“æœ: <strong>${result ? 'âœ… æ£€æŸ¥é€šè¿‡' : 'âŒ æ£€æŸ¥å¤±è´¥'}</strong>
                </div>
            `;

            addAccessLog(`æƒé™æ£€æŸ¥: ${checkMode}æ¨¡å¼`, user.name, result ? 'success' : 'error');
        }

        // æ‰¹é‡æƒé™æ£€æŸ¥
        function batchPermissionCheck() {
            const requiredPerms = ['read', 'write'];
            const results = users.map(user => {
                const hasAllPermissions = includesAll(user.permissions, requiredPerms);
                return { user, hasAllPermissions };
            });

            const content = `
                <div style="max-width: 500px;">
                    <h4>æ‰¹é‡æƒé™æ£€æŸ¥ç»“æœ</h4>
                    <p>æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·æ˜¯å¦åŒ…å«æƒé™: [${requiredPerms.join(', ')}]</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ç”¨æˆ·</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">è§’è‰²</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6;">ç»“æœ</th>
                        </tr>
                        ${results.map(r => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${r.user.name}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">${r.user.role}</td>
                                <td style="padding: 8px; border: 1px solid #dee2e6;">
                                    <span style="color: ${r.hasAllPermissions ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                        ${r.hasAllPermissions ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `;

            modal.alert(content, 'æ‰¹é‡æƒé™æ£€æŸ¥ç»“æœ');
            addAccessLog('æ‰¹é‡æƒé™æ£€æŸ¥', 'system', 'info');
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            modal.confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¿é—®æ—¥å¿—å—ï¼Ÿ').then(confirmed => {
                if (confirmed) {
                    accessLogs = [];
                    updateAccessLog();
                    notification.success('æ—¥å¿—å·²æ¸…é™¤');
                }
            });
        }

        // æ·»åŠ è®¿é—®æ—¥å¿—
        function addAccessLog(action, user, status) {
            const timestamp = new Date();
            const logEntry = {
                time: timestamp,
                action: action,
                user: user,
                status: status
            };

            accessLogs.unshift(logEntry);
            if (accessLogs.length > 50) {
                accessLogs.pop();
            }

            updateAccessLog();
        }

        // æ›´æ–°è®¿é—®æ—¥å¿—
        function updateAccessLog() {
            const container = document.getElementById('accessLog');
            
            container.innerHTML = accessLogs.map(entry => `
                <div class="log-entry">
                    <span class="log-time">${formatDateTime(entry.time)}</span>
                    <span class="log-user">${entry.user}</span>
                    <span class="log-action">${entry.action}</span>
                    <span class="log-result ${entry.status}">${entry.status}</span>
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // å…¨å±€è°ƒè¯•å‡½æ•°
        window.debugPermissionSystem = function() {
            console.log('=== æƒé™ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===');
            console.log('è§’è‰²åˆ—è¡¨:', roles);
            console.log('ç”¨æˆ·åˆ—è¡¨:', users);
            console.log('æƒé™åˆ—è¡¨:', permissions);
            console.log('åŠŸèƒ½åˆ—è¡¨:', features);
            console.log('è®¿é—®æ—¥å¿—æ•°é‡:', accessLogs.length);
            console.log('=======================');
        };
    </script>
</body>

</html>