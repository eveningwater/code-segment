<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è±¡åˆå¹¶ä¸å¯è§†åŒ–å¹³å° - merge</title>
    <link rel="stylesheet" href="../../demo/plugins/modal/style.css">
    <link rel="stylesheet" href="../../demo/plugins/checkbox/style.css">
    <link rel="stylesheet" href="../../demo/plugins/notification/style.css">
    <!-- Highlight.js ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 36px;
            color: white;
        }

        .header h1 {
            font-size: 2.7rem;
            margin-bottom: 12px;
            font-weight: 800;
            text-shadow: 0 3px 8px rgba(15, 23, 42, 0.35);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 26px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 26px;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.15);
            margin-bottom: 10px;
        }

        .card h2 {
            font-size: 1.55rem;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 22px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.98rem;
        }

        .textarea-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 1.05rem;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.25s ease;
            min-height: 120px;
            resize: vertical;
        }

        .textarea-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        .object-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .object-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .object-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .object-item-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 1rem;
        }

        .object-item-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .object-item-remove:hover {
            background: #dc2626;
        }

        .object-display {
            background: #f8fafc;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .object-container {
            background: white;
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #e5e7eb;
            position: relative;
        }

        .object-container.merged {
            border-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .object-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .object-title.merged {
            color: #22c55e;
        }

        .json-display {
            background: #1e293b;
            border-radius: 10px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #a78bfa;
        }

        .json-null {
            color: #94a3b8;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .comparison-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
        }

        .comparison-card h4 {
            font-size: 0.95rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .comparison-card p {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #475569;
            margin: 4px 0;
        }

        .history-list {
            max-height: 320px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 12px;
        }

        .history-item {
            background: white;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }

        .history-summary {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #1f2937;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 3px 12px rgba(15, 23, 42, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .code-block {
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
        }

        .code-block pre {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            overflow-x: auto;
        }

        .empty-state {
            text-align: center;
            padding: 36px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 4px;
        }

        .merge-visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .merge-arrow {
            font-size: 2rem;
            color: #667eea;
            font-weight: 800;
        }

        .object-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .key-highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .key-highlight.merged {
            background: #dcfce7;
            color: #15803d;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .merge-visualization {
                flex-direction: column;
            }

            .merge-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”€ å¯¹è±¡åˆå¹¶ä¸å¯è§†åŒ–å¹³å°</h1>
            <p>åŸºäº merge å‡½æ•°çš„å¯¹è±¡åˆå¹¶å·¥å…·ï¼Œæ™ºèƒ½åˆå¹¶å¤šä¸ªå¯¹è±¡å¹¶å¯è§†åŒ–å±•ç¤ºåˆå¹¶è¿‡ç¨‹</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="card">
                    <h2>ğŸ“ å¯¹è±¡è¾“å…¥</h2>
                    <div class="input-section">
                        <div class="input-group">
                            <label>å¯¹è±¡æ•°æ® (JSON æ ¼å¼)</label>
                            <textarea id="objectInput" class="textarea-field" placeholder='{"a": 1, "b": 2}'></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary btn-block" onclick="window.mergeTool?.addObject()">â• æ·»åŠ å¯¹è±¡</button>
                        </div>
                        <div class="object-list" id="objectList">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“¦</div>
                                <p>æš‚æ— å¯¹è±¡ï¼Œè¯·æ·»åŠ </p>
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-success" onclick="window.mergeTool?.mergeObjects()">âš¡ åˆå¹¶å¯¹è±¡</button>
                            <button class="btn btn-info" onclick="window.mergeTool?.loadSample()">ğŸ“„ ç¤ºä¾‹æ•°æ®</button>
                            <button class="btn btn-danger" onclick="window.mergeTool?.clearAll()">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>âš™ï¸ é«˜çº§é€‰é¡¹</h2>
                    <div class="input-section">
                        <div id="checkboxGroup"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>ğŸ—‚ï¸ åˆå¹¶å†å² (<span id="historyCount">0</span>)</h2>
                    <div class="history-list" id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— åˆå¹¶å†å²</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <div class="card">
                    <h2>ğŸ“¦ è¾“å…¥å¯¹è±¡</h2>
                    <div class="object-display" id="inputDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ å¯¹è±¡åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="card" id="resultCard" style="display:none;">
                    <h2>âœ¨ åˆå¹¶ç»“æœ</h2>
                    <div class="object-display" id="resultDisplay"></div>
                </div>

                <div class="card" id="analysisCard" style="display:none;">
                    <h2>ğŸ“Š åˆå¹¶åˆ†æ</h2>
                    <div class="comparison-grid" id="comparisonGrid"></div>
                </div>

                <div class="card" id="codeSection" style="display:none;">
                    <h2>ğŸ’» æ‰§è¡Œä»£ç </h2>
                    <div class="code-block">
                        <pre><code class="language-javascript" id="codePreview">// ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="card">
            <h2>ğŸ“– å‡½æ•°è¯´æ˜</h2>
            <div style="background:#f8fafc;padding:20px;border-radius:14px;">
                <h3 style="color:#667eea;margin-bottom:12px;">merge å‡½æ•°ï¼ˆå¯¹è±¡åˆå¹¶ï¼‰</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const merge = (...args) => [...args].reduce((acc, item) => 
  Object.keys(item).reduce((a, k) => {
    acc[k] = acc.hasOwnProperty(k) 
      ? [].concat(acc[k]).concat(item[k]) 
      : item[k];
    return acc;
  }, {}), {});</code></pre>
                </div>

                <h3 style="color:#667eea;margin:20px 0 12px;">å‡½æ•°è¯´æ˜</h3>
                <p style="color:#374151;line-height:1.8;">
                    <strong>merge</strong> å‡½æ•°ç”¨äºåˆå¹¶å¤šä¸ªå¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚
                    å¦‚æœå¤šä¸ªå¯¹è±¡ä¸­å­˜åœ¨ç›¸åŒçš„é”®ï¼Œä¼šå°†å€¼åˆå¹¶æˆæ•°ç»„ã€‚
                    å¦‚æœé”®åªåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ·»åŠ è¯¥é”®å€¼å¯¹ã€‚
                </p>

                <h3 style="color:#667eea;margin:20px 0 12px;">ä½¿ç”¨æ–¹å¼</h3>
                <div class="code-block">
                    <pre><code class="language-javascript">const object = {
  a: [{ x: 2 }, { y: 4 }],
  b: 1
};
const other = {
  a: { z: 3 },
  b: [2, 3],
  c: 'foo'
};
merge(object, other);
// { a: [{ x: 2 }, { y: 4 }, { z: 3 }], b: [1, 2, 3], c: 'foo' }</code></pre>
                </div>

                <h3 style="color:#667eea;margin:20px 0 12px;">å…¸å‹åœºæ™¯</h3>
                <div>
                    <span class="badge">é…ç½®åˆå¹¶</span>
                    <span class="badge">æ•°æ®èšåˆ</span>
                    <span class="badge">å¯¹è±¡æ‰©å±•</span>
                    <span class="badge">æ•°æ®æ•´åˆ</span>
                    <span class="badge">é…ç½®ç®¡ç†</span>
                    <span class="badge">ç®—æ³•å­¦ä¹ </span>
                </div>
            </div>
        </div>
    </div>

    <script src="../../demo/plugins/modal/index.js"></script>
    <script src="../../demo/plugins/checkbox/index.js"></script>
    <script src="../../demo/plugins/notification/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        const merge = (...args) => [...args].reduce((acc, item) => Object.keys(item).reduce((a, k) => {
            acc[k] = acc.hasOwnProperty(k) ? [].concat(acc[k]).concat(item[k]) : item[k];
            return acc;
        }, {}), {});

        class MergeTool {
            constructor() {
                this.plugins = {};
                this.objects = [];
                this.mergedResult = null;
                this.history = [];
                this.stats = {
                    totalMerges: 0,
                    totalObjects: 0,
                    averageKeys: 0,
                    maxKeys: 0
                };
                this.objectId = 1;
                this.checkboxOptions = [
                    { id: 'showInput', label: 'æ˜¾ç¤ºè¾“å…¥å¯¹è±¡', checked: true },
                    { id: 'showResult', label: 'æ˜¾ç¤ºåˆå¹¶ç»“æœ', checked: true },
                    { id: 'showAnalysis', label: 'æ˜¾ç¤ºåˆå¹¶åˆ†æ', checked: true },
                    { id: 'showCode', label: 'æ˜¾ç¤ºä»£ç é¢„è§ˆ', checked: true },
                    { id: 'showNotifications', label: 'æ˜¾ç¤ºé€šçŸ¥æé†’', checked: true }
                ];
                this.init();
            }

            async init() {
                try {
                    await this.loadPlugins();
                    this.setupCheckboxes();
                    this.initHighlight();
                    this.updateStats();
                    this.showWelcomeMessage();
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }

            initHighlight() {
                if (window.hljs) {
                    document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                }
            }

            async loadPlugins() {
                try {
                    this.plugins.modal = new Modal();
                    this.plugins.notification = new Notification();
                } catch (error) {
                    console.warn('éƒ¨åˆ†æ’ä»¶åŠ è½½å¤±è´¥:', error);
                }
            }

            setupCheckboxes() {
                const container = document.getElementById('checkboxGroup');
                if (!container) return;
                try {
                    const group = Checkbox.createCheckboxGroup({
                        items: this.checkboxOptions.map(option => ({
                            id: option.id,
                            label: option.label,
                            checked: option.checked
                        })),
                        onChange: () => {}
                    });
                    container.appendChild(group.container);
                    this.plugins.checkboxGroup = group;
                } catch (error) {
                    console.warn('å¤é€‰æ¡†æ’ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿå¤é€‰æ¡†:', error);
                    this.checkboxOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `<input type="checkbox" id="${option.id}" ${option.checked ? 'checked' : ''}>` +
                            `<label for="${option.id}" style="margin-left:6px;">${option.label}</label>`;
                        container.appendChild(div);
                    });
                }
            }

            getCheckboxValue(id) {
                if (this.plugins.checkboxGroup) {
                    try {
                        const states = this.plugins.checkboxGroup.getAllChecked();
                        const index = this.checkboxOptions.findIndex(option => option.id === id);
                        if (index !== -1) {
                            return states[index] || false;
                        }
                    } catch (error) {
                        console.warn('è¯»å–å¤é€‰æ¡†çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            }

            parseObject(input) {
                const str = input.trim();
                if (!str) {
                    throw new Error('è¾“å…¥ä¸èƒ½ä¸ºç©º');
                }

                try {
                    const parsed = JSON.parse(str);
                    if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                        throw new Error('è¾“å…¥å¿…é¡»æ˜¯æœ‰æ•ˆçš„å¯¹è±¡ï¼ˆä¸èƒ½æ˜¯æ•°ç»„æˆ–nullï¼‰');
                    }
                    return parsed;
                } catch (error) {
                    throw new Error('JSON è§£æå¤±è´¥: ' + error.message);
                }
            }

            formatJSON(obj) {
                return JSON.stringify(obj, null, 2);
            }

            highlightJSON(json) {
                return json
                    .replace(/(".*?")\s*:/g, '<span class="json-key">$1</span>:')
                    .replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>')
                    .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                    .replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>')
                    .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
            }

            addObject() {
                const objectInput = document.getElementById('objectInput');
                if (!objectInput) return;

                const objectStr = objectInput.value.trim();
                if (!objectStr) {
                    this.showError('è¯·è¾“å…¥å¯¹è±¡æ•°æ®');
                    return;
                }

                try {
                    const obj = this.parseObject(objectStr);
                    this.objects.push({
                        id: this.objectId++,
                        obj,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });

                    this.displayInputObjects();
                    objectInput.value = '';
                    this.showNotification(`å¯¹è±¡å·²æ·»åŠ ï¼ŒåŒ…å« ${Object.keys(obj).length} ä¸ªé”®`, 'success');
                } catch (error) {
                    this.showError(error.message);
                }
            }

            removeObject(id) {
                this.objects = this.objects.filter(o => o.id !== id);
                this.displayInputObjects();
                this.showNotification('å¯¹è±¡å·²åˆ é™¤', 'info');
            }

            displayInputObjects() {
                const container = document.getElementById('inputDisplay');
                const listContainer = document.getElementById('objectList');
                if (!container || !listContainer) return;

                if (!this.getCheckboxValue('showInput')) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ™ˆ</div>
                            <p>å·²å…³é—­è¾“å…¥å¯¹è±¡å±•ç¤º</p>
                        </div>`;
                    return;
                }

                if (this.objects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>æ·»åŠ å¯¹è±¡åå°†åœ¨æ­¤å±•ç¤º</p>
                        </div>`;
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <p>æš‚æ— å¯¹è±¡ï¼Œè¯·æ·»åŠ </p>
                        </div>`;
                    return;
                }

                // æ›´æ–°å¯¹è±¡åˆ—è¡¨
                listContainer.innerHTML = this.objects.map((item, index) => `
                    <div class="object-item">
                        <div class="object-item-header">
                            <span class="object-item-title">å¯¹è±¡ ${index + 1}</span>
                            <button class="object-item-remove" onclick="window.mergeTool?.removeObject(${item.id})">åˆ é™¤</button>
                        </div>
                        <div class="json-display">${this.highlightJSON(this.formatJSON(item.obj))}</div>
                    </div>
                `).join('');

                // æ›´æ–°è¾“å…¥æ˜¾ç¤º
                const html = this.objects.map((item, index) => `
                    <div class="object-container">
                        <div class="object-title">
                            <span class="object-badge">å¯¹è±¡ ${index + 1}</span>
                            ${Object.keys(item.obj).length} ä¸ªé”®
                        </div>
                        <div class="json-display">${this.highlightJSON(this.formatJSON(item.obj))}</div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            mergeObjects() {
                if (this.objects.length < 2) {
                    this.showError('è‡³å°‘éœ€è¦ 2 ä¸ªå¯¹è±¡æ‰èƒ½åˆå¹¶');
                    return;
                }

                const start = performance.now();
                try {
                    const objectsToMerge = this.objects.map(item => item.obj);
                    this.mergedResult = merge(...objectsToMerge);
                    const end = performance.now();
                    const time = Math.round((end - start) * 1000) / 1000;

                    this.stats.totalMerges++;
                    this.stats.totalObjects += this.objects.length;
                    const totalKeys = Object.keys(this.mergedResult).length;
                    this.stats.averageKeys = Math.round(((this.stats.averageKeys * (this.stats.totalMerges - 1) + totalKeys) / this.stats.totalMerges) * 100) / 100;
                    this.stats.maxKeys = Math.max(this.stats.maxKeys, totalKeys);

                    this.displayResult();
                    this.updateStats();
                    this.addToHistory(time);

                    if (this.getCheckboxValue('showAnalysis')) {
                        this.displayAnalysis();
                    }

                    if (this.getCheckboxValue('showCode')) {
                        this.showCode();
                    }

                    this.showNotification(`åˆå¹¶æˆåŠŸï¼ç»“æœåŒ…å« ${totalKeys} ä¸ªé”®ï¼Œç”¨æ—¶ ${time}Î¼s`, 'success');
                } catch (error) {
                    this.showError('åˆå¹¶å¤±è´¥: ' + error.message);
                }
            }

            displayResult() {
                const card = document.getElementById('resultCard');
                const container = document.getElementById('resultDisplay');
                if (!card || !container) return;

                if (!this.getCheckboxValue('showResult')) {
                    card.style.display = 'none';
                    return;
                }

                if (!this.mergedResult) {
                    card.style.display = 'none';
                    return;
                }

                const mergedKeys = Object.keys(this.mergedResult);
                const mergedValues = Object.values(this.mergedResult);
                const arrayValues = mergedValues.filter(v => Array.isArray(v)).length;

                container.innerHTML = `
                    <div class="object-container merged">
                        <div class="object-title merged">
                            âœ¨ åˆå¹¶ç»“æœ
                            <span style="font-size:0.85rem;color:#64748b;margin-left:12px;">
                                ${mergedKeys.length} ä¸ªé”® | ${arrayValues} ä¸ªæ•°ç»„å€¼
                            </span>
                        </div>
                        <div class="json-display">${this.highlightJSON(this.formatJSON(this.mergedResult))}</div>
                    </div>
                `;

                card.style.display = 'block';
            }

            displayAnalysis() {
                const card = document.getElementById('analysisCard');
                const grid = document.getElementById('comparisonGrid');
                if (!card || !grid) return;

                if (!this.mergedResult || this.objects.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                const mergedKeys = Object.keys(this.mergedResult);
                const inputKeys = this.objects.map(obj => Object.keys(obj.obj));
                const allInputKeys = [...new Set(inputKeys.flat())];
                const commonKeys = inputKeys.reduce((acc, keys) => {
                    keys.forEach(key => {
                        acc[key] = (acc[key] || 0) + 1;
                    });
                    return acc;
                }, {});
                const duplicateKeys = Object.keys(commonKeys).filter(key => commonKeys[key] > 1);
                const uniqueKeys = allInputKeys.filter(key => !duplicateKeys.includes(key));

                const arrayValues = Object.values(this.mergedResult).filter(v => Array.isArray(v));
                const objectValues = Object.values(this.mergedResult).filter(v => typeof v === 'object' && v !== null && !Array.isArray(v));
                const primitiveValues = Object.values(this.mergedResult).filter(v => v === null || (typeof v !== 'object'));

                grid.innerHTML = `
                    <div class="comparison-card">
                        <h4>ğŸ“Š é”®ç»Ÿè®¡</h4>
                        <p>åˆå¹¶åæ€»é”®æ•°: ${mergedKeys.length}</p>
                        <p>è¾“å…¥å¯¹è±¡æ€»æ•°: ${this.objects.length}</p>
                        <p>é‡å¤é”®æ•°é‡: ${duplicateKeys.length}</p>
                        <p>å”¯ä¸€é”®æ•°é‡: ${uniqueKeys.length}</p>
                        <p>é‡å¤é”®åˆ—è¡¨: ${duplicateKeys.length > 0 ? duplicateKeys.join(', ') : 'æ— '}</p>
                    </div>
                    <div class="comparison-card">
                        <h4>ğŸ”¢ å€¼ç±»å‹ç»Ÿè®¡</h4>
                        <p>æ•°ç»„å€¼: ${arrayValues.length}</p>
                        <p>å¯¹è±¡å€¼: ${objectValues.length}</p>
                        <p>åŸå§‹å€¼: ${primitiveValues.length}</p>
                    </div>
                    <div class="comparison-card">
                        <h4>ğŸ“‹ è¾“å…¥å¯¹è±¡è¯¦æƒ…</h4>
                        ${this.objects.map((item, index) => `
                            <p>å¯¹è±¡ ${index + 1}: ${Object.keys(item.obj).length} ä¸ªé”®</p>
                        `).join('')}
                    </div>
                `;

                card.style.display = 'block';
            }

            addToHistory(time) {
                this.history.unshift({
                    time: new Date().toLocaleString('zh-CN'),
                    objectCount: this.objects.length,
                    mergedKeys: Object.keys(this.mergedResult).length,
                    execTime: time
                });
                if (this.history.length > 40) this.history.pop();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('historyList');
                const count = document.getElementById('historyCount');
                if (!container) return;
                if (count) count.textContent = this.history.length;

                if (this.history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <p>æš‚æ— åˆå¹¶å†å²</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.history.slice(0, 20).map(item => `
                    <div class="history-item">
                        <div class="history-time">${item.time} â€¢ ${item.execTime}Î¼s</div>
                        <div class="history-summary">
                            åˆå¹¶ ${item.objectCount} ä¸ªå¯¹è±¡ â†’ ${item.mergedKeys} ä¸ªé”®
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const grid = document.getElementById('statsGrid');
                if (!grid) return;
                grid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalMerges}</div>
                        <div class="stat-label">åˆå¹¶æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.totalObjects}</div>
                        <div class="stat-label">ç´¯è®¡å¯¹è±¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.objects.length}</div>
                        <div class="stat-label">å½“å‰å¯¹è±¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.averageKeys.toFixed(1)}</div>
                        <div class="stat-label">å¹³å‡é”®æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.stats.maxKeys}</div>
                        <div class="stat-label">æœ€å¤§é”®æ•°</div>
                    </div>
                `;
            }

            showCode() {
                const section = document.getElementById('codeSection');
                const preview = document.getElementById('codePreview');
                if (!preview) return;

                if (!this.mergedResult || this.objects.length === 0) {
                    if (section) section.style.display = 'none';
                    return;
                }

                const objectsCode = this.objects.map(item => this.formatJSON(item.obj)).join(',\n  ');

                const code = `const merge = (...args) => [...args].reduce((acc, item) => 
  Object.keys(item).reduce((a, k) => {
    acc[k] = acc.hasOwnProperty(k) 
      ? [].concat(acc[k]).concat(item[k]) 
      : item[k];
    return acc;
  }, {}), {});

// è¾“å…¥å¯¹è±¡
${this.objects.map((item, index) => `const obj${index + 1} = ${this.formatJSON(item.obj)};`).join('\n')}

// åˆå¹¶å¯¹è±¡
const result = merge(${this.objects.map((item, index) => `obj${index + 1}`).join(', ')});
console.log(result);
// ${this.formatJSON(this.mergedResult)}

// è¯´æ˜ï¼š
// - merge å‡½æ•°æ¥å—å¤šä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°
// - å¦‚æœå¤šä¸ªå¯¹è±¡ä¸­å­˜åœ¨ç›¸åŒçš„é”®ï¼Œä¼šå°†å€¼åˆå¹¶æˆæ•°ç»„
// - å¦‚æœé”®åªåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ·»åŠ è¯¥é”®å€¼å¯¹
// - åˆå¹¶åå…±æœ‰ ${Object.keys(this.mergedResult).length} ä¸ªé”®`;

                preview.textContent = code;
                if (window.hljs) {
                    delete preview.dataset.highlighted;
                    preview.className = 'language-javascript';
                    hljs.highlightElement(preview);
                }
                if (section) section.style.display = 'block';
            }

            clearAll() {
                this.objects = [];
                this.mergedResult = null;
                const objectInput = document.getElementById('objectInput');
                if (objectInput) objectInput.value = '';
                this.displayInputObjects();
                const resultCard = document.getElementById('resultCard');
                if (resultCard) resultCard.style.display = 'none';
                const analysisCard = document.getElementById('analysisCard');
                if (analysisCard) analysisCard.style.display = 'none';
                const codeSection = document.getElementById('codeSection');
                if (codeSection) codeSection.style.display = 'none';
                this.showNotification('å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®', 'info');
            }

            loadSample() {
                const sampleObjects = [
                    { a: [{ x: 2 }, { y: 4 }], b: 1 },
                    { a: { z: 3 }, b: [2, 3], c: 'foo' }
                ];

                // æ¸…ç©ºç°æœ‰å¯¹è±¡
                this.objects = [];
                this.objectId = 1;

                // æ·»åŠ ç¤ºä¾‹å¯¹è±¡
                sampleObjects.forEach(obj => {
                    this.objects.push({
                        id: this.objectId++,
                        obj,
                        timestamp: new Date().toLocaleString('zh-CN')
                    });
                });

                this.displayInputObjects();
                this.showNotification('ç¤ºä¾‹æ•°æ®å·²åŠ è½½', 'info');
            }

            showNotification(message, type) {
                if (this.plugins.notification && this.getCheckboxValue('showNotifications')) {
                    this.plugins.notification.show(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showWelcomeMessage() {
                if (this.plugins.modal) {
                    this.plugins.modal.show({
                        title: 'ğŸ‰ æ¬¢è¿ä½¿ç”¨å¯¹è±¡åˆå¹¶å¹³å°',
                        content: `
                            <div style="padding:18px;">
                                <div style="font-size:46px;text-align:center;margin-bottom:12px;">ğŸ”€</div>
                                <p style="color:#1f2937;line-height:1.8;">
                                    ä½¿ç”¨ <strong>merge</strong> å‡½æ•°åˆå¹¶å¤šä¸ªå¯¹è±¡ï¼Œæ™ºèƒ½å¤„ç†ç›¸åŒé”®çš„å€¼åˆå¹¶ã€‚
                                    å¯è§†åŒ–å±•ç¤ºåˆå¹¶å‰åçš„å¯¹è±¡ç»“æ„ï¼Œå¸®åŠ©ç†è§£å¯¹è±¡åˆå¹¶çš„æœºåˆ¶ã€‚
                                </p>
                                <div style="background:#e0e7ff;border-left:4px solid #667eea;padding:12px;border-radius:12px;color:#4338ca;margin-top:12px;">
                                    <strong>äº®ç‚¹ï¼š</strong> å¤šå¯¹è±¡ç®¡ç†ã€åˆå¹¶å¯è§†åŒ–ã€è¯¦ç»†åˆ†æã€ä»£ç é¢„è§ˆã€å†å²è®°å½•ã€‚
                                </div>
                                <ul style="color:#1f2937;margin-left:18px;margin-top:12px;line-height:1.8;">
                                    <li>æ”¯æŒæ·»åŠ å¤šä¸ªå¯¹è±¡è¿›è¡Œåˆå¹¶</li>
                                    <li>å¯è§†åŒ–å±•ç¤ºåˆå¹¶å‰åçš„å¯¹è±¡ç»“æ„</li>
                                    <li>è‡ªåŠ¨è¯†åˆ«é‡å¤é”®å¹¶åˆå¹¶æˆæ•°ç»„</li>
                                    <li>æä¾›è¯¦ç»†çš„ç»Ÿè®¡åˆ†æå’Œå¯¹æ¯”ä¿¡æ¯</li>
                                </ul>
                            </div>
                        `,
                        type: 'alert'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.mergeTool = new MergeTool();
        });

        if (document.readyState !== 'loading' && !window.mergeTool) {
            window.mergeTool = new MergeTool();
        }
    </script>
</body>

</html>
